<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="dark">
<head>
<meta charset="utf-8">
<title>System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<style>
:root {
    --bg-body: #003035;
    --bg-sidebar: #002225;
    --bg-card: linear-gradient(145deg, #004d4d, #003333);
    --bg-input: rgba(0, 0, 0, 0.3);
    --gold-primary: #d4af37;
    --gold-hover: #f9d877;
    --gold-shadow: rgba(212, 175, 55, 0.5);
    --gold-border: rgba(212, 175, 55, 0.7);
    --gold-faint: rgba(212, 175, 55, 0.2);
    --text-main: #e0f2f1;
    --text-muted: #d4af37;
    --btn-bg: linear-gradient(145deg, #005252, #003d3d);
    --success: #00e676; 
    --danger: #ff5252;
    --radius: 12px;
}
[data-theme="light"] {
    --bg-body: #f8f9fa;
    --bg-sidebar: #ffffff;
    --bg-card: #ffffff;
    --bg-input: #f1f3f5;
    --gold-primary: #b8860b; 
    --gold-hover: #d4af37;
    --gold-shadow: rgba(184, 134, 11, 0.15);
    --gold-border: rgba(184, 134, 11, 0.3);
    --gold-faint: rgba(184, 134, 11, 0.08);
    --text-main: #1f2937;
    --text-muted: #856404;
    --btn-bg: linear-gradient(145deg, #ffffff, #f3f4f6);
    --success: #059669; 
    --danger: #dc2626;
    --radius: 12px;
}
input:focus, select:focus, button:focus, .nav-btn:focus, textarea:focus, .fx-box:focus-within {
    outline: 3px solid var(--success) !important;
    box-shadow: 0 0 20px rgba(0, 230, 118, 0.6) !important;
    border-color: var(--success) !important;
    z-index: 100;
    transform: scale(1.01);
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazirmatn', 'Segoe UI', 'Tahoma', 'Arial', sans-serif !important; transition: background 0.3s ease, color 0.2s; }
body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
html[dir="ltr"] body { direction: ltr; }
html[dir="rtl"] body { direction: rtl; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-sidebar); }
html[dir="rtl"] ::-webkit-scrollbar-track { border-left: 1px solid var(--gold-border); }
html[dir="ltr"] ::-webkit-scrollbar-track { border-right: 1px solid var(--gold-border); }
::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 4px; border: 1px solid var(--bg-body); }
#loginPage { 
    position: fixed; top: 0; right: 0; width: 100%; height: 100%; 
    background-color: #001a1c;
    background-image: radial-gradient(var(--gold-border) 1px, transparent 1px);
    background-size: 30px 30px;
    z-index: 9999; 
    display: flex; align-items: center; justify-content: center; 
}
.login-box { 
    background: linear-gradient(180deg, rgba(0,30,30,0.95), rgba(0,15,15,0.98));
    padding: 60px 40px; 
    border-radius: 15px; 
    width: 100%; max-width: 420px; 
    text-align: center; 
    border: 4px double var(--gold-primary); 
    box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px var(--gold-shadow);
    position: relative;
}
.login-box::before {
    content: "âšœ"; position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
    font-size: 40px; color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-shadow);
    background: #001a1c; padding: 0 10px; border-radius: 50%;
}
.login-header-text { color: var(--gold-primary); text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-bottom: 5px; font-weight: 900; letter-spacing: -1px; font-size: 28px; }
.login-sub-text { color: var(--gold-hover); margin-bottom: 30px; font-size: 13px; border-bottom: 1px solid var(--gold-border); display: inline-block; padding-bottom: 5px; font-weight: 300; }
.login-input { background: rgba(0,0,0,0.4) !important; border: 1px solid var(--gold-border) !important; color: var(--gold-primary) !important; text-align: center; border-radius: 50px !important; margin-bottom: 15px; transition: 0.3s; font-size: 16px; font-weight: bold; }
.login-input:focus { box-shadow: 0 0 15px var(--gold-shadow) !important; border-color: var(--gold-hover) !important; }
#loadingMsg { color: var(--gold-primary); margin-top: 20px; font-size: 14px; display: none; }
.lang-select-container { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
.lang-btn { background: transparent; border: 1px solid var(--gold-border); color: var(--gold-primary); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 12px; opacity: 0.6; }
.lang-btn.active { background: var(--gold-primary); color: #000; opacity: 1; font-weight: bold; }
#mainApp { display: flex; width: 100%; height: 100%; display: none; }
.sidebar { width: 280px; background: var(--bg-sidebar); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.05); z-index: 10; }
html[dir="rtl"] .sidebar { border-left: 1px solid var(--gold-border); }
html[dir="ltr"] .sidebar { border-right: 1px solid var(--gold-border); }
.content { flex-grow: 1; overflow-y: auto; padding: 30px; background-image: radial-gradient(circle at 10% 20%, var(--gold-faint) 0%, transparent 20%); }
.page { display: none; animation: fadeIn 0.4s; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.nav-btn { background: transparent; color: var(--text-muted); border: 1px solid transparent; padding: 15px; width: 100%; cursor: pointer; border-radius: var(--radius); margin-bottom: 8px; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: 700; }
html[dir="rtl"] .nav-btn { text-align: right; }
html[dir="ltr"] .nav-btn { text-align: left; }
.nav-btn:hover { color: var(--gold-primary); background: var(--gold-faint); transform: translateX(5px); border: 1px solid var(--gold-border); }
html[dir="rtl"] .nav-btn:hover { transform: translateX(-5px); }
.nav-btn.active { background: linear-gradient(90deg, var(--gold-faint), transparent); color: var(--gold-primary); border: 1px solid var(--gold-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
html[dir="rtl"] .nav-btn.active { border-right: 4px solid var(--gold-primary); }
html[dir="ltr"] .nav-btn.active { border-left: 4px solid var(--gold-primary); }
.card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid var(--gold-border); position: relative; overflow: hidden; }
.card-header { font-size: 20px; font-weight: 900; margin-bottom: 20px; color: var(--gold-primary); border-bottom: 1px solid var(--gold-border); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; letter-spacing: -0.5px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.input, select.input { width: 100%; padding: 10px 12px; border: 1px solid var(--gold-border); border-radius: var(--radius); margin-bottom: 10px; background: var(--bg-input); color: var(--text-main); outline: none; font-size: 14px; font-weight: 500; }
.input:focus { border-color: var(--gold-primary); box-shadow: 0 0 10px var(--gold-shadow); }
.label { font-size: 13px; color: var(--gold-primary); margin-bottom: 4px; display: block; font-weight: 700; }
.btn { padding: 10px 20px; border-radius: 50px; border: none; cursor: pointer; font-size: 14px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: 5px; border: 1px solid transparent; }
.btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
.btn-gold { background: linear-gradient(135deg, #b8860b 0%, #d4af37 50%, #b8860b 100%); color: #fff; box-shadow: 0 4px 15px rgba(184, 134, 11, 0.3); border: none; }
.btn-blue { background: linear-gradient(45deg, #1565c0, #42a5f5); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-green { background: linear-gradient(45deg, #059669, #34d399); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-red { background: linear-gradient(45deg, #b91c1c, #f87171); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-purple { background: linear-gradient(45deg, #6d28d9, #a78bfa); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-indigo { background: linear-gradient(45deg, #3730a3, #818cf8); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-outline { background: transparent; border: 1px solid var(--gold-primary); color: var(--gold-primary); }
.btn-outline:hover { background: var(--gold-primary); color: #fff; }
.btn-sm { padding: 4px 8px !important; font-size: 11px !important; border-radius: 8px !important; min-width: auto !important; }
.fx-container { display: flex; flex-direction: column; gap: 15px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--gold-border); margin-top: 15px; }
.fx-box { flex: 1; background: var(--bg-input); padding: 15px; border-radius: 12px; border: 1px solid var(--gold-border); position: relative; transition: 0.3s; }
.fx-box:focus-within { border-color: var(--gold-primary); box-shadow: 0 0 15px var(--gold-shadow); }
.fx-box-label { font-size: 11px; color: var(--gold-primary); font-weight: 700; margin-bottom: 5px; display: block; text-transform: uppercase; }
.fx-input-group { display: flex; align-items: center; justify-content: space-between; }
.fx-amount { font-size: 24px; font-weight: 900; background: transparent; border: none; color: var(--text-main); width: 100%; outline: none; font-family: 'Arial', sans-serif !important; direction: ltr; text-align: left; }
.fx-currency { font-weight: 900; color: var(--gold-primary); font-size: 16px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; border: none; cursor: pointer; outline: none; }
.fx-rate-bar { display: flex; align-items: center; justify-content: center; gap: 10px; margin: -10px 0; z-index: 2; position: relative; }
.fx-rate-badge { background: var(--bg-card); border: 1px solid var(--gold-primary); padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; color: var(--gold-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; gap: 5px; align-items: center; cursor: pointer; transition: 0.2s; }
.fx-rate-badge:hover { transform: scale(1.05); background: var(--gold-faint); }
.fx-info { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-top: 5px; padding: 0 5px; }
.fx-type-switch { display: flex; background: rgba(0,0,0,0.2); border-radius: 50px; padding: 4px; border: 1px solid var(--gold-border); margin-bottom: 15px; }
.fx-type-opt { flex: 1; text-align: center; padding: 8px; border-radius: 40px; cursor: pointer; font-size: 13px; font-weight: bold; color: var(--text-muted); transition: 0.3s; }
.fx-type-opt.active.sell { background: var(--danger); color: white; box-shadow: 0 4px 10px rgba(255,82,82,0.3); }
.fx-type-opt.active.buy { background: var(--success); color: white; box-shadow: 0 4px 10px rgba(0,230,118,0.3); }
table { width: 100%; border-collapse: separate; border-spacing: 0 0; font-size: 14px; border: 1px solid var(--gold-border); border-radius: 8px; overflow: hidden; }
th { background: var(--gold-faint); color: var(--gold-primary); padding: 12px; border-bottom: 1px solid var(--gold-border); font-weight: 800; }
html[dir="rtl"] th { text-align: right; border-left: 1px solid var(--gold-border); }
html[dir="ltr"] th { text-align: left; border-right: 1px solid var(--gold-border); }
td { padding: 12px; background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--gold-border); color: var(--text-main); font-weight: 500; }
html[dir="rtl"] td { border-left: 1px solid var(--gold-border); }
html[dir="ltr"] td { border-right: 1px solid var(--gold-border); }
tr:last-child td { border-bottom: none; }
html[dir="rtl"] th:last-child, html[dir="rtl"] td:last-child { border-left: none; }
html[dir="ltr"] th:last-child, html[dir="ltr"] td:last-child { border-right: none; }
.badge { padding: 4px 8px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid var(--gold-border); }
.text-green { color: var(--success) !important; font-weight: bold; dir: ltr; }
.text-red { color: var(--danger) !important; font-weight: bold; dir: ltr; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
.modal-content { position: relative; background: var(--bg-body); border: 1px solid var(--gold-primary); padding: 30px; border-radius: 20px; width: 90%; max-width: 650px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; color: var(--text-main); }
.close-icon { position: absolute; top: 20px; font-size: 24px; font-weight: bold; color: var(--danger); cursor: pointer; transition: transform 0.2s; z-index: 10; }
html[dir="rtl"] .close-icon { left: 20px; }
html[dir="ltr"] .close-icon { right: 20px; }
.close-icon:hover { transform: scale(1.2); }
.account-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--gold-border); transition: 0.2s; cursor: pointer; background: rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 5px; }
.account-list-item:hover { background: var(--gold-faint); transform: translateX(5px); }
html[dir="rtl"] .account-list-item:hover { transform: translateX(-5px); }
.search-sticky { position: sticky; top: 0; background: var(--bg-body); z-index: 5; padding-bottom: 10px; border-bottom: 2px solid var(--gold-primary); margin-bottom: 15px; }
.stat-box { background: linear-gradient(to bottom right, var(--gold-faint), rgba(0,0,0,0.02)); padding: 15px; border-radius: 20px; border: 1px solid var(--gold-border); text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
.stat-val { font-size: 26px; font-weight: 900; margin-top: 8px; direction: ltr; color: var(--gold-primary); letter-spacing: 0.5px; }
.profit-section { background: linear-gradient(90deg, #0f2027, #203a43, #2c5364); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; display: flex; justify-content: space-around; border: 2px solid var(--gold-primary); box-shadow: 0 0 15px rgba(0,0,0,0.2); }
.theme-switch { position: absolute; top: 20px; cursor: pointer; font-size: 22px; background: var(--bg-card); padding: 12px; border-radius: 50%; border: 1px solid var(--gold-border); color: var(--gold-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; transition: 0.3s; }
html[dir="rtl"] .theme-switch { left: 20px; }
html[dir="ltr"] .theme-switch { right: 20px; }
.theme-switch:hover { transform: rotate(15deg) scale(1.1); background: var(--gold-faint); }
.radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
.radio-label { flex: 1; text-align: center; padding: 10px; border: 1px solid var(--gold-primary); border-radius: var(--radius); cursor: pointer; opacity: 0.7; color: var(--gold-primary); font-weight: bold; }
.radio-label.active { background: var(--gold-primary); color: #fff; opacity: 1; font-weight: 900; box-shadow: 0 0 15px var(--gold-shadow); }
#printHeaderGlobal { display: none; }
@media print {
    body { background: white !important; color: black !important; display: block !important; height: auto !important; }
    .sidebar, .no-print, .theme-switch, .header-bar .btn, #loginPage { display: none !important; }
    .content { padding: 0 !important; margin: 0 !important; background: none !important; width: 100% !important; overflow: visible !important; }
    .card { border: none !important; box-shadow: none !important; padding: 0 !important; background: white !important; color: black !important; margin-bottom: 20px !important; }
    .card-header { color: black !important; border-bottom: 2px solid black !important; }
    table { width: 100% !important; border-collapse: collapse !important; font-size: 10pt !important; border: 1px solid #000 !important; font-family: 'Vazirmatn', sans-serif !important; }
    th, td { border: 1px solid #000 !important; padding: 5px !important; color: black !important; background: transparent !important; }
    html[dir="rtl"] th, html[dir="rtl"] td { text-align: right !important; }
    html[dir="ltr"] th, html[dir="ltr"] td { text-align: left !important; }
    .stat-box { border: 1px solid #000 !important; color: black !important; page-break-inside: avoid; }
    .stat-val { color: black !important; text-shadow: none !important; }
    .input, input, select { border: none !important; background: transparent !important; color: black !important; padding: 0 !important; margin: 0 !important; height: auto !important; }
    ::-webkit-scrollbar { display: none; }
    #printHeaderGlobal { display: block !important; margin-bottom: 20px; }
}

.group-header {
    justify-content: space-between !important;
    background: rgba(0,0,0,0.2);
    border: 1px dashed var(--gold-border);
}
.group-header:hover {
    background: var(--gold-faint);
}
.submenu {
    display: none;
    flex-direction: column;
    padding-right: 15px;
    border-right: 2px solid var(--gold-primary);
    margin-right: 10px;
    margin-bottom: 10px;
    background: rgba(0,0,0,0.1);
    border-radius: 8px;
    animation: slideDown 0.3s ease;
}
html[dir="ltr"] .submenu {
    padding-right: 0;
    padding-left: 15px;
    border-right: none;
    border-left: 2px solid var(--gold-primary);
    margin-right: 0;
    margin-left: 10px;
}
.submenu.open {
    display: flex;
}
.arrow-icon {
    font-size: 10px;
    transition: 0.3s;
}
.submenu.open + .group-header .arrow-icon {
    transform: rotate(180deg);
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- Ø´Ø±ÙˆØ¹ Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª --- */
#modalSettings .modal-content {
    width: 95% !important;
    height: 90% !important;
    max-width: 1200px !important;
    max-height: 90vh !important;
    padding: 0 !important;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-body);
}
.settings-container { display: flex; flex: 1; height: 100%; overflow: hidden; }
.settings-sidebar { width: 260px; background: rgba(0,0,0,0.15); border-left: 1px solid var(--gold-border); display: flex; flex-direction: column; padding: 20px 10px; overflow-y: auto; }
.settings-menu-btn { text-align: right; padding: 15px 20px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: var(--text-muted); transition: 0.3s; border: 1px solid transparent; display: flex; align-items: center; gap: 10px; }
.settings-menu-btn:hover { background: var(--gold-faint); color: var(--gold-primary); }
.settings-menu-btn.active { background: var(--gold-primary); color: #000; box-shadow: 0 5px 15px var(--gold-shadow); }
.settings-content-area { flex: 1; padding: 40px; overflow-y: auto; background: rgba(0,0,0,0.05); }
.settings-tab { display: none; animation: fadeIn 0.4s; }
.settings-tab.active { display: block; }
.setting-card { background: var(--bg-card); border: 1px solid var(--gold-border); border-radius: 16px; padding: 30px; max-width: 800px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.setting-header-large { font-size: 24px; font-weight: 900; color: var(--gold-primary); margin-bottom: 10px; border-bottom: 2px solid var(--gold-border); padding-bottom: 15px; }
.city-detail-group { background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px dashed var(--gold-border); }
@media print {
    .thermal-receipt {
        width: 80mm !important;
        font-size: 10pt !important;
        padding: 5px !important;
        margin: 0 auto !important;
        border: none !important;
        font-family: 'Tahoma', sans-serif !important;
    }
    .a4-receipt {
        width: 210mm !important;
        height: 290mm !important;
        padding: 20mm !important;
        border: none !important;
        position: relative;
    }
    .id-copy-area {
        margin-top: 50px;
        height: 300px;
        border: 2px dashed #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-weight: bold;
        background: #fdfdfd;
    }
    .print-logo-img {
        max-width: 150px;
        max-height: 80px;
        display: block;
        margin: 0 auto 10px auto;
    }
}
/* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø³Ø¨Ø² Ø§Ú©Ø³Ù„ --- */
@keyframes pulse-green {
    0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); transform: scale(1); }
    70% { box-shadow: 0 0 0 10px rgba(0, 230, 118, 0); transform: scale(1.05); }
    100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); transform: scale(1); }
}
.btn-excel-pulse {
    background: linear-gradient(45deg, #059669, #34d399);
    color: white;
    font-weight: 900;
    border: 2px solid #fff;
    animation: pulse-green 2s infinite;
    display: flex; align-items: center; justify-content: center; gap: 5px;
}
.btn-excel-pulse:hover {
    animation: none;
    transform: scale(1.05);
}






/* ================================================= */
/* GLOBAL MOBILE STANDARDS (Material/iOS Style)      */
/* ================================================= */
body { -webkit-font-smoothing: antialiased; font-size: 14px; }

/* Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
.card {
    border: none !important;
    border-radius: 16px !important;
    background: rgba(30, 41, 59, 0.6) !important;
    backdrop-filter: blur(12px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
    margin-bottom: 16px !important;
    padding: 20px !important;
}

/* ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
.input, select.input, .btn {
    height: 52px !important;
    font-size: 16px !important;
    border-radius: 12px !important;
    padding: 0 15px !important;
}
.btn { font-weight: 700 !important; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); width: 100%; margin-bottom: 8px; }

/* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø³Ú©Ø±ÙˆÙ„â€ŒØ®ÙˆØ± */
.table-container {
    border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; background: rgba(0,0,0,0.2);
    overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px;
}
th, td { white-space: nowrap; padding: 15px !important; font-size: 13px !important; }

/* Ù…Ù†ÙˆÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø«Ø§Ø¨Øª */
.mobile-nav {
    display: flex !important; position: fixed; bottom: 0; left: 0; right: 0;
    height: 65px; background: #0f172a !important;
    border-top: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
    justify-content: space-around; align-items: center; z-index: 9999;
    padding-bottom: env(safe-area-inset-bottom);
}
@media print { .mobile-nav { display: none !important; } }
@media screen and (min-width: 769px) { .mobile-nav { display: none !important; } }

.m-nav-item {
    background: transparent; border: none; display: flex; flex-direction: column;
    align-items: center; justify-content: center; color: #94a3b8;
    font-size: 10px; font-weight: bold; gap: 4px; width: 60px; height: 100%;
}
.m-nav-item .m-icon { font-size: 20px; margin-bottom: 2px; display: block; }
.m-nav-item.active { color: var(--gold-primary); }
.m-nav-item.active .m-icon { transform: translateY(-3px); filter: drop-shadow(0 4px 6px rgba(212, 175, 55, 0.4)); }

/* Ø¯Ú©Ù…Ù‡ Ø´Ù†Ø§ÙˆØ± */
.fab-btn {
    display: flex !important; align-items: center; justify-content: center;
    width: 56px !important; height: 56px !important;
    background: linear-gradient(135deg, #fbbf24, #b45309);
    border-radius: 50%; position: fixed; bottom: 85px !important; left: 50%;
    transform: translateX(-50%); border: none !important; color: #000;
    font-size: 32px; font-weight: bold; z-index: 10000;
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.5); cursor: pointer; transition: 0.3s;
}
@media print { .fab-btn { display: none !important; } }
@media screen and (min-width: 769px) { .fab-btn { display: none !important; } }

/* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media screen and (max-width: 768px) {
    .sidebar { display: none !important; }
    .theme-switch { top: 15px; left: 15px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
    #printHeaderGlobal { display: none; }
    body { background-color: #0f172a; }
    .content { margin: 0 !important; width: 100% !important; padding: 15px !important; padding-bottom: 100px !important; }
    
    .modal-content {
        width: 100% !important; height: 100% !important; max-width: 100% !important;
        border-radius: 0 !important; max-height: 100vh !important;
        padding: 20px !important; padding-top: 60px !important;
    }
    .close-icon {
        top: 20px !important; right: 20px !important; left: auto !important;
        font-size: 30px !important; background: rgba(255,255,255,0.1);
        width: 40px; height: 40px; display: flex; align-items: center;
        justify-content: center; border-radius: 50%;
    }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr !important; gap: 12px !important; }
    .header-bar { margin-bottom: 20px !important; }
    h2#pageTitle { font-size: 22px !important; border: none !important; }
    .profit-section { flex-direction: column; gap: 15px; }
    .profit-details { border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 15px; min-width: auto !important; }
    .profit-details:last-child { border-bottom: none; }
}
</style>
</head>
<body>
<div id="printHeaderGlobal"></div>
<div class="theme-switch no-print" onclick="toggleTheme()" title="Theme/ØªÙ…">ğŸŒ“</div>

<div id="loginPage">
    <div class="login-box">
        <h2 class="login-header-text" data-i18n="app_title">ØµØ±Ø§ÙÛŒ Ù‡Ø±Ø§ØªÛŒâ€ŒÙ‡Ø§</h2>
        <span class="login-sub-text" data-i18n="company_subtitle">Ø´Ø±Ú©Øª ØµØ±Ø§ÙÛŒ Ùˆ Ø®Ø¯Ù…Ø§Øª Ù¾ÙˆÙ„ÛŒ Ù‡Ø±Ø§ØªÛŒÙ‡Ø§</span>
        <br><br>
        <input type="text" id="loginUser" class="input login-input" placeholder="Username / Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" autocomplete="off" autofocus>
        <input type="password" id="loginPass" class="input login-input" placeholder="Password / Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <button class="btn btn-gold" style="width:100%; padding: 15px; font-size: 16px; margin-top: 10px;" onclick="auth()" data-i18n="login_btn">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… (Enter)</button>
        
        <div class="lang-select-container">
            <button class="lang-btn active" onclick="setLanguage('fa')" id="btn-lang-fa">ÙØ§Ø±Ø³ÛŒ</button>
            <button class="lang-btn" onclick="setLanguage('en')" id="btn-lang-en">English</button>
            <button class="lang-btn" onclick="setLanguage('tr')" id="btn-lang-tr">TÃ¼rkÃ§e</button>
            <button class="lang-btn" onclick="setLanguage('ar')" id="btn-lang-ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        </div>

        <p id="loginErr" style="color:var(--danger); margin-top:15px; display:none; font-size:12px" data-i18n="login_error">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª</p>
        <div id="loadingMsg" data-i18n="loading_db">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§Ù…Ù†ÛŒØªÛŒ...</div>
    </div>
</div>
<div id="mainApp">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid var(--gold-border); padding-bottom:15px">
            <h2 style="color:var(--gold-primary); text-shadow: 0 0 10px var(--gold-shadow); font-weight: 900; font-size: 22px;" data-i18n="app_title">Ø´Ø±Ú©Øª Ù‡Ø±Ø§ØªÛŒâ€ŒÙ‡Ø§</h2>
            <div style="font-size:12px; margin-top:5px; color: var(--gold-primary); opacity:0.8; font-weight:500;" id="sidebarUserInfo">User</div>
        </div>
        
        <button class="nav-btn active admin-only-btn" onclick="go('dashboard')" id="nav-dashboard">
            <span data-i18n="nav_dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (F1)</span>
        </button>
        
        <button class="nav-btn group-header" onclick="toggleGroup('grp-ops')">
            <span>ğŸ”„ Ø¹Ù…Ù„ÛŒØ§Øª Ù¾ÙˆÙ„ÛŒ</span>
            <span class="arrow-icon">â–¼</span>
        </button>
        <div id="grp-ops" class="submenu">
            <button class="nav-btn" onclick="go('hawala')" id="nav-hawala">
                <span data-i18n="nav_hawala">âœˆï¸ Ø­ÙˆØ§Ù„Ù‡â€ŒØ¬Ø§Øª (F2)</span>
            </button>
            <button class="nav-btn" onclick="go('ttPage')" id="nav-tt">
                <span data-i18n="nav_tt">ğŸŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø±Ø² (TT) (F6)</span>
            </button>
            <button class="nav-btn" onclick="go('exchange')" id="nav-exchange">
                <span data-i18n="nav_exchange">ğŸ’± Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ (F4)</span>
            </button>
            <button class="nav-btn" onclick="go('cryptoFX')" id="nav-crypto">
                <span data-i18n="nav_crypto">ğŸª™ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</span>
            </button>
        </div>

        <button class="nav-btn group-header" onclick="toggleGroup('grp-people')">
            <span>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´Ø®Ø§Øµ</span>
            <span class="arrow-icon">â–¼</span>
        </button>
        <div id="grp-people" class="submenu">
            <button class="nav-btn" onclick="go('accounts')" id="nav-accounts">
                <span data-i18n="nav_accounts">ğŸ‘¥ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù† (F3)</span>
            </button>
            <button class="nav-btn admin-only-btn" onclick="go('employees')" id="nav-employees">
                <span>ğŸ‘” Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</span>
            </button>
        </div>

        <button class="nav-btn group-header admin-only-btn" onclick="toggleGroup('grp-reports')">
            <span>ğŸ“‘ Ú¯Ø²Ø§Ø±Ø´ Ùˆ Ø¢Ù†Ø§Ù„ÛŒØ²</span>
            <span class="arrow-icon">â–¼</span>
        </button>
        <div id="grp-reports" class="submenu">
            <button class="nav-btn admin-only-btn" onclick="go('analysis')" id="nav-analysis">
                <span data-i18n="nav_analysis">ğŸ§® Ø¢Ù†Ø§Ù„ÛŒØ² Ø³Ø±Ù…Ø§ÛŒÙ‡ (F7)</span>
            </button>
<button class="nav-btn admin-only-btn" onclick="go('commissions')" id="nav-commissions">
                <span>ğŸ’° Ø­Ø³Ø§Ø¨ Ú©Ù…ÛŒØ´Ù†â€ŒÙ‡Ø§</span>
            </button>
            <button class="nav-btn admin-only-btn" onclick="go('reports')" id="nav-reports">
                <span data-i18n="nav_reports">ğŸ“‘ Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ…</span>
            </button>
        </div>
       
        <div style="margin-top:auto; border-top:1px solid var(--gold-border); padding-top:10px">
            <button class="nav-btn" onclick="openSettings()">
                <span data-i18n="nav_settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
            </button>
            <button class="nav-btn" style="color:var(--danger); border-color:rgba(255, 82, 82, 0.3)" onclick="logout()">
                <span data-i18n="nav_logout">ğŸšª Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>

<div class="mobile-nav no-print">
    <button class="m-nav-item" onclick="go('dashboard')" id="mn-dash">
        <span class="m-icon">ğŸ“Š</span><span>Ø®Ø§Ù†Ù‡</span>
    </button>
    <button class="m-nav-item" onclick="go('hawala')" id="mn-hawala">
        <span class="m-icon">âœˆï¸</span><span>Ø­ÙˆØ§Ù„Ù‡</span>
    </button>
    <div style="width: 60px;"></div> <button class="m-nav-item" onclick="go('accounts')" id="mn-acc">
        <span class="m-icon">ğŸ‘¥</span><span>Ø§Ø´Ø®Ø§Øµ</span>
    </button>
    <button class="m-nav-item" onclick="openSettings()" id="mn-set">
        <span class="m-icon">âš™ï¸</span><span>Ù…Ù†Ùˆ</span>
    </button>
</div>

<div class="fab-btn no-print" onclick="toggleFab()">
    <span style="font-size:30px; margin-top:-2px;">+</span>
</div>

<div id="fabMenu" style="position:fixed; bottom:150px; left:50%; transform:translateX(-50%); z-index:10001; width:90%; max-width:300px; display:none; flex-direction:column; gap:10px;">
    <button onclick="go('hawala'); openHawalaModal('Outgoing'); toggleFab()" class="btn btn-gold" style="box-shadow: 0 5px 20px rgba(0,0,0,0.5);">âœˆï¸ Ø­ÙˆØ§Ù„Ù‡ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯</button>
    <button onclick="go('exchange'); toggleFab()" class="btn btn-blue" style="box-shadow: 0 5px 20px rgba(0,0,0,0.5);">ğŸ’± Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ Ø§Ø±Ø²</button>
    <button onclick="go('accounts'); openModal('modalTx'); toggleFab()" class="btn btn-green" style="box-shadow: 0 5px 20px rgba(0,0,0,0.5);">ğŸ’° Ø¯Ø±ÛŒØ§ÙØª / Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ¬Ù‡</button>
</div>
<div class="content">
        <div class="header-bar" style="display:flex; justify-content:space-between; margin-bottom:30px; align-items: center;">
            <h2 id="pageTitle" style="border-right:5px solid var(--gold-primary); padding-right:20px; color:var(--gold-primary); font-size: 30px; font-weight: 900;" data-i18n="nav_dashboard">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
            <div style="font-size:14px; background:var(--bg-card); padding:10px 20px; border-radius:50px; border:1px solid var(--gold-primary); color: var(--gold-primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-weight: bold; margin-left: 60px;">
                ğŸ“… <span id="displayDate"></span>
            </div>
        </div>
        <div id="dashboard" class="page active admin-only-view">
            <div class="profit-section">
                <div class="profit-details" style="min-width: 30%; text-align: center;">
                    <div style="font-size:13px; opacity:0.8; border-bottom: 1px solid var(--gold-border); padding-bottom:10px; margin-bottom:10px; color: var(--gold-primary);" data-i18n="lbl_initial_capital">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø«Ø¨Øª Ø´Ø¯Ù‡</div>
                    <div id="dispInitialCap" style="font-size:20px; font-weight:800; direction:ltr; display:flex; flex-wrap:wrap; justify-content:center; gap: 15px;">0</div>
                </div>
                
                <div style="border-right:1px solid var(--gold-border); margin:0 15px"></div>

                <div class="profit-details" style="min-width: 30%; text-align: center;">
                    <div style="font-size:13px; opacity:0.8; border-bottom: 1px solid var(--gold-border); padding-bottom:10px; margin-bottom:10px; color: var(--text-main);">Ø³ÙˆØ¯ Ø§Ù…Ø±ÙˆØ² (Today)</div>
                    <div id="dispDailyProfit" style="font-size:20px; font-weight:900; color:var(--success)">0</div>
                </div>

                <div style="border-right:1px solid var(--gold-border); margin:0 15px"></div>

                <div class="profit-details" style="min-width: 30%; text-align: center;">
                    <div style="font-size:13px; opacity:0.8; border-bottom: 1px solid var(--gold-border); padding-bottom:10px; margin-bottom:10px; color: var(--gold-primary);" data-i18n="lbl_profit_loss">Ø³ÙˆØ¯ Ú©Ù„ (Total/Yearly)</div>
                    <div id="dispProfit" style="font-size:20px; font-weight:900; color:var(--success)">0</div>
                </div>
            </div>

            <div style="text-align: right; color: var(--gold-primary); margin-bottom: 15px; font-size: 18px; font-weight: 800; border-bottom: 2px solid var(--gold-faint); display:inline-block; padding-bottom:5px;" data-i18n="lbl_cash_balance">Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ ØµÙ†Ø¯ÙˆÙ‚ (Ø®Ø²Ø§Ù†Ù‡)</div>
            <div class="grid-4" id="cashStats" style="margin-bottom: 30px;"></div>

            <div style="text-align: right; color: #42a5f5; margin-bottom: 15px; font-size: 18px; font-weight: 800; border-bottom: 2px solid rgba(66, 165, 245, 0.3); display:inline-block; padding-bottom:5px;" data-i18n="lbl_crypto_assets">Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ (Crypto Assets)</div>
            <div class="grid-4" id="cryptoStats" style="margin-bottom: 30px;"></div>
<div class="card">
                <div class="card-header">
                    <span data-i18n="lbl_city_balance">Ø¨Ø§Ù„Ø§Ù†Ø³ Ú©ØªØ§Ø¨ Ø´Ù‡Ø±Ù‡Ø§ (Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒ/Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†)</span>
                    <button class="btn btn-outline" style="font-size:11px" onclick="renderDashboard()">
                        <span data-i18n="btn_refresh">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</span>
                    </button>
                </div>
                <div class="grid-3" id="cityStats"></div>
                <p style="font-size:11px; color:var(--text-muted); margin-top:15px; border-top: 1px dashed var(--gold-primary); padding-top: 10px;" data-i18n="msg_city_balance_hint">* Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø«Ø¨Øª (Ø³Ø¨Ø²): Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¨Ù‡ Ù…Ø§ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø§Ø³Øª. Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ù†ÙÛŒ (Ù‚Ø±Ù…Ø²): Ù…Ø§ Ø¨Ù‡ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒÙ….</p>
            </div>
            
            <div class="card">
                <div class="card-header"><span data-i18n="lbl_total_commissions">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø­ÙˆØ§Ù„Ù‡ (Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ)</span></div>
                <div class="grid-4" id="cityCommissions"></div>
            </div>
        </div>
<div id="hawala" class="page">
            <div class="card">
               <div class="grid-2" style="align-items:center">
    <h3 style="color:var(--gold-primary); font-weight:800" data-i18n="header_hawala_manage">Ù…Ø¯ÛŒØ±ÛŒØª Ø­ÙˆØ§Ù„Ù‡â€ŒØ¬Ø§Øª</h3>
    <div style="text-align:left; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn btn-gold" onclick="openHawalaModal('Outgoing')" style="border-bottom: 3px solid #b8860b;">
            <span>â¬†ï¸ Ø­ÙˆØ§Ù„Ù‡ Ø§Ø±Ø³Ø§Ù„ÛŒ (F9)</span>
        </button>
        <button class="btn btn-green" onclick="openHawalaModal('Incoming')" style="border-bottom: 3px solid #047857;">
            <span>â¬‡ï¸ Ø­ÙˆØ§Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ (F8)</span>
        </button>
    </div>
</div>
         <div class="grid-4" style="margin-top:25px; align-items:end;">
    <div>
        <label class="label" data-i18n="lbl_filter_city">ÙÛŒÙ„ØªØ± Ø´Ù‡Ø±</label>
        <select id="filterHCity" class="input" onchange="filterHawala()"></select>
    </div>
    <div>
        <label class="label" data-i18n="lbl_type">Ù†ÙˆØ¹</label>
        <select id="filterHType" class="input" onchange="filterHawala()">
            <option value="All" data-i18n="opt_all">Ù‡Ù…Ù‡</option>
            <option value="Outgoing" data-i18n="opt_outgoing">Ø§Ø±Ø³Ø§Ù„ÛŒ (Out)</option>
            <option value="Incoming" data-i18n="opt_incoming">Ø¯Ø±ÛŒØ§ÙØªÛŒ (In)</option>
        </select>
    </div>
    
    <div>
        <label class="label">ğŸ“… Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
        <input type="date" id="filterHDateStart" class="input" onchange="filterHawala()">
    </div>
    <div>
        <label class="label">ğŸ“… ØªØ§ ØªØ§Ø±ÛŒØ®</label>
        <input type="date" id="filterHDateEnd" class="input" onchange="filterHawala()">
    </div>

    <div style="grid-column: span 2;">
        <label class="label">ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø­ÙˆØ§Ù„Ù‡ / Ù†Ø§Ù…</label>
        <input type="text" id="filterHSearchNum" class="input" placeholder="Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ù†Ø§Ù…..." oninput="filterHawala()">
    </div>

    <div>
        <label class="label" data-i18n="lbl_status">ÙˆØ¶Ø¹ÛŒØª</label>
        <select id="filterHStatus" class="input" onchange="filterHawala()">
            <option value="All" data-i18n="opt_all">Ù‡Ù…Ù‡</option>
            <option value="Pending" data-i18n="opt_pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¬Ø±Ø§</option>
            <option value="Done" data-i18n="opt_done">Ø§Ø¬Ø±Ø§/ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡</option>
        </select>
    </div>
    
    <div id="divFilterGroup" style="display:none;">
        <label class="label" style="color:#ff5252">ÙÛŒÙ„ØªØ± Ù…Ø­Ø±Ù…Ø§Ù†Ù‡</label>
        <select id="filterHGroup" class="input" onchange="filterHawala()">
            <option value="All">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ (A + B)</option>
            <option value="A">ÙÙ‚Ø· Ú¯Ø±ÙˆÙ‡ A</option>
            <option value="B">ÙÙ‚Ø· Ú¯Ø±ÙˆÙ‡ B</option>
        </select>
    </div>

    <div style="grid-column: span 4; display:flex; gap:10px; border-top:1px dashed var(--gold-border); padding-top:10px;">
        <button class="btn btn-outline" style="font-size:12px; flex:1" onclick="exportHawalaToExcel()">
            <span data-i18n="btn_excel">ğŸ“Š Ø§Ú©Ø³Ù„ Ø¹Ø§Ù„ÛŒ</span>
        </button>
        <button class="btn btn-outline" style="font-size:12px; flex:1" onclick="printHawalaList()">
            <span data-i18n="btn_print_book">ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª Ú©ØªØ§Ø¨</span>
        </button>
    </div>
</div>
            </div>
<div class="card table-container" style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="th_hawala_no">Ù†Ù…Ø¨Ø± Ø­ÙˆØ§Ù„Ù‡</th>
                            <th data-i18n="th_type">Ù†ÙˆØ¹</th>
                            <th data-i18n="th_city_book">Ø´Ù‡Ø± / Ú©ØªØ§Ø¨</th>
                            <th data-i18n="th_amount">Ù…Ø¨Ù„Øº</th>
                            <th data-i18n="th_commission">Ú©Ù…ÛŒØ´Ù†</th>
                            <th data-i18n="th_reg_date">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</th>
                            <th data-i18n="th_exec_date">ØªØ§Ø±ÛŒØ® Ø§Ø¬Ø±Ø§</th>
                            <th data-i18n="th_status">ÙˆØ¶Ø¹ÛŒØª</th>
                            <th style="min-width: 200px;" data-i18n="th_ops">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="hawalaBody"></tbody>
                </table>
            </div>
        </div>
<div id="accounts" class="page">
            <div class="card">
                <div class="card-header" data-i18n="header_accounts_manage">Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
                <div class="grid-2">
                    <div>
                        <label class="label" data-i18n="lbl_search_customer">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ</label>
                        <select id="selCustomer" class="input" onchange="loadCustomerLedger()"></select>
                    </div>
                    <div style="text-align:left; padding-top:25px; display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end;">
                        <button class="btn btn-green" onclick="openModal('modalNewCust')" id="btnNewCust">
                            <span data-i18n="btn_new_customer">â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ (F9)</span>
                        </button>
                        <button class="btn btn-blue" onclick="openModal('modalTx')">
                            <span data-i18n="btn_deposit_withdraw">ğŸ’° ÙˆØ§Ø±ÛŒØ²/Ø¨Ø±Ø¯Ø§Ø´Øª</span>
                        </button>
                        <button class="btn btn-indigo" onclick="openModalClientTransfer()">
                            <span data-i18n="btn_transfer">ğŸ”„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø­Ø³Ø§Ø¨</span>
                        </button>
                        <button class="btn btn-gold admin-only-btn" onclick="openAllAccountsModal()">
                            <span data-i18n="btn_all_accounts">ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</span>
                        </button>
                    </div>
                </div>
            </div>
<div class="card" id="ledgerCard" style="display:none">
                <div class="card-header">
                    <span>
                        <span data-i18n="lbl_statement">ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨:</span> 
                        <b id="ledgerName" style="color:var(--text-main); text-shadow: 0 0 10px var(--gold-faint);"></b> 
                        <span id="ledgerPhone" style="font-size:13px; color:var(--text-muted); margin-right:10px; font-weight:400;"></span>
                    </span>
                    <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                        <span id="ledgerFinalSum" dir="ltr" style="font-size:15px; margin-left:10px; font-weight: 900;"></span>
                        <button class="btn btn-outline btn-sm" onclick="openEditCustomerModal()">
                            <span data-i18n="btn_edit">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</span>
                        </button>
                        <button class="btn btn-red btn-sm" onclick="deleteCustomer()">
                            <span data-i18n="btn_delete">ğŸ—‘ Ø­Ø°Ù</span>
                        </button>
                        <button class="btn btn-outline btn-sm no-print" onclick="exportLedgerToExcel()">
                            <span data-i18n="btn_excel">ğŸ“Š Ø§Ú©Ø³Ù„</span>
                        </button>
                        <button class="btn btn-outline btn-sm no-print" onclick="printLedger()">
                            <span data-i18n="btn_print">ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="th_date">ØªØ§Ø±ÛŒØ®</th>
                                <th data-i18n="th_desc">Ø´Ø±Ø­</th>
                                <th data-i18n="th_currency">Ø§Ø±Ø²</th>
                                <th data-i18n="th_debit">Ø¨Ø¯Ù‡Ú©Ø§Ø±</th>
                                <th data-i18n="th_credit">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</th>
                                <th data-i18n="th_balance">Ù…Ø§Ù†Ø¯Ù‡ (ØªØ´Ø®ÛŒØµ)</th>
                                <th class="no-print" data-i18n="th_ops">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="ledgerBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
<div id="ttPage" class="page">
            <div class="card" style="max-width:850px; margin:0 auto">
                <div class="card-header">
                    <span data-i18n="header_tt_app">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­ÙˆØ§Ù„Ù‡ Ø§Ø±Ø²ÛŒ (TT Application)</span>
                </div>
                <div class="radio-group">
                    <div id="ttOptInternal" class="radio-label active" onclick="setTTType('internal')" tabindex="0">
                        <span data-i18n="opt_internal_cust">Ù…Ø´ØªØ±ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±)</span>
                    </div>
                    <div id="ttOptExternal" class="radio-label" onclick="setTTType('external')" tabindex="0">
                        <span data-i18n="opt_external_cust">Ù…Ø´ØªØ±ÛŒ Ø®Ø§Ø±Ø¬ÛŒ (Ù†Ù‚Ø¯ÛŒ)</span>
                    </div>
                </div>
                <div class="grid-2" style="background:rgba(212,175,55,0.05); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid var(--gold-border)">
                    <div id="ttInternalSec">
                         <label class="label" data-i18n="lbl_select_account">Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ (Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø­Ø³Ø§Ø¨)</label>
                         <select id="ttCustomer" class="input"></select>
                    </div>
                    <div id="ttExternalSec" style="display:none">
                        <label class="label" data-i18n="lbl_payer_name">Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ)</label>
                        <input type="text" id="ttExtName" class="input" placeholder="...">
                        <label class="label" style="margin-top:5px" data-i18n="lbl_phone">ØªÙ„ÙÙ† ØªÙ…Ø§Ø³</label>
                        <input type="text" id="ttExtPhone" class="input" placeholder="07...">
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_amount">Ù…Ø¨Ù„Øº Ø­ÙˆØ§Ù„Ù‡</label>
                        <div style="display:flex; gap:5px">
                            <input type="number" id="ttAmt" class="input" placeholder="0.00" oninput="updateTTAutoWords()">
                            <select id="ttCurr" class="input" style="width:100px"></select>
                        </div>
                        <label class="label">Amount in Words (Auto - English)</label>
                        <input type="text" id="ttAmtWords" class="input" placeholder="Amount in letters...">
                    </div>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--gold-primary)">
                <h4 style="color:var(--gold-primary); margin-bottom:15px; font-weight:800;" data-i18n="header_beneficiary">Ù…Ø´Ø®ØµØ§Øª Ø°ÛŒÙ†ÙØ¹ (Beneficiary)</h4>
                <div class="grid-2">
                     <div>
                        <label class="label" data-i18n="lbl_ben_name">Ù†Ø§Ù… Ø°ÛŒÙ†ÙØ¹ (ÙØ§Ø±Ø³ÛŒ)</label>
                        <input type="text" id="ttBenName" class="input">
                     </div>
                     <div>
                        <label class="label">Beneficiary Name (English)</label>
                        <input type="text" id="ttBenNameEn" class="input" style="text-align:left; direction:ltr" placeholder="Full Name in English">
                     </div>
                </div>
                <div class="grid-2">
                     <div><label class="label">Ú©Ø´ÙˆØ± (Country)</label><input type="text" id="ttCountry" class="input"></div>
                     <div><label class="label">Ø´Ù‡Ø± (City)</label><input type="text" id="ttCityDest" class="input"></div>
                </div>
                <label class="label">Ø¢Ø¯Ø±Ø³ (Address)</label><input type="text" id="ttAddress" class="input">
                <div class="grid-2" style="margin-top:10px">
                     <div><label class="label">Ø¨Ø§Ù†Ú© Ù…Ù‚ØµØ¯ (Dest. Bank)</label><input type="text" id="ttDestBank" class="input"></div>
                     <div><label class="label">Ø³ÙˆØ¦ÛŒÙØª Ú©Ø¯ (Swift Code)</label><input type="text" id="ttSwift" class="input" style="text-transform:uppercase"></div>
                </div>
                <label class="label">Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ / IBAN</label><input type="text" id="ttIban" class="input" style="direction:ltr; text-align:left">
                <div class="grid-2" style="margin-top:10px">
                     <div><label class="label">Ø¨Ø§Ù†Ú© Ú©Ø§Ø±Ú¯Ø²Ø§Ø± (Intermediary Bank)</label><input type="text" id="ttInterBank" class="input"></div>
                     <div><label class="label">Ø³ÙˆØ¦ÛŒÙØª Ú©Ø§Ø±Ú¯Ø²Ø§Ø± (Intermediary Swift)</label><input type="text" id="ttInterSwift" class="input"></div>
                </div>
                <label class="label">Ø±ÙØ±Ù†Ø³ (Reference)</label><input type="text" id="ttRef" class="input">
                <label class="label" data-i18n="lbl_desc">ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ</label><input type="text" id="ttDesc" class="input">
                <div style="margin-top:25px; display:flex; gap:10px">
                    <button class="btn btn-purple" style="flex:2; padding:15px" onclick="submitNewTT()">
                        <span data-i18n="btn_submit_tt">Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ùˆ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¬Ù‡ (F10)</span>
                    </button>
                    <button class="btn btn-outline" style="flex:1" onclick="printCurrentTTForm()">
                        <span data-i18n="btn_print_form">ğŸ–¨ Ú†Ø§Ù¾ ÙØ±Ù… Ø±Ø³Ù…ÛŒ</span>
                    </button>
                </div>
            </div>
        </div>
<div id="cryptoFX" class="page">
            <div class="card" style="max-width:750px; margin:0 auto">
                <div class="card-header">
                    <span data-i18n="header_crypto_deal">Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ (Crypto)</span>
                    <button class="btn btn-outline" style="font-size:12px;" onclick="printCryptoFx()">
                        <span data-i18n="btn_print_receipt">ğŸ–¨ Ú†Ø§Ù¾ Ø±Ø³ÛŒØ¯</span>
                    </button>
                </div>
                
                <div class="radio-group">
                    <div id="cryptoOptExternal" class="radio-label active" onclick="setCryptoCustType('external')" tabindex="0">
                        <span data-i18n="opt_external_cust">Ù…Ø´ØªØ±ÛŒ Ø¢Ø²Ø§Ø¯ (Ù†Ù‚Ø¯ÛŒ)</span>
                    </div>
                    <div id="cryptoOptInternal" class="radio-label" onclick="setCryptoCustType('internal')" tabindex="0">
                        <span data-i18n="opt_internal_cust">Ù…Ø´ØªØ±ÛŒ Ø­Ø³Ø§Ø¨â€ŒØ¯Ø§Ø±</span>
                    </div>
                </div>
                <div id="cryptoInternalSec" style="display:none; margin-bottom:15px; padding:10px; border:1px solid var(--gold-border); border-radius:12px;">
                    <label class="label" data-i18n="lbl_select_customer">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</label>
                    <select id="cryptoCustomer" class="input" style="margin-bottom:0"></select>
                </div>

                <div class="grid-2">
                    <div style="background:rgba(212,175,55,0.05); padding:15px; border-radius:15px; border:1px solid var(--gold-primary)">
                        <label class="label" style="font-weight:900; color:var(--text-main)" data-i18n="lbl_deal_type">Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡</label>
                        <select id="cryptoTxType" class="input" style="margin-bottom:0">
                            <option value="Buy" data-i18n="opt_buy">Ø®Ø±ÛŒØ¯ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÙˆÙ„)</option>
                            <option value="Sell" data-i18n="opt_sell">ÙØ±ÙˆØ´ (Ø¯Ø±ÛŒØ§ÙØª Ù¾ÙˆÙ„)</option>
                        </select>
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_desc">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <input type="text" id="cryptoDesc" class="input" placeholder="..." style="margin-bottom:0">
                    </div>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--gold-primary)">
                <div class="grid-2">
                    <div>
                        <label class="label" data-i18n="lbl_crypto_name">Ù†Ø§Ù… Ø§Ø±Ø² (USDT)</label>
                        <input type="text" id="cryptoName" class="input" placeholder="USDT, BTC...">
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_volume">Ù…Ù‚Ø¯Ø§Ø± (Volume)</label>
                        <input type="number" id="cryptoAmt" class="input" placeholder="0.00">
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <label class="label" data-i18n="lbl_payment_curr">Ù†ÙˆØ¹ Ø§Ø±Ø² Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ/Ø¯Ø±ÛŒØ§ÙØªÛŒ</label>
                        <select class="input" id="cryptoCurr"></select>
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_total_fiat">Ù…Ø¨Ù„Øº Ú©Ù„ (Total Fiat)</label>
                        <input type="number" id="fiatAmt" class="input" placeholder="0">
                    </div>
                </div>
                <div style="background:rgba(212,175,55,0.05); padding:15px; border-radius:15px; border:1px solid var(--gold-border); margin-top: 15px;">
                    <label class="label" style="color:var(--text-muted)" data-i18n="lbl_cost_basis">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´): Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ú†Ù‚Ø¯Ø± Ø¨ÙˆØ¯Ù‡ØŸ</label>
                    <input type="number" id="cryptoCostBasis" class="input" placeholder="" style="margin-bottom: 0;">
                </div>
                <button class="btn btn-blue" style="width:100%; margin-top:25px; padding: 15px;" onclick="submitCryptoFx()">
                    <span data-i18n="btn_submit_deal">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ (F10)</span>
                </button>
            </div>
        </div>
<div id="exchange" class="page">
            <div class="card" style="max-width:800px; margin:0 auto">
                <div class="card-header">
                    <span data-i18n="header_fx_deal">Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø§Ø±Ø²ÛŒ (FX Deal Ticket)</span>
                    <button class="btn btn-outline btn-sm" onclick="printExchangeReceipt()">
                        <span data-i18n="btn_print_receipt">ğŸ–¨ Ú†Ø§Ù¾ Ø±Ø³ÛŒØ¯</span>
                    </button>
                </div>

<div class="radio-group">
    <div id="exOptExternal" class="radio-label active" onclick="setExType('external')" tabindex="0">
        <span data-i18n="opt_external_cust">Ù…Ø´ØªØ±ÛŒ Ø¢Ø²Ø§Ø¯ (Ù†Ù‚Ø¯ÛŒ)</span>
    </div>
    <div id="exOptInternal" class="radio-label" onclick="setExType('internal')" tabindex="0">
        <span data-i18n="opt_internal_cust">Ù…Ø´ØªØ±ÛŒ Ø­Ø³Ø§Ø¨â€ŒØ¯Ø§Ø±</span>
    </div>
</div>

<div id="exInternalSec" style="display:none; margin-bottom:15px; padding:10px; border:1px solid var(--gold-border); border-radius:12px;">
    <label class="label" data-i18n="lbl_select_customer">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</label>
    <select id="exCustomer" class="input" style="margin-bottom:0"></select>
</div>

<div id="exExternalSec" style="margin-bottom:15px; background:rgba(255,255,255,0.02); padding:10px; border-radius:12px; border:1px dashed var(--gold-border);">
    <div class="grid-2">
        <div>
            <label class="label">Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ / Ø®Ø±ÛŒØ¯Ø§Ø± / ÙØ±ÙˆØ´Ù†Ø¯Ù‡</label>
            <input type="text" id="exExtName" class="input" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„...">
        </div>
        <div>
            <label class="label">Ù†Ø§Ù… Ù¾Ø¯Ø± (ÙˆÙ„Ø¯)</label>
            <input type="text" id="exExtFather" class="input" placeholder="...">
        </div>
    </div>
    <div class="grid-2">
        <div>
            <label class="label">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
            <input type="text" id="exExtPhone" class="input" placeholder="07...">
        </div>
        <div>
            <label class="label">Ø´Ù…Ø§Ø±Ù‡ ØªØ°Ú©Ø±Ù‡ / ID</label>
            <input type="text" id="exExtID" class="input" placeholder="...">
        </div>
    </div>
</div>

                <div class="fx-container">
                    <div class="fx-type-switch">
                        <div id="btnFxBuy" class="fx-type-opt active buy" onclick="setFxDirection('Buy')" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                            <span data-i18n="btn_fx_buy">Ø®Ø±ÛŒØ¯ (BUY)</span>
                        </div>
                        <div id="btnFxSell" class="fx-type-opt" onclick="setFxDirection('Sell')" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                            <span data-i18n="btn_fx_sell">ÙØ±ÙˆØ´ (SELL)</span>
                        </div>
                    </div>

                    <div class="fx-box">
                        <span class="fx-box-label" data-i18n="lbl_volume">Ù…Ù‚Ø¯Ø§Ø± (Volume)</span>
                        <div class="fx-input-group">
                            <input type="number" id="fxBaseAmt" class="fx-amount" placeholder="1000" oninput="calcFx()">
                            <select id="fxBaseCurr" class="fx-currency" onchange="calcFx()"></select>
                        </div>
                    </div>

                    <div class="fx-rate-bar">
                        <div class="fx-rate-badge">
                            <span data-i18n="lbl_rate">Rate:</span>
                            <input type="number" id="fxRate" style="background:transparent; border:none; color:var(--gold-primary); font-weight:bold; width:80px; text-align:center;" value="1" oninput="calcFx()">
                        </div>
                        <div class="fx-rate-badge" onclick="toggleFxOperator()" title="Operator" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                            <span id="fxOpDisplay">âœ–</span>
                        </div>
                    </div>

                    <div class="fx-box">
                        <span class="fx-box-label" data-i18n="lbl_total">Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ (Total)</span>
                        <div class="fx-input-group">
                            <input type="number" id="fxQuoteAmt" class="fx-amount" placeholder="0" readonly>
                            <select id="fxQuoteCurr" class="fx-currency" onchange="calcFx()"></select>
                        </div>
                    </div>
                    
                    <div class="fx-info">
                        <span id="fxDirText">---</span>
                        <span data-i18n="lbl_cash_balance_after">ØªØ±Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚ Ù¾Ø³ Ø§Ø² Ø§Ù†Ø¬Ø§Ù…</span>
                    </div>
                </div>

                <div style="margin-top:15px">
                    <label class="label" data-i18n="lbl_desc_opt">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <input type="text" id="exDesc" class="input" placeholder="...">
                </div>

                <div style="margin-top:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <label class="label" style="font-weight:normal; opacity:0.8" data-i18n="lbl_cost_basis_fx">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (Cost Basis)</label>
                    <div style="display:flex; gap:10px; align-items:center">
                        <input type="number" id="exCostBasis" class="input" placeholder="..." style="margin-bottom:0">
                        <span id="estimatedProfit" style="font-weight:bold; color:var(--success)">---</span>
                    </div>
                </div>

                <button class="btn btn-blue" style="width:100%; margin-top:20px; padding:15px; font-size:16px;" onclick="submitExchange()">
                    <span data-i18n="btn_submit_deal">Ø«Ø¨Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ (Submit Deal) (F10)</span>
                </button>
            </div>
        </div>
<div id="analysis" class="page admin-only-view">
    <div class="card">
        <div class="card-header">
            <span>Ø¢Ù†Ø§Ù„ÛŒØ² Ø¯Ù‚ÛŒÙ‚ Ø³Ø±Ù…Ø§ÛŒÙ‡ (ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¯Ù„Ø§Ø±)</span>
            <button class="btn btn-gold" onclick="renderAnalysis()">
                <span>ğŸ”„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯</span>
            </button>
        </div>
        
        <div style="margin-bottom:20px; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; border:1px solid var(--gold-primary);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:18px; font-weight:bold; color:var(--text-main);">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø´Ù…Ø§ Ø¨Ù‡ Ø¯Ù„Ø§Ø±:</span>
                <span id="grandTotalUSD" style="font-size:24px; font-weight:900; color:var(--success); direction:ltr; text-shadow:0 0 10px rgba(0,230,118,0.5);">0.00 $</span>
            </div>
            <p style="font-size:11px; color:var(--text-muted); margin-top:10px;">
                * Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„: Ø§Ø±Ø²Ø´ Û± ÙˆØ§Ø­Ø¯ Ø§Ø² Ø¢Ù† Ø§Ø±Ø² Ø¨Ù‡ Ø¯Ù„Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø±Ø§ÛŒ ÛŒÙˆØ±Ùˆ 1.05ØŒ Ø¨Ø±Ø§ÛŒ ØªØªØ± 1).
                <br>
                * Ø³ØªÙˆÙ† Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø®Ø§Ù„Øµ = (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú¯Ø§ÙˆØµÙ†Ø¯ÙˆÙ‚) + (Ø·Ù„Ø¨ Ø§Ø² Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†) + (Ø·Ù„Ø¨ Ø§Ø² Ù…Ø´ØªØ±ÛŒØ§Ù†).
            </p>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:10%">Ø§Ø±Ø²</th>
                        <th style="width:15%">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú¯Ø§ÙˆØµÙ†Ø¯ÙˆÙ‚</th>
                        <th style="width:15%">Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù†</th>
                        <th style="width:15%">Ù…Ø§Ù†Ø¯Ù‡ Ú©ØªØ§Ø¨ Ø­ÙˆØ§Ù„Ù‡</th>
                        <th style="width:15%; background:rgba(212,175,55,0.1)">âœ… Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø®Ø§Ù„Øµ</th>
                        <th style="width:15%">Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¯Ù„Ø§Ø± ($)</th>
                        <th style="width:15%">Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±ÛŒ</th>
                    </tr>
                </thead>
                <tbody id="analysisBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="commissions" class="page admin-only-view">
    <div class="card">
        <div class="card-header">
            <span>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ ØªÙ‚Ø³ÛŒÙ… Ø³ÙˆØ¯ (Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø´Ù‡Ø±)</span>
            <button class="btn btn-gold" onclick="renderCommissionCalc()">ğŸ”„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯</button>
        </div>
        
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">
            * Ø¯Ø±ØµØ¯Ù‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø´Ù‡Ø± Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø³Ù‡Ù…â€ŒÙ‡Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯.
        </p>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø´Ù‡Ø± / Ú©ØªØ§Ø¨</th>
                        <th>Ø§Ø±Ø²</th>
                        <th>Ú©Ù„ Ú©Ù…ÛŒØ´Ù†</th>
                        <th style="color:var(--success)">Ø³Ù‡Ù… Ø¯ÙØªØ± (Ù…Ø§)</th>
                        <th style="color:var(--gold-primary)">Ø³Ù‡Ù… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</th>
                        <th style="color:var(--danger)">Ù…Ø§Ù„ÛŒØ§Øª/Ù‡Ø²ÛŒÙ†Ù‡</th>
                    </tr>
                </thead>
                <tbody id="commCalcBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="reports" class="page admin-only-view">
    <div class="card" style="margin-bottom:15px">
        <div class="card-header">
            <span data-i18n="header_backup">Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ (Backup & Export)</span>
        </div>
        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:15px; font-size:12px; color:var(--text-muted)">
            Û±. <b>ÙØ§ÛŒÙ„ Ø³ÛŒØ³ØªÙ…ÛŒ (JSON):</b> Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÙ‚ØªÛŒ ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¹ÙˆØ¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.<br>
            Û². <b>ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ (Excel):</b> Ù…Ø®ØµÙˆØµ Ú†Ø§Ù¾ Ú©Ø±Ø¯Ù† Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¯Ø± Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¯ÙØªØ±ÛŒ.
        </div>
        
        <div class="grid-3">
            <button class="btn btn-blue" onclick="exportDB()" style="height:50px">
                <span data-i18n="btn_download_backup">â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø³ÛŒØ³ØªÙ… (JSON)</span>
            </button>
            
            <button class="btn btn-gold" onclick="importDB()" style="height:50px">
                <span data-i18n="btn_restore_backup">â¬†ï¸ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ… (Upload)</span>
            </button>

            <button class="btn btn-excel-pulse" onclick="fullExcelBackup()" style="height:50px">
                <span>ğŸ“Š Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø§Ú©Ø³Ù„</span>
            </button>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <span data-i18n="header_journal">Ø¯ÙØªØ± Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ (Log) - Ø§Ù…Ú©Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´Øª ØªØ±Ø§Ú©Ù†Ø´</span>
            <button class="btn btn-outline no-print" style="font-size:12px;" onclick="printTodayJournal()">
                <span data-i18n="btn_print_log">ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª Ø±Ø³Ù…ÛŒ Ú¯Ø²Ø§Ø±Ø´</span>
            </button>
        </div>
        <div class="table-container" style="height:500px; overflow-y:auto">
            <table id="journalTable">
                <thead>
                    <tr>
                        <th data-i18n="th_time">Ø²Ù…Ø§Ù†</th>
                        <th data-i18n="th_section">Ø¨Ø®Ø´</th>
                        <th data-i18n="th_desc">ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                        <th data-i18n="th_amount">Ù…Ø¨Ù„Øº</th>
                        <th data-i18n="th_user">Ú©Ø§Ø±Ø¨Ø±</th>
                        <th class="admin-only-col" data-i18n="th_ops">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody id="journalBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="modalNewHawala" class="modal">
    <div class="modal-content" style="max-width:900px;">
        <span class="close-icon" onclick="closeModal('modalNewHawala')">&times;</span>
        <div class="card-header" id="modalHawalaTitle" style="border-bottom: 2px solid var(--gold-primary);">Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯</div>
        <input type="hidden" id="hType">

        <div class="grid-2">
<div id="divHGroup" style="display:none; margin-bottom:10px; background:rgba(255,0,0,0.1); padding:8px; border-radius:8px; border:1px dashed #ff5252;">
    <label class="label" style="color:#ff5252; font-weight:bold;">Ø³Ø·Ø­ Ù…Ø­Ø±Ù…Ø§Ù†Ú¯ÛŒ (Data Level)</label>
    <select id="hGroup" class="input" style="border-color:#ff5252;">
        <option value="A">Ú¯Ø±ÙˆÙ‡ Ø§Ù„Ù (A) - Ø¹Ù…ÙˆÙ…ÛŒ</option>
        <option value="B">Ú¯Ø±ÙˆÙ‡ Ø¨ (B) - Ù…Ø­Ø±Ù…Ø§Ù†Ù‡</option>
    </select>
</div>
             <div class="radio-group" style="margin-bottom: 0;">
                <div id="hOptExternal" class="radio-label active" onclick="setHawalaCustType('external')">Ù†Ù‚Ø¯ÛŒ (Ø¢Ø²Ø§Ø¯)</div>
                <div id="hOptInternal" class="radio-label" onclick="setHawalaCustType('internal')">Ø­Ø³Ø§Ø¨â€ŒØ¯Ø§Ø±</div>
            </div>
            <div>
                <label class="label">Ú©ØªØ§Ø¨ Ø´Ù‡Ø±</label>
                <select id="hCityBook" class="input"></select>
            </div>
        </div>

        <div id="hInternalSec" style="display:none; background:rgba(212,175,55,0.1); padding:10px; border-radius:8px; margin-bottom:15px; margin-top:10px;">
            <label class="label">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ø­Ø³Ø§Ø¨â€ŒØ¯Ø§Ø±</label>
            <select id="hCustomerSelect" class="input" onchange="fillHawalaCustName()"></select>
        </div>

        <div style="background:rgba(255,255,255,0.03); padding:10px; border:1px dashed var(--gold-border); border-radius:10px; margin:10px 0;">
            <div class="grid-4">
                <div><label class="label">Ù…Ø¨Ù„Øº Ø§ØµÙ„ Ø­ÙˆØ§Ù„Ù‡</label><input type="number" id="hAmt" class="input"></div>
                <div><label class="label">Ø§Ø±Ø² Ø­ÙˆØ§Ù„Ù‡</label><select id="hCurr" class="input"></select></div>
                <div>
                    <label class="label">Ù…Ø¨Ù„Øº Ú©Ù…ÛŒØ´Ù†</label>
                    <div style="display:flex; gap:2px;">
                        <input type="number" id="hComm" class="input" value="0">
                        <select id="hCommType" class="input" style="width:70px; padding:0 5px;">
                             <option value="in">Ø³ÙˆØ¯ (+)</option>
                             <option value="out">Ù‡Ø²ÛŒÙ†Ù‡ (-)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="label">Ø§Ø±Ø² Ú©Ù…ÛŒØ´Ù†</label>
                    <select id="hCommCurr" class="input"></select>
                </div>
            </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--gold-border); margin:15px 0;">

        <div class="grid-2" style="gap:20px;">
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
                <h4 style="color:var(--gold-primary); margin-bottom:10px; border-bottom:1px solid var(--gold-faint);">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø³ØªÙ†Ø¯Ù‡ (Sender)</h4>
                <div class="grid-2">
                    <div><label class="label">Ù†Ø§Ù…</label><input id="hSender" class="input"></div>
                    <div><label class="label">ØªØ®Ù„Øµ</label><input id="hSenderLast" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Ù†Ø§Ù… Ù¾Ø¯Ø±</label><input id="hSenderFather" class="input"></div>
                    <div><label class="label">Ù…ÙˆØ¨Ø§ÛŒÙ„</label><input id="hPhone" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Ø´Ù…Ø§Ø±Ù‡ ØªØ°Ú©Ø±Ù‡/ID</label><input id="hSenderID" class="input"></div>
                    <div><label class="label">Ù…Ù†Ø¨Ø¹ Ø¹Ø§ÛŒØ¯</label><input id="hSenderSource" class="input"></div>
                </div>
                <div><label class="label">Ù‡Ø¯Ù Ø§Ø±Ø³Ø§Ù„ / Ø¬Ø²Ø¦ÛŒØ§Øª</label><input id="hSenderPurpose" class="input"></div>
            </div>

            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
                <h4 style="color:#42a5f5; margin-bottom:10px; border-bottom:1px solid rgba(66, 165, 245, 0.3);">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Receiver)</h4>
                <div class="grid-2">
                    <div><label class="label">Ù†Ø§Ù…</label><input id="hReceiver" class="input"></div>
                    <div><label class="label">ØªØ®Ù„Øµ</label><input id="hReceiverLast" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Ù†Ø§Ù… Ù¾Ø¯Ø±</label><input id="hReceiverFather" class="input"></div>
                    <div><label class="label">Ù…ÙˆØ¨Ø§ÛŒÙ„</label><input id="hReceiverPhone" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Ø´Ù…Ø§Ø±Ù‡ ØªØ°Ú©Ø±Ù‡/ID</label><input id="hReceiverID" class="input"></div>
                    <div><label class="label">Ù…Ù†Ø¨Ø¹ Ø¹Ø§ÛŒØ¯/Ø´ØºÙ„</label><input id="hReceiverSource" class="input"></div>
                </div>
                <div><label class="label">Ù‡Ø¯Ù Ø¯Ø±ÛŒØ§ÙØª / Ø¬Ø²Ø¦ÛŒØ§Øª</label><input id="hReceiverPurpose" class="input"></div>
            </div>
        </div>

        <div style="margin-top:15px; text-align:left">
            <button class="btn btn-outline" onclick="closeModal('modalNewHawala')">Ø§Ù†ØµØ±Ø§Ù (Esc)</button>
            <button class="btn btn-gold" onclick="submitHawala()">ØµØ¯ÙˆØ± Ùˆ Ø«Ø¨Øª (F10)</button>
        </div>
    </div>
</div>

<div id="modalEditHawala" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('modalEditHawala')">&times;</span>
        <div class="card-header">
            <span data-i18n="modal_edit_hawala">ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ Ø­ÙˆØ§Ù„Ù‡ (Ù…Ø¯ÛŒØ±ÛŒØª)</span> 
            <span id="editHawalaId" style="color:var(--gold-primary)"></span>
        </div>
        
        <input type="hidden" id="editHId">

        <div class="grid-2">
            <div>
                <label class="label">Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª</label>
                <select id="editHType" class="input">
                    <option value="Outgoing">Ø§Ø±Ø³Ø§Ù„ (Out)</option>
                    <option value="Incoming">Ø¯Ø±ÛŒØ§ÙØª (In)</option>
                </select>
            </div>
            <div>
                <label class="label">Ú©ØªØ§Ø¨ Ø´Ù‡Ø±</label>
                <select id="editHCityBook" class="input"></select>
            </div>
        </div>
        
        <div style="background:rgba(212,175,55,0.05); padding:10px; border-radius:10px; border:1px dashed var(--gold-primary); margin-bottom:15px;">
            <div class="grid-2">
                <div><label class="label">Ù…Ø¨Ù„Øº Ø­ÙˆØ§Ù„Ù‡</label><input type="number" id="editHAmt" class="input"></div>
                <div><label class="label">Ø§Ø±Ø² Ø­ÙˆØ§Ù„Ù‡</label><select id="editHCurr" class="input"></select></div>
            </div>
            <div class="grid-2">
                <div><label class="label">Ù…Ø¨Ù„Øº Ú©Ù…ÛŒØ´Ù†</label><input type="number" id="editHComm" class="input"></div>
                <div><label class="label">Ø§Ø±Ø² Ú©Ù…ÛŒØ´Ù†</label><select id="editHCommCurr" class="input"></select></div>
            </div>
        </div>

        <hr style="margin:10px 0; border:0; border-top:1px dashed var(--gold-border)">
        
        <div style="background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; margin-bottom:10px;">
            <label class="label" style="color:var(--gold-primary)">Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø³ØªÙ†Ø¯Ù‡</label>
            <div class="grid-3">
                <div><label class="label">Ù†Ø§Ù…</label><input id="editHSender" class="input"></div>
                <div><label class="label">ØªØ®Ù„Øµ</label><input id="editHSenderLast" class="input"></div>
                <div><label class="label">Ù†Ø§Ù… Ù¾Ø¯Ø±</label><input id="editHSenderFather" class="input"></div>
            </div>
        </div>

        <div style="background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; margin-bottom:10px;">
            <label class="label" style="color:#42a5f5">Ù…Ø´Ø®ØµØ§Øª Ú¯ÛŒØ±Ù†Ø¯Ù‡</label>
            <div class="grid-3">
                <div><label class="label">Ù†Ø§Ù…</label><input id="editHReceiver" class="input"></div>
                <div><label class="label">ØªØ®Ù„Øµ</label><input id="editHReceiverLast" class="input"></div>
                <div><label class="label">Ù†Ø§Ù… Ù¾Ø¯Ø±</label><input id="editHReceiverFather" class="input"></div>
            </div>
        </div>

        <div class="grid-2">
            <div><label class="label">ØªÙ„ÙÙ† ØªÙ…Ø§Ø³</label><input id="editHPhone" class="input"></div>
            <div><label class="label">Ø´Ù…Ø§Ø±Ù‡ ØªØ°Ú©Ø±Ù‡/ID</label><input id="editHIDCard" class="input"></div>
        </div>
        
        <div style="margin-top:15px; text-align:left">
            <button class="btn btn-outline" onclick="closeModal('modalEditHawala')">Ø§Ù†ØµØ±Ø§Ù (Esc)</button>
            <button class="btn btn-blue" onclick="submitEditHawala()">Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª (F10)</button>
        </div>
    </div>
</div>
<div id="modalTx" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('modalTx')">&times;</span>
        <div class="card-header" data-i18n="modal_tx_header">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</div>
        <label class="label" data-i18n="lbl_account_party">Ø·Ø±Ù Ø­Ø³Ø§Ø¨</label>
        <select id="txCust" class="input"></select>
        <div class="grid-2">
            <div>
                <label class="label" data-i18n="lbl_type">Ù†ÙˆØ¹</label>
                <select id="txType" class="input">
                    <option value="credit" data-i18n="opt_deposit">ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø­Ø³Ø§Ø¨ (Ø¯Ø±ÛŒØ§ÙØª Ù¾ÙˆÙ„)</option>
                    <option value="debit" data-i18n="opt_withdraw">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø­Ø³Ø§Ø¨ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÙˆÙ„)</option>
                </select>
            </div>
            <div>
                <label class="label" data-i18n="lbl_currency">Ø§Ø±Ø²</label>
                <select id="txCurr" class="input"></select>
            </div>
        </div>
        <label class="label" data-i18n="lbl_amount">Ù…Ø¨Ù„Øº</label>
        <input type="number" id="txAmt" class="input">
        <label class="label" data-i18n="lbl_desc">Ø´Ø±Ø­</label>
        <input type="text" id="txDesc" class="input">
        <button class="btn btn-gold" style="width:100%; margin-top:15px" onclick="submitTx()">
            <span data-i18n="btn_submit_tx">Ø«Ø¨Øª Ø³Ù†Ø¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalTx')">
            <span data-i18n="btn_close">Ø¨Ø³ØªÙ† (Esc)</span>
        </button>
    </div>
</div>
<div id="modalClientTransfer" class="modal">
    <div class="modal-content" style="max-width:500px">
        <span class="close-icon" onclick="closeModal('modalClientTransfer')">&times;</span>
        <div class="card-header" data-i18n="modal_transfer_header">Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</div>
        <div style="background:rgba(212, 175, 55, 0.1); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid var(--gold-primary)">
            <span style="font-size:12px; color:var(--text-main)" data-i18n="lbl_source_account">Ù…Ø¨Ø¯Ø§ (Ú©Ø³Ø± Ø§Ø² Ø­Ø³Ø§Ø¨): </span>
            <b id="ctSender" style="color:var(--gold-primary); font-size:14px"></b>
        </div>
        <label class="label" data-i18n="lbl_dest_account">Ù…Ù‚ØµØ¯ (ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø­Ø³Ø§Ø¨)</label>
        <select id="ctReceiver" class="input"></select>
        <div class="grid-2">
            <div><label class="label" data-i18n="lbl_transfer_amount">Ù…Ø¨Ù„Øº Ø§Ù†ØªÙ‚Ø§Ù„</label><input type="number" id="ctAmt" class="input"></div>
            <div><label class="label" data-i18n="lbl_currency">Ø§Ø±Ø²</label><select id="ctCurr" class="input"></select></div>
        </div>
        <label class="label" data-i18n="lbl_desc">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
        <input type="text" id="ctDesc" class="input" placeholder="...">
        <button class="btn btn-indigo" style="width:100%; margin-top:15px" onclick="submitClientTransfer()">
            <span data-i18n="btn_do_transfer">Ø§Ù†Ø¬Ø§Ù… Ø§Ù†ØªÙ‚Ø§Ù„ (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalClientTransfer')">
            <span data-i18n="btn_cancel">Ø§Ù†ØµØ±Ø§Ù (Esc)</span>
        </button>
    </div>
</div>

<div id="modalNewCust" class="modal">
    <div class="modal-content" style="max-width:400px; border: 2px solid var(--gold-primary);">
        <span class="close-icon" onclick="closeModal('modalNewCust')">&times;</span>
        <div class="card-header" data-i18n="modal_new_cust">Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</div>
        <div class="label" data-i18n="lbl_cust_name">Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ù…Ø´ØªØ±ÛŒ</div>
        <input id="newCustName" class="input" placeholder="...">
        <div class="label" data-i18n="lbl_phone">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</div>
        <input id="newCustPhone" class="input" placeholder="07...">
        <button class="btn btn-green" style="width:100%" onclick="addCustomer()">
            <span data-i18n="btn_add_list">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalNewCust')">
            <span data-i18n="btn_cancel">Ù„ØºÙˆ (Esc)</span>
        </button>
    </div>
</div>

<div id="modalEditCust" class="modal">
    <div class="modal-content" style="max-width:400px; border: 2px solid var(--gold-primary);">
        <span class="close-icon" onclick="closeModal('modalEditCust')">&times;</span>
        <div class="card-header" data-i18n="modal_edit_cust">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´Ø®ØµØ§Øª Ù…Ø´ØªØ±ÛŒ</div>
        <div class="label" style="color:var(--danger); font-size:11px; margin-bottom:5px" data-i18n="msg_edit_name_warning">ØªÙˆØ¬Ù‡: ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¨Ø§Ø¹Ø« ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¯Ø± ØªÙ…Ø§Ù… Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù‚Ø¨Ù„ÛŒ Ù†ÛŒØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        <div class="label" data-i18n="lbl_new_name">Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯</div>
        <input id="editCustName" class="input">
        <div class="label" data-i18n="lbl_new_phone">ØªÙ„ÙÙ† Ø¬Ø¯ÛŒØ¯</div>
        <input id="editCustPhone" class="input">
        <button class="btn btn-blue" style="width:100%" onclick="submitEditCustomer()">
            <span data-i18n="btn_save_changes">Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalEditCust')">
            <span data-i18n="btn_cancel">Ù„ØºÙˆ (Esc)</span>
        </button>
    </div>
</div>

<div id="modalAllAcc" class="modal">
    <div class="modal-content" style="max-width:800px; max-height: 90vh; display: flex; flex-direction: column;">
        <span class="close-icon" onclick="closeModal('modalAllAcc')">&times;</span>
        <div class="card-header" data-i18n="modal_all_acc_status">ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
        
        <div class="search-sticky">
            <div class="label" style="font-size: 11px; margin-bottom: 5px; color: var(--gold-primary);" data-i18n="msg_click_to_view">* Ø¬Ù‡Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÛŒØ²Ø­Ø³Ø§Ø¨ØŒ Ø±ÙˆÛŒ Ú©Ø§Ø±Øª Ù…Ø´ØªØ±ÛŒ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</div>
            <input type="text" id="searchAllAcc" class="input" placeholder="ğŸ” ..." oninput="filterAllAccounts()" style="margin-bottom: 0;">
        </div>

        <div id="allAccountsList" style="flex-grow: 1; overflow-y: auto; padding-right: 5px;"></div>

        <div style="margin-top:15px; text-align:left; border-top: 1px solid var(--gold-border); padding-top: 10px;">
            <button class="btn btn-red" onclick="closeModal('modalAllAcc')">
                <span data-i18n="btn_close">Ø¨Ø³ØªÙ† (Esc)</span>
            </button>
        </div>
    </div>
</div>
<div id="modalSettings" class="modal">
    <div class="modal-content">
        <div style="padding: 15px 25px; border-bottom: 1px solid var(--gold-border); display:flex; justify-content:space-between; align-items:center; background: var(--bg-sidebar);">
            <span style="font-size:18px; font-weight:900; color:var(--gold-primary)">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ… (System Settings)</span>
            <span class="close-icon" onclick="closeModal('modalSettings')" style="position:static; font-size:28px;">&times;</span>
        </div>

        <div class="settings-container">
            <div class="settings-sidebar">
                <div class="settings-menu-btn active" onclick="switchSettingsTab('tab-profile', this)">ğŸ¢ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØµØ±Ø§ÙÛŒ</div>
                <div class="settings-menu-btn" onclick="switchSettingsTab('tab-print', this)">ğŸ–¨ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Ø§Ù¾</div>
                
<div id="adminMenuSection" style="display:none; margin-top:20px; border-top:1px dashed var(--gold-border); padding-top:10px">
    <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px; padding-right:10px">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹ Ù…Ø¯ÛŒØ±ÛŒØª (Reports)</div>
    
    <div class="settings-menu-btn" onclick="closeModal('modalSettings'); go('analysis')">
        ğŸ“Š Ø¢Ù†Ø§Ù„ÛŒØ² Ø³Ø±Ù…Ø§ÛŒÙ‡ (F7)
    </div>
    <div class="settings-menu-btn" onclick="closeModal('modalSettings'); go('commissions')">
        ğŸ’° Ø­Ø³Ø§Ø¨ Ú©Ù…ÛŒØ´Ù†â€ŒÙ‡Ø§
    </div>
    <div class="settings-menu-btn" onclick="closeModal('modalSettings'); go('reports')">
        ğŸ“‘ Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ… Ùˆ Ú˜ÙˆØ±Ù†Ø§Ù„
    </div>
    <div class="settings-menu-btn" onclick="closeModal('modalSettings'); go('employees')">
        ğŸ‘” Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†
    </div>

    <div style="border-top:1px dashed var(--gold-border); margin:10px 0;"></div>
    
    <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px; padding-right:10px">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…ÛŒ</div>
    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-capital', this)">ğŸ¦ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡</div>
    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-currency', this)">ğŸ’µ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø²Ù‡Ø§</div>
    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-cities', this)">ğŸ™ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ù‡Ø±Ù‡Ø§</div>
    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-users', this)">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
    <div class="settings-menu-btn" style="color:var(--danger)" onclick="switchSettingsTab('tab-reset', this)">âš ï¸ Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</div>
</div>
                
                <div style="margin-top:auto">

    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-password', this)">ğŸ”’ ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</div>
</div>
            </div>

            <div class="settings-content-area">
                
                <div id="tab-profile" class="settings-tab active">
                    <div class="setting-card">
                        <div class="setting-header-large">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ Ù…Ø´Ø®ØµØ§Øª ØµØ±Ø§ÙÛŒ</div>
                        <p style="color:var(--text-muted); margin-bottom:20px; font-size:13px;">Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø³Ø±Ø¨Ø±Ú¯ ØªÙ…Ø§Ù… Ø±Ø³ÛŒØ¯Ù‡Ø§ Ùˆ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ú†Ø§Ù¾ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">Ù†Ø§Ù… ØµØ±Ø§ÙÛŒ (Ø¨Ø²Ø±Ú¯ Ø¯Ø± Ø³Ø±Ø¨Ø±Ú¯)</label>
                                <input id="setCompName" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØµØ±Ø§ÙÛŒ Ø¨Ø±Ø§Ø¯Ø±Ø§Ù†...">
                            </div>
                            <div>
                                <label class="label">Ø´Ø¹Ø§Ø± ØªØ¨Ù„ÛŒØºØ§ØªÛŒ (Ø²ÛŒØ± Ù†Ø§Ù…)</label>
                                <input id="setCompSlogan" class="input" placeholder="Ø³Ø±ÛŒØ¹ØŒ Ù…Ø·Ù…Ø¦Ù†...">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div>
                                <label class="label">Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ø³</label>
                                <input id="setCompPhone" class="input" placeholder="0799...">
                            </div>
                            <div>
                                <label class="label">Ø¢Ø¯Ø±Ø³ Ø¯ÙØªØ± Ù…Ø±Ú©Ø²ÛŒ</label>
                                <input id="setCompAddress" class="input" placeholder="Ù‡Ø±Ø§ØªØŒ Ú†ÙˆÚ© Ú¯Ù„Ù‡Ø§...">
                            </div>
                        </div>
                        <div>
                            <label class="label">Ù¾ÛŒØ§Ù… ØªØ´Ú©Ø± (Ù¾Ø§ÙˆØ±Ù‚ÛŒ ÙØ§Ú©ØªÙˆØ±)</label>
                            <input id="setCompFooter" class="input" placeholder="Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ…">
                        </div>
                        <div style="margin-top:15px; border-top:1px dashed var(--gold-border); padding-top:15px;">
    <label class="label">Ù„ÙˆÚ¯ÙˆÛŒ ØµØ±Ø§ÙÛŒ (Ø¬Ù‡Øª Ú†Ø§Ù¾ Ø¯Ø± Ø±Ø³ÛŒØ¯)</label>
    <input type="file" id="logoUploader" accept="image/*" class="input" onchange="saveLogo()">
    <img id="logoPreview" style="max-height:60px; display:none; margin-top:5px; border:1px solid #ccc;">
    <button class="btn btn-red btn-sm" onclick="clearLogo()" style="margin-top:5px">Ø­Ø°Ù Ù„ÙˆÚ¯Ùˆ</button>
</div>

<button class="btn btn-gold" style="width:100%; padding:15px; margin-top:15px" onclick="saveCompanyProfile()">
    Ø«Ø¨Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø´Ø®ØµØ§Øª (Save)
</button>
                    </div>
                </div>

                <div id="tab-print" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Ø§Ù¾ (Print Options)</div>
                        
                        <div style="display:flex; align-items:center; gap:15px; background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; border:1px solid var(--gold-border)">
                            <input type="checkbox" id="printHeaderOpt" style="width:25px; height:25px; cursor:pointer" onchange="togglePrintHeaderSetting()">
                            <div>
                                <label for="printHeaderOpt" style="font-size:16px; font-weight:bold; cursor:pointer; color:var(--text-main)">Ù†Ù…Ø§ÛŒØ´ Â«Ø³Ø±Ø¨Ø±Ú¯ Ø´Ø±Ú©ØªÂ» Ø¯Ø± Ú†Ø§Ù¾â€ŒÙ‡Ø§</label>
                                <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ù†Ø§Ù… Ùˆ Ù„ÙˆÚ¯ÙˆÛŒ ØµØ±Ø§ÙÛŒ Ø´Ù…Ø§ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ØªÙ…Ø§Ù… Ø±Ø³ÛŒØ¯Ù‡Ø§ Ú†Ø§Ù¾ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§Ú¯Ø± Ø§Ø² Ú©Ø§ØºØ° Ø³Ø±Ø¨Ø±Ú¯â€ŒØ¯Ø§Ø± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŒ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ú©Ù†ÛŒØ¯.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-capital" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ (Initial Capital)</div>
                        <p style="color:var(--text-muted); margin-bottom:20px;">Ø§ÛŒÙ† Ù…Ø¨Ø§Ù„Øº ÙÙ‚Ø· Ø¬Ù‡Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ø¶Ø§ÙÙ‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                        <div id="initialCapitalInputs"></div>
                        <button class="btn btn-blue" style="width:100%; margin-top:15px" onclick="setInitialCapital()">
                            Ø«Ø¨Øª Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡
                        </button>
                    </div>
                </div>

                <div id="tab-currency" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø²Ù‡Ø§</div>
                        <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; margin-bottom:20px">
                            <label class="label" style="color:var(--success)">Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø±Ø² Ø¬Ø¯ÛŒØ¯</label>
                            <div style="display:flex; gap:10px">
                                <input id="newCurrCode" class="input" placeholder="Code (e.g. TOMAN)" style="margin-bottom:0">
                                <button class="btn btn-green" onclick="addCurrency()">Ø§ÙØ²ÙˆØ¯Ù†</button>
                            </div>
                        </div>
                        <div style="background:rgba(255,0,0,0.1); padding:20px; border-radius:12px;">
                            <label class="label" style="color:var(--danger)">Ø­Ø°Ù Ø§Ø±Ø²</label>
                            <div style="display:flex; gap:10px">
                                <select id="currToDelete" class="input" style="margin-bottom:0"></select>
                                <button class="btn btn-red" onclick="deleteCurrency()">Ø­Ø°Ù</button>
                            </div>
                        </div>
                    </div>
                </div>
<div id="tab-cities" class="settings-tab">
    <div class="setting-card">
        <div class="setting-header-large">Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ù‡Ø±Ù‡Ø§ Ùˆ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</div>
        
        <div class="city-detail-group">
            <input type="hidden" id="editCityOldCode"> <div class="grid-2">
                <div>
                    <label class="label">Ù†Ø§Ù… Ø´Ù‡Ø±</label>
                    <input id="newCityName" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø²Ø§Ø±Ø´Ø±ÛŒÙ">
                </div>
                <div>
                    <label class="label">Ú©Ø¯ Ø´Ù‡Ø± (Ù…Ø®ÙÙ)</label>
                    <input id="newCityCode" class="input" placeholder="MZR" style="text-transform:uppercase">
                </div>
            </div>
            <div class="grid-2">
                <div>
                    <label class="label" style="color:var(--gold-primary)">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ / ØµØ±Ø§ÙÛŒ Ù‡Ù…Ú©Ø§Ø±</label>
                    <input id="newCityRep" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØµØ±Ø§ÙÛŒ ØµØ¯Ø§Ù‚Øª (Ø­Ø§Ø¬ÛŒ Ø§Ø­Ù…Ø¯)">
                </div>
                <div>
                    <label class="label" style="color:var(--gold-primary)">Ø¢Ø¯Ø±Ø³ / ØªÙ„ÙÙ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ (Ø¬Ù‡Øª Ú†Ø§Ù¾ Ø¯Ø± Ø±Ø³ÛŒØ¯)</label>
                    <input id="newCityContact" class="input" placeholder="Ù…Ø§Ø±Ú©Øª... / 0799...">
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button id="btnSaveCity" class="btn btn-gold" style="flex:1" onclick="saveCityProcess()">
                    Ø«Ø¨Øª Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯
                </button>
                <button id="btnCancelEditCity" class="btn btn-outline" style="display:none;" onclick="cancelCityEdit()">
                    Ø§Ù†ØµØ±Ø§Ù
                </button>
            </div>
        </div>

        <div style="margin-top:20px; border-top:1px dashed var(--gold-border); padding-top:15px;">
            <label class="label">Ù„ÛŒØ³Øª Ø´Ù‡Ø±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„</label>
            <div id="cityListContainer" style="max-height:300px; overflow-y:auto; background:rgba(0,0,0,0.1); border-radius:8px;">
                </div>
        </div>

        <div style="margin-top:30px; background:rgba(255,0,0,0.05); padding:15px; border-radius:10px; border:1px solid rgba(255,0,0,0.2)">
             <label class="label" style="color:var(--danger)">Ø­Ø°Ù Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø´Ù‡Ø± (Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø­ÙˆØ§Ù„Ù‡ Ø¯Ø§Ø±Ø¯)</label>
             <div style="display:flex; gap:10px;">
                 <div style="flex:1">
                     <select id="cityToDelete" class="input" onchange="checkCityForDelete()"></select>
                     <div id="transferCitySection" style="display:none; margin-top:5px">
                         <label class="label" style="color:var(--danger)">Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡:</label>
                         <select id="cityTransferTarget" class="input"></select>
                     </div>
                 </div>
                 <button class="btn btn-red" onclick="deleteCityProcess()" style="height:45px">Ø­Ø°Ù Ø´Ù‡Ø±</button>
             </div>
        </div>

    </div>
</div>

                <div id="tab-users" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ…</div>
                        <div class="grid-2" style="gap:10px">
                            <input id="newUName" class="input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Username)">
                            <input id="newUPass" class="input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Password)">
                        </div>
                        <label class="label">Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:</label>
                        <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px">
                            <label><input type="checkbox" id="perm_hawala" checked> Ø­ÙˆØ§Ù„Ù‡</label>
                            <label><input type="checkbox" id="perm_exchange" checked> ØµØ±Ø§ÙÛŒ</label>
                            <label><input type="checkbox" id="perm_accounts"> Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</label>
                            <label><input type="checkbox" id="perm_tt"> TT</label>
                            <label><input type="checkbox" id="perm_admin" onchange="toggleAdminAccess(this)"> <span style="color:var(--gold-primary); font-weight:bold">Ù…Ø¯ÛŒØ± Ú©Ù„</span></label>
<label><input type="checkbox" id="perm_group_b"> <span style="color:#ff5252; font-weight:bold;">Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ B</span></label>
                        </div>
                        <button class="btn btn-green" style="width:100%" onclick="addUser()">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</button>
                        
                        <div style="margin-top:20px">
                            <label class="label">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</label>
                            <div id="userListManage"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-reset" class="settings-tab">
                    <div class="setting-card" style="border-color:var(--danger)">
                        <div class="setting-header-large" style="color:var(--danger); border-color:var(--danger)">Ø±ÛŒØ³Øª ÙÚ©ØªÙˆØ±ÛŒ (Factory Reset)</div>
                        <p style="color:var(--danger); font-weight:bold; margin-bottom:20px">
                            Ù‡Ø´Ø¯Ø§Ø±: Ø¨Ø§ Ø²Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ±ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ØŒ Ø­ÙˆØ§Ù„Ù‡â€ŒÙ‡Ø§ØŒ Ù…Ø´ØªØ±ÛŒØ§Ù† Ùˆ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.
                        </p>
                        <button class="btn btn-red" style="width:100%; padding:20px; font-size:16px" onclick="resetData()">
                            âš ï¸ Ø­Ø°Ù ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡
                        </button>
                    </div>
                </div>

                <div id="tab-password" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ù†</div>
                        <input type="password" id="myNewPass" class="input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯...">
                        <button class="btn btn-blue" style="width:100%" onclick="changeMyPass()">
                            ØªØºÛŒÛŒØ± Ø±Ù…Ø²
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="employees" class="page admin-only-view">
    <div class="card">
        <div class="card-header">
            <span>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ùˆ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯ (HRM)</span>
            <div style="display:flex; gap:10px">
                <button class="btn btn-gold" onclick="applyMonthlySalaries()">ğŸ’° ÙˆØ§Ø±ÛŒØ² Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø¯Ø³ØªÛŒ)</button>
                <button class="btn btn-green" onclick="openModal('modalNewEmp')">â• Ø§Ø³ØªØ®Ø¯Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</button>
            </div>
        </div>
        
        <div class="stat-box" style="margin-bottom:15px; text-align:right; background:rgba(212,175,55,0.05); border:1px dashed var(--gold-border)">
            <span style="font-size:12px; color:var(--text-muted)">* Ø¬Ù‡Øª ÙˆØ§Ø±ÛŒØ² Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† Ù…Ø§Ù‡ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "ÙˆØ§Ø±ÛŒØ² Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯. Ø³ÛŒØ³ØªÙ… Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø­Ù‚ÙˆÙ‚ ØªÚ©Ø±Ø§Ø±ÛŒ ÙˆØ§Ø±ÛŒØ² Ù†Ø´ÙˆØ¯.</span>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                        <th>Ø³Ù…Øª / ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</th>
                        <th>Ø­Ù‚ÙˆÙ‚ Ù¾Ø§ÛŒÙ‡ (Ù…Ø§Ù‡Ø§Ù†Ù‡)</th>
                        <th>ÙˆØ¶Ø¹ÛŒØª Ø­Ø³Ø§Ø¨ (Ù…Ø§Ù†Ø¯Ù‡)</th>
                        <th style="min-width: 280px;">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody id="employeeBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalNewEmp" class="modal">
    <div class="modal-content" style="max-width:400px; border: 2px solid var(--gold-primary);">
        <span class="close-icon" onclick="closeModal('modalNewEmp')">&times;</span>
        <div class="card-header">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</div>
        
        <label class="label">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
        <input id="empName" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ø­Ù…Ø¯ Ø±Ø¶Ø§ÛŒÛŒ">
        
        <label class="label">Ø³Ù…Øª / Ø´ØºÙ„</label>
        <input id="empJob" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±">
        
        <label class="label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± (Ø¬Ù‡Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚)</label>
        <input type="date" id="empJoinDate" class="input">
        
        <div class="grid-2">
            <div>
                <label class="label">Ù…Ø¨Ù„Øº Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡</label>
                <input type="number" id="empSalary" class="input" placeholder="0">
            </div>
            <div>
                <label class="label">Ø§Ø±Ø² Ø­Ù‚ÙˆÙ‚</label>
                <select id="empCurr" class="input"></select>
            </div>
        </div>

        <button class="btn btn-green" style="width:100%" onclick="saveNewEmployee()">
            Ø«Ø¨Øª Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… (F10)
        </button>
    </div>
</div>

<div id="modalEmpLedger" class="modal">
    <div class="modal-content" style="max-width:900px; height:90vh; display:flex; flex-direction:column;">
        <span class="close-icon" onclick="closeModal('modalEmpLedger')">&times;</span>
        <div class="card-header" style="justify-content:flex-start; gap:15px;">
            <span>ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨: <span id="ledgerEmpName" style="color:var(--gold-primary)"></span></span>
            <span id="ledgerEmpJob" style="font-size:12px; opacity:0.7; font-weight:normal"></span>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(212,175,55,0.1); padding:15px; border-radius:12px; border:1px solid var(--gold-primary); margin-bottom:15px;">
            <div>
                <div style="font-size:12px; color:var(--text-muted)">Ù…Ø§Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø­Ø³Ø§Ø¨ (Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª):</div>
                <div id="ledgerEmpBalance" style="font-size:24px; font-weight:900; direction:ltr; margin-top:5px;">0</div>
            </div>
            <button class="btn btn-blue" onclick="paySalaryFromLedger()">
                ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (Ø¨Ø±Ø¯Ø§Ø´Øª)
            </button>
        </div>
        
        <div class="table-container" style="flex:1; overflow-y:auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width:15%">ØªØ§Ø±ÛŒØ®</th>
                        <th style="width:35%">Ø´Ø±Ø­ Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        <th style="width:15%; color:var(--danger)">Ø¨Ø±Ø¯Ø§Ø´Øª (Ù†Ù‚Ø¯)</th>
                        <th style="width:15%; color:var(--success)">Ø­Ù‚ÙˆÙ‚ (Ø·Ù„Ø¨)</th>
                        <th style="width:15%">Ù…Ø§Ù†Ø¯Ù‡ (Balance)</th>
                        <th style="width:5%">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="empLedgerBody"></tbody>
            </table>
        </div>
        <div style="margin-top:10px; text-align:left; display:flex; gap:10px;">
            <button class="btn btn-outline" onclick="printEmpLedgerCurrent()">ğŸ–¨ Ú†Ø§Ù¾ ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨ (Statement)</button>
            <button class="btn btn-red" onclick="closeModal('modalEmpLedger')">Ø¨Ø³ØªÙ†</button>
        </div>
        <input type="hidden" id="currentEmpId">
    </div>
</div>
<script>
function numberToPersianWords(number) {
    const units = ['', 'ÛŒÚ©', 'Ø¯Ùˆ', 'Ø³Ù‡', 'Ú†Ù‡Ø§Ø±', 'Ù¾Ù†Ø¬', 'Ø´Ø´', 'Ù‡ÙØª', 'Ù‡Ø´Øª', 'Ù†Ù‡'];
    const teens = ['Ø¯Ù‡', 'ÛŒØ§Ø²Ø¯Ù‡', 'Ø¯ÙˆØ§Ø²Ø¯Ù‡', 'Ø³ÛŒØ²Ø¯Ù‡', 'Ú†Ù‡Ø§Ø±Ø¯Ù‡', 'Ù¾Ø§Ù†Ø²Ø¯Ù‡', 'Ø´Ø§Ù†Ø²Ø¯Ù‡', 'Ù‡ÙØ¯Ù‡', 'Ù‡Ø¬Ø¯Ù‡', 'Ù†ÙˆØ²Ø¯Ù‡'];
    const tens = ['', '', 'Ø¨ÛŒØ³Øª', 'Ø³ÛŒ', 'Ú†Ù‡Ù„', 'Ù¾Ù†Ø¬Ø§Ù‡', 'Ø´ØµØª', 'Ù‡ÙØªØ§Ø¯', 'Ù‡Ø´ØªØ§Ø¯', 'Ù†ÙˆØ¯'];
    const hundreds = ['', 'ÛŒÚ©ØµØ¯', 'Ø¯ÙˆÛŒØ³Øª', 'Ø³ÛŒØµØ¯', 'Ú†Ù‡Ø§Ø±ØµØ¯', 'Ù¾Ø§Ù†ØµØ¯', 'Ø´Ø´ØµØ¯', 'Ù‡ÙØªØµØ¯', 'Ù‡Ø´ØªØµØ¯', 'Ù†Ù‡ØµØ¯'];
    if (number === 0) return 'ØµÙØ±';
    const str = number.toString();
    function convertGroup(n) {
        let res = '';
        const h = Math.floor(n / 100);
        const t = n % 100;
        if (h > 0) {
            res += hundreds[h];
            if (t > 0) res += ' Ùˆ ';
        }
        if (t > 0) {
            if (t < 10) res += units[t];
            else if (t < 20) res += teens[t - 10];
            else {
                res += tens[Math.floor(t / 10)];
                if (t % 10 > 0) res += ' Ùˆ ' + units[t % 10];
            }
        }
        return res;
    }
    const parts = [];
    let n = Math.floor(number);
    const scales = ['', ' Ù‡Ø²Ø§Ø±', ' Ù…ÛŒÙ„ÛŒÙˆÙ†', ' Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯', ' ØªØ±ÛŒÙ„ÛŒÙˆÙ†'];
    let scaleIndex = 0;
    while(n > 0) {
        let chunk = n % 1000;
        if(chunk > 0) {
            let chunkStr = convertGroup(chunk);
            parts.push(chunkStr + scales[scaleIndex]);
        }
        n = Math.floor(n / 1000);
        scaleIndex++;
    }
    return parts.reverse().join(' Ùˆ ').trim();
}

function numberToEnglishWords(n) {
    if (n < 0) return "Minus " + numberToEnglishWords(-n);
    if (n === 0) return "Zero";
    const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
    const scales = ["", "Thousand", "Million", "Billion", "Trillion"];
    let result = "";
    let scaleIndex = 0;
    function convertChunk(num) {
        let chunkStr = "";
        if (num >= 100) {
            chunkStr += units[Math.floor(num / 100)] + " Hundred ";
            num %= 100;
        }
        if (num >= 20) {
            chunkStr += tens[Math.floor(num / 10)] + " ";
            num %= 10;
        }
        if (num > 0) {
            chunkStr += units[num] + " ";
        }
        return chunkStr;
    }
    while (n > 0) {
        let chunk = n % 1000;
        if (chunk > 0) {
            let str = convertChunk(chunk).trim();
            result = str + (scales[scaleIndex] ? " " + scales[scaleIndex] : "") + " " + result;
        }
        n = Math.floor(n / 1000);
        scaleIndex++;
    }
    return result.trim();
}

function updateTTAutoWords() {
    const amt = parseInt(document.getElementById('ttAmt').value);
    if (!isNaN(amt)) document.getElementById('ttAmtWords').value = numberToEnglishWords(amt);
    else document.getElementById('ttAmtWords').value = '';
}
const TRANSLATIONS = {
    fa: {
        dir: 'rtl',
        app_title: "ØµØ±Ø§ÙÛŒ Ù‡Ø±Ø§ØªÛŒâ€ŒÙ‡Ø§",
        company_subtitle: "Ø´Ø±Ú©Øª ØµØ±Ø§ÙÛŒ Ùˆ Ø®Ø¯Ù…Ø§Øª Ù¾ÙˆÙ„ÛŒ Ù‡Ø±Ø§ØªÛŒÙ‡Ø§",
        login_btn: "ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… (Enter)",
        login_error: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª",
        loading_db: "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§Ù…Ù†ÛŒØªÛŒ...",
        nav_dashboard: "ğŸ“Š Ù†Ù…Ø§ Ù…Ø±Ú©Ø²ÛŒ Ø­Ø³Ø§Ø¨   (F1)",
        nav_hawala: "âœˆï¸ Ø­ÙˆØ§Ù„Ù‡â€ŒØ¬Ø§Øª (F2)",
        nav_accounts: "ğŸ‘¥ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù† (F3)",
        nav_tt: "ğŸŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø±Ø² (TT) (F6)",
        nav_exchange: "ğŸ’± Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ (FX) (F4)",
        nav_crypto: "ğŸª™ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ (Crypto)",
        nav_reports: "ğŸ“‘ Ú¯Ø²Ø§Ø±Ø´Ø§Øª (Logs)",
        nav_settings: "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª",
        nav_logout: "ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ù…Ù†",
        lbl_initial_capital: "Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø«Ø¨Øª Ø´Ø¯Ù‡",
        lbl_profit_loss: "Ø³ÙˆØ¯ / Ø²ÛŒØ§Ù† (FX & Crypto)",
        lbl_cash_balance: "Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ ØµÙ†Ø¯ÙˆÙ‚ (Ø®Ø²Ø§Ù†Ù‡)",
        lbl_crypto_assets: "Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ (Crypto Assets)",
        lbl_city_balance: "Ø¨Ø§Ù„Ø§Ù†Ø³ Ú©ØªØ§Ø¨ Ø´Ù‡Ø±Ù‡Ø§ (Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒ/Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†)",
        btn_refresh: "ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ",
        msg_city_balance_hint: "* Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø«Ø¨Øª (Ø³Ø¨Ø²): Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¨Ù‡ Ù…Ø§ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø§Ø³Øª. Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ù†ÙÛŒ (Ù‚Ø±Ù…Ø²): Ù…Ø§ Ø¨Ù‡ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒÙ….",
        lbl_total_commissions: "Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø­ÙˆØ§Ù„Ù‡ (Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ)",
        header_hawala_manage: "Ù…Ø¯ÛŒØ±ÛŒØª Ø­ÙˆØ§Ù„Ù‡â€ŒØ¬Ø§Øª",
        btn_new_hawala: "â• Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ (F9)",
        lbl_filter_city: "ÙÛŒÙ„ØªØ± Ø´Ù‡Ø±",
        lbl_type: "Ù†ÙˆØ¹",
        opt_all: "Ù‡Ù…Ù‡",
        opt_outgoing: "Ø§Ø±Ø³Ø§Ù„ÛŒ (Out)",
        opt_incoming: "Ø¯Ø±ÛŒØ§ÙØªÛŒ (In)",
        lbl_status: "ÙˆØ¶Ø¹ÛŒØª",
        opt_pending: "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¬Ø±Ø§",
        opt_done: "Ø§Ø¬Ø±Ø§/ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡",
        btn_excel: "ğŸ“Š Ø§Ú©Ø³Ù„ Ø¹Ø§Ù„ÛŒ",
        btn_print_book: "ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª Ú©ØªØ§Ø¨",
        th_hawala_no: "Ù†Ù…Ø¨Ø± Ø­ÙˆØ§Ù„Ù‡",
        th_type: "Ù†ÙˆØ¹",
        th_city_book: "Ø´Ù‡Ø± / Ú©ØªØ§Ø¨",
        th_amount: "Ù…Ø¨Ù„Øº",
        th_commission: "Ú©Ù…ÛŒØ´Ù†",
        th_reg_date: "ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª",
        th_exec_date: "ØªØ§Ø±ÛŒØ® Ø§Ø¬Ø±Ø§",
        th_status: "ÙˆØ¶Ø¹ÛŒØª",
        th_ops: "Ø¹Ù…Ù„ÛŒØ§Øª",
        header_accounts_manage: "Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù†",
        lbl_search_customer: "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ",
        btn_new_customer: "â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ (F9)",
        btn_deposit_withdraw: "ğŸ’° ÙˆØ§Ø±ÛŒØ²/Ø¨Ø±Ø¯Ø§Ø´Øª",
        btn_transfer: "ğŸ”„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø­Ø³Ø§Ø¨",
        btn_all_accounts: "ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§",
        lbl_statement: "ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨:",
        btn_edit: "âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´",
        btn_delete: "ğŸ—‘ Ø­Ø°Ù",
        btn_print: "ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª",
        th_date: "ØªØ§Ø±ÛŒØ®",
        th_desc: "Ø´Ø±Ø­",
        th_currency: "Ø§Ø±Ø²",
        th_debit: "Ø¨Ø¯Ù‡Ú©Ø§Ø±",
        th_credit: "Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±",
        th_balance: "Ù…Ø§Ù†Ø¯Ù‡ (ØªØ´Ø®ÛŒØµ)",
        header_tt_app: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­ÙˆØ§Ù„Ù‡ Ø§Ø±Ø²ÛŒ (TT Application)",
        opt_internal_cust: "Ù…Ø´ØªØ±ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±)",
        opt_external_cust: "Ù…Ø´ØªØ±ÛŒ Ø®Ø§Ø±Ø¬ÛŒ (Ù†Ù‚Ø¯ÛŒ)",
        lbl_select_account: "Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ (Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø­Ø³Ø§Ø¨)",
        lbl_payer_name: "Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ)",
        lbl_phone: "ØªÙ„ÙÙ† ØªÙ…Ø§Ø³",
        lbl_amount: "Ù…Ø¨Ù„Øº",
        header_beneficiary: "Ù…Ø´Ø®ØµØ§Øª Ø°ÛŒÙ†ÙØ¹ (Beneficiary)",
        lbl_ben_name: "Ù†Ø§Ù… Ø°ÛŒÙ†ÙØ¹ (ÙØ§Ø±Ø³ÛŒ)",
        lbl_desc: "ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ",
        btn_submit_tt: "Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ùˆ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¬Ù‡ (F10)",
        btn_print_form: "ğŸ–¨ Ú†Ø§Ù¾ ÙØ±Ù… Ø±Ø³Ù…ÛŒ",
        header_crypto_deal: "Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ (Crypto)",
        btn_print_receipt: "ğŸ–¨ Ú†Ø§Ù¾ Ø±Ø³ÛŒØ¯",
        lbl_select_customer: "Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ",
        lbl_deal_type: "Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡",
        opt_buy: "Ø®Ø±ÛŒØ¯ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÙˆÙ„)",
        opt_sell: "ÙØ±ÙˆØ´ (Ø¯Ø±ÛŒØ§ÙØª Ù¾ÙˆÙ„)",
        lbl_crypto_name: "Ù†Ø§Ù… Ø§Ø±Ø² (USDT)",
        lbl_volume: "Ù…Ù‚Ø¯Ø§Ø± (Volume)",
        lbl_payment_curr: "Ù†ÙˆØ¹ Ø§Ø±Ø² Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ/Ø¯Ø±ÛŒØ§ÙØªÛŒ",
        lbl_total_fiat: "Ù…Ø¨Ù„Øº Ú©Ù„ (Total Fiat)",
        lbl_cost_basis: "Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´): Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ú†Ù‚Ø¯Ø± Ø¨ÙˆØ¯Ù‡ØŸ",
        btn_submit_deal: "Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ (F10)",
        header_fx_deal: "Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø§Ø±Ø²ÛŒ (FX Deal Ticket)",
        btn_fx_buy: "Ø®Ø±ÛŒØ¯ (BUY)",
        btn_fx_sell: "ÙØ±ÙˆØ´ (SELL)",
        lbl_rate: "Rate:",
        lbl_total: "Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ (Total)",
        lbl_cash_balance_after: "ØªØ±Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚ Ù¾Ø³ Ø§Ø² Ø§Ù†Ø¬Ø§Ù…",
        lbl_desc_opt: "ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
        lbl_cost_basis_fx: "Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (Cost Basis)",
        header_backup: "Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ (Backup)",
        btn_download_backup: "â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾ Ú©Ø§Ù…Ù„",
        btn_restore_backup: "â¬†ï¸ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©â€ŒØ¢Ù¾ (Restore)",
        header_journal: "Ø¯ÙØªØ± Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ (Log) - Ø§Ù…Ú©Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´Øª ØªØ±Ø§Ú©Ù†Ø´",
        btn_print_log: "ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª Ø±Ø³Ù…ÛŒ Ú¯Ø²Ø§Ø±Ø´",
        th_time: "Ø²Ù…Ø§Ù†",
        th_section: "Ø¨Ø®Ø´",
        th_user: "Ú©Ø§Ø±Ø¨Ø±",
        modal_new_hawala: "Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯",
        lbl_operation_type: "Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª",
        opt_outgoing_full: "Ø§Ø±Ø³Ø§Ù„ (Ø¨Ù‡ Ø´Ù‡Ø± Ø¯ÛŒÚ¯Ø±)",
        opt_incoming_full: "Ø¯Ø±ÛŒØ§ÙØª (Ø§Ø² Ø´Ù‡Ø± Ø¯ÛŒÚ¯Ø±)",
        lbl_city_book: "Ú©ØªØ§Ø¨ Ø´Ù‡Ø± (Ø·Ø±Ù Ø­Ø³Ø§Ø¨)",
        lbl_currency: "Ø§Ø±Ø²",
        lbl_commission: "Ú©Ù…ÛŒØ´Ù† (Ø¯Ø³ØªÛŒ)",
        lbl_sender: "Ù†Ø§Ù… ÙØ±Ø³ØªÙ†Ø¯Ù‡",
        lbl_receiver: "Ù†Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡",
        lbl_id_card: "Ø´Ù…Ø§Ø±Ù‡ ØªØ°Ú©Ø±Ù‡/Ù¾Ø§Ø³Ù¾ÙˆØ±Øª",
        btn_cancel: "Ø§Ù†ØµØ±Ø§Ù (Esc)",
        btn_issue_hawala: "ØµØ¯ÙˆØ± Ùˆ Ø«Ø¨Øª (F10)",
        modal_edit_hawala: "ÙˆÛŒØ±Ø§ÛŒØ´ Ø­ÙˆØ§Ù„Ù‡",
        msg_security_warning: "ØªÙˆØ¬Ù‡: Ø¬Ù‡Øª Ø§Ù…Ù†ÛŒØª ØµÙ†Ø¯ÙˆÙ‚ØŒ Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ± Ù…Ø¨Ù„Øº ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø¨Ø±Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ Ù…Ø¨Ù„ØºØŒ Ø­ÙˆØ§Ù„Ù‡ Ø±Ø§ Ø­Ø°Ù Ùˆ Ù…Ø¬Ø¯Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.",
        lbl_amount_fixed: "Ù…Ø¨Ù„Øº (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)",
        lbl_currency_fixed: "Ø§Ø±Ø² (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)",
        btn_save_edit: "Ø«Ø¨Øª ÙˆÛŒØ±Ø§ÛŒØ´ (F10)",
        modal_tx_header: "Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ",
        lbl_account_party: "Ø·Ø±Ù Ø­Ø³Ø§Ø¨",
        opt_deposit: "ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø­Ø³Ø§Ø¨ (Ø¯Ø±ÛŒØ§ÙØª Ù¾ÙˆÙ„)",
        opt_withdraw: "Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø­Ø³Ø§Ø¨ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÙˆÙ„)",
        btn_submit_tx: "Ø«Ø¨Øª Ø³Ù†Ø¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… (F10)",
        btn_close: "Ø¨Ø³ØªÙ† (Esc)",
        modal_transfer_header: "Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§",
        lbl_source_account: "Ù…Ø¨Ø¯Ø§ (Ú©Ø³Ø± Ø§Ø² Ø­Ø³Ø§Ø¨):",
        lbl_dest_account: "Ù…Ù‚ØµØ¯ (ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø­Ø³Ø§Ø¨)",
        lbl_transfer_amount: "Ù…Ø¨Ù„Øº Ø§Ù†ØªÙ‚Ø§Ù„",
        btn_do_transfer: "Ø§Ù†Ø¬Ø§Ù… Ø§Ù†ØªÙ‚Ø§Ù„ (F10)",
        modal_new_cust: "Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯",
        lbl_cust_name: "Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ù…Ø´ØªØ±ÛŒ",
        btn_add_list: "Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª (F10)",
        modal_edit_cust: "ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´Ø®ØµØ§Øª Ù…Ø´ØªØ±ÛŒ",
        msg_edit_name_warning: "ØªÙˆØ¬Ù‡: ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¨Ø§Ø¹Ø« ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¯Ø± ØªÙ…Ø§Ù… Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù‚Ø¨Ù„ÛŒ Ù†ÛŒØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
        lbl_new_name: "Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯",
        lbl_new_phone: "ØªÙ„ÙÙ† Ø¬Ø¯ÛŒØ¯",
        btn_save_changes: "Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª (F10)",
        modal_all_acc_status: "ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†",
        msg_click_to_view: "* Ø¬Ù‡Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÛŒØ²Ø­Ø³Ø§Ø¨ØŒ Ø±ÙˆÛŒ Ú©Ø§Ø±Øª Ù…Ø´ØªØ±ÛŒ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.",
        header_settings: "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…",
        lbl_print_settings: "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Ø§Ù¾",
        lbl_print_header_opt: "Ù†Ù…Ø§ÛŒØ´ Â«Ù†Ø§Ù… Ø´Ø±Ú©ØªÂ» Ø¯Ø± Ø³Ø±Ø¨Ø±Ú¯ ØªÙ…Ø§Ù… Ú†Ø§Ù¾â€ŒÙ‡Ø§",
        lbl_initial_capital_set: "Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ (Ø¬Ù‡Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†)",
        btn_save_capital: "Ø«Ø¨Øª Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡",
        lbl_user_mgmt: "Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†",
        lbl_permissions: "Ø³Ø·ÙˆØ­ Ø¯Ø³ØªØ±Ø³ÛŒ:",
        perm_hawala: "Ø­ÙˆØ§Ù„Ù‡â€ŒØ¬Ø§Øª",
        perm_exchange: "Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´",
        perm_accounts: "Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù†",
        perm_tt: "Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø±Ø² (TT)",
        perm_admin: "Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ (Ù…Ø¯ÛŒØ±)",
        btn_add_user: "Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±",
        lbl_add_city: "Ø§ÙØ²ÙˆØ¯Ù† Ø´Ù‡Ø± (Ú©ØªØ§Ø¨ Ø­ÙˆØ§Ù„Ù‡)",
        btn_add: "Ø§ÙØ²ÙˆØ¯Ù†",
        lbl_delete_city: "Ø­Ø°Ù Ø´Ù‡Ø± (Delete City)",
        msg_city_has_data: "ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø´Ù‡Ø± Ø¯Ø§Ø±Ø§ÛŒ Ø­ÙˆØ§Ù„Ù‡ Ø§Ø³Øª. Ù…Ù‚ØµØ¯ Ø§Ù†ØªÙ‚Ø§Ù„:",
        btn_delete_city: "Ø­Ø°Ù Ø´Ù‡Ø±",
        lbl_currency_mgmt: "Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø²Ù‡Ø§ (Ø§ÙØ²ÙˆØ¯Ù† Ùˆ Ø­Ø°Ù)",
        lbl_reset_app: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ø­Ø°Ù ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù…Ø´ØªØ±ÛŒØ§Ù†)",
        btn_full_reset: "Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡",
        lbl_change_pass: "ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ù†",
        btn_change_pass: "ØªØºÛŒÛŒØ± Ø±Ù…Ø²"
    },
    en: {
        dir: 'ltr',
        app_title: "Heratiha Exchange",
        company_subtitle: "Money Exchange & Services Co.",
        login_btn: "Login (Enter)",
        login_error: "Invalid Credentials",
        loading_db: "Loading Secure Database...",
        nav_dashboard: "ğŸ“Š Dashboard (F1)",
        nav_hawala: "âœˆï¸ Hawala (F2)",
        nav_accounts: "ğŸ‘¥ Accounts (F3)",
        nav_tt: "ğŸŒ TT Transfer (F6)",
        nav_exchange: "ğŸ’± Exchange (FX) (F4)",
        nav_crypto: "ğŸª™ Crypto Assets",
        nav_reports: "ğŸ“‘ Reports (Logs)",
        nav_settings: "âš™ï¸ Settings",
        nav_logout: "ğŸšª Secure Logout",
        lbl_initial_capital: "Initial Capital Registered",
        lbl_profit_loss: "Profit / Loss (FX & Crypto)",
        lbl_cash_balance: "Physical Cash Balance (Vault)",
        lbl_crypto_assets: "Digital Assets (Crypto)",
        lbl_city_balance: "City Ledgers Balance (Agents)",
        btn_refresh: "ğŸ”„ Refresh",
        msg_city_balance_hint: "* Positive (Green): Agent owes us. Negative (Red): We owe agent.",
        lbl_total_commissions: "Total Hawala Commissions (Net Profit)",
        header_hawala_manage: "Hawala Management",
        btn_new_hawala: "â• New Hawala (F9)",
        lbl_filter_city: "Filter City",
        lbl_type: "Type",
        opt_all: "All",
        opt_outgoing: "Outgoing",
        opt_incoming: "Incoming",
        lbl_status: "Status",
        opt_pending: "Pending",
        opt_done: "Done/Settled",
        btn_excel: "ğŸ“Š Export Excel",
        btn_print_book: "ğŸ–¨ Print Book",
        th_hawala_no: "Hawala No",
        th_type: "Type",
        th_city_book: "City/Book",
        th_amount: "Amount",
        th_commission: "Comm",
        th_reg_date: "Date",
        th_exec_date: "Exec Date",
        th_status: "Status",
        th_ops: "Actions",
        header_accounts_manage: "Customer Accounts",
        lbl_search_customer: "Search Customer",
        btn_new_customer: "â• New Customer (F9)",
        btn_deposit_withdraw: "ğŸ’° Dep/Withdraw",
        btn_transfer: "ğŸ”„ Transfer",
        btn_all_accounts: "ğŸ“‹ All Balances",
        lbl_statement: "Statement:",
        btn_edit: "âœï¸ Edit",
        btn_delete: "ğŸ—‘ Delete",
        btn_print: "ğŸ–¨ Print",
        th_date: "Date",
        th_desc: "Description",
        th_currency: "Curr",
        th_debit: "Debit",
        th_credit: "Credit",
        th_balance: "Balance",
        header_tt_app: "TT Application Form",
        opt_internal_cust: "Internal Customer (Account)",
        opt_external_cust: "Walk-in Customer (Cash)",
        lbl_select_account: "Select Account (Debit)",
        lbl_payer_name: "Payer Name (Cash)",
        lbl_phone: "Phone Number",
        lbl_amount: "Amount",
        header_beneficiary: "Beneficiary Details",
        lbl_ben_name: "Beneficiary Name",
        lbl_desc: "Additional Description",
        btn_submit_tt: "Submit Application (F10)",
        btn_print_form: "ğŸ–¨ Print Official Form",
        header_crypto_deal: "Crypto Currency Deals",
        btn_print_receipt: "ğŸ–¨ Print Receipt",
        lbl_select_customer: "Select Customer",
        lbl_deal_type: "Deal Type",
        opt_buy: "Buy (Pay Cash)",
        opt_sell: "Sell (Receive Cash)",
        lbl_crypto_name: "Asset Name (USDT)",
        lbl_volume: "Volume",
        lbl_payment_curr: "Payment Currency",
        lbl_total_fiat: "Total Fiat Amount",
        lbl_cost_basis: "Profit Calc (For Sells): Buy Price?",
        btn_submit_deal: "Submit Deal (F10)",
        header_fx_deal: "FX Deal Ticket",
        btn_fx_buy: "BUY",
        btn_fx_sell: "SELL",
        lbl_rate: "Rate:",
        lbl_total: "Total Amount",
        lbl_cash_balance_after: "Vault Balance After Deal",
        lbl_desc_opt: "Description (Optional)",
        lbl_cost_basis_fx: "Est. Profit Calc (Cost Basis)",
        header_backup: "Backup & Restore",
        btn_download_backup: "â¬‡ï¸ Download Full Backup",
        btn_restore_backup: "â¬†ï¸ Restore Backup",
        header_journal: "Journal Log (Reversal)",
        btn_print_log: "ğŸ–¨ Print Journal",
        th_time: "Time",
        th_section: "Section",
        th_user: "User",
        modal_new_hawala: "New Hawala Entry",
        lbl_operation_type: "Operation Type",
        opt_outgoing_full: "Outgoing (Send)",
        opt_incoming_full: "Incoming (Receive)",
        lbl_city_book: "City Book",
        lbl_currency: "Currency",
        lbl_commission: "Commission",
        lbl_sender: "Sender Name",
        lbl_receiver: "Receiver Name",
        lbl_id_card: "ID Card / Passport",
        btn_cancel: "Cancel (Esc)",
        btn_issue_hawala: "Issue & Save (F10)",
        modal_edit_hawala: "Edit Hawala",
        msg_security_warning: "Security: Amount cannot be changed. Delete and re-create if needed.",
        lbl_amount_fixed: "Amount (Fixed)",
        lbl_currency_fixed: "Currency (Fixed)",
        btn_save_edit: "Save Changes (F10)",
        modal_tx_header: "Customer Transaction",
        lbl_account_party: "Account Holder",
        opt_deposit: "Deposit (Receive Cash)",
        opt_withdraw: "Withdraw (Pay Cash)",
        btn_submit_tx: "Submit Transaction (F10)",
        btn_close: "Close (Esc)",
        modal_transfer_header: "Internal Transfer",
        lbl_source_account: "From (Debit):",
        lbl_dest_account: "To (Credit)",
        lbl_transfer_amount: "Transfer Amount",
        btn_do_transfer: "Execute Transfer (F10)",
        modal_new_cust: "New Customer",
        lbl_cust_name: "Full Name",
        btn_add_list: "Add to List (F10)",
        modal_edit_cust: "Edit Customer",
        msg_edit_name_warning: "Warning: Changing name updates all past records.",
        lbl_new_name: "New Name",
        lbl_new_phone: "New Phone",
        btn_save_changes: "Save Changes (F10)",
        modal_all_acc_status: "All Accounts Status",
        msg_click_to_view: "* Click on a customer card to view ledger.",
        header_settings: "System Settings",
        lbl_print_settings: "Print Settings",
        lbl_print_header_opt: "Show Company Name on Header",
        lbl_initial_capital_set: "Initial Capital (Profit Calc)",
        btn_save_capital: "Save Capital",
        lbl_user_mgmt: "User Management",
        lbl_permissions: "Permissions:",
        perm_hawala: "Hawala",
        perm_exchange: "Exchange",
        perm_accounts: "Accounts",
        perm_tt: "TT Transfer",
        perm_admin: "Full Admin",
        btn_add_user: "Add User",
        lbl_add_city: "Add City",
        btn_add: "Add",
        lbl_delete_city: "Delete City",
        msg_city_has_data: "City has data. Transfer to:",
        btn_delete_city: "Delete City",
        lbl_currency_mgmt: "Currency Management",
        lbl_reset_app: "Factory Reset (Wipe Data)",
        btn_full_reset: "Full Reset",
        lbl_change_pass: "Change My Password",
        btn_change_pass: "Change Password"
    },
    tr: {
        dir: 'ltr',
        app_title: "Heratiha DÃ¶viz",
        company_subtitle: "Para Transfer ve DÃ¶viz Hizmetleri",
        login_btn: "GiriÅŸ (Enter)",
        login_error: "HatalÄ± Bilgi",
        loading_db: "VeritabanÄ± YÃ¼kleniyor...",
        nav_dashboard: "ğŸ“Š GÃ¶sterge Paneli",
        nav_hawala: "âœˆï¸ Havale (F2)",
        nav_accounts: "ğŸ‘¥ MÃ¼ÅŸteri HesaplarÄ±",
        nav_tt: "ğŸŒ TT Transfer",
        nav_exchange: "ğŸ’± DÃ¶viz AlÄ±m/SatÄ±m",
        nav_crypto: "ğŸª™ Kripto Para",
        nav_reports: "ğŸ“‘ Raporlar",
        nav_settings: "âš™ï¸ Ayarlar",
        nav_logout: "ğŸšª Ã‡Ä±kÄ±ÅŸ",
        lbl_initial_capital: "KayÄ±tlÄ± Sermaye",
        lbl_profit_loss: "Kar / Zarar",
        lbl_cash_balance: "Kasa Bakiyesi",
        lbl_crypto_assets: "Dijital VarlÄ±klar",
        lbl_city_balance: "Åehir Bakiyeleri",
        btn_refresh: "ğŸ”„ Yenile",
        msg_city_balance_hint: "* YeÅŸil: AlacaklÄ±yÄ±z. KÄ±rmÄ±zÄ±: BorÃ§luyuz.",
        lbl_total_commissions: "Toplam Komisyonlar",
        header_hawala_manage: "Havale YÃ¶netimi",
        btn_new_hawala: "â• Yeni Havale (F9)",
        lbl_filter_city: "Åehir Filtrele",
        lbl_type: "Tip",
        opt_all: "Hepsi",
        opt_outgoing: "Giden (Out)",
        opt_incoming: "Gelen (In)",
        lbl_status: "Durum",
        opt_pending: "Beklemede",
        opt_done: "TamamlandÄ±",
        btn_excel: "ğŸ“Š Excel Ä°ndir",
        btn_print_book: "ğŸ–¨ YazdÄ±r",
        th_hawala_no: "Havale No",
        th_type: "Tip",
        th_city_book: "Åehir",
        th_amount: "Tutar",
        th_commission: "Komisyon",
        th_reg_date: "Tarih",
        th_exec_date: "Ä°ÅŸlem Tarihi",
        th_status: "Durum",
        th_ops: "Ä°ÅŸlem",
        header_accounts_manage: "Hesap YÃ¶netimi",
        lbl_search_customer: "MÃ¼ÅŸteri Ara",
        btn_new_customer: "â• Yeni MÃ¼ÅŸteri",
        btn_deposit_withdraw: "ğŸ’° YatÄ±r/Ã‡ek",
        btn_transfer: "ğŸ”„ Transfer",
        btn_all_accounts: "ğŸ“‹ TÃ¼m Hesaplar",
        lbl_statement: "Ekstre:",
        btn_edit: "âœï¸ DÃ¼zenle",
        btn_delete: "ğŸ—‘ Sil",
        btn_print: "ğŸ–¨ YazdÄ±r",
        th_date: "Tarih",
        th_desc: "AÃ§Ä±klama",
        th_currency: "DÃ¶viz",
        th_debit: "BorÃ§",
        th_credit: "Alacak",
        th_balance: "Bakiye",
        header_tt_app: "TT Transfer Formu",
        opt_internal_cust: "KayÄ±tlÄ± MÃ¼ÅŸteri",
        opt_external_cust: "Nakit MÃ¼ÅŸteri",
        lbl_select_account: "Hesap SeÃ§imi",
        lbl_payer_name: "Ã–deyen AdÄ±",
        lbl_phone: "Telefon",
        lbl_amount: "Tutar",
        header_beneficiary: "AlÄ±cÄ± Bilgileri",
        lbl_ben_name: "AlÄ±cÄ± AdÄ±",
        lbl_desc: "AÃ§Ä±klama",
        btn_submit_tt: "Onayla ve GÃ¶nder (F10)",
        btn_print_form: "ğŸ–¨ Form YazdÄ±r",
        header_crypto_deal: "Kripto Ä°ÅŸlemleri",
        btn_print_receipt: "ğŸ–¨ Makbuz",
        lbl_select_customer: "MÃ¼ÅŸteri SeÃ§",
        lbl_deal_type: "Ä°ÅŸlem Tipi",
        opt_buy: "AlÄ±ÅŸ",
        opt_sell: "SatÄ±ÅŸ",
        lbl_crypto_name: "Kripto (USDT)",
        lbl_volume: "Miktar",
        lbl_payment_curr: "Ã–deme Birimi",
        lbl_total_fiat: "Toplam Tutar",
        lbl_cost_basis: "Maliyet (Kar Hesaplama)",
        btn_submit_deal: "Kaydet (F10)",
        header_fx_deal: "DÃ¶viz Ä°ÅŸlemi",
        btn_fx_buy: "ALIÅ",
        btn_fx_sell: "SATIÅ",
        lbl_rate: "Kur:",
        lbl_total: "SonuÃ§",
        lbl_cash_balance_after: "Ä°ÅŸlem SonrasÄ± Kasa",
        lbl_desc_opt: "Not",
        lbl_cost_basis_fx: "Kar Hesaplama (Opsiyonel)",
        header_backup: "Yedekleme",
        btn_download_backup: "â¬‡ï¸ Ä°ndir",
        btn_restore_backup: "â¬†ï¸ YÃ¼kle",
        header_journal: "Ä°ÅŸlem GÃ¼nlÃ¼ÄŸÃ¼",
        btn_print_log: "ğŸ–¨ GÃ¼nlÃ¼k YazdÄ±r",
        th_time: "Saat",
        th_section: "BÃ¶lÃ¼m",
        th_user: "KullanÄ±cÄ±",
        modal_new_hawala: "Yeni Havale",
        lbl_operation_type: "Ä°ÅŸlem TÃ¼rÃ¼",
        opt_outgoing_full: "GÃ¶nderim",
        opt_incoming_full: "AlÄ±m",
        lbl_city_book: "Åehir KitabÄ±",
        lbl_currency: "Para Birimi",
        lbl_commission: "Komisyon",
        lbl_sender: "GÃ¶nderen",
        lbl_receiver: "AlÄ±cÄ±",
        lbl_id_card: "Kimlik No",
        btn_cancel: "Ä°ptal",
        btn_issue_hawala: "OluÅŸtur",
        modal_edit_hawala: "Havale DÃ¼zenle",
        msg_security_warning: "GÃ¼venlik: Tutar deÄŸiÅŸtirilemez.",
        lbl_amount_fixed: "Tutar (Sabit)",
        lbl_currency_fixed: "Para Birimi (Sabit)",
        btn_save_edit: "Kaydet",
        modal_tx_header: "Hesap Ä°ÅŸlemi",
        lbl_account_party: "Hesap Sahibi",
        opt_deposit: "Para YatÄ±rma",
        opt_withdraw: "Para Ã‡ekme",
        btn_submit_tx: "Onayla",
        btn_close: "Kapat",
        modal_transfer_header: "Transfer",
        lbl_source_account: "GÃ¶nderen:",
        lbl_dest_account: "AlÄ±cÄ±:",
        lbl_transfer_amount: "Tutar",
        btn_do_transfer: "Transfer Et",
        modal_new_cust: "Yeni MÃ¼ÅŸteri",
        lbl_cust_name: "Ad Soyad",
        btn_add_list: "Ekle",
        modal_edit_cust: "MÃ¼ÅŸteri DÃ¼zenle",
        msg_edit_name_warning: "UyarÄ±: Ä°sim deÄŸiÅŸirse eski kayÄ±tlar da gÃ¼ncellenir.",
        lbl_new_name: "Yeni Ä°sim",
        lbl_new_phone: "Yeni Telefon",
        btn_save_changes: "Kaydet",
        modal_all_acc_status: "Hesap DurumlarÄ±",
        msg_click_to_view: "* Detay iÃ§in tÄ±klayÄ±n",
        header_settings: "Ayarlar",
        lbl_print_settings: "YazdÄ±rma AyarlarÄ±",
        lbl_print_header_opt: "BaÅŸlÄ±kta Åirket AdÄ± GÃ¶ster",
        lbl_initial_capital_set: "BaÅŸlangÄ±Ã§ Sermayesi",
        btn_save_capital: "Kaydet",
        lbl_user_mgmt: "KullanÄ±cÄ± YÃ¶netimi",
        lbl_permissions: "Yetkiler:",
        perm_hawala: "Havale",
        perm_exchange: "DÃ¶viz",
        perm_accounts: "Hesaplar",
        perm_tt: "TT",
        perm_admin: "YÃ¶netici",
        btn_add_user: "Ekle",
        lbl_add_city: "Åehir Ekle",
        btn_add: "Ekle",
        lbl_delete_city: "Åehir Sil",
        msg_city_has_data: "Bu ÅŸehirde veri var. Transfer et:",
        btn_delete_city: "Sil",
        lbl_currency_mgmt: "DÃ¶viz YÃ¶netimi",
        lbl_reset_app: "SÄ±fÄ±rla",
        btn_full_reset: "Tam SÄ±fÄ±rlama",
        lbl_change_pass: "Åifre DeÄŸiÅŸtir",
        btn_change_pass: "DeÄŸiÅŸtir"
    },
    ar: {
        dir: 'rtl',
        app_title: "ØµØ±Ø§ÙØ© Ø§Ù„Ù‡Ø±Ø§ØªÙŠÙŠÙ†",
        company_subtitle: "Ø´Ø±ÙƒØ© Ù‡Ø±Ø§Øª Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØµØ±Ø§ÙØ©",
        login_btn: "Ø¯Ø®ÙˆÙ„ (Enter)",
        login_error: "Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©",
        loading_db: "Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
        nav_dashboard: "ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        nav_hawala: "âœˆï¸ Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª (F2)",
        nav_accounts: "ğŸ‘¥ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (F3)",
        nav_tt: "ğŸŒ Ø­ÙˆØ§Ù„Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© (TT)",
        nav_exchange: "ğŸ’± Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ (FX)",
        nav_crypto: "ğŸª™ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©",
        nav_reports: "ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±",
        nav_settings: "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
        nav_logout: "ğŸšª Ø®Ø±ÙˆØ¬",
        lbl_initial_capital: "Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„",
        lbl_profit_loss: "Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©",
        lbl_cash_balance: "Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ",
        lbl_crypto_assets: "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©",
        lbl_city_balance: "Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø¯Ù† ÙˆØ§Ù„ÙØ±ÙˆØ¹",
        btn_refresh: "ğŸ”„ ØªØ­Ø¯ÙŠØ«",
        msg_city_balance_hint: "* Ø§Ù„Ø£Ø®Ø¶Ø±: Ù„Ù†Ø§ØŒ Ø§Ù„Ø£Ø­Ù…Ø±: Ø¹Ù„ÙŠÙ†Ø§.",
        lbl_total_commissions: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª (Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ)",
        header_hawala_manage: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª",
        btn_new_hawala: "â• Ø­ÙˆØ§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (F9)",
        lbl_filter_city: "ÙÙ„ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
        lbl_type: "Ø§Ù„Ù†ÙˆØ¹",
        opt_all: "Ø§Ù„ÙƒÙ„",
        opt_outgoing: "ØµØ§Ø¯Ø±Ø©",
        opt_incoming: "ÙˆØ§Ø±Ø¯Ø©",
        lbl_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
        opt_pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
        opt_done: "Ù…ÙƒØªÙ…Ù„Ø©",
        btn_excel: "ğŸ“Š Ù…Ù„Ù Ø¥ÙƒØ³Ù„",
        btn_print_book: "ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù",
        th_hawala_no: "Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø©",
        th_type: "Ø§Ù„Ù†ÙˆØ¹",
        th_city_book: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
        th_amount: "Ø§Ù„Ù…Ø¨Ù„Øº",
        th_commission: "Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©",
        th_reg_date: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
        th_exec_date: "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°",
        th_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
        th_ops: "Ø¹Ù…Ù„ÙŠØ§Øª",
        header_accounts_manage: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª",
        lbl_search_customer: "Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„",
        btn_new_customer: "â• Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯",
        btn_deposit_withdraw: "ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹/Ø³Ø­Ø¨",
        btn_transfer: "ğŸ”„ ØªØ­ÙˆÙŠÙ„",
        btn_all_accounts: "ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±ØµØ¯Ø©",
        lbl_statement: "ÙƒØ´Ù Ø­Ø³Ø§Ø¨:",
        btn_edit: "âœï¸ ØªØ¹Ø¯ÙŠÙ„",
        btn_delete: "ğŸ—‘ Ø­Ø°Ù",
        btn_print: "ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©",
        th_date: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
        th_desc: "Ø§Ù„Ø¨ÙŠØ§Ù†",
        th_currency: "Ø§Ù„Ø¹Ù…Ù„Ø©",
        th_debit: "Ù…Ø¯ÙŠÙ† (Ø¹Ù„ÙŠÙ‡)",
        th_credit: "Ø¯Ø§Ø¦Ù† (Ù„Ù‡)",
        th_balance: "Ø§Ù„Ø±ØµÙŠØ¯",
        header_tt_app: "Ø·Ù„Ø¨ Ø­ÙˆØ§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ© (TT)",
        opt_internal_cust: "Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„",
        opt_external_cust: "Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ",
        lbl_select_account: "Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø®ØµÙ…)",
        lbl_payer_name: "Ø§Ø³Ù… Ø§Ù„Ø¯Ø§ÙØ¹ (Ù†Ù‚Ø¯ÙŠ)",
        lbl_phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
        lbl_amount: "Ø§Ù„Ù…Ø¨Ù„Øº",
        header_beneficiary: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯",
        lbl_ben_name: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯",
        lbl_desc: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©",
        btn_submit_tt: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (F10)",
        btn_print_form: "ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©",
        header_crypto_deal: "Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø´ÙØ±Ø© (Crypto)",
        btn_print_receipt: "ğŸ–¨ Ø¥ÙŠØµØ§Ù„",
        lbl_select_customer: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„",
        lbl_deal_type: "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
        opt_buy: "Ø´Ø±Ø§Ø¡",
        opt_sell: "Ø¨ÙŠØ¹",
        lbl_crypto_name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø© (USDT)",
        lbl_volume: "Ø§Ù„ÙƒÙ…ÙŠØ©",
        lbl_payment_curr: "Ø¹Ù…Ù„Ø© Ø§Ù„Ø¯ÙØ¹/Ø§Ù„Ù‚Ø¨Ø¶",
        lbl_total_fiat: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
        lbl_cost_basis: "Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­)",
        btn_submit_deal: "ØªÙ†ÙÙŠØ° (F10)",
        header_fx_deal: "Ø´Ø§Ø´Ø© Ø§Ù„ØµØ±Ø§ÙØ© (FX)",
        btn_fx_buy: "Ø´Ø±Ø§Ø¡ (BUY)",
        btn_fx_sell: "Ø¨ÙŠØ¹ (SELL)",
        lbl_rate: "Ø§Ù„Ø³Ø¹Ø±:",
        lbl_total: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
        lbl_cash_balance_after: "Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
        lbl_desc_opt: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        lbl_cost_basis_fx: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù„Ø­Ø¸ÙŠ",
        header_backup: "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ",
        btn_download_backup: "â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø©",
        btn_restore_backup: "â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©",
        header_journal: "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Journal)",
        btn_print_log: "ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„",
        th_time: "Ø§Ù„ÙˆÙ‚Øª",
        th_section: "Ø§Ù„Ù‚Ø³Ù…",
        th_user: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
        modal_new_hawala: "ØªØ³Ø¬ÙŠÙ„ Ø­ÙˆØ§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©",
        lbl_operation_type: "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
        opt_outgoing_full: "Ø¥Ø±Ø³Ø§Ù„ (ØµØ§Ø¯Ø±Ø©)",
        opt_incoming_full: "Ø§Ø³ØªÙ„Ø§Ù… (ÙˆØ§Ø±Ø¯Ø©)",
        lbl_city_book: "Ø¯ÙØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
        lbl_currency: "Ø§Ù„Ø¹Ù…Ù„Ø©",
        lbl_commission: "Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©",
        lbl_sender: "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„",
        lbl_receiver: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…",
        lbl_id_card: "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©",
        btn_cancel: "Ø¥Ù„ØºØ§Ø¡",
        btn_issue_hawala: "Ø¥ØµØ¯Ø§Ø± (F10)",
        modal_edit_hawala: "ØªØ¹Ø¯ÙŠÙ„ Ø­ÙˆØ§Ù„Ø©",
        msg_security_warning: "Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº.",
        lbl_amount_fixed: "Ø§Ù„Ù…Ø¨Ù„Øº (Ø«Ø§Ø¨Øª)",
        lbl_currency_fixed: "Ø§Ù„Ø¹Ù…Ù„Ø© (Ø«Ø§Ø¨ØªØ©)",
        btn_save_edit: "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„",
        modal_tx_header: "Ø­Ø±ÙƒØ© Ø­Ø³Ø§Ø¨",
        lbl_account_party: "ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨",
        opt_deposit: "Ø¥ÙŠØ¯Ø§Ø¹ (Ù‚Ø¨Ø¶)",
        opt_withdraw: "Ø³Ø­Ø¨ (Ø¯ÙØ¹)",
        btn_submit_tx: "ØªÙ†ÙÙŠØ°",
        btn_close: "Ø¥ØºÙ„Ø§Ù‚",
        modal_transfer_header: "ØªØ­ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ",
        lbl_source_account: "Ù…Ù† Ø­Ø³Ø§Ø¨:",
        lbl_dest_account: "Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨:",
        lbl_transfer_amount: "Ù…Ø¨Ù„Øº Ø§Ù„ØªØ­ÙˆÙŠÙ„",
        btn_do_transfer: "ØªØ­ÙˆÙŠÙ„",
        modal_new_cust: "Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯",
        lbl_cust_name: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
        btn_add_list: "Ø¥Ø¶Ø§ÙØ©",
        modal_edit_cust: "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…ÙŠÙ„",
        msg_edit_name_warning: "ØªÙ†Ø¨ÙŠÙ‡: ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø³ÙŠØ­Ø¯Ø« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.",
        lbl_new_name: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯",
        lbl_new_phone: "Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯",
        btn_save_changes: "Ø­ÙØ¸",
        modal_all_acc_status: "Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª",
        msg_click_to_view: "* Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.",
        header_settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
        lbl_print_settings: "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",
        lbl_print_header_opt: "Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",
        lbl_initial_capital_set: "Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠ",
        btn_save_capital: "Ø­ÙØ¸",
        lbl_user_mgmt: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
        lbl_permissions: "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:",
        perm_hawala: "Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª",
        perm_exchange: "Ø§Ù„ØµØ±Ø§ÙØ©",
        perm_accounts: "Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª",
        perm_tt: "TT",
        perm_admin: "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…",
        btn_add_user: "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…",
        lbl_add_city: "Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠÙ†Ø©",
        btn_add: "Ø¥Ø¶Ø§ÙØ©",
        lbl_delete_city: "Ø­Ø°Ù Ù…Ø¯ÙŠÙ†Ø©",
        msg_city_has_data: "ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©. Ø§Ù†Ù‚Ù„ Ø¥Ù„Ù‰:",
        btn_delete_city: "Ø­Ø°Ù",
        lbl_currency_mgmt: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª",
        lbl_reset_app: "Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹",
        btn_full_reset: "Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        lbl_change_pass: "ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        btn_change_pass: "ØªØºÙŠÙŠØ±"
    }
};

let currentLang = localStorage.getItem('heratiha_lang') || 'fa';

function setLanguage(lang) {
    if(!TRANSLATIONS[lang]) return;
    currentLang = lang;
    localStorage.setItem('heratiha_lang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = TRANSLATIONS[lang].dir;
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(`btn-lang-${lang}`);
    if(activeBtn) activeBtn.classList.add('active');
    applyTranslations();
}

function applyTranslations() {
    const t = TRANSLATIONS[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(t[key]) {
            if(el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
                el.placeholder = t[key];
            } else {
                el.innerText = t[key];
            }
        }
    });
    if(document.getElementById('mainApp').style.display === 'flex') {
        updateUI(); 
    }
}

class DBAdapter {
    constructor() {
        const firebaseConfig = {
            apiKey: "AIzaSyDNHTnLU10FDcvr95YFBk9el5AXaiPg8OA",
            authDomain: "heratexchang.firebaseapp.com",
            projectId: "heratexchang",
            storageBucket: "heratexchang.firebasestorage.app",
            messagingSenderId: "6448674064",
            appId: "1:6448674064:web:50aab04aaf80b14644a195",
            measurementId: "G-ZL2GBTDYKX"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        this.db = firebase.firestore();
        this.collectionName = 'Herat_Exchange_V2'; 
    }

    async init() {
        console.log("Firebase Connected (V2 - Optimized Mode)");
        try {
            await this.db.enablePersistence({ synchronizeTabs: true });
        } catch (err) {
            console.log("Persistence note:", err.code);
        }
        return true;
    }

    async loadAll() {
        const data = { hawalas: [], accounts: {}, journal: [] };
        
        try {
            // 1. Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (Ø´Ø§Ù…Ù„ Ù„ÛŒØ³Øª Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒØ§Ù†ØŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ...)
            // Ø§ÛŒÙ† ÙÙ‚Ø· 1 Ø¨Ø§Ø± Ø®ÙˆØ§Ù†Ø¯Ù† (Read) Ø§Ø² Ø³Ø±ÙˆØ± Ù…ØµØ±Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            const docRef = this.db.collection(this.collectionName).doc('General_Data');
            const doc = await docRef.get();
            if (doc.exists) {
                const loaded = doc.data();
                ['users', 'customers', 'cashBox', 'currencies', 'cities', 'initialCapital', 'cityHawalaCounters', 'fxProfit', 'settings', 'employees', 'employeeLedger'].forEach(k => {
                    if (loaded[k]) data[k] = loaded[k];
                });
            }

            // *** ØªØºÛŒÛŒØ± Ù…Ù‡Ù…: Ø­Ø°Ù Ø­Ù„Ù‚Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ ***
            // Ù…Ø§ Ø¯ÛŒÚ¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø³Ù‚Ù ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ù¾Ø± Ù†Ø´ÙˆØ¯.
            
            // 2. Ø¯Ø±ÛŒØ§ÙØª Ú˜ÙˆØ±Ù†Ø§Ù„ (Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ 50 Ù„Ø§Ú¯ Ø¢Ø®Ø± Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª)
            const logSnapshot = await this.db.collection(this.collectionName + '_Journal')
                                         .orderBy('time', 'desc').limit(50).get();
            logSnapshot.forEach(doc => {
                data.journal.push(doc.data());
            });

            // 3. Ø¯Ø±ÛŒØ§ÙØª Ø­ÙˆØ§Ù„Ù‡â€ŒÙ‡Ø§ (Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ 100 Ø­ÙˆØ§Ù„Ù‡ Ø¢Ø®Ø±)
            const hawalaSnapshot = await this.db.collection(this.collectionName + '_Hawalas')
                             .orderBy('regDate', 'desc').limit(100).get();
            hawalaSnapshot.forEach(doc => {
                data.hawalas.push(doc.data());
            });

            console.log("System Loaded Successfully (Smart Mode).");
            return data;
        } catch (error) {
            console.error("Firebase Load Error:", error);
            return {};
        }
    }

    // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø¯Ø±ÛŒØ§ÙØª Ø­Ø³Ø§Ø¨ ÛŒÚ© Ù…Ø´ØªØ±ÛŒ Ø®Ø§Øµ ---
    async loadSingleAccount(customerName) {
        try {
            const doc = await this.db.collection(this.collectionName + '_Accounts').doc(customerName).get();
            if (doc.exists) {
                return doc.data().list || [];
            }
            return []; // Ø§Ú¯Ø± Ø­Ø³Ø§Ø¨ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯
        } catch (e) {
            console.error("Error loading account:", e);
            return [];
        }
    }

    // Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
    async saveGeneral(dbObj) {
        const { hawalas, accounts, journal, ...generalData } = dbObj;
        try {
            await this.db.collection(this.collectionName).doc('General_Data').set(generalData, { merge: true });
        } catch (e) { console.error("General Save Error:", e); }
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ø­Ø³Ø§Ø¨ ÛŒÚ© Ù…Ø´ØªØ±ÛŒ Ø®Ø§Øµ
    async saveCustomerAccount(customerName, txList) {
        try {
            await this.db.collection(this.collectionName + '_Accounts').doc(customerName).set({
                list: txList,
                lastUpdate: Date.now()
            });
        } catch (e) { console.error("Account Save Error:", e); }
    }

    // Ø°Ø®ÛŒØ±Ù‡ ÛŒÚ© Ù„Ø§Ú¯ Ø¬Ø¯ÛŒØ¯
    async saveLogEntry(logItem) {
        try {
            await this.db.collection(this.collectionName + '_Journal').doc(String(logItem.time)).set(logItem);
        } catch (e) { console.error("Log Save Error:", e); }
    }
    
    // Ø­Ø°Ù Ù„Ø§Ú¯
    async deleteLogEntry(timeId) {
        try {
            await this.db.collection(this.collectionName + '_Journal').doc(String(timeId)).delete();
        } catch (e) { console.error("Log Delete Error:", e); }
    }

    // Ø­ÙˆØ§Ù„Ù‡â€ŒÙ‡Ø§
    async saveSingleHawala(h) {
        try { await this.db.collection(this.collectionName + '_Hawalas').doc(h.id).set(h); } 
        catch (e) { console.error("Hawala Save Error:", e); }
    }
    async deleteSingleHawala(hId) {
        try { await this.db.collection(this.collectionName + '_Hawalas').doc(hId).delete(); } 
        catch (e) { console.error("Hawala Delete Error:", e); }
    }
    
    // Ø°Ø®ÛŒØ±Ù‡ Ù‡Ù…Ù‡ (Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¢Ù¾Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡)
    async saveAll(fullDb) {
         await this.saveGeneral(fullDb);
    }
}
// Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø¢Ø¯Ø§Ù¾ØªÙˆØ± ÙØ§ÛŒØ±Ø¨ÛŒØ³
const dbAdapter = new DBAdapter();
// --- Ù¾Ø§ÛŒØ§Ù† Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ ÙØ§ÛŒØ±Ø¨ÛŒØ³ ---
function generateSalt() { return CryptoJS.lib.WordArray.random(128/8).toString(); }
function hashPassword(pwd, salt) { return CryptoJS.PBKDF2(pwd, salt, { keySize: 256/32, iterations: 1000 }).toString(); }
function escapeHtml(text) { if (!text) return ''; return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

let db = { 
    users: [], 
    customers: [], 
    cashBox: { 'USD': 0, 'AFN': 0, 'EUR': 0 }, 
    currencies: ['USD', 'AFN', 'EUR', 'USDT', 'BTC', 'ETH'], 
    hawalas: [], 
    accounts: {}, 
    journal: [], 
    cities: [{ name: 'Ú©Ø§Ø¨Ù„', code: 'KBL' }, { name: 'Ù‡Ø±Ø§Øª', code: 'HRT' }], 
    initialCapital: { 'USD': 0, 'AFN': 0, 'EUR': 0 }, 
    cityHawalaCounters: {}, 
    fxProfit: {}, 
    settings: { printHeader: false } 
};

let currentUser = null; 
let fxProfit = {};
let ttType = 'internal'; 
let exType = 'external';
let hawalaCustType = 'external'; 
let cryptoCustType = 'external'; 
let fxDirection = 'Buy'; 
let fxOperator = 'multiply';
const CRYPTO_LIST = ['USDT', 'BTC', 'ETH', 'TRX', 'LTC', 'DOGE', 'BNB'];
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
}

// --- Ø´Ø±ÙˆØ¹ Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ ---
function toggleGroup(id) {
    const submenu = document.getElementById(id);
    if (submenu.classList.contains('open')) {
        submenu.classList.remove('open');
    } else {
        document.querySelectorAll('.submenu').forEach(el => el.classList.remove('open'));
        submenu.classList.add('open');
    }
}

function getPrintHeaderHTML() {
    if (!db.settings || db.settings.printHeader === false) return '';
    const title = db.settings.companyName || "ØµØ±Ø§ÙÛŒ Ù‡Ø±Ø§ØªÛŒâ€ŒÙ‡Ø§";
    const sub = db.settings.slogan || "";
    const logoImg = db.settings.logo ? `<img src="${db.settings.logo}" class="print-logo-img">` : '';
    
    return `<div style="text-align:center; margin-bottom:10px; border-bottom:2px solid #000; padding-bottom:10px;">
                ${logoImg}
                <h2 style="margin:0; font-family:'Vazirmatn'; font-weight:900;">${title}</h2>
                <div style="font-size:12px;">${sub}</div>
                <div style="font-size:11px; margin-top:5px;">${db.settings.phone || ''} | ${db.settings.address || ''}</div>
            </div>`;
}

// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¢ÙÙ„Ø§ÛŒÙ† Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ ---
localforage.config({
    name: 'HeratihaExchangeDB',
    storeName: 'main_store',
    description: 'Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø±Ø§ÛŒ ØµØ±Ø§ÙÛŒ'
});

async function loadDB() {
    const loadingMsg = document.getElementById('loadingMsg');
    if(loadingMsg) loadingMsg.style.display = 'block';

    try {
        console.log("Loading Data...");

        // 1. Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ù…Ø±ÙˆØ±Ú¯Ø± (IndexedDB)
        const localData = await localforage.getItem('HeratExchange_FullDB');
        
        if (localData) {
            db = localData;
            console.log("âœ… Ø¯ÛŒØªØ§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ÙˆØ¯ Ø´Ø¯.");
        }

        // 2. ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ÛŒ Ø§ÛŒÙ†ØªØ±Ù†Øª (ÙØ§ÛŒØ±Ø¨ÛŒØ³)
        // Ø§Ú¯Ø± Ø§ÛŒÙ†ØªØ±Ù†Øª Ù†Ø¨Ø§Ø´Ø¯ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø±ÙˆØ± Ù…ÛŒØ¯Ù‡Ø¯ Ùˆ Ø¨Ù‡ catch Ù…ÛŒØ±ÙˆØ¯ (Ú©Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³Øª)
        await dbAdapter.init();
        const cloudData = await dbAdapter.loadAll();

        if (cloudData && Object.keys(cloudData).length > 0) {
            // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯: Ø§Ú¯Ø± Ø¯ÛŒØªØ§ÛŒ Ø§Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ØªØ± Ø¨ÙˆØ¯ØŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†
            // Ø§Ù…Ø§ Ø§Ú¯Ø± Ù…Ø§ Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ø± Ú©Ø±Ø¯Ù‡ Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø¯ÛŒØªØ§ÛŒ Ø®ÙˆØ¯Ù…Ø§Ù† Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
            const localLastUpdate = db.lastUpdate || 0;
            const cloudLastUpdate = cloudData.settings ? (cloudData.settings.lastUpdate || 0) : 0;

            if (cloudLastUpdate > localLastUpdate) {
                console.log("â¬‡ï¸ Ø¯ÛŒØªØ§ÛŒ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¬Ø¯ÛŒØ¯ØªØ± Ø§Ø³Øª. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...");
                db = Object.assign(db, cloudData);
                // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±ÙˆÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±
                await localforage.setItem('HeratExchange_FullDB', db);
            } else if (localLastUpdate > cloudLastUpdate) {
                console.log("â¬†ï¸ Ø¯ÛŒØªØ§ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ø¬Ø¯ÛŒØ¯ØªØ± Ø§Ø³Øª (Ú©Ø§Ø± Ø¢ÙÙ„Ø§ÛŒÙ†). Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª...");
                await saveDB(); // Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ù‡ Ø³Ø±ÙˆØ±
            }
        } else {
            // Ø§Ú¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ Ùˆ Ù„ÙˆÚ©Ø§Ù„ Ø¯ÛŒØªØ§ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†
            if (localData) {
                console.log("ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯. Ø¢Ù¾Ù„ÙˆØ¯ Ø¯ÛŒØªØ§ÛŒ Ù„ÙˆÚ©Ø§Ù„...");
                await dbAdapter.saveAll(db);
            } else {
                // Ø¨Ø§Ø± Ø§ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ (Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø®Ø§Ù„ÛŒ)
                const s = generateSalt();
                db.users = [{
                    u: 'admin',
                    salt: s,
                    hash: hashPassword('123456', s),
                    perms: { hawala: true, exchange: true, accounts: true, tt: true, admin: true, access_group_b: true }
                }];
                db.lastUpdate = Date.now();
            }
        }

        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§ (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ú¯)
        if (!db.settings) db.settings = { printHeader: false };
        if (!db.employeeLedger) db.employeeLedger = {};
        if (!db.fxProfit) db.fxProfit = {};
        if (!db.cityHawalaCounters) db.cityHawalaCounters = {};
        
        db.currencies.forEach(c => { 
            if (db.cashBox[c] === undefined) db.cashBox[c] = 0; 
            if (db.initialCapital[c] === undefined) db.initialCapital[c] = 0; 
        });

    } catch (e) {
        console.log("âš ï¸ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù†ÛŒØ³Øª. Ú©Ø§Ø± Ø¨Ø§ Ø¯ÛŒØªØ§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯.");
        // Ø§Ø±ÙˆØ± Ø±Ø§ Ù†Ø´Ø§Ù† Ù†Ø¯Ù‡ ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ù†Ú¯Ø±Ø§Ù† Ù†Ø´ÙˆØ¯ØŒ Ú†ÙˆÙ† Ø¯ÛŒØªØ§ÛŒ Ù„ÙˆÚ©Ø§Ù„ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.
    } finally {
        if(loadingMsg) loadingMsg.style.display = 'none';
        updateUI();
    }
}

async function saveDB() {
    db.lastUpdate = Date.now();
    if(!db.settings) db.settings = {};
    db.settings.lastUpdate = db.lastUpdate;
    db.fxProfit = fxProfit;

    // Ø°Ø®ÛŒØ±Ù‡ Ù„ÙˆÚ©Ø§Ù„ (Ø¢ÙÙ„Ø§ÛŒÙ†) - Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯
    try {
        await localforage.setItem('HeratExchange_FullDB', db);
    } catch (localErr) { console.error("Local Save Error:", localErr); }

    // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø¨Ø±ÛŒ (ÙØ§ÛŒØ±Ø¨ÛŒØ³) - ÙÙ‚Ø· ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯
    // Ù†Ú©ØªÙ‡: Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ Ùˆ Ú˜ÙˆØ±Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
    try {
        await dbAdapter.saveGeneral(db);
        
        // Ù†Ù…Ø§ÛŒØ´ ØªÛŒÚ© Ø³Ø¨Ø²
        const header = document.querySelector('.header-bar h2');
        if(header) {
            const originalColor = header.style.color;
            header.style.color = '#00e676';
            setTimeout(() => header.style.color = originalColor, 1000);
        }
    } catch (err) { console.log("Cloud save skipped (offline)"); }
}
function go(pageId) {
    // Ú†Ú© Ú©Ø±Ø¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ± ØµÙØ­Ù‡
    if (pageId === 'dashboard' && !currentUser.perms.admin) {
        // Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³Øª Ùˆ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø¨Ø±ÙˆØ¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ù‡
        return; 
    }
    if (pageId === 'hawala' && !currentUser.perms.hawala && !currentUser.perms.admin) return;
    if (pageId === 'accounts' && !currentUser.perms.accounts && !currentUser.perms.admin) return;
    if (pageId === 'exchange' && !currentUser.perms.exchange && !currentUser.perms.admin) return;
    if (pageId === 'cryptoFX' && !currentUser.perms.exchange && !currentUser.perms.admin) return; // Ù…Ø¹Ù…ÙˆÙ„Ø§ Ø¨Ø§ Ø§Ú©Ø³Ú†Ù†Ø¬ ÛŒÚ©ÛŒ Ø§Ø³Øª
    if (pageId === 'ttPage' && !currentUser.perms.tt && !currentUser.perms.admin) return;
    if (pageId === 'reports' && !currentUser.perms.admin) return; // Ú¯Ø²Ø§Ø±Ø´Ø§Øª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±

    // Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±...
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    const targetPage = document.getElementById(pageId);
    if(targetPage) targetPage.classList.add('active');
    
    const btn = document.querySelector(`.nav-btn[onclick="go('${pageId}')"]`);
    if(btn) btn.classList.add('active');
    
    const t = TRANSLATIONS[currentLang];
    let titleKey = "";
    switch(pageId) {
        case 'dashboard': titleKey = 'nav_dashboard'; break;
        case 'hawala': titleKey = 'nav_hawala'; break;
        case 'accounts': titleKey = 'nav_accounts'; break;
        case 'exchange': titleKey = 'nav_exchange'; break;
        case 'ttPage': titleKey = 'nav_tt'; break;
        case 'cryptoFX': titleKey = 'nav_crypto'; break;
        case 'reports': titleKey = 'nav_reports'; break;
        case 'employees': titleKey = 'lbl_user_mgmt'; break; 
        // ... Ø³Ø§ÛŒØ± Ú©ÛŒØ³â€ŒÙ‡Ø§
    }
    let titleText = t[titleKey] || pageId;
    if(document.getElementById('pageTitle')) document.getElementById('pageTitle').innerText = titleText;
    
    updateUI();
    setTimeout(() => { 
        if(targetPage) {
            const firstInput = targetPage.querySelector('input, select'); 
            if(firstInput) firstInput.focus(); 
        }
    }, 100);
}

function openModal(id) { const modal = document.getElementById(id); modal.style.display = 'flex'; setTimeout(() => { const firstInput = modal.querySelector('input:not([type="hidden"]), select'); if(firstInput) firstInput.focus(); }, 100); }
function closeModal(id) { const modal = document.getElementById(id); modal.style.display = 'none'; modal.querySelectorAll('input').forEach(inp => inp.value = ''); modal.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0); }
function logTx(section, desc, amt, type = null, data = null) { 
    const logItem = { 
        id: Date.now() + Math.random(), 
        time: new Date().getTime(), 
        section: section, 
        desc: desc, 
        amt: amt, 
        user: currentUser.u, 
        type: type, 
        data: data 
    };
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø±Ù… (Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ)
    db.journal.push(logItem);
    
    // Ø§Ø±Ø³Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… ÙÙ‚Ø· Ù‡Ù…ÛŒÙ† ÛŒÚ© Ù„Ø§Ú¯ Ø¨Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³
    dbAdapter.saveLogEntry(logItem);
}
async function init() {
    setLanguage(currentLang);
    const loadingMsg = document.getElementById('loadingMsg'); loadingMsg.style.display = 'block';
    await loadDB(); loadingMsg.style.display = 'none';
    document.getElementById('displayDate').innerText = new Date().toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');
    document.addEventListener('keydown', handleGlobalKeydown);
}

function handleGlobalKeydown(e) {
    if (e.key === 'Enter') {
        const target = e.target;
        if (target.tagName === 'BUTTON') return;
        if (target.tagName === 'TEXTAREA' && !e.shiftKey) { e.preventDefault(); } else if (target.tagName !== 'TEXTAREA') { e.preventDefault(); }
        const formElements = Array.from(document.querySelectorAll('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled])')).filter(el => { return el.offsetWidth > 0 && el.offsetHeight > 0 && el.closest('.modal') === document.querySelector('.modal[style*="flex"]') || (!document.querySelector('.modal[style*="flex"]') && el.closest('.page.active')); });
        const index = formElements.indexOf(target);
        if (index > -1 && index < formElements.length - 1) { formElements[index + 1].focus(); } else if (index === formElements.length - 1) { handleF10(); }
    }
    if (e.key.startsWith('F')) {
        const key = e.key;
        if(['F1','F2','F3','F4','F6','F8','F9','F10'].includes(key)) e.preventDefault();
        
        switch (key) {
            case 'F1': go('dashboard'); break;
            case 'F2': go('hawala'); break;
            case 'F3': go('accounts'); break;
            case 'F4': go('exchange'); break;
            case 'F6': go('ttPage'); break;
           
            case 'F8': 
                if(document.querySelector('.page.active').id === 'hawala') {
                    openHawalaModal('Incoming');
                }
                break;

            case 'F9': handleF9(); break; 
            case 'F10': handleF10(); break; 
        }
    }
    if (e.key === 'Escape') { document.querySelectorAll('.modal').forEach(m => { if(m.style.display === 'flex') { const closeBtn = m.querySelector('.close-icon'); if(closeBtn) closeBtn.click(); else m.style.display = 'none'; } }); }
}
function handleF9() {
    if (document.querySelector('.modal[style*="flex"]')) return;
    const activePage = document.querySelector('.page.active').id;
    
    if (activePage === 'hawala') {
        openHawalaModal('Outgoing'); // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ F9 Ø±Ø§ Ø±ÙˆÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ…
    }
    else if (activePage === 'accounts') openModal('modalNewCust');
    else if (activePage === 'exchange') document.getElementById('fxBaseAmt').focus();
    else if (activePage === 'ttPage') document.getElementById('ttAmt').focus();
}

function handleF10() {
    const openModals = document.querySelectorAll('.modal');
    for (let m of openModals) {
        if (m.style.display === 'flex' || getComputedStyle(m).display === 'flex') {
            if (m.id === 'modalNewHawala') submitHawala();
            else if (m.id === 'modalEditHawala') submitEditHawala();
            else if (m.id === 'modalTx') submitTx();
            else if (m.id === 'modalClientTransfer') submitClientTransfer();
            else if (m.id === 'modalNewCust') addCustomer();
            else if (m.id === 'modalEditCust') submitEditCustomer();
            return;
        }
    }
    const activePage = document.querySelector('.page.active').id;
    if (activePage === 'exchange') submitExchange();
    else if (activePage === 'cryptoFX') submitCryptoFx();
    else if (activePage === 'ttPage') submitNewTT();
}

function auth() {
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value;
    
    // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    const user = db.users.find(x => x.u === u);
    document.getElementById('loginErr').style.display = 'none';
    
    if (!user) {
        // Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
        document.getElementById('loginErr').style.display = 'block';
        return;
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ù‡Ø´ Ø´Ø¯Ù‡)
    const calculatedHash = hashPassword(p, user.salt);
    
    if (calculatedHash === user.hash) {
        // ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚
        currentUser = user; 
        document.getElementById('loginPage').style.display = 'none'; 
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('sidebarUserInfo').innerText = `${u}`;
        
        applyPermissions(); 
        applyTranslations();

        // Ù‡Ø¯Ø§ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ
        if (user.perms.admin) go('dashboard'); 
        else if (user.perms.hawala) go('hawala'); 
        else if (user.perms.exchange) go('exchange'); 
        else if (user.perms.accounts) go('accounts'); 
        else if (user.perms.tt) go('ttPage');
        else alert("Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù‡ÛŒÚ† Ø¨Ø®Ø´ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!");
    } else {
        // Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª
        document.getElementById('loginErr').style.display = 'block';
    }
}
function logout() {
    // 1. Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    // alert("Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÙØªÙ† Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ùˆ Ø®Ø±ÙˆØ¬...");

    // 2. Ø¯Ø³ØªÙˆØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ú©â€ŒØ¢Ù¾
    if (typeof exportDB === 'function') {
        exportDB();
    }

    // 3. Ù…Ú©Ø« Û² Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ØŒ Ø³Ù¾Ø³ Ø®Ø±ÙˆØ¬ (Ø±ÛŒÙ„ÙˆØ¯)
    setTimeout(() => {
        location.reload();
    }, 2000);
}
function applyPermissions() {
    const isFullAdmin = currentUser?.perms.admin; 
    
    document.querySelectorAll('.admin-only-btn').forEach(el => { 
        el.style.display = isFullAdmin ? 'flex' : 'none'; 
    });

    if (!isFullAdmin) {
        document.getElementById('nav-dashboard').style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯
    } else {
        document.getElementById('nav-dashboard').style.display = 'flex';
    }

    const btnHawala = document.getElementById('nav-hawala');
    if (btnHawala) btnHawala.style.display = (isFullAdmin || currentUser.perms.hawala) ? 'flex' : 'none';

    const btnEx = document.getElementById('nav-exchange');
    if (btnEx) btnEx.style.display = (isFullAdmin || currentUser.perms.exchange) ? 'flex' : 'none';

    const btnAcc = document.getElementById('nav-accounts');
    if (btnAcc) btnAcc.style.display = (isFullAdmin || currentUser.perms.accounts) ? 'flex' : 'none';

    const btnTT = document.getElementById('nav-tt');
    if (btnTT) btnTT.style.display = (isFullAdmin || currentUser.perms.tt) ? 'flex' : 'none';

    const btnCrypto = document.getElementById('nav-crypto');
    if (btnCrypto) btnCrypto.style.display = (isFullAdmin || currentUser.perms.exchange) ? 'flex' : 'none';

    const settingsAdminSection = document.getElementById('adminMenuSection');
    if (settingsAdminSection) settingsAdminSection.style.display = isFullAdmin ? 'block' : 'none';

    if (isFullAdmin) renderUserManagement();

    const hasGroupAccess = currentUser.perms.access_group_b || currentUser.perms.admin;
    const filterDiv = document.getElementById('divFilterGroup');
    if(filterDiv) filterDiv.style.display = hasGroupAccess ? 'block' : 'none';
}

function updateUI() {
    const t = TRANSLATIONS[currentLang];
    const currOptions = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    document.querySelectorAll('#hCurr, #editHCurr, #txCurr, #exSellCurr, #exBuyCurr, #cryptoCurr, #ttCurr, #ctCurr, #fxBaseCurr, #fxQuoteCurr, #hCommCurr').forEach(select => { 
        select.innerHTML = currOptions; 
    });
    const cityOptions = db.cities.map(c => `<option value="${c.code}">${escapeHtml(c.name)}</option>`).join('');
    document.querySelectorAll('#hCityBook, #editHCityBook').forEach(select => { select.innerHTML = cityOptions; });
    document.getElementById('filterHCity').innerHTML = `<option value="All">${t.opt_all || 'All'}</option>` + cityOptions;
    document.getElementById('cityToDelete').innerHTML = `<option value="">...</option>` + cityOptions;
    document.getElementById('cityTransferTarget').innerHTML = cityOptions;
    const custOptions = db.customers.map(c => `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
    document.querySelectorAll('#selCustomer, #txCust, #ttCustomer, #hCustomerSelect, #cryptoCustomer, #exCustomer').forEach(sel => { 
        sel.innerHTML = `<option value="">...</option>` + custOptions; 
    });
    document.getElementById('ctReceiver').innerHTML = custOptions;
    const currToDelete = document.getElementById('currToDelete'); 
    if (currToDelete) currToDelete.innerHTML = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    
    if(db.settings && db.settings.logo) {
        const img = document.getElementById('logoPreview');
        if(img) { img.src = db.settings.logo; img.style.display = 'block'; }
    }

    if(document.getElementById('hawala').classList.contains('active')) filterHawala(); 
    if(document.getElementById('accounts').classList.contains('active')) loadCustomerLedger();
    if(document.getElementById('dashboard').classList.contains('active')) renderDashboard();
    if (db.settings) {
        if(document.getElementById('reports').classList.contains('active')) renderJournal();
        if(document.getElementById('setCompName')) document.getElementById('setCompName').value = db.settings.companyName || '';
        if(document.getElementById('setCompSlogan')) document.getElementById('setCompSlogan').value = db.settings.slogan || '';
        if(document.getElementById('setCompPhone')) document.getElementById('setCompPhone').value = db.settings.phone || '';
        if(document.getElementById('setCompAddress')) document.getElementById('setCompAddress').value = db.settings.address || '';
        if(document.getElementById('setCompFooter')) document.getElementById('setCompFooter').value = db.settings.footerMsg || '';
        applyCompanySettings();
    }
}
async function togglePrintHeaderSetting() { if (!db.settings) db.settings = {}; db.settings.printHeader = document.getElementById('printHeaderOpt').checked; await saveDB(); }
function renderAnalysis() {
    const tbody = document.getElementById('analysisBody');
    tbody.innerHTML = '';
    
    let customerBalances = {};
    for (let custName in db.accounts) {
        db.accounts[custName].forEach(tx => {
            if (!customerBalances[tx.curr]) customerBalances[tx.curr] = 0;

            customerBalances[tx.curr] += (tx.debit - tx.credit);
        });
    }

    let cityBalances = {};
    db.hawalas.forEach(h => {
        if (!cityBalances[h.curr]) cityBalances[h.curr] = 0;
        
        if (h.type === 'Outgoing') {

            cityBalances[h.curr] += h.amt; 
        } 
        else if (h.type === 'Incoming') {

            if (h.status === 'Done') {
                cityBalances[h.curr] -= h.amt; 
            }

        } 
    });

    db.currencies.forEach(curr => {
        const cash = (db.cashBox[curr] || 0) + (db.initialCapital[curr] || 0);
        
        const custBal = customerBalances[curr] || 0; 
        
        const cityBal = cityBalances[curr] || 0;

        const netCapital = cash + custBal - cityBal;


        let defaultRate = '';
        if(db.avgRates && db.avgRates[curr]) defaultRate = db.avgRates[curr];
        else if(curr === 'USD' || curr === 'USDT') defaultRate = '1';
        
        let op = 'multiply';
        if(curr !== 'EUR' && curr !== 'GBP' && curr !== 'USD' && curr !== 'USDT') {
             op = 'divide'; 
        }
        if(curr === 'USD' || curr === 'USDT') op = 'multiply';
        const opIcon = op === 'multiply' ? 'âœ–' : 'â—';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold">${curr}</td>
            <td dir="ltr" style="font-weight:bold; color:${cash >= 0 ? 'var(--text-main)' : 'var(--danger)'}">${cash.toLocaleString()}</td>
            <td dir="ltr" style="color:${custBal >= 0 ? 'var(--success)' : 'var(--danger)'}">${custBal.toLocaleString()}</td>
            <td dir="ltr" style="color:${cityBal >= 0 ? 'var(--danger)' : 'var(--success)'}">${cityBal.toLocaleString()}</td>
            <td dir="ltr" style="font-weight:900; background:rgba(212,175,55,0.05); color:${netCapital >= 0 ? 'var(--gold-primary)' : 'var(--danger)'}">${netCapital.toLocaleString()}</td>
            <td>
                <div style="display:flex; align-items:center; gap:5px">
                    <button class="btn btn-outline btn-sm no-print" 
                            style="padding:2px 8px;" 
                            id="btnOp_${curr}" 
                            data-op="${op}"
                            onclick="toggleAnalysisOp(this, '${curr}', ${netCapital})">
                        ${opIcon}
                    </button>
                    <input type="number" class="input" style="margin:0; text-align:center; direction:ltr" 
                           placeholder="Ù†Ø±Ø®" value="${defaultRate}" id="rate_${curr}" 
                           oninput="calculateRowUSD('${curr}', ${netCapital})">
                </div>
            </td>
            <td dir="ltr" style="font-weight:bold" id="usdResult_${curr}">0</td>
        `;
        tbody.appendChild(tr);
        
        setTimeout(() => calculateRowUSD(curr, netCapital), 100);
    });
}
function toggleAnalysisOp(btn, curr, netCapital) {
    const currentOp = btn.getAttribute('data-op');
    if(currentOp === 'multiply') {
        btn.setAttribute('data-op', 'divide');
        btn.innerText = 'â—';
        btn.style.color = 'var(--gold-primary)';
        btn.style.borderColor = 'var(--gold-primary)';
    } else {
        btn.setAttribute('data-op', 'multiply');
        btn.innerText = 'âœ–';
        btn.style.color = 'var(--text-muted)';
        btn.style.borderColor = 'var(--text-muted)';
    }
    calculateRowUSD(curr, netCapital);
}

function calculateRowUSD(curr, netCapital) {
    const rateInput = document.getElementById(`rate_${curr}`).value;
    const resultCell = document.getElementById(`usdResult_${curr}`);
    const btnOp = document.getElementById(`btnOp_${curr}`);
    const op = btnOp ? btnOp.getAttribute('data-op') : 'multiply';
    
    if (rateInput && !isNaN(rateInput)) {
        const rate = parseFloat(rateInput);
        let totalUSD = 0;
        
        if(op === 'multiply') {
            totalUSD = netCapital * rate;
        } else {
            
            if(rate !== 0) totalUSD = netCapital / rate;
        }

        resultCell.innerText = totalUSD.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
        resultCell.style.color = totalUSD >= 0 ? 'var(--success)' : 'var(--danger)';
        resultCell.dataset.value = totalUSD; 
    } else {
        resultCell.innerText = "0";
        resultCell.dataset.value = 0;
    }
    updateGrandTotal();
}
function updateGrandTotal() {
    let total = 0;
    db.currencies.forEach(c => {
        const cell = document.getElementById(`usdResult_${c}`);
        if(cell && cell.dataset.value) {
            total += parseFloat(cell.dataset.value);
        }
    });
    document.getElementById('grandTotalUSD').innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " $";
}
function renderDashboard() { 
    const hasAccess = currentUser.perms.access_group_b || currentUser.perms.admin;

    let totalProfit = {}; 
    let dailyProfit = {};
    const startOfDay = new Date();
    startOfDay.setHours(0,0,0,0); 
    const startTime = startOfDay.getTime();

    db.journal.forEach(log => {

        if ((log.type === 'EXCHANGE' || log.type === 'CRYPTO') && log.data && log.data.profit) {
            
            const pCurr = log.data.quoteCurr || log.data.curr; 
            
            if (pCurr) {
                totalProfit[pCurr] = (totalProfit[pCurr] || 0) + log.data.profit;

                if (log.time >= startTime) {
                    dailyProfit[pCurr] = (dailyProfit[pCurr] || 0) + log.data.profit;
                }
            }
        }
    });

    let initHtml = ''; 
    db.currencies.forEach(c => { 
        if (db.initialCapital[c] > 0) initHtml += `<span style="margin-left:10px">${db.initialCapital[c].toLocaleString()} ${c}</span>`; 
    });
    document.getElementById('dispInitialCap').innerHTML = initHtml || `<span style="opacity:0.6">-</span>`;

    let profitHtml = ''; 
    for (const c in totalProfit) { 
        const val = totalProfit[c]; 
        if (Math.abs(val) > 0.01) { 
            const color = val >= 0 ? 'var(--success)' : 'var(--danger)'; 
            profitHtml += `<div style="color:${color}; direction:ltr; font-size:18px;">${val >= 0 ? '+' : ''}${val.toLocaleString(undefined, {maximumFractionDigits: 2})} ${c}</div>`; 
        } 
    }
    document.getElementById('dispProfit').innerHTML = profitHtml || `<span style="color:var(--text-muted)">0</span>`;

    let dailyHtml = '';
    for (const c in dailyProfit) {
        const val = dailyProfit[c];
        if (Math.abs(val) > 0.01) {
            const color = val >= 0 ? '#4caf50' : '#f44336'; 
            dailyHtml += `<div style="color:${color}; direction:ltr; font-weight:bold;">${val >= 0 ? '+' : ''}${val.toLocaleString(undefined, {maximumFractionDigits: 2})} ${c}</div>`;
        }
    }
    document.getElementById('dispDailyProfit').innerHTML = dailyHtml || `<span style="opacity:0.5; font-size:14px">ÙØ¹Ù„Ø§ Ù‡ÛŒÚ†</span>`;

    const cashStatsDiv = document.getElementById('cashStats'); 
    const cryptoStatsDiv = document.getElementById('cryptoStats');
    cashStatsDiv.innerHTML = ''; 
    cryptoStatsDiv.innerHTML = '';
    db.currencies.forEach(c => {
        const amount = (db.cashBox[c] || 0) + (db.initialCapital[c] || 0);
        const colorClass = amount < 0 ? 'var(--danger)' : 'var(--gold-primary)';
        const boxHtml = `<div class="stat-box"><div class="label" style="color:var(--text-muted); font-weight:800">${c}</div><div class="stat-val" style="color:${colorClass}">${amount.toLocaleString()}</div></div>`;
        if (CRYPTO_LIST.includes(c)) cryptoStatsDiv.innerHTML += boxHtml; 
        else cashStatsDiv.innerHTML += boxHtml;
    });
    

    renderCityBalancesAndCommissions(); 
}

function renderCityBalancesAndCommissions() {
     const cityStatsDiv = document.getElementById('cityStats'); 
     if(!cityStatsDiv) return;
     cityStatsDiv.innerHTML = '';
     
     const cityBalances = {}; 
     const totalCommissions = {};
     const hasAccess = currentUser.perms.access_group_b || currentUser.perms.admin;

     db.hawalas.forEach(h => { 
         if (!hasAccess && h.dataGroup === 'B') return;
         if (!cityBalances[h.cityBook]) cityBalances[h.cityBook] = {}; 
         if (!cityBalances[h.cityBook][h.curr]) cityBalances[h.cityBook][h.curr] = 0; 
         if (h.type === 'Outgoing') cityBalances[h.cityBook][h.curr] += h.amt; 
         else if (h.type === 'Incoming') cityBalances[h.cityBook][h.curr] -= h.amt; 
         if (h.comm && h.comm > 0) { 
             const cC = h.commCurr || h.curr; 
             if (!totalCommissions[cC]) totalCommissions[cC] = 0; 
             totalCommissions[cC] += h.comm; 
         }
     });
     
     db.cities.forEach(city => {
         let balanceHtml = ''; 
         const cityBal = cityBalances[city.code];
         if (cityBal) { 
             for (const curr in cityBal) { 
                 const bal = cityBal[curr]; 
                 if (Math.abs(bal) > 0.001) { 
                     const color = bal >= 0 ? 'var(--success)' : 'var(--danger)'; 
                     balanceHtml += `<div style="font-size:14px; font-weight:900; color:${color}; direction:ltr">${bal >= 0 ? '+' : ''}${bal.toLocaleString()} ${curr}</div>`; 
                 } 
             } 
         }
         cityStatsDiv.innerHTML += `<div class="stat-box" style="text-align:right"><div class="label" style="font-size:14px; font-weight:bold">${escapeHtml(city.name)}</div>${balanceHtml || '<div style="font-size:12px; color:gray">0</div>'}</div>`;
     });
 
     const commDiv = document.getElementById('cityCommissions'); 
     if(commDiv) {
         commDiv.innerHTML = '';
         for (const curr in totalCommissions) { 
             commDiv.innerHTML += `<div class="stat-box" style="background:rgba(0, 230, 118, 0.05); border-color:var(--success);"><div class="label" style="color:var(--success)">${curr}</div><div class="stat-val" style="color:var(--success)">+${totalCommissions[curr].toLocaleString()}</div></div>`; 
         } 
     }
}
function renderJournal() {
    if (!currentUser.perms.admin) return;
    const t = TRANSLATIONS[currentLang];
    const tbody = document.getElementById('journalBody');
    const logs = db.journal.sort((a, b) => b.time - a.time);
    tbody.innerHTML = logs.map(j => {
        const timeStr = new Date(j.time).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US', { hour: '2-digit', minute: '2-digit' });
        const canReverse = j.type ? true : false;
        const btnStyle = canReverse ? "btn-red" : "btn-outline";
        const btnText = canReverse ? (currentLang === 'fa' ? "Ø­Ø°Ù Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª" : "Reverse") : (currentLang === 'fa' ? "Ø­Ø°Ù Ù„Ø§Ú¯" : "Delete Log");
        return `<tr><td style="font-size:11px">${timeStr}</td><td>${j.section}</td><td>${escapeHtml(j.desc)}</td><td dir="ltr" style="font-size:11px; font-weight:bold">${j.amt}</td><td style="font-size:11px">${j.user}</td><td class="admin-only-col"><button class="btn ${btnStyle}" style="padding:2px 5px; font-size:10px" onclick="deleteLog(${j.time}, ${j.id})">${btnText}</button></td></tr>`;
    }).join('');
}

async function deleteLog(time, logId) {
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
    const logIndex = db.journal.findIndex(j => (j.id && j.id === logId) || j.time === time);
    if (logIndex === -1) return;
    
    const logEntry = db.journal[logIndex];

    const msg = currentLang === 'fa' ? 
        'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª ØªÙ…Ø§Ù… Ù…Ø¨Ø§Ù„Øº Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ' : 
        'Are you sure you want to reverse this transaction completely?';
    
    if (!confirm(msg)) return;

    // --- Ø´Ø±ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§Ø²Ú¯Ø´Øª ØªØ±Ø§Ú©Ù†Ø´ (Reverse Logic) ---
    if (logEntry.type && logEntry.data) {
        const d = logEntry.data;
        try {
            if (logEntry.type === 'HAWALA_SUBMIT') {
                const hIndex = db.hawalas.findIndex(h => h.id === d.hawalaId);
                
                if (hIndex > -1) {
                    const h = db.hawalas[hIndex];
                    
                    if (h.type === 'Outgoing' && !h.isInternal) { 
                        db.cashBox[h.curr] = (db.cashBox[h.curr] || 0) - h.amt; 
                        
                        if(h.comm) {
                            const cCurr = h.commCurr || h.curr;
                            db.cashBox[cCurr] = (db.cashBox[cCurr] || 0) - h.comm; 
                        }
                    }

                    if (h.isInternal && h.internalCust && db.accounts[h.internalCust]) {
                        if(d.accId) {
                             db.accounts[h.internalCust] = db.accounts[h.internalCust].filter(acc => acc.id !== d.accId);
                             // Ø¢Ù¾Ø¯ÛŒØª Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³
                             await dbAdapter.saveCustomerAccount(h.internalCust, db.accounts[h.internalCust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                        }
                    }

                    db.hawalas.splice(hIndex, 1);
                    // Ø­Ø°Ù Ø­ÙˆØ§Ù„Ù‡ Ø§Ø² ÙØ§ÛŒØ±Ø¨ÛŒØ³
                    await dbAdapter.deleteSingleHawala(d.hawalaId); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                }

                if (d.hawalaId) {
                    const parts = d.hawalaId.split('-');
                    if(parts.length >= 3) {
                        const city = parts[0];
                        const typeChar = parts[1]; 
                        const num = parseInt(parts[2]);
                        const typeKey = typeChar === 'O' ? 'Outgoing' : 'Incoming';

                        if (db.cityHawalaCounters[city] && db.cityHawalaCounters[city][typeKey] === num + 1) {
                            db.cityHawalaCounters[city][typeKey]--;
                        }
                    }
                }
            }

            else if (logEntry.type === 'EXCHANGE') {
                if (d.isInternal) {
                    if (d.cust && db.accounts[d.cust]) {
                        db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId1 && acc.id !== d.accId2);
                        // Ø¢Ù¾Ø¯ÛŒØª Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³
                        await dbAdapter.saveCustomerAccount(d.cust, db.accounts[d.cust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                    }
                } else {
                    if (d.direction === 'Buy') { 
                        db.cashBox[d.baseCurr] -= d.baseAmt; 
                        db.cashBox[d.quoteCurr] += d.quoteAmt; 
                    } else { 
                        db.cashBox[d.baseCurr] += d.baseAmt; 
                        db.cashBox[d.quoteCurr] -= d.quoteAmt; 
                    }
                }
                if (d.profit && d.quoteCurr) {
                    fxProfit[d.quoteCurr] = (fxProfit[d.quoteCurr] || 0) - d.profit;
                }
            } 

            else if (logEntry.type === 'TX') {
                if (d.type === 'debit') {
                    db.cashBox[d.curr] += d.amt; 
                } else {
                    db.cashBox[d.curr] -= d.amt; 
                }
                if (db.accounts[d.cust]) {
                    db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId);
                    // Ø¢Ù¾Ø¯ÛŒØª Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³
                    await dbAdapter.saveCustomerAccount(d.cust, db.accounts[d.cust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                }
            }

            else if (logEntry.type === 'HAWALA_EXEC_IN') {
                const h = db.hawalas.find(h => h.id === d.hawalaId);
                if(h) {
                    h.status = 'Pending'; 
                    h.execDate = 0;
                    // Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø­ÙˆØ§Ù„Ù‡ Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³
                    await dbAdapter.saveSingleHawala(h); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                    
                    if (d.isInternal && d.cust) {
                        if(db.accounts[d.cust] && d.accId) {
                            db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId);
                            // Ø¢Ù¾Ø¯ÛŒØª Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³
                            await dbAdapter.saveCustomerAccount(d.cust, db.accounts[d.cust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                        }
                    } else {
                        db.cashBox[d.curr] += d.amt;
                    }
                }
            }

            else if (logEntry.type === 'TT_EXTERNAL') {
                db.cashBox[d.curr] -= d.amt;
            }
            else if (logEntry.type === 'TT_INTERNAL') {
                if(db.accounts[d.cust]) {
                    db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId);
                    await dbAdapter.saveCustomerAccount(d.cust, db.accounts[d.cust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                }
            }

            else if (logEntry.type === 'ACC_TRANSFER') {
                if(db.accounts[d.s]) {
                    db.accounts[d.s] = db.accounts[d.s].filter(a => a.id !== d.id1);
                    await dbAdapter.saveCustomerAccount(d.s, db.accounts[d.s]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                }
                if(db.accounts[d.r]) {
                    db.accounts[d.r] = db.accounts[d.r].filter(a => a.id !== d.id2);
                    await dbAdapter.saveCustomerAccount(d.r, db.accounts[d.r]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                }
            }
            else if (logEntry.type === 'CRYPTO') {
                if (d.type === 'Buy') {
                    db.cashBox[d.cName] -= d.vol;
                    if(d.isInternal && d.cust) {
                         db.accounts[d.cust] = db.accounts[d.cust].filter(a => a.id !== d.accId);
                         await dbAdapter.saveCustomerAccount(d.cust, db.accounts[d.cust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                    } else {
                        db.cashBox[d.curr] += d.fiatAmt;
                    }
                } else {
                    db.cashBox[d.cName] += d.vol;
                    if(d.isInternal && d.cust) {
                         db.accounts[d.cust] = db.accounts[d.cust].filter(a => a.id !== d.accId);
                         await dbAdapter.saveCustomerAccount(d.cust, db.accounts[d.cust]); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯
                    } else {
                        db.cashBox[d.curr] -= d.fiatAmt;
                    }
                    if(d.profit) fxProfit[d.curr] = (fxProfit[d.curr] || 0) - d.profit;
                }
            }
            
            else if (logEntry.type === 'EMP_PAYMENT') {
                db.cashBox[d.curr] = (db.cashBox[d.curr] || 0) + d.amount;
                if(db.employeeLedger && db.employeeLedger[d.empId]) {
                    db.employeeLedger[d.empId] = db.employeeLedger[d.empId].filter(x => x.id !== d.txId);
                }
            }

        } catch (err) { 
            console.error(err); 
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª."); 
            return; 
        }
    }
    // --- Ù¾Ø§ÛŒØ§Ù† Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§Ø²Ú¯Ø´Øª ---

    // ==========================================
    // Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ú©Ù‡ Ù¾Ø±Ø³ÛŒØ¯ÛŒØ¯ (Ø­Ø°Ù Ù†Ù‡Ø§ÛŒÛŒ Ù„Ø§Ú¯)
    // ==========================================
    
    // 1. Ø¢ÛŒØªÙ… Ø±Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°Ù Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…
    const deletedItem = db.journal[logIndex];
    
    // 2. Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    db.journal.splice(logIndex, 1);
    
    // 3. Ø§Ø² ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ù‡Ù… Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù…)
    await dbAdapter.deleteLogEntry(deletedItem.time); // <--- Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ùˆ Ø­ÛŒØ§ØªÛŒ

    // ==========================================

    await saveDB(); 
    renderJournal(); 
    renderDashboard(); 
    
    if(document.getElementById('hawala').classList.contains('active')) filterHawala();
    if(document.getElementById('accounts').classList.contains('active')) loadCustomerLedger();
    if(document.getElementById('employees').classList.contains('active')) renderEmployees();

    alert(currentLang === 'fa' ? "Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯ Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø§ØµÙ„Ø§Ø­ Ú¯Ø±Ø¯ÛŒØ¯." : "Reversed successfully.");
}
function openSettings() { 
    updateUI(); 
    if(currentUser && currentUser.perms.admin) {
        document.getElementById('adminMenuSection').style.display = 'block';
    } else {
        document.getElementById('adminMenuSection').style.display = 'none';
    }
    openModal('modalSettings'); 
    switchSettingsTab('tab-profile', document.querySelector('.settings-menu-btn'));
}

function getNewHawalaNumber(cityCode, type) {

    const existingNumbers = db.hawalas
        .filter(h => h.cityBook === cityCode && h.type === type)
        .map(h => parseInt(h.bookNum)) 
        .sort((a, b) => a - b); 


    let nextNum = 1001;
    for (let num of existingNumbers) {
        if (num === nextNum) {
            nextNum++; 
        } else if (num > nextNum) {
            return nextNum;
        }
    }

    return nextNum;
}

function setHawalaCustType(type) {
    hawalaCustType = type;
    document.getElementById('hOptInternal').classList.toggle('active', type === 'internal');
    document.getElementById('hOptExternal').classList.toggle('active', type === 'external');
    document.getElementById('hInternalSec').style.display = type === 'internal' ? 'block' : 'none';
}

function fillHawalaCustName() {
    const sel = document.getElementById('hCustomerSelect');
    if(hawalaCustType === 'internal' && sel.value) {
        document.getElementById('hSender').value = sel.value; 
    }
}

async function submitHawala() {
    const hType = document.getElementById('hType').value; 
    const hCityBook = document.getElementById('hCityBook').value; 
    const hAmt = parseFloat(document.getElementById('hAmt').value); 
    const hCurr = document.getElementById('hCurr').value; 
    
    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ (Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ null Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯)
    const getVal = (id) => { const v = document.getElementById(id).value.trim(); return v === '' ? null : v; };

    const hSender = getVal('hSender');
    const hSenderLast = getVal('hSenderLast'); 
    const hSenderFather = getVal('hSenderFather'); 
    const hSenderPhone = getVal('hPhone'); 
    const hSenderID = getVal('hSenderID'); 
    const hSenderPurpose = getVal('hSenderPurpose');

    const hReceiver = getVal('hReceiver');
    const hReceiverLast = getVal('hReceiverLast');
    const hReceiverFather = getVal('hReceiverFather');
    const hReceiverPhone = getVal('hReceiverPhone');
    const hReceiverID = getVal('hReceiverID');
    const hReceiverPurpose = getVal('hReceiverPurpose');

    let rawComm = parseFloat(document.getElementById('hComm').value) || 0; 
    const commType = document.getElementById('hCommType').value;
    const commCurr = document.getElementById('hCommCurr').value; 
    const hComm = (commType === 'out') ? -rawComm : rawComm; 

    if (!hCityBook || hAmt <= 0 || !hSender || !hReceiver) { alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª (Ù†Ø§Ù… ÙØ±Ø³ØªÙ†Ø¯Ù‡ØŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ØŒ Ù…Ø¨Ù„Øº Ùˆ Ø´Ù‡Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª)"); return; }
    
    let dataGroup = 'A'; 
    if (currentUser.perms.access_group_b || currentUser.perms.admin) dataGroup = document.getElementById('hGroup').value;
    const isInternal = (hawalaCustType === 'internal');
    const custName = document.getElementById('hCustomerSelect').value;
    const bookNum = getNewHawalaNumber(hCityBook, hType);
    const uniqueId = `${hCityBook}-${hType === 'Outgoing' ? 'O' : 'I'}-${bookNum}`;
    const displayNum = `${hCityBook}-${bookNum}`;

    const newHawala = { 
        id: uniqueId, displayId: displayNum, bookNum: bookNum, type: hType, 
        cityBook: hCityBook, amt: hAmt, curr: hCurr, 
        comm: hComm, commCurr: commCurr,
        // Ø°Ø®ÛŒØ±Ù‡ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§
        sender: hSender, senderLast: hSenderLast, senderFather: hSenderFather, senderPhone: hSenderPhone, senderID: hSenderID, senderPurpose: hSenderPurpose,
        receiver: hReceiver, receiverLast: hReceiverLast, receiverFather: hReceiverFather, receiverPhone: hReceiverPhone, receiverID: hReceiverID, receiverPurpose: hReceiverPurpose,
        
        regDate: Date.now(), 
        execDate: hType === 'Outgoing' ? Date.now() : 0, 
        status: hType === 'Outgoing' ? 'Done' : 'Pending',
        isInternal: isInternal, internalCust: isInternal ? custName : null, dataGroup: dataGroup 
    };

    let logData = { hawalaId: uniqueId, isInternal: isInternal };

    if (hType === 'Outgoing') { 
        let logText = `Ø§Ø±Ø³Ø§Ù„ Ø­ÙˆØ§Ù„Ù‡ (${displayNum}) Ø¨Ù‡ ${hCityBook} | ÙØ±Ø³ØªÙ†Ø¯Ù‡: ${hSender} | Ú¯ÛŒØ±Ù†Ø¯Ù‡: ${hReceiver}`;
        if (isInternal) {
            const accId = Date.now();
            db.accounts[custName].push({ id: accId, date: Date.now(), desc: `Hawala Out ${displayNum} (Comm: ${hComm} ${commCurr})`, curr: hCurr, debit: hAmt, credit: 0, type: 'debit' });
            logTx('Ø­ÙˆØ§Ù„Ù‡ (Ø¯Ø§Ø®Ù„ÛŒ)', logText, `Ú©Ø³Ø± Ø§Ø² Ø­Ø³Ø§Ø¨: ${hAmt}`, 'HAWALA_SUBMIT', logData);
        } else {
            db.cashBox[hCurr] = (db.cashBox[hCurr] || 0) + hAmt; 
            db.cashBox[commCurr] = (db.cashBox[commCurr] || 0) + hComm;
            logTx('Ø­ÙˆØ§Ù„Ù‡ (Ø§Ø±Ø³Ø§Ù„ÛŒ)', logText, `Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø¯: ${hAmt} ${hCurr}`, 'HAWALA_SUBMIT', logData); 
        }
    } else { 
        let logText = `Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡ ÙˆØ§Ø±Ø¯Ù‡ (${displayNum}) Ø§Ø² ${hCityBook} | Ú¯ÛŒØ±Ù†Ø¯Ù‡: ${hReceiver} | ÙØ±Ø³ØªÙ†Ø¯Ù‡: ${hSender}`;
        logTx('Ø­ÙˆØ§Ù„Ù‡ (Ø¯Ø±ÛŒØ§ÙØªÛŒ)', logText, `Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: ${hAmt} ${hCurr}`, 'HAWALA_SUBMIT', logData); 
    }

    db.hawalas.push(newHawala); 
// Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ Ø­ÙˆØ§Ù„Ù‡ Ù‡Ù…Ø§Ù† Ù„Ø­Ø¸Ù‡ Ø¯Ø± Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯
    dbAdapter.saveSingleHawala(newHawala);
    await saveDB(); 
    closeModal('modalNewHawala'); filterHawala(); renderDashboard(); 
    alert(`Ø­ÙˆØ§Ù„Ù‡ ${displayNum} Ø«Ø¨Øª Ø´Ø¯.\nØ­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ø¨Ø®Ø´ Ú†Ø§Ù¾ØŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø¢Ù† Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.`);
}

async function execHawala(id) {
    if (!currentUser.perms.admin && !currentUser.perms.hawala) return;
    const h = db.hawalas.find(x => x.id === id); if (!h || h.status !== 'Pending') return;
    
    let confirmMsg = currentLang === 'fa' ? `Ø¢ÛŒØ§ Ø­ÙˆØ§Ù„Ù‡ ${h.displayId || h.id} Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯ØŸ` : `Is Hawala ${h.displayId || h.id} Paid?`;
    
    if (h.type === 'Incoming' && confirm(confirmMsg)) {
        let logData = { hawalaId: h.id, curr: h.curr, amt: h.amt, isInternal: false };
        const currentCash = (db.cashBox[h.curr] || 0) + (db.initialCapital[h.curr] || 0);
        if (currentCash < h.amt) { alert(`Low Cash`); return; }
        db.cashBox[h.curr] -= h.amt; 
        logTx('Ø­ÙˆØ§Ù„Ù‡', `Paid Hawala (Cash) ${h.displayId}`, `Cash Out: ${h.amt} ${h.curr}`, 'HAWALA_EXEC_IN', logData);

        h.status = 'Done'; h.execDate = new Date().getTime(); 
        await saveDB(); filterHawala(); renderDashboard();
    }
}

function openEditHawalaModal(id) {
    // 1. Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¯ÛŒØ±
    if (!currentUser || !currentUser.perms.admin) {
        alert("â›” Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²!\nÙˆÛŒØ±Ø§ÛŒØ´ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª (Admin) Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª.");
        return;
    }

    const h = db.hawalas.find(x => x.id === id); 
    if (!h) return;
    
    // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
    document.getElementById('editHId').value = h.id; 
    document.getElementById('editHawalaId').innerText = h.displayId || h.id; 
    document.getElementById('editHType').value = h.type; 
    document.getElementById('editHCityBook').value = h.cityBook; 
    
    // Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ
    document.getElementById('editHAmt').value = h.amt; 
    document.getElementById('editHCurr').value = h.curr;
    document.getElementById('editHComm').value = h.comm || 0;
    
    // Ù„ÛŒØ³Øª Ø§Ø±Ø² Ø¨Ø±Ø§ÛŒ Ú©Ù…ÛŒØ´Ù†
    const commCurrSelect = document.getElementById('editHCommCurr');
    commCurrSelect.innerHTML = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    commCurrSelect.value = h.commCurr || h.curr;

    // --- Ù…Ø´Ø®ØµØ§Øª Ø¬Ø¯ÛŒØ¯ (Ù†Ø§Ù…ØŒ ØªØ®Ù„ØµØŒ Ù¾Ø¯Ø±) ---
    document.getElementById('editHSender').value = h.sender; 
    document.getElementById('editHSenderLast').value = h.senderLast || ''; 
    document.getElementById('editHSenderFather').value = h.senderFather || ''; 

    document.getElementById('editHReceiver').value = h.receiver; 
    document.getElementById('editHReceiverLast').value = h.receiverLast || ''; 
    document.getElementById('editHReceiverFather').value = h.receiverFather || ''; 
    // ------------------------------------

    document.getElementById('editHPhone').value = h.phone; 
    document.getElementById('editHIDCard').value = h.idCard; 
    
    openModal('modalEditHawala');
}

async function submitEditHawala() {
    if (!currentUser || !currentUser.perms.admin) {
        alert("â›” Ø´Ù…Ø§ Ù…Ø¬ÙˆØ² Ø°Ø®ÛŒØ±Ù‡ Ø§ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.");
        return;
    }

    const id = document.getElementById('editHId').value;
    const h = db.hawalas.find(x => x.id === id); 
    if (!h) return;

    // Ø¯Ø±ÛŒØ§ÙØª Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø§Ø² ÙØ±Ù…
    const newAmt = parseFloat(document.getElementById('editHAmt').value) || 0;
    const newCurr = document.getElementById('editHCurr').value;
    const newComm = parseFloat(document.getElementById('editHComm').value) || 0;
    const newCommCurr = document.getElementById('editHCommCurr').value;
    const newType = document.getElementById('editHType').value;
    
    // === Ù…Ø±Ø­Ù„Ù‡ 1: Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† ØªØ§Ø«ÛŒØ± Ø­ÙˆØ§Ù„Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚ (Revert) ===
    if (!h.isInternal) {
        if (h.type === 'Outgoing') {
            // Ù‚Ø¨Ù„Ø§Ù‹ Ù¾ÙˆÙ„ Ú¯Ø±ÙØªÙ‡ Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø­Ø§Ù„Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ù… Ú©Ù†ÛŒÙ…
            db.cashBox[h.curr] = (db.cashBox[h.curr] || 0) - h.amt;
            // Ø§ØµÙ„Ø§Ø­ Ø¨Ø§Ú¯ Ú©Ù…ÛŒØ´Ù†: Ú©Ø³Ø± Ø§Ø² Ø§Ø±Ø² Ù…Ø®ØµÙˆØµ Ú©Ù…ÛŒØ´Ù†
            const oldCommCurr = h.commCurr || h.curr;
            if(h.comm) db.cashBox[oldCommCurr] = (db.cashBox[oldCommCurr] || 0) - h.comm;
            
        } else if (h.type === 'Incoming' && h.status === 'Done') {
            // Ù‚Ø¨Ù„Ø§Ù‹ Ù¾ÙˆÙ„ Ø¯Ø§Ø¯Ù‡ Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø­Ø§Ù„Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ…
            db.cashBox[h.curr] = (db.cashBox[h.curr] || 0) + h.amt;
        }
    }

    // === Ù…Ø±Ø­Ù„Ù‡ 2: Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯ (Ø´Ø§Ù…Ù„ Ù†Ø§Ù… Ù¾Ø¯Ø± Ùˆ ØªØ®Ù„Øµ) ===
    h.cityBook = document.getElementById('editHCityBook').value; 
    h.type = newType;
    h.amt = newAmt;
    h.curr = newCurr;
    h.comm = newComm;
    h.commCurr = newCommCurr;
    
    h.sender = document.getElementById('editHSender').value; 
    h.senderLast = document.getElementById('editHSenderLast').value; // ØªØ®Ù„Øµ
    h.senderFather = document.getElementById('editHSenderFather').value; // Ù¾Ø¯Ø±

    h.receiver = document.getElementById('editHReceiver').value; 
    h.receiverLast = document.getElementById('editHReceiverLast').value; // ØªØ®Ù„Øµ
    h.receiverFather = document.getElementById('editHReceiverFather').value; // Ù¾Ø¯Ø±

    h.phone = document.getElementById('editHPhone').value; 
    h.idCard = document.getElementById('editHIDCard').value;

    // === Ù…Ø±Ø­Ù„Ù‡ 3: Ø§Ø¹Ù…Ø§Ù„ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø±ÙˆÛŒ ØµÙ†Ø¯ÙˆÙ‚ ===
    if (!h.isInternal) {
        if (h.type === 'Outgoing') {
            db.cashBox[newCurr] = (db.cashBox[newCurr] || 0) + newAmt;
            db.cashBox[newCommCurr] = (db.cashBox[newCommCurr] || 0) + newComm;
            
        } else if (h.type === 'Incoming' && h.status === 'Done') {
            db.cashBox[newCurr] = (db.cashBox[newCurr] || 0) - newAmt;
        }
    }

    logTx('ÙˆÛŒØ±Ø§ÛŒØ´ Ø­ÙˆØ§Ù„Ù‡', `Ø§ØµÙ„Ø§Ø­ Ø­ÙˆØ§Ù„Ù‡ ${h.displayId || id}`, `Ù…Ø¨Ù„Øº Ø¬Ø¯ÛŒØ¯: ${newAmt} ${newCurr}`);
   // Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø± Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‡Ù… Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯
    dbAdapter.saveSingleHawala(h); 
    await saveDB(); 
    closeModal('modalEditHawala'); 
    filterHawala(); 
    renderDashboard(); 
    alert(`ØªØºÛŒÛŒØ±Ø§Øª Ø«Ø¨Øª Ø´Ø¯.`);
}
async function deleteHawala(id) {
    if (!currentUser.perms.admin) return; // Ú†Ú© Ú©Ø±Ø¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    const hIndex = db.hawalas.findIndex(x => x.id === id); 
    if (hIndex === -1) return; 
    const h = db.hawalas[hIndex];
    
    if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø­ÙˆØ§Ù„Ù‡ ${h.displayId || h.id} Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ\nÙ…Ø¨Ø§Ù„Øº Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚ Ú©Ø³Ø± Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.`)) return;
    
    // --- Ø´Ø±ÙˆØ¹ Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ø¨Ø§Ú¯ ---
    if (h.type === 'Outgoing' && h.status === 'Done' && !h.isInternal) {
        // 1. Ú©Ø³Ø± Ø§ØµÙ„ Ù…Ø¨Ù„Øº Ø§Ø² Ø§Ø±Ø² Ø§ØµÙ„ÛŒ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ù„Ø§Ø±)
        db.cashBox[h.curr] = (db.cashBox[h.curr] || 0) - h.amt;
        
        // 2. Ú©Ø³Ø± Ú©Ù…ÛŒØ´Ù† Ø§Ø² Ø§Ø±Ø² Ú©Ù…ÛŒØ´Ù† (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
        if (h.comm && h.comm !== 0) {
            const cCurr = h.commCurr || h.curr; // ØªØ´Ø®ÛŒØµ Ø§Ø±Ø² Ú©Ù…ÛŒØ´Ù†
            db.cashBox[cCurr] = (db.cashBox[cCurr] || 0) - h.comm;
        }

    } else if (h.type === 'Incoming' && h.status === 'Done' && !h.isInternal) {
        // Ø¨Ø±Ø§ÛŒ Ø­ÙˆØ§Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡ØŒ Ù¾ÙˆÙ„ Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯
        db.cashBox[h.curr] = (db.cashBox[h.curr] || 0) + h.amt;
    }
    // --- Ù¾Ø§ÛŒØ§Ù† Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ ---

    db.hawalas.splice(hIndex, 1); 
// Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ Ø­ÙˆØ§Ù„Ù‡ Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‡Ù… Ù¾Ø§Ú© Ø´ÙˆØ¯
    dbAdapter.deleteSingleHawala(h.id);
    
    // Ø«Ø¨Øª Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø±Ø¯Ú¯ÛŒØ±ÛŒ
    logTx('Ø­Ø°Ù Ø­ÙˆØ§Ù„Ù‡', `Deleted Hawala ${h.displayId || id}`, `Reversed: ${h.amt} ${h.curr}`);
    
    await saveDB(); 
    filterHawala(); 
    renderDashboard();
    
    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
    alert("Ø­ÙˆØ§Ù„Ù‡ Ø­Ø°Ù Ø´Ø¯ Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø§Ø±Ø² Ø§ØµÙ„Ø§Ø­ Ú¯Ø±Ø¯ÛŒØ¯.");
}
function filterHawala() {
    const hasAccess = currentUser.perms.access_group_b || currentUser.perms.admin;
    const filterCity = document.getElementById('filterHCity').value;
    const filterType = document.getElementById('filterHType').value;
    const filterStatus = document.getElementById('filterHStatus').value;
    const filterGroup = hasAccess ? document.getElementById('filterHGroup').value : 'A';

    const list = db.hawalas.filter(h => {

        if (!hasAccess && h.dataGroup === 'B') return false;


        if (hasAccess && filterGroup !== 'All') {
            const g = h.dataGroup || 'A';
            if (g !== filterGroup) return false;
        }

        return (filterCity === 'All' || h.cityBook === filterCity) && 
               (filterType === 'All' || h.type === filterType) && 
               (filterStatus === 'All' || h.status === filterStatus);
    }).sort((a, b) => b.regDate - a.regDate);

    const t = TRANSLATIONS[currentLang];
    document.getElementById('hawalaBody').innerHTML = list.map(h => {

        const groupLabel = (hasAccess && h.dataGroup === 'B') ? '<b style="color:red; font-size:10px;">(B)</b> ' : '';
        
        let opBtns = `<button class="btn btn-outline no-print" style="padding:5px 8px; font-size:12px; margin-left:5px" onclick="printH('${h.id}')">ğŸ–¨</button>`;
        if (h.status === 'Pending' && h.type === 'Incoming') opBtns += `<button class="btn btn-green no-print" style="padding:5px" onclick="execHawala('${h.id}')">âœ…</button>`; 
        if (currentUser.perms.admin) { opBtns += ` <button class="btn btn-outline" style="padding:5px" onclick="openEditHawalaModal('${h.id}')">âœï¸</button>`; opBtns += ` <button class="btn btn-red no-print" style="padding:5px" onclick="deleteHawala('${h.id}')">ğŸ—‘</button>`; }
        const commDisp = h.comm ? h.comm.toLocaleString() : '0';
        const typeLabel = h.type === 'Outgoing' ? `<span class="badge" style="background:#fff3cd; color:#856404">${t.opt_outgoing || 'Out'}</span>` : `<span class="badge" style="background:#d4edda; color:#155724">${t.opt_incoming || 'In'}</span>`;
        const statusLabel = h.status === 'Done' ? (t.opt_done || 'Done') : (t.opt_pending || 'Pending');
        
        return `<tr><td style="font-weight:900; direction:ltr">${groupLabel}${h.displayId || h.id}</td><td>${typeLabel}</td><td>${h.cityBook}</td><td dir="ltr" style="font-weight:bold">${h.amt.toLocaleString()} ${h.curr}</td><td dir="ltr" style="color:var(--text-muted); font-weight:bold">${commDisp}</td><td>${new Date(h.regDate).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US')}</td><td>${h.execDate ? new Date(h.execDate).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US') : '-'}</td><td>${statusLabel}</td><td>${opBtns}</td></tr>`;
    }).join('');
}










function setTTType(type) { 
    ttType = type; 
    document.getElementById('ttOptInternal').classList.toggle('active', type === 'internal'); 
    document.getElementById('ttOptExternal').classList.toggle('active', type === 'external'); 
    document.getElementById('ttInternalSec').style.display = type === 'internal' ? 'block' : 'none'; 
    document.getElementById('ttExternalSec').style.display = type === 'external' ? 'block' : 'none'; 
}

async function submitNewTT() {
    const amt = parseFloat(document.getElementById('ttAmt').value); 
    const curr = document.getElementById('ttCurr').value; 
    const ref = document.getElementById('ttRef').value || `TT-${Math.floor(Math.random()*10000)}`; 
    const ben = document.getElementById('ttBenName').value;
    const country = document.getElementById('ttCountry').value;
    const city = document.getElementById('ttCityDest').value;

    if (!amt || amt <= 0 || !ben) { alert('Invalid Data'); return; }

    // Ù…ØªÙ† Ù„Ø§Ú¯
    let logDesc = `Ø¯Ø±Ø®ÙˆØ§Ø³Øª TT (Ø±ÙØ±Ù†Ø³: ${ref}) | Ø°ÛŒÙ†ÙØ¹: ${ben} | Ù…Ù‚ØµØ¯: ${city}, ${country}`;

    if (ttType === 'internal') {
        const custName = document.getElementById('ttCustomer').value;
        const accId = Date.now();
        db.accounts[custName].push({ id: accId, date: Date.now(), desc: `TT Request (${ref}) - Ben: ${ben}`, curr: curr, debit: amt, credit: 0, type: 'debit' });
        
        logTx('TT (Ø­Ø³Ø§Ø¨)', `${logDesc} | Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø­Ø³Ø§Ø¨ ${custName}`, `${amt} ${curr}`, 'TT_INTERNAL', { cust: custName, accId: accId, amt: amt, curr: curr });
    } else {
        const extName = document.getElementById('ttExtName').value;
        const extPhone = document.getElementById('ttExtPhone').value;
        
        logDesc += ` | Ù…Ø´ØªØ±ÛŒ Ù†Ù‚Ø¯ÛŒ: ${extName} (${extPhone})`;
        
        db.cashBox[curr] = (db.cashBox[curr] || 0) + amt; 
        logTx('TT (Ù†Ù‚Ø¯ÛŒ)', logDesc, `Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø¯: ${amt} ${curr}`, 'TT_EXTERNAL', { amt: amt, curr: curr });
    }
    await saveDB(); renderDashboard(); alert(`TT Registered.`); 
}
function printCurrentTTForm() { 
    const amt = document.getElementById('ttAmt').value; 
    const curr = document.getElementById('ttCurr').value; 
    const t = TRANSLATIONS[currentLang];
    const win = window.open('', '_blank', 'width=900,height=1000'); 
    win.document.write(`<html><head><title>TT Form</title><style>body{font-family:'Vazirmatn';direction:${t.dir}}</style></head><body>${getPrintHeaderHTML()}<h3>TT Application</h3><div>Amount: ${amt} ${curr}</div></body></html>`); 
    win.document.close(); win.print(); 
}

function setCryptoCustType(type) {
    cryptoCustType = type;
    document.getElementById('cryptoOptInternal').classList.toggle('active', type === 'internal');
    document.getElementById('cryptoOptExternal').classList.toggle('active', type === 'external');
    document.getElementById('cryptoInternalSec').style.display = type === 'internal' ? 'block' : 'none';
}

async function submitCryptoFx() {
    const t = document.getElementById('cryptoTxType').value; 
    const n = document.getElementById('cryptoName').value; 
    const v = parseFloat(document.getElementById('cryptoAmt').value); 
    const fc = document.getElementById('cryptoCurr').value; 
    const fa = parseFloat(document.getElementById('fiatAmt').value);
    const desc = document.getElementById('cryptoDesc').value;

    if(!n || !v || !fa) { alert("Incomplete Data"); return; }

    let logData = { type: t, curr: fc, fiatAmt: fa, profit: 0, isInternal: false, cName: n, vol: v };
    const isInternal = (cryptoCustType === 'internal');
    const cust = document.getElementById('cryptoCustomer').value;

    if(isInternal && !cust) { alert("Select Customer"); return; }

    if (t === 'Buy') { 
        if (!isInternal && ((db.cashBox[fc]||0)+(db.initialCapital[fc]||0)) < fa) return alert('Low Cash'); 
        
        if (isInternal) {
            const id1 = Date.now();
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `Crypto Buy: ${v} ${n} (${desc})`, curr: fc, debit: 0, credit: fa, type: 'credit' });
            logData.isInternal = true; logData.cust = cust; logData.accId = id1;
        } else {
            db.cashBox[fc] -= fa; 
        }
        db.cashBox[n] = (db.cashBox[n] || 0) + v; 
        logTx('Ú©Ø±ÛŒÙ¾ØªÙˆ', `Buy ${v} ${n}`, `Paid ${fa} ${fc}`, 'CRYPTO', logData); 

    } else { 
        const cost = parseFloat(document.getElementById('cryptoCostBasis').value) || 0; 
        if (cost > 0) { logData.profit = fa - cost; fxProfit[fc] = (fxProfit[fc] || 0) + logData.profit; } 
        
        if (isInternal) {
            const id1 = Date.now();
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `Crypto Sell: ${v} ${n} (${desc})`, curr: fc, debit: fa, credit: 0, type: 'debit' });
            logData.isInternal = true; logData.cust = cust; logData.accId = id1;
        } else {
            db.cashBox[fc] += fa; 
        }
        db.cashBox[n] = (db.cashBox[n] || 0) - v; 
        logTx('Ú©Ø±ÛŒÙ¾ØªÙˆ', `Sell ${v} ${n}`, `Recvd ${fa} ${fc}`, 'CRYPTO', logData); 
    }

    if (!db.currencies.includes(n)) db.currencies.push(n); 
    await saveDB(); renderDashboard(); alert('Crypto Deal Saved.');
}

function printCryptoFx() { 
    const win = window.open('', '_blank', 'width=500,height=600'); 
    win.document.write(`<html><head><title>Crypto</title><style>body{font-family:'Vazirmatn';direction:${TRANSLATIONS[currentLang].dir}}</style></head><body>${getPrintHeaderHTML()}<h3>Crypto Receipt</h3></body></html>`); 
    win.document.close(); win.print(); 
}

async function addCustomer() { 
    // ... (Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ)
    db.customers.push({ name: n, phone: document.getElementById('newCustPhone').value }); 
    db.accounts[n] = []; 
    
    // Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¯Ø± General
    await saveDB(); 
    // Ø§ÛŒØ¬Ø§Ø¯ Ø³Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ú©Ø§Ù„Ú©Ø´Ù† Ø¬Ø¯ÛŒØ¯
    await dbAdapter.saveCustomerAccount(n, []);
    
    closeModal('modalNewCust'); updateUI(); alert("Added."); 
}

async function openEditCustomerModal() { 
    const custName = document.getElementById('selCustomer').value; 
    if (!custName) return; 
    
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù‡ Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ù„Ø§Ø²Ù… Ø§Ø³Øª)
    if (!db.accounts[custName]) {
         db.accounts[custName] = await dbAdapter.loadSingleAccount(custName);
    }

    const custObj = db.customers.find(c => c.name === custName); 
    document.getElementById('editCustName').value = custObj.name; 
    document.getElementById('editCustPhone').value = custObj.phone || ''; 
    openModal('modalEditCust'); 
}
async function submitEditCustomer() { const oldName = document.getElementById('selCustomer').value; const newName = document.getElementById('editCustName').value.trim(); if (!newName) return; const custIndex = db.customers.findIndex(c => c.name === oldName); if (custIndex !== -1) { db.customers[custIndex].name = newName; db.customers[custIndex].phone = document.getElementById('editCustPhone').value.trim(); } if (newName !== oldName && db.accounts[oldName]) { db.accounts[newName] = db.accounts[oldName]; delete db.accounts[oldName]; } await saveDB(); closeModal('modalEditCust'); updateUI(); document.getElementById('selCustomer').value = newName; loadCustomerLedger(); alert('Edited.'); }

async function submitTx() {
    // ... (Ú©Ø¯Ù‡Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ù…Ø«Ù„ Ù‚Ø¨Ù„ Ø¨Ù…Ø§Ù†Ø¯)
    const c = document.getElementById('txCust').value; 
    const t = document.getElementById('txType').value; 
    const a = parseFloat(document.getElementById('txAmt').value); 
    const cur = document.getElementById('txCurr').value; 
    const d = document.getElementById('txDesc').value.trim();
    
    if (!c || !a || a <= 0) { alert("Data Error"); return; }
    
    // ... (Ú©Ø¯ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ Ù…Ø«Ù„ Ù‚Ø¨Ù„ Ø¨Ù…Ø§Ù†Ø¯)
    const typeText = t === 'debit' ? 'Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø­Ø³Ø§Ø¨ (Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯)' : 'ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø­Ø³Ø§Ø¨ (Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø¯)';
    const logDetail = `${typeText} Ù…Ø´ØªØ±ÛŒ: ${c} | ØªÙˆØ¶ÛŒØ­Ø§Øª: ${d}`;

    // ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚
    if (t === 'debit') { 
        if (((db.cashBox[cur]||0) + (db.initialCapital[cur]||0)) < a) { alert('Low Cash'); return; } 
        db.cashBox[cur] -= a; 
    } else { 
        db.cashBox[cur] += a; 
    }
    
    const accId = Date.now();
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
    if(!db.accounts[c]) db.accounts[c] = [];
    db.accounts[c].push({ id: accId, date: Date.now(), desc: d, curr: cur, debit: t === 'debit' ? a : 0, credit: t === 'credit' ? a : 0, type: t });
    
    // Ø«Ø¨Øª Ù„Ø§Ú¯ (Ø®ÙˆØ¯ Ù„Ø§Ú¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    logTx('ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø³Ø§Ø¨', logDetail, `${a} ${cur}`, 'TX', { type: t, cust: c, accId: accId, amt: a, curr: cur }); 
    
    // *** ØªØºÛŒÛŒØ± Ù…Ù‡Ù…: Ø°Ø®ÛŒØ±Ù‡ ÙÙ‚Ø· Ø­Ø³Ø§Ø¨ Ù‡Ù…ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³ ***
    await dbAdapter.saveCustomerAccount(c, db.accounts[c]);
    
    // Ø°Ø®ÛŒØ±Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ú†ÙˆÙ† ØµÙ†Ø¯ÙˆÙ‚ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡)
    await saveDB(); 

    closeModal('modalTx'); loadCustomerLedger(); renderDashboard(); alert("Saved.");
}

async function loadCustomerLedger() {
    const c = document.getElementById('selCustomer').value; 
    const div = document.getElementById('ledgerCard');
    
    if (!c) { div.style.display = 'none'; return; }
    
    // Ø¨Ø±Ø±Ø³ÛŒ: Ø¢ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ
    if (!db.accounts[c]) {
        // Ø§Ú¯Ø± Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø§Ù„Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù† (Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø§Ù†ØªØ¸Ø§Ø±)
        document.getElementById('ledgerName').innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...";
        const downloadedList = await dbAdapter.loadSingleAccount(c);
        db.accounts[c] = downloadedList; // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ
    }

    div.style.display = 'block'; 
    const custObj = db.customers.find(customer => customer.name === c);
    document.getElementById('ledgerName').innerText = c;
    document.getElementById('ledgerPhone').innerText = custObj ? `(${custObj.phone || ''})` : '';
    
    const list = db.accounts[c] || []; 
    list.sort((a, b) => a.date - b.date); 
    
    const bal = {};
    const t = TRANSLATIONS[currentLang]; // Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ TRANSLATIONS Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª
    
    document.getElementById('ledgerBody').innerHTML = list.map(x => {
        bal[x.curr] = (bal[x.curr] || 0) + (x.credit - x.debit);
        return `<tr>
            <td>${new Date(x.date).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US')}</td>
            <td>${escapeHtml(x.desc)}</td>
            <td>${x.curr}</td>
            <td class="${x.debit > 0 ? 'text-red' : ''}">${x.debit > 0 ? x.debit.toLocaleString() : '-'}</td>
            <td class="${x.credit > 0 ? 'text-green' : ''}">${x.credit > 0 ? x.credit.toLocaleString() : '-'}</td>
            <td dir="ltr" style="font-weight:bold">${bal[x.curr].toLocaleString()}</td>
            <td class="no-print"><button class="btn btn-red admin-only-col" style="padding:2px 5px; font-size:10px" onclick="delTx('${c}',${x.id})">x</button></td>
        </tr>`;
    }).join('');
    
    let s = ''; 
    for (let k in bal) {
        if (Math.abs(bal[k]) > 0.1) {
            s += `<span class="${bal[k] > 0 ? 'text-red' : 'text-green'}" style="margin-right:10px">${bal[k].toLocaleString()} ${k}</span>`;
        }
    }
    document.getElementById('ledgerFinalSum').innerHTML = s || '0'; 
    applyPermissions();
}
async function delTx(c, id) { if (!currentUser.perms.admin || !confirm('Delete?')) return; const idx = db.accounts[c].findIndex(x => x.id === id); const tx = db.accounts[c][idx]; if (tx.type === 'debit') db.cashBox[tx.curr] += tx.debit; else db.cashBox[tx.curr] -= tx.credit; db.accounts[c].splice(idx, 1); await saveDB(); loadCustomerLedger(); renderDashboard(); }
async function deleteCustomer() { const c = document.getElementById('selCustomer').value; if (!c || !confirm('Delete Customer?')) return; delete db.accounts[c]; db.customers = db.customers.filter(cust => cust.name !== c); await saveDB(); updateUI(); document.getElementById('ledgerCard').style.display = 'none'; }
function openModalClientTransfer() { const s = document.getElementById('selCustomer').value; if(!s) { alert("Select Source"); return; } document.getElementById('ctSender').innerText = s; openModal('modalClientTransfer'); }
async function submitClientTransfer() {
    // ... (Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª)
    
    // Ø¨Ø¹Ø¯ Ø§Ø² push Ú©Ø±Ø¯Ù† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ db.accounts[s] Ùˆ db.accounts[r]:
    
    // Ø°Ø®ÛŒØ±Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù‡Ø± Ø¯Ùˆ Ø·Ø±Ù Ø­Ø³Ø§Ø¨
    await dbAdapter.saveCustomerAccount(s, db.accounts[s]);
    await dbAdapter.saveCustomerAccount(r, db.accounts[r]);
    
    // Ø°Ø®ÛŒØ±Ù‡ Ù„Ø§Ú¯ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
    // logTx Ø®ÙˆØ¯Ø´ Ø°Ø®ÛŒØ±Ù‡ Ù„Ø§Ú¯ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
    await saveDB(); 
    
    closeModal('modalClientTransfer'); alert('Done'); loadCustomerLedger();
}
function setExType(type) { 
    exType = type; 
    document.getElementById('exOptInternal').classList.toggle('active', type === 'internal'); 
    document.getElementById('exOptExternal').classList.toggle('active', type === 'external'); 
    

    document.getElementById('exInternalSec').style.display = type === 'internal' ? 'block' : 'none'; 

    const extSec = document.getElementById('exExternalSec');
    if(extSec) extSec.style.display = type === 'external' ? 'block' : 'none';
}

function setFxDirection(dir) { 
    fxDirection = dir; 
    document.getElementById('btnFxBuy').classList.remove('active', 'buy'); 
    document.getElementById('btnFxSell').classList.remove('active', 'sell'); 
    if (dir === 'Buy') { 
        document.getElementById('btnFxBuy').classList.add('active', 'buy'); 
        document.getElementById('fxDirText').innerText = currentLang === 'fa' ? "Ù…Ø§ Ù…ÛŒâ€ŒØ®Ø±ÛŒÙ… (Ø§Ø±Ø² Ù¾Ø§ÛŒÙ‡ ÙˆØ§Ø±Ø¯ ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯)" : "We Buy (Base Currency IN)"; 
        document.getElementById('fxDirText').style.color = "var(--success)"; 
    } else { 
        document.getElementById('btnFxSell').classList.add('active', 'sell'); 
        document.getElementById('fxDirText').innerText = currentLang === 'fa' ? "Ù…Ø§ Ù…ÛŒâ€ŒÙØ±ÙˆØ´ÛŒÙ… (Ø§Ø±Ø² Ù¾Ø§ÛŒÙ‡ Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø§ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯)" : "We Sell (Base Currency OUT)"; 
        document.getElementById('fxDirText').style.color = "var(--danger)"; 
    } 
    calcFx(); 
}
function toggleFxOperator() { fxOperator = fxOperator === 'multiply' ? 'divide' : 'multiply'; document.getElementById('fxOpDisplay').innerText = fxOperator === 'multiply' ? 'âœ–' : 'â—'; calcFx(); }

function calcFx() { 
    const baseAmt = parseFloat(document.getElementById('fxBaseAmt').value) || 0; 
    const rate = parseFloat(document.getElementById('fxRate').value) || 1; 
    const quoteCurr = document.getElementById('fxQuoteCurr').value; 
    const baseCurr = document.getElementById('fxBaseCurr').value; 

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ
    let quoteAmt = 0; 
    if (rate !== 0) { 
        if (fxOperator === 'multiply') quoteAmt = baseAmt * rate; 
        else quoteAmt = baseAmt / rate; 
    } 
    document.getElementById('fxQuoteAmt').value = quoteAmt.toFixed(2); 

    if (fxDirection === 'Sell') {
        let avgBuyRate = db.avgRates ? db.avgRates[baseCurr] : 0;

        /* Ù†Ú©ØªÙ‡: Ú†ÙˆÙ† Ø¯Ø± ØªØ§Ø¨Ø¹ setInitialCapital Ù…Ø§ Ù†Ø±Ø® Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± avgRates Ù…ÛŒØ±ÛŒØ²ÛŒÙ…ØŒ 
           Ù‡Ù…Ø§Ù† Ø®Ø· Ø¨Ø§Ù„Ø§ Ú©Ø§ÙÛŒØ³Øª. Ø§Ù…Ø§ Ù…Ø­Ø¶ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ú†Ú© Ù…ÛŒÚ©Ù†ÛŒÙ… */
        
        if (avgBuyRate && avgBuyRate > 0) {
            document.getElementById('exCostBasis').value = avgBuyRate.toFixed(4); 
            
            let totalCost = 0;
            if (avgBuyRate > 2) totalCost = baseAmt / avgBuyRate; 
            else totalCost = baseAmt * avgBuyRate;
            
            const estProfit = quoteAmt - totalCost;
            
            const profitEl = document.getElementById('estimatedProfit');
            profitEl.innerText = estProfit.toLocaleString(undefined, {maximumFractionDigits: 2}) + " " + quoteCurr;
            
            if(estProfit >= 0) {
                profitEl.style.color = "var(--success)";
                profitEl.innerHTML += " (Ø³ÙˆØ¯)";
            } else {
                profitEl.style.color = "var(--danger)";
                profitEl.innerHTML += " (Ø²ÛŒØ§Ù†)";
            }
        } else {
            document.getElementById('estimatedProfit').innerText = "Ù†Ø±Ø® Ø®Ø±ÛŒØ¯ Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª (ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯)";
            document.getElementById('estimatedProfit').style.color = "orange";
            document.getElementById('exCostBasis').placeholder = "Ù†Ø±Ø® Ø¯Ø³ØªÛŒØŸ";
        }
    } else {
        // Ø¯Ø± Ø­Ø§Ù„Øª Ø®Ø±ÛŒØ¯ØŒ Ø³ÙˆØ¯ Ù…Ø¹Ù†ÛŒ Ù†Ø¯Ø§Ø±Ø¯ Ú†ÙˆÙ† Ø¯Ø§Ø±ÛŒÙ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        document.getElementById('estimatedProfit').innerText = "---";
        document.getElementById('exCostBasis').value = ""; 
    }
}

async function submitExchange() {
    const baseAmt = parseFloat(document.getElementById('fxBaseAmt').value); 
    const quoteAmt = parseFloat(document.getElementById('fxQuoteAmt').value); 
    const baseCurr = document.getElementById('fxBaseCurr').value; 
    const quoteCurr = document.getElementById('fxQuoteCurr').value; 
    const desc = document.getElementById('exDesc').value; 
    
    if (!baseAmt || baseAmt <= 0 || !quoteAmt || baseCurr === quoteCurr) { 
        alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª"); return; 
    }

    if (!db.avgRates) db.avgRates = {};
    let profit = 0; 
    let effectiveRate = (baseAmt > 0) ? (quoteAmt / baseAmt) : 0;

    if (fxDirection === 'Sell') {
        const avgBuyRate = db.avgRates[baseCurr] || 0;
        if (avgBuyRate > 0) {
            let costOfSoldItems = 0;
            if (avgBuyRate > 2) costOfSoldItems = baseAmt / avgBuyRate;
            else costOfSoldItems = baseAmt * avgBuyRate;
            profit = quoteAmt - costOfSoldItems;
        } else {
            profit = 0;
        }
    }

    if (fxDirection === 'Buy') {
        const currentQty = (db.cashBox[baseCurr] || 0) + (db.initialCapital[baseCurr] || 0);
        const currentRate = db.avgRates[baseCurr] || 0;
        
        let currentTotalValue = 0;
        if(currentRate > 0) {
            if(currentRate > 2) currentTotalValue = currentQty / currentRate;
            else currentTotalValue = currentQty * currentRate;
        }
        const newTradeValue = quoteAmt; 
        const newTotalQty = currentQty + baseAmt;

        if (newTotalQty > 0) {
            const newTotalValue = currentTotalValue + newTradeValue;
            let newAvgRate = 0;
            if (fxOperator === 'divide' || (quoteAmt > baseAmt * 2)) {
                 newAvgRate = newTotalValue / newTotalQty; 
            } else {
                 newAvgRate = newTotalValue / newTotalQty;
            }
            db.avgRates[baseCurr] = newAvgRate;
        }
    }


    const logData = { 
        baseCurr, baseAmt, quoteCurr, quoteAmt, 
        direction: fxDirection, 
        profit: profit, 
        rate: effectiveRate,
        isInternal: false 
    };

    let actionType = fxDirection === 'Buy' ? 'Ø®Ø±ÛŒØ¯' : 'ÙØ±ÙˆØ´';
    let logDetail = "";
    
    if (exType === 'internal') {
        const cust = document.getElementById('exCustomer').value; 
        const id1 = Date.now(); const id2 = Date.now() + 1;
        if (fxDirection === 'Buy') {
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `ÙØ±ÙˆØ´ Ø§Ø±Ø² Ø¨Ù‡ ØµØ±Ø§ÙÛŒ`, curr: baseCurr, debit: baseAmt, credit: 0, type: 'debit' });
            db.accounts[cust].push({ id: id2, date: Date.now(), desc: `Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¹Ø§Ø¯Ù„`, curr: quoteCurr, debit: 0, credit: quoteAmt, type: 'credit' });
            db.cashBox[baseCurr] = (db.cashBox[baseCurr] || 0) + baseAmt; 
        } else {
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `Ø®Ø±ÛŒØ¯ Ø§Ø±Ø² Ø§Ø² ØµØ±Ø§ÙÛŒ`, curr: baseCurr, debit: 0, credit: baseAmt, type: 'credit' });
            db.accounts[cust].push({ id: id2, date: Date.now(), desc: `Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø¹Ø§Ø¯Ù„`, curr: quoteCurr, debit: quoteAmt, credit: 0, type: 'debit' });
            db.cashBox[baseCurr] = (db.cashBox[baseCurr] || 0) - baseAmt; 
        }
        logData.isInternal = true; logData.cust = cust; logData.accId1 = id1; logData.accId2 = id2;
        logDetail = `${actionType} (Ø­Ø³Ø§Ø¨): ${baseAmt} ${baseCurr} - Ù…Ø´ØªØ±ÛŒ: ${cust}`;
    } else {

        const exName = document.getElementById('exExtName').value || "Ù†Ù‚Ø¯ÛŒ";
        if (fxDirection === 'Buy') { 
            db.cashBox[baseCurr] = (db.cashBox[baseCurr] || 0) + baseAmt; 
            db.cashBox[quoteCurr] = (db.cashBox[quoteCurr] || 0) - quoteAmt; 
        } else { 
            db.cashBox[baseCurr] = (db.cashBox[baseCurr] || 0) - baseAmt; 
            db.cashBox[quoteCurr] = (db.cashBox[quoteCurr] || 0) + quoteAmt; 
        }
        logDetail = `${actionType}: ${baseAmt} ${baseCurr} (Ù†Ø±Ø®: ${db.avgRates[baseCurr]?.toFixed(1) || '-'}) | Ù…Ø´ØªØ±ÛŒ: ${exName}`;
    }

    logTx('ØµØ±Ø§ÙÛŒ', logDetail, `${quoteAmt} ${quoteCurr}`, 'EXCHANGE', logData);
    await saveDB(); 
    renderDashboard(); 
    

    printExchangeReceipt();    
}

function printHawalaList() {
    const filterCity = document.getElementById('filterHCity').value;
    const filterType = document.getElementById('filterHType').value;
    const filterStatus = document.getElementById('filterHStatus').value;

    if (filterType === 'All') {
        alert("Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ (Ø§Ø±Ø³Ø§Ù„ÛŒ ÛŒØ§ Ø¯Ø±ÛŒØ§ÙØªÛŒ) Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ Ú©ØªØ§Ø¨ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.");
        return;
    }

    const filtered = db.hawalas.filter(h =>
        (filterCity === 'All' || h.cityBook === filterCity) &&
        (h.type === filterType) &&
        (filterStatus === 'All' || h.status === filterStatus)
    ).sort((a, b) => a.regDate - b.regDate);

    if (filtered.length === 0) {
        alert("Ù‡ÛŒÚ† Ø­ÙˆØ§Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.");
        return;
    }

    const presentCurrencies = [...new Set(filtered.map(h => h.curr))];

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ù…Ø¹ Ú©Ù„
    let amountTotals = {};
    let commTotals = {}; 
    presentCurrencies.forEach(c => amountTotals[c] = 0);

    filtered.forEach(h => {
        if (amountTotals[h.curr] !== undefined) amountTotals[h.curr] += h.amt;
        else amountTotals[h.curr] = h.amt;

        if(h.comm && h.comm !== 0) {
            const cCurr = h.commCurr || h.curr;
            if(!commTotals[cCurr]) commTotals[cCurr] = 0;
            commTotals[cCurr] += h.comm;
        }
    });

    // Ù‡Ø¯Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²
    let currencyHeaders = presentCurrencies.map(c => 
        `<th style="background:#ddd !important; border-bottom:2px solid #000; min-width:80px;">Ù…Ø¨Ù„Øº (${c})</th>`
    ).join('');

    // Ø³Ø§Ø®Øª Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§
    const tableRows = filtered.map((h, i) => {
        // Ø³Ø§Ø®Øª Ø¨Ù„ÙˆÚ© ÙØ±Ø³ØªÙ†Ø¯Ù‡ - Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ ÙˆØ¬ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        let sInfo = `<div class="main-txt">${h.sender} ${h.senderLast||''}</div>`;
        if(h.senderFather) sInfo += `<div class="sub-txt">ÙˆÙ„Ø¯: ${h.senderFather}</div>`;
        if(h.senderPhone)  sInfo += `<div class="sub-txt">ØªÙ„ÙÙ†: ${h.senderPhone}</div>`;
        if(h.senderID)     sInfo += `<div class="sub-txt">ID: ${h.senderID}</div>`;

        // Ø³Ø§Ø®Øª Ø¨Ù„ÙˆÚ© Ú¯ÛŒØ±Ù†Ø¯Ù‡
        let rInfo = `<div class="main-txt">${h.receiver} ${h.receiverLast||''}</div>`;
        if(h.receiverFather) rInfo += `<div class="sub-txt">ÙˆÙ„Ø¯: ${h.receiverFather}</div>`;
        if(h.receiverPhone)  rInfo += `<div class="sub-txt">ØªÙ„ÙÙ†: ${h.receiverPhone}</div>`;
        if(h.receiverID)     rInfo += `<div class="sub-txt">ID: ${h.receiverID}</div>`;

        // Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø¨Ù„Øº
        const amountCells = presentCurrencies.map(curr => {
            if (h.curr === curr) {
                return `<td style="text-align:center; font-weight:bold; font-size:12px; vertical-align:middle;">${h.amt.toLocaleString()}</td>`;
            } else {
                return `<td style="text-align:center; background:#f5f5f5; color:#ccc; vertical-align:middle;">-</td>`;
            }
        }).join('');

        const commText = h.comm ? `<span dir="ltr">${h.comm.toLocaleString()} ${h.commCurr||h.curr}</span>` : '0';
        const dateStr = h.execDate ? new Date(h.execDate).toLocaleDateString('fa-IR') : (new Date(h.regDate).toLocaleDateString('fa-IR') + ' (Ø«Ø¨Øª)');

        return `
            <tr>
                <td style="text-align:center; vertical-align:middle;">${i + 1}</td>
                <td style="text-align:center; vertical-align:middle; font-weight:bold;">${h.displayId || h.bookNum}</td>
                <td style="padding:4px 8px; text-align:right; vertical-align:top;">${sInfo}</td>
                <td style="padding:4px 8px; text-align:right; vertical-align:top;">${rInfo}</td>
                ${amountCells}
                <td style="text-align:center; vertical-align:middle;">${commText}</td>
                <td style="text-align:center; vertical-align:middle; font-size:10px;">${h.receiverPurpose || h.senderPurpose || '-'}</td>
                <td style="text-align:center; vertical-align:middle; font-size:11px;">${dateStr}</td>
            </tr>
        `;
    }).join('');

    // Ø¨Ø®Ø´ Ø¬Ù…Ù„Ù‡ Ø´Ø¯
    let summaryAmountsHtml = presentCurrencies.map(c => 
        `<div class="sum-box">Ø¬Ù…Ù„Ù‡ Ø´Ø¯ ${c}: <b dir="ltr">${amountTotals[c].toLocaleString()}</b></div>`
    ).join('');

    let summaryCommsHtml = '';
    const cKeys = Object.keys(commTotals);
    if(cKeys.length > 0) {
        summaryCommsHtml = cKeys.map(c => `<b dir="ltr">${commTotals[c].toLocaleString()}</b> ${c}`).join(' + ');
    } else {
        summaryCommsHtml = '0';
    }

    const title = filterType === 'Outgoing' ? 'Ú©ØªØ§Ø¨ Ø­ÙˆØ§Ù„Ø¬Ø§Øª Ø§Ø±Ø³Ø§Ù„ÛŒ' : 'Ú©ØªØ§Ø¨ Ø­ÙˆØ§Ù„Ø¬Ø§Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ';
    
    const win = window.open('', '_blank', 'width=1200,height=800');
    win.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="fa">
        <head>
            <title>${title}</title>
            <style>
                @page { size: A4 landscape; margin: 10mm; }
                body { font-family: 'Tahoma', 'Vazirmatn', sans-serif; background: #fff; padding: 10px; margin: 0; color: #000; }
                
                .header-box {
                    display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
                    border: 2px solid #000; background: #f9f9f9; border-radius: 8px;
                    padding: 10px; margin-bottom: 15px; align-items: center;
                }
                .sum-box { 
                    border: 1px solid #000; padding: 5px 15px; background: #fff; 
                    font-size: 14px; font-weight:bold; box-shadow: 2px 2px 0 #ccc;
                }
                
                table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top:10px; }
                th, td { border: 1px solid #000; padding: 4px; }
                th { background: #e0e0e0; text-align: center; padding: 8px 0; -webkit-print-color-adjust: exact; }
                
                /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø²ÛŒØ± Ù‡Ù… */
                .main-txt { font-weight: bold; font-size: 12px; margin-bottom: 3px; border-bottom: 1px dotted #999; display:block; }
                .sub-txt { font-size: 11px; color: #444; margin-top: 1px; display:block; }

                @media print {
                    body { margin: 0; }
                    .header-box { background: none !important; border: 2px solid #000; }
                    .sum-box { box-shadow: none; border: 1px solid #000; }
                    th { background: #ccc !important; }
                    td { background: transparent !important; }
                }
            </style>
        </head>
        <body>
            ${getPrintHeaderHTML()}
            <h3 style="text-align:center; margin:0 0 10px 0;">${title} - Ø´Ù‡Ø±: ${filterCity === 'All' ? 'Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§' : filterCity}</h3>

            <div class="header-box">
                ${summaryAmountsHtml}
                <div class="sum-box" style="border-color:red;">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù…ÛŒØ´Ù†: ${summaryCommsHtml}</div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width:30px">#</th>
                        <th style="width:70px">Ø´Ù…Ø§Ø±Ù‡</th>
                        <th style="width:18%">Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø³ØªÙ†Ø¯Ù‡</th>
                        <th style="width:18%">Ù…Ø´Ø®ØµØ§Øª Ú¯ÛŒØ±Ù†Ø¯Ù‡</th>
                        ${currencyHeaders}
                        <th style="width:80px">Ú©Ù…ÛŒØ´Ù†</th>
                        <th style="width:12%">ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                        <th style="width:70px">ØªØ§Ø±ÛŒØ®</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
            <div style="margin-top:10px; font-size:10px;">ØªØ§Ø±ÛŒØ® Ú†Ø§Ù¾: ${new Date().toLocaleDateString('fa-IR')} | Ú©Ø§Ø±Ø¨Ø±: ${currentUser ? currentUser.u : '-'}</div>
        </body>
        </html>
    `);

    win.document.close();
    win.focus();
    setTimeout(() => { win.print(); }, 500); 
}

function printH(id) {
    const h = db.hawalas.find(x => x.id === id); 
    if (!h) { alert('Ø­ÙˆØ§Ù„Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.'); return; }
    
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù‡Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ùˆ ØªÙ…Ø§Ø³
    const cityObj = db.cities.find(c => c.code === h.cityBook);
    // Ù†Ø§Ù… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ (Ù…Ø«Ù„Ø§Ù‹ ØµØ±Ø§ÙÛŒ ØµØ¯Ø§Ù‚Øª)
    const repName = cityObj && cityObj.rep ? cityObj.rep : '---';
    // Ø¢Ø¯Ø±Ø³ Ùˆ ØªÙ„ÙÙ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡
    const repContact = cityObj && cityObj.contact ? cityObj.contact : ''; 
    const cityName = cityObj ? cityObj.name : h.cityBook;

    const amtInWords = numberToPersianWords(h.amt) + " " + h.curr;
    const win = window.open('', '_blank', 'width=1000,height=1200');
    
    let content = '';

    if (h.type === 'Outgoing') {
        // --- Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡: Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ù…Ø´Ø®ØµØ§Øª ØµØ±Ø§ÙÛŒ Ø§Ø¬Ø±Ø§ Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ø±Ø³ÛŒØ¯ ---
        content = `
        <html><head><title>${h.displayId}</title>
        <style>
            @page { size: 80mm auto; margin: 0; } 
            body { font-family: 'Vazirmatn', Tahoma; direction: rtl; padding: 10px 5px; font-size: 10pt; width: 78mm; } 
            .line { display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 5px 0; } 
            .center { text-align: center; } 
            .big { font-size: 14pt; font-weight: bold; }
            .footer-rep { 
                margin-top: 15px; 
                border-top: 2px solid #000; 
                padding-top: 5px; 
                text-align: center; 
                background: #f0f0f0; 
                border-radius: 5px; 
                padding: 10px;
            }
            .rep-label { font-size: 9pt; font-weight: bold; margin-bottom: 5px; }
            .rep-val { font-size: 11pt; font-weight: 900; }
            .rep-addr { font-size: 9pt; margin-top: 5px; }
        </style>
        </head><body>
            ${getPrintHeaderHTML()}
            <div class="center">Ø±Ø³ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø­ÙˆØ§Ù„Ù‡</div>
            <div class="center big">${h.displayId}</div><br>
            <div class="line"><span>ØªØ§Ø±ÛŒØ®:</span><span>${new Date(h.regDate).toLocaleDateString('fa-IR')}</span></div>
            <div class="line"><span>ÙØ±Ø³ØªÙ†Ø¯Ù‡:</span><span>${h.sender} ${h.senderLast||''}</span></div>
            <div class="line"><span>Ú¯ÛŒØ±Ù†Ø¯Ù‡:</span><span>${h.receiver} ${h.receiverLast||''}</span></div>
            <div class="line"><span>Ù…Ù‚ØµØ¯:</span><span>${cityName}</span></div>
            <div class="line"><span>Ù…Ø¨Ù„Øº:</span><span class="big" dir="ltr">${h.amt.toLocaleString()} ${h.curr}</span></div>
            <div class="line"><span>Ú©Ù…ÛŒØ´Ù†:</span><span>${h.comm} ${h.commCurr || h.curr}</span></div>
            <div style="text-align:center; margin-top:10px; font-size:9pt; font-weight:bold;">${amtInWords}</div><br>
            
            <div style="display:flex; justify-content:space-between; margin-top:20px; margin-bottom:20px;">
                 <div style="text-align:center; width:45%;">Ø§Ù…Ø¶Ø§Ø¡ Ù…Ø´ØªØ±ÛŒ</div>
                 <div style="text-align:center; width:45%;">Ø§Ù…Ø¶Ø§Ø¡ Ù…ØªØµØ¯ÛŒ</div>
            </div>

            <div class="footer-rep">
                <div class="rep-label">ØµØ±Ø§ÙÛŒ/Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø± ${cityName}:</div>
                <div class="rep-val">${repName}</div>
                <div class="rep-addr">${repContact}</div>
            </div>
            <br>.
        </body></html>`;
    } else {
        // --- Ø±Ø³ÛŒØ¯ Ø­ÙˆØ§Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
        content = `
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <meta charset="utf-8">
            <title>${h.displayId}</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap');
                @page { size: A4; margin: 0; }
                body { font-family: 'Vazirmatn', 'Tahoma', sans-serif; background: white; margin: 0; padding: 40px; color: #222; }
                .voucher-container { width: 100%; max-width: 210mm; border: 2px solid #333; border-radius: 12px; padding: 30px; box-sizing: border-box; position: relative; }
                .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 25px; }
                .doc-title { font-size: 24px; font-weight: 900; color: #000; letter-spacing: -1px; border: 2px solid #000; padding: 8px 30px; border-radius: 50px; background: #fff; }
                .meta-info { text-align: left; font-size: 13px; line-height: 1.6; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
                .info-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; }
                .box-header { font-size: 14px; font-weight: 900; color: #555; border-bottom: 1px dashed #ddd; padding-bottom: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; }
                .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
                .label { color: #777; font-weight: 500; }
                .value { font-weight: 700; color: #000; }
                .amount-panel { background: #f4f4f4; border-radius: 10px; padding: 12px 25px; text-align: center; border: 1px solid #ccc; margin-bottom: 30px; }
                .amount-row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
                .amt-label { font-size: 13px; color: #666; font-weight:bold; }
                .amt-digit { font-size: 24px; font-weight: 900; font-family: 'Courier New', monospace; color: #000; direction: ltr; letter-spacing: 1px; }
                .amt-text { font-size: 14px; font-weight: bold; color: #333; border-top: 1px dashed #bbb; padding-top: 5px; margin-top: 2px; }
                .footer-grid { display: flex; justify-content: space-around; margin-top: 20px; }
                .sign-box { text-align: center; width: 200px; }
                .sign-title { font-weight: bold; font-size: 14px; margin-bottom: 60px; }
                .sign-line { border-top: 1px solid #000; width: 100%; display: block; }
                
                .rep-footer { 
                    margin-top: 20px; 
                    padding-top: 10px; 
                    border-top: 1px dashed #ccc; 
                    text-align: center; 
                    font-size: 12px; 
                    color: #444; 
                    background: #fdfdfd;
                    border-radius: 0 0 10px 10px;
                }
                .rep-name { font-weight: 900; font-size: 14px; color: #000; }
                .rep-contact { font-size: 11px; margin-top: 3px; color: #555; }
                
                @media print { body { -webkit-print-color-adjust: exact; } }
            </style>
        </head>
        <body>
            <div class="voucher-container">
                <div class="header-section">
                    <div style="flex:1">${getPrintHeaderHTML()}</div>
                    <div style="flex:1; text-align:center;">
                        <div class="doc-title">Ø±Ø³ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÙˆÙ„ Ø­ÙˆØ§Ù„Ù‡ </div>
                        <div style="font-size:12px; color:#666; margin-top:5px;">INCOMING TRANSFER VOUCHER</div>
                    </div>
                    <div class="meta-info" style="flex:1">
                        <div class="meta-item">Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯: <b style="font-size:16px;">${h.displayId}</b></div>
                        <div class="meta-item">ØªØ§Ø±ÛŒØ® Ø§Ø¬Ø±Ø§: <b>${new Date().toLocaleDateString('fa-IR')}</b></div>
                        <div class="meta-item">ÙˆØ¶Ø¹ÛŒØª: <b>Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ (ØªØ³ÙˆÛŒÙ‡)</b></div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <div class="box-header"><span>Ù…Ø´Ø®ØµØ§Øª (Ú¯ÛŒØ±Ù†Ø¯Ù‡)</span><span>BENEFICIARY</span></div>
                        <div class="row"><span class="label">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</span><span class="value">${h.receiver} ${h.receiverLast||''}</span></div>
                        <div class="row"><span class="label">Ù†Ø§Ù… Ù¾Ø¯Ø±:</span><span class="value">${h.receiverFather||'-'}</span></div>
                        <div class="row"><span class="label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span><span class="value" dir="ltr">${h.receiverPhone||'-'}</span></div>
                        <div class="row"><span class="label">Ø´Ù…Ø§Ø±Ù‡ ØªØ°Ú©Ø±Ù‡/ID:</span><span class="value">${h.receiverID||'-'}</span></div>
                    </div>
                    <div class="info-box">
                        <div class="box-header"><span>Ù…Ø´Ø®ØµØ§Øª ÙØ±Ø³ØªÙ†Ø¯Ù‡</span><span>SENDER</span></div>
                        <div class="row"><span class="label">Ù†Ø§Ù… ÙØ±Ø³ØªÙ†Ø¯Ù‡:</span><span class="value">${h.sender} ${h.senderLast||''}</span></div>
                        <div class="row"><span class="label">Ø´Ù‡Ø± Ù…Ø¨Ø¯Ø£:</span><span class="value">${cityName}</span></div>
                        <div class="row"><span class="label">Ø¨Ø§Ø¨Øª / ØªÙˆØ¶ÛŒØ­Ø§Øª:</span><span class="value">${h.receiverPurpose || h.senderPurpose || '-'}</span></div>
                        <div class="row"><span class="label">ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±:</span><span class="value">${new Date(h.regDate).toLocaleDateString('fa-IR')}</span></div>
                    </div>
                </div>

                <div class="amount-panel">
                    <div class="amount-row-top">
                        <span class="amt-label">Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ / AMOUNT RECEIVED</span>
                        <span class="amt-digit">*** ${h.amt.toLocaleString()} ${h.curr} ***</span>
                    </div>
                    <div class="amt-text">${amtInWords}</div>
                </div>

                <div class="footer-grid">
                    <div class="sign-box">
                        <div class="sign-title">Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§Ø¡ ØµØ±Ø§ÙÛŒ (ØªØ­ÙˆÛŒÙ„ Ø¯Ù‡Ù†Ø¯Ù‡)</div>
                        <span class="sign-line"></span>
                    </div>
                    <div class="sign-box">
                        <div class="sign-title">Ø§Ù…Ø¶Ø§Ø¡ Ùˆ Ø§Ø«Ø± Ø§Ù†Ú¯Ø´Øª Ù…Ø´ØªØ±ÛŒ (Ú¯ÛŒØ±Ù†Ø¯Ù‡)</div>
                        <span class="sign-line"></span>
                    </div>
                </div>

                <div class="rep-footer">
                    Ø­ÙˆØ§Ù„Ù‡ ÙˆØ§Ø±Ø¯Ù‡ Ø§Ø² Ø·Ø±Ù: <span class="rep-name">${repName}</span>
                    <div class="rep-contact">${repContact}</div>
                </div>
            </div>
        </body>
        </html>`;
    }
    
    win.document.write(content); 
    win.document.close(); 
    win.print();
}
 
function printCurrentTTForm() {
    const amt = document.getElementById('ttAmt').value; const curr = document.getElementById('ttCurr').value; const amtWords = document.getElementById('ttAmtWords').value; const benName = document.getElementById('ttBenName').value; const benNameEn = document.getElementById('ttBenNameEn').value; const country = document.getElementById('ttCountry').value; const city = document.getElementById('ttCityDest').value; const address = document.getElementById('ttAddress').value; const bank = document.getElementById('ttDestBank').value; const swift = document.getElementById('ttSwift').value; const iban = document.getElementById('ttIban').value; const ref = document.getElementById('ttRef').value || '---';
    if (!amt || !benName) { alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ±Ù… Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.'); return; }
    const win = window.open('', '_blank', 'width=900,height=1000');
    win.document.write(`<html><head><title>TT Application - ${ref}</title><style>@page { size: A4; margin: 10mm; } body { font-family: 'Times New Roman', sans-serif; padding: 20px; border: 2px solid #000; margin: 0; font-size: 11pt; } .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; } .title { font-size: 22px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; } .row { display: flex; margin-bottom: 5px; border-bottom: 1px dotted #eee; padding-bottom: 2px; } .lbl { font-weight: bold; width: 180px; } .val { flex: 1; font-family: 'Courier New', monospace; font-weight: 600; } .legal-text { direction: rtl; text-align: justify; font-family: 'Vazirmatn'; font-size: 9pt; margin-top: 30px; border-top: 2px solid #000; padding-top: 10px; background: #f9f9f9; padding: 10px; }</style></head><body>${getPrintHeaderHTML()}<div class="header"><div class="title">Telegraphic Transfer Application</div><div>REF: ${ref}</div><div>Date: ${new Date().toLocaleDateString('en-GB')}</div></div><div class="row"><span class="lbl">Beneficiary (FA):</span><span class="val" style="font-family:'Vazirmatn'">${benName}</span></div><div class="row"><span class="lbl">Beneficiary (EN):</span><span class="val">${benNameEn}</span></div><div class="row"><span class="lbl">Destination:</span><span class="val">${city}, ${country}</span></div><div class="row"><span class="lbl">Bank:</span><span class="val">${bank}</span></div><div class="row"><span class="lbl">Swift:</span><span class="val">${swift}</span></div><div class="row"><span class="lbl">IBAN:</span><span class="val">${iban}</span></div><div class="row"><span class="lbl">Amount:</span><span class="val">*** ${Number(amt).toLocaleString()} ${curr} ***</span></div><div class="row"><span class="lbl">Words:</span><span class="val">${amtWords}</span></div><div class="legal-text"><strong>Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª / Terms & Conditions:</strong><br>Û±. ØµØ­Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ù…Ø´ØªØ±ÛŒ Ø§Ø³Øª.<br>Û². Ù…Ø³Ø¦ÙˆÙ„ÛŒØª ØªØ­Ø±ÛŒÙ… Ùˆ Ø¨Ù„ÙˆÚ©Ù‡ Ø´Ø¯Ù† ÙˆØ¬Ù‡ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ Ø§Ø³Øª.<br>Û³. ØªØ§ÛŒÛŒØ¯ ÙˆØµÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ø² Û· Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø§Ø¹Ù„Ø§Ù… Ø´ÙˆØ¯.</div><br><br><div style="display:flex; justify-content:space-between;"><div>Signature</div><div>Company Stamp</div></div></body></html>`);
    win.document.close(); win.print();
}

function printTodayJournal() { 
    const win = window.open('', '_blank', 'width=1000,height=800');
    const originalBody = document.getElementById('journalBody');
    let rowsHTML = ""; if (originalBody) { Array.from(originalBody.rows).forEach(row => { let newRow = "<tr>"; for (let i = 0; i < 5; i++) { if (row.cells[i]) newRow += `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${row.cells[i].innerHTML}</td>`; } newRow += "</tr>"; rowsHTML += newRow; }); }
    win.document.write(`<html><head><title>Journal Report</title><style>@page { size: A4 landscape; margin: 15mm; } body { font-family: 'Vazirmatn', Tahoma, sans-serif; direction: rtl; padding: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; } th { background-color: #f2f2f2; font-weight: bold; border: 1px solid #999; padding: 10px; text-align: center; } td { border: 1px solid #ddd; padding: 8px; text-align: right; } </style></head><body>${getPrintHeaderHTML()}<h2 style="text-align:center">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø¯ÙØªØ± Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ (Log)</h2><table><thead><tr><th style="width: 15%">Ø²Ù…Ø§Ù†</th><th style="width: 15%">Ø¨Ø®Ø´ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</th><th style="width: 40%">Ø´Ø±Ø­ ØªØ±Ø§Ú©Ù†Ø´</th><th style="width: 15%">Ù…Ø¨Ù„Øº / ØªØºÛŒÛŒØ±Ø§Øª</th><th style="width: 15%">Ú©Ø§Ø±Ø¨Ø±</th></tr></thead><tbody>${rowsHTML}</tbody></table></body></html>`);
    win.document.close(); win.print();
}

function printExchangeReceipt() {
    const baseAmt = document.getElementById('fxBaseAmt').value;
    const quoteAmt = document.getElementById('fxQuoteAmt').value;
    const baseCurr = document.getElementById('fxBaseCurr').value;
    const quoteCurr = document.getElementById('fxQuoteCurr').value;
    const rate = document.getElementById('fxRate').value;
    const desc = document.getElementById('exDesc').value || '';

    const type = fxDirection === 'Buy' ? 'Ø®Ø±ÛŒØ¯ Ø§Ø±Ø² (Purchase)' : 'ÙØ±ÙˆØ´ Ø§Ø±Ø² (Sale)';

    let custName = "";
    let custFather = "";
    let custPhone = "";
    let custID = "";
    let custTypeLabel = "";

    if (exType === 'internal') {
        custName = document.getElementById('exCustomer').value;
        custTypeLabel = "(Ø­Ø³Ø§Ø¨â€ŒØ¯Ø§Ø±)";
        const custObj = db.customers.find(c => c.name === custName);
        if (custObj && custObj.phone) custPhone = custObj.phone;

    } else {
        custName = document.getElementById('exExtName').value || "Ù…Ø´ØªØ±ÛŒ Ù†Ù‚Ø¯ÛŒ";
        custFather = document.getElementById('exExtFather').value;
        custPhone = document.getElementById('exExtPhone').value;
        custID = document.getElementById('exExtID').value;
        custTypeLabel = "(Ù†Ù‚Ø¯ÛŒ)";
    }

    // 3. Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾
    const win = window.open('', '_blank', 'width=400,height=600');
    
    win.document.write(`
    <html>
    <head>
        <title>Receipt</title>
        <style>
            @page { size: 80mm auto; margin: 0; }
            body {
                font-family: 'Vazirmatn', 'Tahoma', sans-serif;
                direction: rtl;
                margin: 0;
                padding: 5px 10px;
                width: 72mm; /* Ø¹Ø±Ø¶ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ÙÛŒØ´ */
                font-size: 11px;
                color: #000;
            }
            .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 5px; margin-bottom: 5px; }
            .header h2 { margin: 5px 0; font-size: 14px; font-weight: 900; }
            
            /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Ù…Ø´Ø®ØµØ§Øª Ù…Ø´ØªØ±ÛŒ */
            .customer-box {
                border: 1px solid #999;
                border-radius: 5px;
                padding: 5px;
                margin-bottom: 8px;
                background: #f9f9f9;
            }
            .info-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
            .lbl { color: #555; font-size: 10px; }
            .val { font-weight: bold; font-size: 11px; }
            
            .divider { border-top: 1px dashed #000; margin: 8px 0; }
            
            .total-box { 
                font-size: 14px; font-weight: 900; text-align: center; 
                border: 2px solid #000; padding: 5px; border-radius: 5px; margin-top: 5px; 
            }
            .footer { text-align: center; font-size: 9px; margin-top: 15px; }
            img { max-width: 60px; }
        </style>
    </head>
    <body>
        ${getPrintHeaderHTML()} <div class="header">
            <h2>Ø±Ø³ÛŒØ¯ ${type}</h2>
            <div style="font-size:10px">${new Date().toLocaleDateString('fa-IR')} - ${new Date().toLocaleTimeString('fa-IR')}</div>
        </div>

        <div class="customer-box">
            <div style="text-align:center; font-weight:bold; border-bottom:1px solid #ccc; margin-bottom:4px;">Ù…Ø´Ø®ØµØ§Øª Ù…Ø´ØªØ±ÛŒ ${custTypeLabel}</div>
            
            <div class="info-row">
                <span class="lbl">Ù†Ø§Ù…:</span>
                <span class="val">${custName}</span>
            </div>
            
            ${custFather ? `
            <div class="info-row">
                <span class="lbl">Ù†Ø§Ù… Ù¾Ø¯Ø±:</span>
                <span class="val">${custFather}</span>
            </div>` : ''}

            ${custID ? `
            <div class="info-row">
                <span class="lbl">ØªØ°Ú©Ø±Ù‡/ID:</span>
                <span class="val">${custID}</span>
            </div>` : ''}

            ${custPhone ? `
            <div class="info-row">
                <span class="lbl">ØªÙ„ÙÙ†:</span>
                <span class="val" dir="ltr">${custPhone}</span>
            </div>` : ''}
        </div>
        
        <div class="divider"></div>

        <div class="info-row">
            <span class="lbl">Ù…Ø¨Ù„Øº Ù¾Ø§ÛŒÙ‡:</span>
            <span class="val" dir="ltr">${parseFloat(baseAmt).toLocaleString()} ${baseCurr}</span>
        </div>
        <div class="info-row">
            <span class="lbl">Ù†Ø±Ø® (Rate):</span>
            <span class="val">${rate}</span>
        </div>

        <div class="total-box">
            <div style="font-size:10px; font-weight:normal">Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ (Total)</div>
            <div dir="ltr">${parseFloat(quoteAmt).toLocaleString()} ${quoteCurr}</div>
        </div>

        ${desc ? `<div class="divider"></div><div style="font-size:10px"><b>ØªÙˆØ¶ÛŒØ­Ø§Øª:</b> ${desc}</div>` : ''}

        <div class="footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; margin-top:10px;">
                <span>Ø§Ù…Ø¶Ø§Ø¡ Ù…Ø´ØªØ±ÛŒ</span>
                <span>Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§Ø¡ ØµØ±Ø§ÙÛŒ</span>
            </div>
            <p>Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ø³Ù¾Ø§Ø³Ú¯Ø²Ø§Ø±ÛŒÙ…</p>
        </div>
    </body>
    </html>
    `);
    
    win.document.close();
    win.focus();
    
    setTimeout(() => { 
        win.print(); 
        // win.close(); 
    }, 500);
}
function printCryptoFx() {
    const t = document.getElementById('cryptoTxType').value === 'Buy' ? 'Ø®Ø±ÛŒØ¯ (Buy)' : 'ÙØ±ÙˆØ´ (Sell)'; const n = document.getElementById('cryptoName').value; const v = document.getElementById('cryptoAmt').value; const fc = document.getElementById('cryptoCurr').value; const fa = document.getElementById('fiatAmt').value; const desc = document.getElementById('cryptoDesc').value || '---';
    const win = window.open('', '_blank', 'width=500,height=600');
    win.document.write(`<html><head><title>Crypto Receipt</title><style>body{font-family:'Vazirmatn',tahoma;direction:rtl;padding:10px;text-align:center}.box{border:3px double #000;padding:20px;margin:0 auto;width:90%}.row{display:flex;justify-content:space-between;border-bottom:1px dotted #ccc;padding:8px 0}.val{font-weight:bold}</style></head><body>${getPrintHeaderHTML()}<div class="box"><h3>Ø±Ø³ÛŒØ¯ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ (Crypto)</h3><div class="row"><span>Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡:</span><span class="val">${t}</span></div><div class="row"><span>Ù†Ø§Ù… Ø§Ø±Ø²:</span><span class="val" style="text-transform:uppercase">${n}</span></div><div class="row"><span>Ù…Ù‚Ø¯Ø§Ø± (Volume):</span><span class="val" dir="ltr">${v}</span></div><div class="row"><span>Ù…Ø¨Ù„Øº Ú©Ù„ (Fiat):</span><span class="val" dir="ltr">${fa} ${fc}</span></div><div class="row"><span>Ù…Ø´ØªØ±ÛŒ/ØªÙˆØ¶ÛŒØ­Ø§Øª:</span><span class="val">${desc}</span></div><br><div style="font-size:12px; border-top:1px solid #000; padding-top:10px;">Ø§Ù…Ø¶Ø§Ø¡ Ùˆ Ù…Ù‡Ø±</div></div></body></html>`);
    win.document.close(); win.print();
}

function exportDB() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], { type: "application/json" })); a.download = `Backup_${Date.now()}.json`; a.click(); }
function importDB() { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => { const r = new FileReader(); r.onload = async ev => { try { db = JSON.parse(ev.target.result); await dbAdapter.saveAll(db); location.reload(); } catch (x) { alert('File Error'); } }; r.readAsText(e.target.files[0]); }; i.click(); }

function exportHawalaToExcel() { 
    const filterCity = document.getElementById('filterHCity').value; 
    const filterType = document.getElementById('filterHType').value; 
    const filterStatus = document.getElementById('filterHStatus').value;
    
    const filteredHawalas = db.hawalas.filter(h => 
        (filterCity === 'All' || h.cityBook === filterCity) && 
        (filterType === 'All' || h.type === filterType) && 
        (filterStatus === 'All' || h.status === filterStatus)
    ).sort((a, b) => b.regDate - a.regDate); // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¨Ø§Ù„Ø§
    
    if (filteredHawalas.length === 0) {
        alert("Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
        return;
    }

    const data = []; 
    
    data.push({ 'Ø´Ù…Ø§Ø±Ù‡_Ø­ÙˆØ§Ù„Ù‡': '--- Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ø±Ø²Ù‡Ø§ ---' });
    
    let currencyTotals = {}; 
    filteredHawalas.forEach(h => { 
        if(!currencyTotals[h.curr]) currencyTotals[h.curr] = 0; 
        currencyTotals[h.curr] += h.amt; 
    }); 
    
    for(let c in currencyTotals) { 
        data.push({ 
            'Ø´Ù…Ø§Ø±Ù‡_Ø­ÙˆØ§Ù„Ù‡': `Ù…Ø¬Ù…ÙˆØ¹ ${c}`, 
            'Ù…Ø¨Ù„Øº': currencyTotals[c] 
        }); 
    } 
    
    data.push({}); 
    data.push({});
    
    filteredHawalas.forEach(h => { 
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ø´Ù‡Ø±
        const cityName = db.cities.find(c => c.code === h.cityBook)?.name || h.cityBook;

        data.push({ 
            'Ø´Ù…Ø§Ø±Ù‡_Ø­ÙˆØ§Ù„Ù‡': h.displayId || h.id, 
            'Ù†ÙˆØ¹': h.type === 'Outgoing' ? 'Ø§Ø±Ø³Ø§Ù„ÛŒ' : 'Ø¯Ø±ÛŒØ§ÙØªÛŒ', 
            'Ø´Ù‡Ø±/Ú©ØªØ§Ø¨': cityName, 
            'Ù…Ø¨Ù„Øº': h.amt, 
            'Ø§Ø±Ø²': h.curr, 
            'Ú©Ù…ÛŒØ´Ù†': h.comm || 0,
            
            'Ù†Ø§Ù…_ÙØ±Ø³ØªÙ†Ø¯Ù‡': `${h.sender} ${h.senderLast || ''}`.trim(),
            'ÙˆÙ„Ø¯_ÙØ±Ø³ØªÙ†Ø¯Ù‡': h.senderFather || '',
            'ØªÙ„ÙÙ†_ÙØ±Ø³ØªÙ†Ø¯Ù‡': h.senderPhone || '',
            'ØªØ°Ú©Ø±Ù‡_ÙØ±Ø³ØªÙ†Ø¯Ù‡': h.senderID || '',

            'Ù†Ø§Ù…_Ú¯ÛŒØ±Ù†Ø¯Ù‡': `${h.receiver} ${h.receiverLast || ''}`.trim(),
            'ÙˆÙ„Ø¯_Ú¯ÛŒØ±Ù†Ø¯Ù‡': h.receiverFather || '',
            'ØªÙ„ÙÙ†_Ú¯ÛŒØ±Ù†Ø¯Ù‡': h.receiverPhone || '',
            'ØªØ°Ú©Ø±Ù‡_Ú¯ÛŒØ±Ù†Ø¯Ù‡': h.receiverID || '',

            'ØªÙˆØ¶ÛŒØ­Ø§Øª/Ø¨Ø§Ø¨Øª': h.receiverPurpose || h.senderPurpose || '',
            'ØªØ§Ø±ÛŒØ®_Ø«Ø¨Øª': new Date(h.regDate).toLocaleDateString('fa-IR'), 
            'ØªØ§Ø±ÛŒØ®_Ø§Ø¬Ø±Ø§': h.execDate ? new Date(h.execDate).toLocaleDateString('fa-IR') : '-',
            'ÙˆØ¶Ø¹ÛŒØª': h.status === 'Done' ? 'Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡' : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' 
        }); 
    });
    
    const ws = XLSX.utils.json_to_sheet(data); 
    
    const wscols = [
        {wch: 15}, 
        {wch: 10}, 
        {wch: 15}, 
        {wch: 12}, 
        {wch: 8},  
        {wch: 10}, 
        {wch: 20}, 
        {wch: 15}, 
        {wch: 15}, 
        {wch: 15}, 
        {wch: 20}, 
        {wch: 15}, 
        {wch: 15}, 
        {wch: 15}, 
        {wch: 25}, 
        {wch: 12}, 
    ];
    ws['!cols'] = wscols;

    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Ù„ÛŒØ³Øª Ø­ÙˆØ§Ù„Ø¬Ø§Øª"); 
    
    XLSX.writeFile(wb, `Hawala_Full_${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.xlsx`);
}
function exportLedgerToExcel() {
    const c = document.getElementById('selCustomer').value; 
    if(!c) {
        alert("Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù…Ø´ØªØ±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        return;
    }
    
    const list = db.accounts[c] || []; 
    list.sort((a, b) => a.date - b.date);
    

    const balances = {}; 
    list.forEach(x => { 
        balances[x.curr] = (balances[x.curr] || 0) + (x.credit - x.debit); 
    });
    
    const balanceString = Object.entries(balances)
        .map(([curr, val]) => `${val.toLocaleString()} ${curr}`)
        .join(' | ');
    
    const data = []; 
    
    data.push({ 'ØªØ§Ø±ÛŒØ®': `Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: ${c}`, 'Ø´Ø±Ø­': `Ù…Ø§Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø­Ø³Ø§Ø¨: ${balanceString}` }); 
    data.push({}); 
    
    list.forEach(x => { 
        data.push({ 
            'ØªØ§Ø±ÛŒØ®': new Date(x.date).toLocaleDateString('fa-IR'), 
            'Ø´Ø±Ø­': x.desc, 
            'Ø§Ø±Ø²': x.curr, 
            'Ø¨Ø¯Ù‡Ú©Ø§Ø±': x.debit > 0 ? x.debit : 0, 
            'Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±': x.credit > 0 ? x.credit : 0 
        }); 
    });
    
    const ws = XLSX.utils.json_to_sheet(data); 
    
    const wscols = [
        {wch:15}, 
        {wch:50}, 
        {wch:10}, 
        {wch:15}, 
        {wch:15}  
    ]; 
    ws['!cols'] = wscols;
    
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Ledger"); 
    
    XLSX.writeFile(wb, `ØµÙˆØ±ØªØ­Ø³Ø§Ø¨_${c}.xlsx`);
}
async function setInitialCapital() { 
    if (currentUser.perms.admin) { 
        if (!db.avgRates) db.avgRates = {}; 
        
        db.currencies.forEach(c => {
            db.initialCapital[c] = parseFloat(document.getElementById(`initCap_${c}`).value) || 0;
            
            const rateInput = document.getElementById(`initRate_${c}`);
            if(rateInput && rateInput.value) { 
                db.avgRates[c] = parseFloat(rateInput.value); 
            }
        });

        await saveDB(); 
        alert('Ø³Ø±Ù…Ø§ÛŒÙ‡ Ùˆ Ù†Ø±Ø®â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.\nØ³ÛŒØ³ØªÙ… Ø§Ú©Ù†ÙˆÙ† Ù†Ø±Ø® Ø®Ø±ÛŒØ¯ Ø±Ø§ Ù…ÛŒâ€ŒØ´Ù†Ø§Ø³Ø¯.'); 
        renderDashboard(); 
    } 
}
async function changeMyPass() { const p = document.getElementById('myNewPass').value; if (p.length < 4) return; const u = db.users.find(x => x.u === currentUser.u); u.salt = generateSalt(); u.hash = hashPassword(p, u.salt); await saveDB(); alert('Password Changed.'); }
async function addUser() { 
    const u = document.getElementById('newUName').value;
    const p = document.getElementById('newUPass').value; 
    if (u && p) { 
        const s = generateSalt(); 
        db.users.push({ 
            u, 
            salt: s, 
            hash: hashPassword(p, s), 
            perms: { 
                hawala: document.getElementById('perm_hawala').checked, 
                exchange: document.getElementById('perm_exchange').checked, 
                accounts: document.getElementById('perm_accounts').checked, 
                tt: document.getElementById('perm_tt').checked, 
                admin: document.getElementById('perm_admin').checked,
                access_group_b: document.getElementById('perm_group_b').checked // Ø¯Ø³ØªØ±Ø³ÛŒ Ø¬Ø¯ÛŒØ¯
            } 
        }); 
        await saveDB(); 
        renderUserManagement(); 
        alert("Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."); 
    } 
}

function renderUserManagement() { document.getElementById('userListManage').innerHTML = db.users.map(u => `<div>${u.u} <button onclick="delUser('${u.u}')" class="btn btn-red" style="padding:2px 5px; font-size:10px">Delete</button></div>`).join(''); }
async function delUser(u) { if (u !== 'admin' && confirm('Delete?')) { db.users = db.users.filter(x => x.u !== u); await saveDB(); renderUserManagement(); alert("Deleted."); } }
async function addCity() { 
    const n = document.getElementById('newCityName').value.trim();
    const c = document.getElementById('newCityCode').value.trim().toUpperCase();
    const rep = document.getElementById('newCityRep').value.trim(); 
    const contact = document.getElementById('newCityContact').value.trim(); 

    if (n && c) { 
        db.cities.push({ name: n, code: c, rep: rep, contact: contact }); 
        db.cityHawalaCounters[c] = { Outgoing: 1001, Incoming: 1001 }; 
        await saveDB(); 
        updateUI(); 
        
        document.getElementById('newCityName').value = '';
        document.getElementById('newCityCode').value = '';
        document.getElementById('newCityRep').value = '';
        document.getElementById('newCityContact').value = '';

        alert("Ø´Ù‡Ø± Ùˆ Ù…Ø´Ø®ØµØ§Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯."); 
    } else {
        alert("Ù†Ø§Ù… Ø´Ù‡Ø± Ùˆ Ú©Ø¯ Ø´Ù‡Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
    }
}
async function addCurrency() { const c = document.getElementById('newCurrCode').value.toUpperCase(); if (c && !db.currencies.includes(c)) { db.currencies.push(c); db.cashBox[c] = 0; db.initialCapital[c] = 0; await saveDB(); updateUI(); alert("Currency Added."); } }
async function deleteCurrency() { const c = document.getElementById('currToDelete').value; if(c && confirm('Delete?')) { db.currencies = db.currencies.filter(x=>x!==c); delete db.cashBox[c]; await saveDB(); updateUI(); renderDashboard(); alert("Deleted."); } }
function checkCityForDelete() { const c = document.getElementById('cityToDelete').value; document.getElementById('transferCitySection').style.display = db.hawalas.some(h=>h.cityBook===c) ? 'block' : 'none'; }
async function deleteCityProcess() { const c = document.getElementById('cityToDelete').value; if(!c) return; const hasH = db.hawalas.some(h=>h.cityBook===c); if(hasH) { const t=document.getElementById('cityTransferTarget').value; if(!t)return alert('Select Target'); db.hawalas.forEach(h=>{if(h.cityBook===c)h.cityBook=t}); } db.cities=db.cities.filter(x=>x.code!==c); await saveDB(); updateUI(); alert('City Deleted.'); }
async function resetData() { if (confirm('Warning: Full Reset?')) { db.hawalas = []; db.accounts = {}; db.journal = []; db.customers = []; db.cityHawalaCounters = {}; db.cities.forEach(c => db.cityHawalaCounters[c.code] = { Outgoing: 1001, Incoming: 1001 }); db.currencies.forEach(c => db.cashBox[c] = 0); fxProfit = {}; await saveDB(); location.reload(); } }
let allAccountsCache = []; 
function openAllAccountsModal() { allAccountsCache = db.customers.map(c => { const bal = {}; if(db.accounts[c.name]) { db.accounts[c.name].forEach(x => { bal[x.curr] = (bal[x.curr] || 0) + (x.credit - x.debit); }); } return { name: c.name, phone: c.phone, balances: bal }; }); renderAllAccountsList(allAccountsCache); document.getElementById('searchAllAcc').value = ''; openModal('modalAllAcc'); }
function filterAllAccounts() { const q = document.getElementById('searchAllAcc').value.toLowerCase().trim(); if (!q) { renderAllAccountsList(allAccountsCache); return; } const filtered = allAccountsCache.filter(x => { const n = x.name ? x.name.toLowerCase() : ""; const p = x.phone ? x.phone.toString() : ""; return n.includes(q) || p.includes(q); }); renderAllAccountsList(filtered); }
function renderAllAccountsList(list) {
    const container = document.getElementById('allAccountsList');
    if(list.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:gray">No Data</div>'; return; }
    container.innerHTML = list.map(item => {
        let balancesHtml = ''; let hasBalance = false;     
        for(let k in item.balances) { if(Math.abs(item.balances[k]) > 0.1) { hasBalance = true; const colorClass = item.balances[k] >= 0 ? 'text-green' : 'text-red'; const sign = item.balances[k] >= 0 ? '+' : ''; balancesHtml += `<span style="margin-left:8px; font-size:12px; background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:10px; border:1px solid rgba(212,175,5,0.2)">${k}: <span class="${colorClass}" dir="ltr" style="font-weight:900">${sign}${item.balances[k].toLocaleString()}</span></span>`; } }
        if(!hasBalance) { balancesHtml = '<span style="font-size:11px; opacity:0.6; color:var(--text-muted)">Settled</span>'; }
        return `<div class="account-list-item" onclick="selectAndOpenLedger('${item.name}')"><div style="display:flex; align-items:center; gap:10px;"><div style="background:var(--gold-faint); color:var(--gold-primary); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:1px solid var(--gold-border)">${item.name.charAt(0)}</div><div><div style="font-weight:bold; font-size:15px; color:var(--text-main)">${item.name}</div><div style="font-size:11px; opacity:0.7; color:var(--gold-primary)">${item.phone || ''}</div></div></div><div style="text-align:left; display:flex; flex-direction:column; align-items:flex-end; gap:5px; margin-top:5px;">${balancesHtml}</div></div>`;
    }).join('');
}
function selectAndOpenLedger(name) { closeModal('modalAllAcc'); go('accounts'); setTimeout(() => { const sel = document.getElementById('selCustomer'); const opt = Array.from(sel.options).find(o => o.value === name); if (!opt) { return setTimeout(() => selectAndOpenLedger(name), 150); } sel.value = name; loadCustomerLedger(); }, 200); }
function toggleAdminAccess(checkbox) { const isChecked = checkbox.checked; document.getElementById('perm_hawala').checked = isChecked; document.getElementById('perm_exchange').checked = isChecked; document.getElementById('perm_accounts').checked = isChecked; document.getElementById('perm_tt').checked = isChecked; }

async function saveCompanyProfile() {
    if (!db.settings) db.settings = {};
    
    db.settings.companyName = document.getElementById('setCompName').value;
    db.settings.slogan = document.getElementById('setCompSlogan').value;
    db.settings.phone = document.getElementById('setCompPhone').value;
    db.settings.address = document.getElementById('setCompAddress').value;
    db.settings.footerMsg = document.getElementById('setCompFooter').value;
    
    await saveDB();
    applyCompanySettings();
    alert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ø±Ú©Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
}

function applyCompanySettings() {
    if (!db.settings) return;
    
    const name = db.settings.companyName || "ØµØ±Ø§ÙÛŒ Ù‡Ø±Ø§ØªÛŒâ€ŒÙ‡Ø§";
    const slogan = db.settings.slogan || "Ø®Ø¯Ù…Ø§Øª Ù¾ÙˆÙ„ÛŒ Ùˆ Ø§Ø±Ø²ÛŒ";
    
    const loginTitle = document.querySelector('.login-header-text');
    if(loginTitle) loginTitle.innerText = name;
    
    const loginSub = document.querySelector('.login-sub-text');
    if(loginSub) loginSub.innerText = slogan;
    
    const sidebarInfo = document.querySelector('.sidebar h2');
    if(sidebarInfo) sidebarInfo.innerText = name;
}

init();
document.addEventListener('DOMContentLoaded', () => { 
    const fxContainer = document.querySelector('.fx-container'); 
    if (fxContainer) { setFxDirection('Buy'); calcFx(); } 
    setCryptoCustType('external');
});
// =================================================
// Ø³ÛŒØ³ØªÙ… Ø¬Ø¯ÛŒØ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† (Ø­Ù‚ÙˆÙ‚ Ø®ÙˆØ¯Ú©Ø§Ø± + ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨)
// =================================================

if (!db.employees) { db.employees = []; }

async function paySalary(id) {
    const emp = db.employees.find(e => e.id === id);
    if(!emp) return;
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù†Ø¯Ù‡ ÙØ¹Ù„ÛŒ
    let currentBal = 0;
    if(db.employeeLedger[id]) {
        db.employeeLedger[id].forEach(t => currentBal += (t.credit - t.debit));
    }

    const amountToPay = prompt(`Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ Ø¨Ù‡ ${emp.name}\n(Ø·Ù„Ø¨ ÙØ¹Ù„ÛŒ Ø§ÛŒØ´Ø§Ù†: ${currentBal.toLocaleString()} ${emp.curr})\nÙ…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:`);
    
    if(amountToPay && parseFloat(amountToPay) > 0) {
        const amt = parseFloat(amountToPay);
        const desc = prompt("Ø¨Ø§Ø¨Øª / ØªÙˆØ¶ÛŒØ­Ø§Øª:", "Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³Ø§Ø¹Ø¯Ù‡ / ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨");
        
        // Ú†Ú© Ú©Ø±Ø¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚
        const currentCash = (db.cashBox[emp.curr] || 0) + (db.initialCapital[emp.curr] || 0);
        if(currentCash < amt) { alert(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ ${emp.curr} Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!`); return; }

        // Ú©Ø³Ø± Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚
        db.cashBox[emp.curr] -= amt;
        
        // Ø«Ø¨Øª Ø¨Ø±Ø¯Ø§Ø´Øª (Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø´Ø¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯)
        if(!db.employeeLedger[id]) db.employeeLedger[id] = [];
        db.employeeLedger[id].push({
            id: Date.now(),
            date: Date.now(),
            type: 'debit',
            amount: amt,
            curr: emp.curr,
            desc: desc || 'Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø¯ÛŒ'
        });
        
        // Ø«Ø¨Øª Ø¯Ø± Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ…
        logTx('Ø­Ù‚ÙˆÙ‚', `Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ ${emp.name}`, `Cash Out: ${amt} ${emp.curr}`, 'SALARY_PAY', { empId: id, amt: amt });

        await saveDB();
        renderEmployees();
        renderDashboard(); // Ø¢Ù¾Ø¯ÛŒØª ØµÙ†Ø¯ÙˆÙ‚ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        alert("Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
    }
}


async function deleteEmpTx(empId, txId) {
    if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ (Ø§Ú¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ù¾ÙˆÙ„ Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯)")) return;
    const list = db.employeeLedger[empId];
    const idx = list.findIndex(x => x.id === txId);
    if(idx === -1) return;

    const tx = list[idx];
    if(tx.type === 'debit') { // Ø§Ú¯Ø± Ù¾ÙˆÙ„ Ù†Ù‚Ø¯ Ø¨ÙˆØ¯Ù‡ØŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù† Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚
        db.cashBox[tx.curr] = (db.cashBox[tx.curr] || 0) + tx.amount;
    }
    list.splice(idx, 1);
    await saveDB();
    openEmpLedger(empId); // Ø±ÙØ±Ø´ Ù„ÛŒØ³Øª
    renderDashboard();
    renderEmployees();
}

// === Ø´Ø±ÙˆØ¹ Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø§ÙˆØ§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø³ÛŒØ³ØªÙ… Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ===

// 1. Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø¯Ø± ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª
function renderEmployees() {
    const tbody = document.getElementById('employeeBody');
    if (!tbody) return;
    
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    if (!db.employees) db.employees = [];
    if (!db.employeeLedger) db.employeeLedger = {};

    tbody.innerHTML = db.employees.map(emp => {
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ (Credits - Debits)
        let balance = 0;
        const ledger = db.employeeLedger[emp.id] || [];
        ledger.forEach(tx => {
            if(tx.type === 'credit') balance += tx.amount; // Ø­Ù‚ÙˆÙ‚ (Ø·Ù„Ø¨)
            else if(tx.type === 'debit') balance -= tx.amount; // Ø¨Ø±Ø¯Ø§Ø´Øª (Ø¨Ø¯Ù‡ÛŒ)
        });

        const color = balance >= 0 ? 'var(--success)' : 'var(--danger)'; // Ø³Ø¨Ø²=Ø·Ù„Ø¨Ú©Ø§Ø±ØŒ Ù‚Ø±Ù…Ø²=Ø¨Ø¯Ù‡Ú©Ø§Ø±
        const statusText = balance >= 0 ? 'Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø± (Ø·Ù„Ø¨)' : 'Ø¨Ø¯Ù‡Ú©Ø§Ø± (Ù¾ÛŒØ´â€ŒØ®ÙˆØ±)';
        const joinDate = emp.joinDate ? new Date(emp.joinDate).toLocaleDateString('fa-IR') : '-';

        return `
            <tr>
                <td>
                    <div style="font-weight:bold">${emp.name}</div>
                </td>
                <td>
                    <div style="font-size:12px">${emp.job}</div>
                    <div style="font-size:10px; opacity:0.6">Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${joinDate}</div>
                </td>
                <td>${parseInt(emp.salary).toLocaleString()} ${emp.curr}</td>
                <td style="background:rgba(0,0,0,0.1)">
                    <div style="color:${color}; font-weight:900; direction:ltr; font-size:15px;">
                        ${balance.toLocaleString()} ${emp.curr}
                    </div>
                    <div style="font-size:10px; opacity:0.8">${statusText}</div>
                </td>
                <td>
                    <button class="btn btn-outline btn-sm" onclick="openEmpLedger('${emp.id}')">ğŸ“œ ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨</button>
                    <button class="btn btn-blue btn-sm" onclick="quickPaySalary('${emp.id}')">ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª</button>
                    <button class="btn btn-red btn-sm" onclick="deleteEmployee('${emp.id}')">âŒ</button>
                </td>
            </tr>
        `;
    }).join('');

    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§
    const currSelect = document.getElementById('empCurr');
    if(currSelect && currSelect.options.length === 0) {
        currSelect.innerHTML = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    }
}

// 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯
async function saveNewEmployee() {
    const name = document.getElementById('empName').value;
    const job = document.getElementById('empJob').value;
    const salary = parseFloat(document.getElementById('empSalary').value);
    const curr = document.getElementById('empCurr').value;
    const joinDate = document.getElementById('empJoinDate').value; 

    if(!name || !salary) { alert("Ù†Ø§Ù… Ùˆ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); return; }

    const newId = Date.now().toString();
    const newEmp = { 
        id: newId, 
        name: name, 
        job: job, 
        salary: salary, 
        curr: curr, 
        joinDate: joinDate || new Date().toISOString().split('T')[0], 
        status: 'Active'
    };

    if(!db.employees) db.employees = [];
    db.employees.push(newEmp);
    
    if(!db.employeeLedger) db.employeeLedger = {};
    db.employeeLedger[newId] = [];

    await saveDB();
    closeModal('modalNewEmp');
    renderEmployees();
    alert("Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø´Ø¯.");
}

// 3. ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ÙˆØ§Ø±ÛŒØ² Ø¯Ø³ØªÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø§ Ø¯Ú©Ù…Ù‡
async function applyMonthlySalaries() {
    if (!db.employees || db.employees.length === 0) { alert("Ù‡ÛŒÚ† Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."); return; }

    const now = new Date();
    // Ù†Ø§Ù… Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
    const currentMonthName = now.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long' });
    
    // Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (Ù…Ø«Ù„Ø§ SAL_2025_11) Ø¬Ù‡Øª Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ÙˆØ§Ø±ÛŒØ² ØªÚ©Ø±Ø§Ø±ÛŒ
    const salaryMetaId = `SAL_${now.getFullYear()}_${now.getMonth()}`;

    if(!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (${currentMonthName}) Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† ÙØ¹Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø¨Ù‡ Ø­Ø³Ø§Ø¨Ø´Ø§Ù† Ù…Ù†Ø¸ÙˆØ± Ú©Ù†ÛŒØ¯ØŸ`)) return;

    let count = 0;
    let alreadyPaidCount = 0;

    db.employees.forEach(emp => {
        if(emp.status !== 'Active') return; // ÙÙ‚Ø· ÙØ¹Ø§Ù„â€ŒÙ‡Ø§
        if (!db.employeeLedger[emp.id]) db.employeeLedger[emp.id] = [];

        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù‚Ø¨Ù„Ø§Ù‹ Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø±Ø§ Ú¯Ø±ÙØªÙ‡ ÛŒØ§ Ù†Ù‡
        const alreadyPaid = db.employeeLedger[emp.id].some(tx => tx.metaId === salaryMetaId);

        if (!alreadyPaid) {
            db.employeeLedger[emp.id].push({
                id: Date.now() + Math.random(),
                date: Date.now(),
                type: 'credit', // Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø± Ø´Ø¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ (Ø·Ù„Ø¨)
                amount: parseFloat(emp.salary),
                curr: emp.curr,
                desc: `Ø­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${currentMonthName}`,
                metaId: salaryMetaId 
            });
            count++;
        } else {
            alreadyPaidCount++;
        }
    });

    if (count > 0) {
        await saveDB();
        renderEmployees();
        alert(`Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚: Ø­Ù‚ÙˆÙ‚ ${count} Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨Ø´Ø§Ù† ÙˆØ§Ø±ÛŒØ² Ø´Ø¯.`);
    } else {
        alert(`Ø­Ù‚ÙˆÙ‚ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† (${alreadyPaidCount} Ù†ÙØ±) Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ ${currentMonthName} Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ§Ø±ÛŒØ² Ø´Ø¯Ù‡ Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¬Ø¯Ø¯ Ù†ÛŒØ³Øª.`);
    }
}
function openEmpLedger(id) {
    const emp = db.employees.find(e => e.id === id);
    if(!emp) return;

    document.getElementById('currentEmpId').value = id; // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„
    document.getElementById('ledgerEmpName').innerText = emp.name;
    document.getElementById('ledgerEmpJob').innerText = emp.job;
    
    const tbody = document.getElementById('empLedgerBody');
    tbody.innerHTML = '';

    const list = db.employeeLedger[id] || [];
    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®
    list.sort((a,b) => a.date - b.date);

    let runningBalance = 0;
    
    list.forEach(tx => {
        if (tx.type === 'credit') runningBalance += tx.amount; 
        else runningBalance -= tx.amount;

        const dateStr = new Date(tx.date).toLocaleDateString(currentLang==='fa'?'fa-IR':'en-US');
        const debitDisplay = tx.type === 'debit' ? tx.amount.toLocaleString() : '-';
        const creditDisplay = tx.type === 'credit' ? tx.amount.toLocaleString() : '-';
        
        // Ø±Ù†Ú¯ Ù…Ø§Ù†Ø¯Ù‡
        const balanceColor = runningBalance >= 0 ? 'var(--gold-primary)' : 'var(--danger)';
        const deleteBtn = `<button class="btn btn-red btn-sm" onclick="revertEmpTx('${id}', ${tx.id})">ğŸ—‘</button>`;

        tbody.innerHTML += `
            <tr>
                <td style="font-size:12px">${dateStr}</td>
                <td style="font-size:12px">${tx.desc}</td>
                <td style="color:var(--danger); font-weight:bold">${debitDisplay}</td>
                <td style="color:var(--success); font-weight:bold">${creditDisplay}</td>
                <td style="color:${balanceColor}; font-weight:bold; direction:ltr">${runningBalance.toLocaleString()}</td>
                <td>${deleteBtn}</td>
            </tr>
        `;
    });

    const finalBalEl = document.getElementById('ledgerEmpBalance');
    finalBalEl.innerText = `${runningBalance.toLocaleString()} ${emp.curr}`;
    finalBalEl.style.color = runningBalance >= 0 ? 'var(--success)' : 'var(--danger)';
    
    openModal('modalEmpLedger');
}

// 5. Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚ (Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚ Ùˆ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯)
async function processEmployeePayment(empId, amount, desc) {
    const emp = db.employees.find(e => e.id === empId);
    if(!emp) return;

    // 1. Ú†Ú© Ú©Ø±Ø¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚
    const currentCash = (db.cashBox[emp.curr] || 0) + (db.initialCapital[emp.curr] || 0);
    if(currentCash < amount) {
        alert(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ ${emp.curr} Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: ${currentCash.toLocaleString()}`);
        return;
    }

    // 2. Ú©Ø³Ø± Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚
    db.cashBox[emp.curr] = (db.cashBox[emp.curr] || 0) - amount;

    // 3. Ø«Ø¨Øª Ø¯Ø± Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ù…Ù†Ø¯ (Debit)
    const txId = Date.now();
    const ledgerEntry = {
        id: txId,
        date: Date.now(),
        type: 'debit',
        amount: amount,
        curr: emp.curr,
        desc: desc || 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ / Ù…Ø³Ø§Ø¹Ø¯Ù‡',
        metaId: null // Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¯Ø³ØªÛŒ Ù…ØªØ§ Ù†Ø¯Ø§Ø±Ø¯
    };
    db.employeeLedger[empId].push(ledgerEntry);

    // 4. Ø«Ø¨Øª Ø¯Ø± Ù„Ø§Ú¯ Ø³Ø±Ø§Ø³Ø±ÛŒ (Journal) Ø¨Ø±Ø§ÛŒ Ø§Ù…Ú©Ø§Ù† Revert
    // Ù†ÙˆØ¹ EMP_PAYMENT Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¯Ø± deleteLog Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´ÙˆØ¯
    logTx('Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯', `Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ ${emp.name} (${desc})`, `Ø®Ø±ÙˆØ¬ Ù†Ù‚Ø¯: ${amount} ${emp.curr}`, 'EMP_PAYMENT', { 
        empId: empId, 
        txId: txId, 
        amount: amount, 
        curr: emp.curr 
    });

    await saveDB();
    renderEmployees();
    renderDashboard(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ Ø¯Ø± ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
    if(document.getElementById('modalEmpLedger').style.display === 'flex') {
        openEmpLedger(empId); // Ø±ÙØ±Ø´ Ù„ÛŒØ³Øª Ø§Ú¯Ø± Ø¨Ø§Ø² Ø§Ø³Øª
    }
    alert("Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
}

// ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
function quickPaySalary(id) {
    const emp = db.employees.find(e => e.id === id);
    const amt = prompt(`Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ¬Ù‡ Ø¨Ù‡ ${emp.name}\nØ­Ù‚ÙˆÙ‚ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${emp.salary}\nÙ…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:`);
    if(amt && parseFloat(amt) > 0) {
        processEmployeePayment(id, parseFloat(amt), "Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ");
    }
}

function paySalaryFromLedger() {
    const id = document.getElementById('currentEmpId').value;
    quickPaySalary(id);
}

// 6. Ú†Ø§Ù¾ ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
function printEmpLedgerCurrent() {
    const id = document.getElementById('currentEmpId').value;
    if(!id) return;
    const emp = db.employees.find(e => e.id === id);
    const list = db.employeeLedger[id] || [];
    list.sort((a,b) => a.date - b.date);

    let rows = '';
    let balance = 0;
    
    list.forEach(tx => {
        if(tx.type === 'credit') balance += tx.amount; 
        else balance -= tx.amount;
        
        const cIn = tx.type==='credit' ? tx.amount.toLocaleString() : '';
        const cOut = tx.type==='debit' ? tx.amount.toLocaleString() : '';
        
        rows += `
        <tr>
            <td>${new Date(tx.date).toLocaleDateString('fa-IR')}</td>
            <td>${tx.desc}</td>
            <td>${cIn}</td>
            <td>${cOut}</td>
            <td dir="ltr">${balance.toLocaleString()}</td>
        </tr>`;
    });

    const win = window.open('', '_blank', 'width=800,height=1100');
    win.document.write(`
    <html><head><title>HR Statement</title>
    <style>
        body { font-family: 'Vazirmatn', Tahoma; direction: rtl; padding: 30px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background: #eee; }
    </style>
    </head><body>
        ${getPrintHeaderHTML()}
        <div class="header">
            <h2>ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯</h2>
            <div>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯: <b>${emp.name}</b> (${emp.job})</div>
            <div>ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´: ${new Date().toLocaleDateString('fa-IR')}</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ø´Ø±Ø­</th>
                    <th>Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø± (Ø­Ù‚ÙˆÙ‚)</th>
                    <th>Ø¨Ø¯Ù‡Ú©Ø§Ø± (Ø¨Ø±Ø¯Ø§Ø´Øª)</th>
                    <th>Ù…Ø§Ù†Ø¯Ù‡</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
        <div style="margin-top:20px; font-weight:bold; font-size:14px;">
            Ù…Ø§Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: ${balance.toLocaleString()} ${emp.curr}
        </div>
        <div style="margin-top:50px; display:flex; justify-content:space-between; width:80%">
            <div>Ø§Ù…Ø¶Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±</div>
            <div>Ø§Ù…Ø¶Ø§Ø¡ Ú©Ø§Ø±Ù…Ù†Ø¯</div>
        </div>
    </body></html>
    `);
    win.document.close(); win.print();
}

// 7. Ø­Ø°Ù Ú©Ø§Ø±Ù…Ù†Ø¯
async function deleteEmployee(id) {
    if(confirm("Ù‡Ø´Ø¯Ø§Ø±: Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§ÛŒÙ† Ú©Ø§Ø±Ù…Ù†Ø¯ Ùˆ ØªÙ…Ø§Ù… Ø³ÙˆØ§Ø¨Ù‚ Ù…Ø§Ù„ÛŒ Ø§Ùˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) {
        db.employees = db.employees.filter(e => e.id !== id);
        delete db.employeeLedger[id];
        await saveDB();
        renderEmployees();
    }
}

// 8. Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ÛŒÚ© ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø§Øµ (Revert) Ø§Ø² Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„
async function revertEmpTx(empId, txId) {
    const list = db.employeeLedger[empId];
    const tx = list.find(x => x.id === txId);
    if(!tx) return;

    if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ\nØ§Ú¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ù¾ÙˆÙ„ Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.")) return;

    // Ø§Ú¯Ø± Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆØ¬Ù‡ (Debit) Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ù¾ÙˆÙ„ Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø±Ú¯Ø±Ø¯Ø¯
    if (tx.type === 'debit') {
        db.cashBox[tx.curr] = (db.cashBox[tx.curr] || 0) + tx.amount;
        
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ùˆ Ø­Ø°Ù Ù„Ø§Ú¯ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø² Ú˜ÙˆØ±Ù†Ø§Ù„ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…ÛŒØ²ÛŒ Ú©Ø§Ø±
        const logIndex = db.journal.findIndex(j => j.data && j.data.txId === txId);
        if(logIndex > -1) db.journal.splice(logIndex, 1);
    }
    
    // Ø­Ø°Ù Ø§Ø² Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨
    db.employeeLedger[empId] = list.filter(x => x.id !== txId);

    await saveDB();
    openEmpLedger(empId);
    renderEmployees();
    renderDashboard();
    alert("ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø°Ù Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯.");
}
// === Ù¾Ø§ÛŒØ§Ù† Ú©Ø¯Ù‡Ø§ÛŒ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯ ===
function printEmpLedger(empId) {
    if(!empId) return;
    const emp = db.employees.find(e => e.id === empId);
    const list = db.employeeLedger[empId] || [];
    let rows = '';
    let balance = 0;
    
    list.forEach(tx => {
        if(tx.type === 'credit') balance += tx.amount; else balance -= tx.amount;
        rows += `<tr><td>${new Date(tx.date).toLocaleDateString('fa-IR')}</td><td>${tx.desc}</td><td>${tx.type==='debit'?tx.amount.toLocaleString():'-'}</td><td>${tx.type==='credit'?tx.amount.toLocaleString():'-'}</td><td dir="ltr">${balance.toLocaleString()}</td></tr>`;
    });

    const win = window.open('', '_blank', 'width=800,height=1000');
    win.document.write(`<html><head><title>Statement</title><style>body{font-family:'Vazirmatn', Tahoma; direction:rtl; padding:20px;} table{width:100%; border-collapse:collapse; margin-top:20px;} th,td{border:1px solid #000; padding:8px; text-align:center;} .header{text-align:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;}</style></head><body><div class="header"><h3>ØµÙˆØ±Øªâ€ŒØ­Ø³Ø§Ø¨ Ú©Ø§Ø±Ù…Ù†Ø¯</h3><div>Ù†Ø§Ù…: <b>${emp.name}</b> (${emp.job})</div><div>ØªØ§Ø±ÛŒØ® Ú†Ø§Ù¾: ${new Date().toLocaleDateString('fa-IR')}</div></div><table><thead><tr style="background:#eee;"><th>ØªØ§Ø±ÛŒØ®</th><th>Ø´Ø±Ø­</th><th>Ø¨Ø±Ø¯Ø§Ø´Øª</th><th>Ø­Ù‚ÙˆÙ‚</th><th>Ù…Ø§Ù†Ø¯Ù‡</th></tr></thead><tbody>${rows}</tbody></table><br><h3>Ù…Ø§Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${balance.toLocaleString()} ${emp.curr}</h3></body></html>`);
    win.document.close(); win.print();
}

// Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ù…Ù†ÙˆÛŒ "Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†" Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŒ Ù„ÛŒØ³Øª Ø±ÙØ±Ø´ Ø´ÙˆØ¯
const originalGo = window.go;
window.go = function(pageId) {
    originalGo(pageId);
    if(pageId === 'employees') {
        renderEmployees();
    }
};

function switchSettingsTab(tabId, btn) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-menu-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}
function saveLogo() {
    const file = document.getElementById('logoUploader').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        if(!db.settings) db.settings = {};
        db.settings.logo = e.target.result;
        await saveDB();
        document.getElementById('logoPreview').src = db.settings.logo;
        document.getElementById('logoPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function clearLogo() {
    if(confirm('Ø­Ø°Ù Ù„ÙˆÚ¯ÙˆØŸ')) {
        if(db.settings) db.settings.logo = null;
        saveDB();
        document.getElementById('logoPreview').style.display = 'none';
        document.getElementById('logoUploader').value = '';
    }
}

function renderInitialCapitalInputs() {
    const container = document.getElementById('initialCapitalInputs');
    if (!container) return;

    let html = '';
    if(!db.currencies) db.currencies = ['USD', 'AFN', 'EUR'];
    if(!db.initialCapital) db.initialCapital = {};
    if(!db.avgRates) db.avgRates = {};

    db.currencies.forEach(c => {
        const cap = db.initialCapital[c] || 0;
        const rate = db.avgRates[c] || 0;

        html += `
        <div style="background:rgba(0,0,0,0.1); padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--gold-border);">
            <div style="font-weight:bold; color:var(--gold-primary); margin-bottom:5px; border-bottom:1px solid var(--gold-border);">${c}</div>
            <div class="grid-2">
                <div>
                    <label class="label">Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ø±ÙˆØ¹)</label>
                    <input type="number" id="initCap_${c}" class="input" value="${cap}" onfocus="this.select()">
                </div>
                <div>
                    <label class="label">Ù†Ø±Ø® Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯ (Cost Rate)</label>
                    <input type="number" id="initRate_${c}" class="input" value="${rate}" onfocus="this.select()" placeholder="Ù…Ø«Ù„Ø§Ù‹: 1">
                </div>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

window.switchSettingsTab = function(tabId, btn) {
    // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªØ¨â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-menu-btn').forEach(b => b.classList.remove('active'));
    
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªØ¨ Ø¬Ø¯ÛŒØ¯
    const target = document.getElementById(tabId);
    if(target) target.classList.add('active');
    
    if(btn) btn.classList.add('active');

    // Ø§Ú¯Ø± ØªØ¨ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨ÙˆØ¯ØŒ Ø§ÛŒÙ†Ù¾ÙˆØªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø³Ø§Ø²
    if (tabId === 'tab-capital') {
        renderInitialCapitalInputs();
    }

    // *** (Ù…Ù‡Ù…) Ø§Ú¯Ø± ØªØ¨ Ø´Ù‡Ø±Ù‡Ø§ Ø¨ÙˆØ¯ØŒ Ù„ÛŒØ³Øª Ø´Ù‡Ø±Ù‡Ø§ Ø±Ø§ Ø¨Ø³Ø§Ø² ***
    if (tabId === 'tab-cities') {
        renderCityList();
    }
};
function renderCommissionCalc() {
    let cityData = {};
    db.hawalas.forEach(h => {
        if (h.comm && h.comm > 0) {
            const city = h.cityBook;
            const curr = h.commCurr || h.curr;
            
            if (!cityData[city]) cityData[city] = {};
            if (!cityData[city][curr]) cityData[city][curr] = 0;
            
            cityData[city][curr] += h.comm;
        }
    });

    const container = document.getElementById('commCalcBody');
    
    const pageContainer = document.querySelector('#commissions .card');
    
    let htmlContent = `
        <div class="card-header">
            <span>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ ØªÙ‚Ø³ÛŒÙ… Ø³ÙˆØ¯ (Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø´Ù‡Ø±)</span>
            <button class="btn btn-gold" onclick="renderCommissionCalc()">ğŸ”„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯</button>
        </div>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">
            * Ø¯Ø±ØµØ¯Ù‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø´Ù‡Ø± ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ ØªØ§ Ø±ÙˆÛŒ ØªÙ…Ø§Ù… Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¢Ù† Ø´Ù‡Ø± Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯.
        </p>
    `;

    if (Object.keys(cityData).length === 0) {
        htmlContent += `<div style="text-align:center; padding:20px;">Ù‡ÛŒÚ† Ú©Ù…ÛŒØ´Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>`;
        pageContainer.innerHTML = htmlContent;
        return;
    }

       for (let city in cityData) {
        
        const safeCityId = city.replace(/\s+/g, '_');
        
        htmlContent += `
        <div style="background:rgba(255,255,255,0.02); border:1px solid var(--gold-border); border-radius:12px; margin-bottom:25px; overflow:hidden;">
            
            <div style="background:rgba(212,175,55,0.1); padding:15px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; border-bottom:1px dashed var(--gold-border);">
                <div style="font-weight:900; font-size:18px; color:var(--gold-primary); margin-bottom:10px;">
                    ğŸ™ ${city}
                </div>
                
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; color:var(--success)">Ø³Ù‡Ù… Ù…Ø§:</span>
                        <input type="number" class="input" style="width:60px; margin:0; text-align:center; height:35px; border-color:var(--success)" 
                               value="40" id="pc_share_${safeCityId}" oninput="updateCityCalc('${safeCityId}')"> %
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; color:var(--gold-primary)">Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡:</span>
                        <input type="number" class="input" style="width:60px; margin:0; text-align:center; height:35px; border-color:var(--gold-primary)" 
                               value="40" id="pc_ag_${safeCityId}" oninput="updateCityCalc('${safeCityId}')"> %
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; color:var(--danger)">Ù‡Ø²ÛŒÙ†Ù‡:</span>
                        <input type="number" class="input" style="width:60px; margin:0; text-align:center; height:35px; border-color:var(--danger)" 
                               value="20" id="pc_tax_${safeCityId}" oninput="updateCityCalc('${safeCityId}')"> %
                    </div>
                </div>
            </div>

            <div class="table-container" style="padding:0;">
                <table style="margin:0; border:none;">
                    <thead>
                        <tr>
                            <th style="background:transparent; border-bottom:1px solid #444;">Ø§Ø±Ø²</th>
                            <th style="background:transparent; border-bottom:1px solid #444;">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ú©Ù…ÛŒØ´Ù†</th>
                            <th style="background:transparent; border-bottom:1px solid #444; color:var(--success)">âœ… Ø³Ù‡Ù… Ù…Ø§</th>
                            <th style="background:transparent; border-bottom:1px solid #444; color:var(--gold-primary)">ğŸ¤ Ø³Ù‡Ù… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</th>
                            <th style="background:transparent; border-bottom:1px solid #444; color:var(--danger)">ğŸ“‰ Ù‡Ø²ÛŒÙ†Ù‡/Ù…Ø§Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        for (let curr in cityData[city]) {
            const total = cityData[city][curr];
            const safeCurrId = curr.replace(/\s+/g, '_');
           
            const rowId = `${safeCityId}_${safeCurrId}`;
            
            htmlContent += `
                        <tr>
                            <td style="font-weight:bold;">${curr}</td>
                            <td style="font-weight:900; font-size:16px;" dir="ltr" id="total_${rowId}" data-val="${total}">
                                ${total.toLocaleString()}
                            </td>
                            <td style="font-weight:bold; color:var(--success);" dir="ltr" id="res_share_${rowId}">0</td>
                            <td style="font-weight:bold; color:var(--gold-primary);" dir="ltr" id="res_ag_${rowId}">0</td>
                            <td style="font-weight:bold; color:var(--danger);" dir="ltr" id="res_tax_${rowId}">0</td>
                        </tr>
            `;
        }

        htmlContent += `
                    </tbody>
                </table>
            </div>
            <input type="hidden" id="currencies_${safeCityId}" value="${Object.keys(cityData[city]).join(',')}">
        </div>
        `;
    }

    pageContainer.innerHTML = htmlContent;

    setTimeout(() => {
        for (let city in cityData) {
            updateCityCalc(city.replace(/\s+/g, '_'));
        }
    }, 100);
}

function updateCityCalc(cityId) {
    const pShare = parseFloat(document.getElementById(`pc_share_${cityId}`).value) || 0;
    const pAg = parseFloat(document.getElementById(`pc_ag_${cityId}`).value) || 0;
    const pTax = parseFloat(document.getElementById(`pc_tax_${cityId}`).value) || 0;

    const currString = document.getElementById(`currencies_${cityId}`).value;
    if (!currString) return;
    const currencies = currString.split(',');

    currencies.forEach(curr => {
        const safeCurr = curr.replace(/\s+/g, '_'); // Ø§Ú¯Ø± ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø´Øª
        const rowId = `${cityId}_${safeCurr}`;
        
        const totalEl = document.getElementById(`total_${rowId}`);
        const total = parseFloat(totalEl.getAttribute('data-val')) || 0;

        const valShare = (total * pShare) / 100;
        const valAg = (total * pAg) / 100;
        const valTax = (total * pTax) / 100;

        document.getElementById(`res_share_${rowId}`).innerText = valShare.toLocaleString(undefined, {maximumFractionDigits:1});
        document.getElementById(`res_ag_${rowId}`).innerText = valAg.toLocaleString(undefined, {maximumFractionDigits:1});
        document.getElementById(`res_tax_${rowId}`).innerText = valTax.toLocaleString(undefined, {maximumFractionDigits:1});
    });
}
function updateCommRow(key) {
    const row = document.getElementById(`row_${key}`);
    if(!row) return;
    
    const totalCell = row.querySelector('[data-total]');
    const total = parseFloat(totalCell.getAttribute('data-total')) || 0;

    const pOff = parseFloat(document.getElementById(`p_off_${key}`).value) || 0;
    const pAg = parseFloat(document.getElementById(`p_ag_${key}`).value) || 0;
    const pTax = parseFloat(document.getElementById(`p_tax_${key}`).value) || 0;

    const vOff = (total * pOff) / 100;
    const vAg = (total * pAg) / 100;
    const vTax = (total * pTax) / 100;

    document.getElementById(`res_off_${key}`).innerText = vOff.toLocaleString(undefined, {maximumFractionDigits:1});
    document.getElementById(`res_ag_${key}`).innerText = vAg.toLocaleString(undefined, {maximumFractionDigits:1});
    document.getElementById(`res_tax_${key}`).innerText = vTax.toLocaleString(undefined, {maximumFractionDigits:1});
}

function openHawalaModal(type) {
    const hiddenInput = document.getElementById('hType');
    if(hiddenInput) hiddenInput.value = type;

    const titleEl = document.getElementById('modalHawalaTitle');
    if (type === 'Outgoing') {
        titleEl.innerText = "Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡ Ø§Ø±Ø³Ø§Ù„ÛŒ (Outgoing)";
        titleEl.style.color = "var(--gold-primary)";
        titleEl.style.borderColor = "var(--gold-primary)";
    } else {
        titleEl.innerText = "Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ (Incoming)";
        titleEl.style.color = "#00e676";
        titleEl.style.borderColor = "#00e676";
    }

    const hasGroupAccess = currentUser.perms.access_group_b || currentUser.perms.admin;
    const groupDiv = document.getElementById('divHGroup');
    if(groupDiv) {
        groupDiv.style.display = hasGroupAccess ? 'block' : 'none';
        document.getElementById('hGroup').value = 'A'; // Ù‡Ù…ÛŒØ´Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±ÙˆÛŒ A Ø¨Ø§Ø´Ø¯
    }

    setHawalaCustType('external');
    openModal('modalNewHawala');
}

function renderCityList() {
    const container = document.getElementById('cityListContainer');
    if(!container) return;
    
    if(db.cities.length === 0) {
        container.innerHTML = '<div style="padding:10px; text-align:center; color:gray;">Ø´Ù‡Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
        return;
    }

    container.innerHTML = db.cities.map(c => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid var(--gold-border); background:rgba(255,255,255,0.02);">
            <div>
                <div style="font-weight:bold; color:var(--text-main);">${c.name} <span style="font-size:11px; color:var(--gold-primary);">(${c.code})</span></div>
                <div style="font-size:11px; opacity:0.8;">${c.rep || '-'}</div>
                <div style="font-size:10px; color:var(--text-muted);">${c.contact || ''}</div>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-outline btn-sm" onclick="prepareEditCity('${c.code}')">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button class="btn btn-red btn-sm" onclick="deleteSimpleCity('${c.code}')">ğŸ—‘</button>
            </div>
        </div>
    `).join('');
    
    // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø±Ø¯Ù† Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ùˆ Ø§Ù†ØªØ®Ø§Ø¨
    updateUI(); 
}


function prepareEditCity(code) {
    const city = db.cities.find(c => c.code === code);
    if(!city) return;

    document.getElementById('newCityName').value = city.name;
    document.getElementById('newCityCode').value = city.code;
    document.getElementById('newCityRep').value = city.rep || '';
    document.getElementById('newCityContact').value = city.contact || '';
    
    
    document.getElementById('editCityOldCode').value = city.code;
    
    
    const btnSave = document.getElementById('btnSaveCity');
    btnSave.innerText = "ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª";
    btnSave.classList.remove('btn-gold');
    btnSave.classList.add('btn-blue');
    
    document.getElementById('btnCancelEditCity').style.display = 'inline-block';
}


function cancelCityEdit() {
    document.getElementById('newCityName').value = '';
    document.getElementById('newCityCode').value = '';
    document.getElementById('newCityRep').value = '';
    document.getElementById('newCityContact').value = '';
    document.getElementById('editCityOldCode').value = '';
    
    const btnSave = document.getElementById('btnSaveCity');
    btnSave.innerText = "Ø«Ø¨Øª Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯";
    btnSave.classList.add('btn-gold');
    btnSave.classList.remove('btn-blue');
    
    document.getElementById('btnCancelEditCity').style.display = 'none';
}

async function saveCityProcess() {
    const name = document.getElementById('newCityName').value.trim();
    const code = document.getElementById('newCityCode').value.trim().toUpperCase();
    const rep = document.getElementById('newCityRep').value.trim();
    const contact = document.getElementById('newCityContact').value.trim();
    const oldCode = document.getElementById('editCityOldCode').value;

    if (!name || !code) { alert("Ù†Ø§Ù… Ùˆ Ú©Ø¯ Ø´Ù‡Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); return; }

    if (oldCode) {
        
        const index = db.cities.findIndex(c => c.code === oldCode);
        if (index !== -1) {
            db.cities[index] = { name, code, rep, contact };
            
            
            if (oldCode !== code) {
                db.hawalas.forEach(h => {
                    if (h.cityBook === oldCode) h.cityBook = code;
                });
                
                
                if(db.cityHawalaCounters[oldCode]) {
                    db.cityHawalaCounters[code] = db.cityHawalaCounters[oldCode];
                    delete db.cityHawalaCounters[oldCode];
                }
            }
            alert("Ù…Ø´Ø®ØµØ§Øª Ø´Ù‡Ø±/Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.");
        }
    } else {
        if (db.cities.some(c => c.code === code)) { alert("Ø§ÛŒÙ† Ú©Ø¯ Ø´Ù‡Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª!"); return; }
        
        db.cities.push({ name, code, rep, contact });
        db.cityHawalaCounters[code] = { Outgoing: 1001, Incoming: 1001 };
        alert("Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
    }

    await saveDB();
    cancelCityEdit(); 
    renderCityList(); 
}


async function deleteSimpleCity(code) {
    const hasData = db.hawalas.some(h => h.cityBook === code);
    if(hasData) {
        alert("Ø§ÛŒÙ† Ø´Ù‡Ø± Ø¯Ø§Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø³Øª Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³Ø±ÛŒØ¹ Ø­Ø°Ù Ú©Ù†ÛŒØ¯. Ø§Ø² Ø¨Ø®Ø´ Ø­Ø°Ù Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
        return;
    }
    if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø´Ù‡Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) return;
    
    db.cities = db.cities.filter(c => c.code !== code);
    await saveDB();
    renderCityList();
}
// --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§Ú©Ø³Ù„ Ú©Ø§Ù…Ù„ ---
function fullExcelBackup() {
    if (!confirm("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø§Ú©Ø³Ù„ (Excel) Ø§Ø² ØªÙ…Ø§Ù… Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ Ùˆ ØµÙ†Ø¯ÙˆÙ‚ ØªÙ‡ÛŒÙ‡ Ú©Ù†ÛŒØ¯ØŸ")) return;

    const wb = XLSX.utils.book_new();
    const dateStr = new Date().toLocaleDateString('fa-IR').replace(/\//g, '-');

    // 1. ØµÙØ­Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚
    const cashData = db.currencies.map(c => ({
        'Ø§Ø±Ø²': c,
        'Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ': (db.cashBox[c] || 0),
        'Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡': (db.initialCapital[c] || 0)
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cashData), "Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚");

    // 2. ØµÙØ­Ù‡ Ù„ÛŒØ³Øª Ø­ÙˆØ§Ù„Ù‡â€ŒÙ‡Ø§
    const hawalaData = db.hawalas.map(h => ({
        'Ø´Ù…Ø§Ø±Ù‡': h.displayId || h.id,
        'Ù†ÙˆØ¹': h.type === 'Outgoing' ? 'Ø§Ø±Ø³Ø§Ù„ÛŒ' : 'Ø¯Ø±ÛŒØ§ÙØªÛŒ',
        'Ø´Ù‡Ø±': h.cityBook,
        'Ù…Ø¨Ù„Øº': h.amt,
        'Ø§Ø±Ø²': h.curr,
        'ÙØ±Ø³ØªÙ†Ø¯Ù‡': h.sender,
        'Ú¯ÛŒØ±Ù†Ø¯Ù‡': h.receiver,
        'ÙˆØ¶Ø¹ÛŒØª': h.status === 'Done' ? 'ØªÙ…Ø§Ù… Ø´Ø¯Ù‡' : 'Ù…Ø¹Ù„Ù‚'
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hawalaData), "Ù„ÛŒØ³Øª Ø­ÙˆØ§Ù„Ø¬Ø§Øª");

    // 3. ØµÙØ­Ù‡ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù†
    let accountSummary = [];
    if (db.customers) {
        db.customers.forEach(cust => {
            const txList = db.accounts[cust.name] || [];
            let bals = {};
            txList.forEach(t => { bals[t.curr] = (bals[t.curr] || 0) + (t.credit - t.debit); });
            // ØªØ¨Ø¯ÛŒÙ„ Ù…Ø§Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ù…ØªÙ† Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù†
            let balStr = Object.entries(bals)
                .filter(([k,v]) => Math.abs(v) > 0)
                .map(([k,v]) => `${v.toLocaleString()} ${k}`)
                .join(' | ');
            
            if(balStr) {
                accountSummary.push({ 
                    'Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ': cust.name, 
                    'ØªÙ„ÙÙ†': cust.phone, 
                    'Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨': balStr 
                });
            }
        });
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(accountSummary), "Ù…Ø§Ù†Ø¯Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù†");

    // 4. ØµÙØ­Ù‡ Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ…
    const logData = db.journal.map(j => ({
        'Ø²Ù…Ø§Ù†': new Date(j.time).toLocaleString('fa-IR'),
        'Ø¨Ø®Ø´': j.section,
        'ØªÙˆØ¶ÛŒØ­Ø§Øª': j.desc,
        'Ù…Ø¨Ù„Øº': j.amt,
        'Ú©Ø§Ø±Ø¨Ø±': j.user
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logData), "Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ…");

    // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
    XLSX.writeFile(wb, `Excel_Report_${dateStr}.xlsx`);
}
// =========================================
// Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª (Ø´Ø±ÙˆØ¹)
// =========================================

// 1. Ù‡ÙˆØ´Ù…Ù†Ø¯Ø³Ø§Ø²ÛŒ Ù…Ù†ÙˆÛŒ Ù¾Ø§ÛŒÛŒÙ†
const originalGoFunc = window.go;
window.go = function(pageId) {
    if(typeof originalGoFunc === 'function') originalGoFunc(pageId);
    
    // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    document.querySelectorAll('.m-nav-item').forEach(b => b.classList.remove('active'));
    if(pageId === 'dashboard') document.getElementById('mn-dash')?.classList.add('active');
    if(pageId === 'hawala') document.getElementById('mn-hawala')?.classList.add('active');
    if(pageId === 'accounts') document.getElementById('mn-acc')?.classList.add('active');
    
    document.getElementById('fabMenu').style.display = 'none';
    window.scrollTo(0,0);
};

// =========================================
// Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
// =========================================

// Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ú©Ù…Ù‡ Ø´Ù†Ø§ÙˆØ± Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ùˆ Ø¨Ù„ÙˆØ±
function toggleFab() {
    const m = document.getElementById('fabMenu');
    const fabBtn = document.querySelector('.fab-btn');
    const content = document.querySelector('.content');
    
    if (m.style.display === 'flex') {
        m.style.display = 'none';
        fabBtn.style.transform = 'translateX(-50%) rotate(0deg)';
        fabBtn.style.background = 'linear-gradient(135deg, #fbbf24, #b45309)';
        fabBtn.innerHTML = '<span style="font-size:30px; margin-top:-2px;">+</span>';
        if(content) content.style.filter = 'none';
    } else {
        m.style.display = 'flex';
        fabBtn.style.transform = 'translateX(-50%) rotate(45deg)';
        fabBtn.style.background = '#ff5252'; 
        fabBtn.innerHTML = '<span style="font-size:30px; margin-top:-2px;">+</span>';
        if(content) content.style.filter = 'blur(5px)';
    }
}

// Ø§ØµÙ„Ø§Ø­ Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ø±Ù†Ú¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø§Ø³Ú©Ø±ÙˆÙ„)
const originalGoFuncMobile = window.go;
window.go = function(pageId) {
    if(typeof originalGoFuncMobile === 'function') originalGoFuncMobile(pageId);
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ú©ØªÛŒÙˆ Ø¨ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
    document.querySelectorAll('.m-nav-item').forEach(b => b.classList.remove('active'));
    if(pageId === 'dashboard') document.getElementById('mn-dash')?.classList.add('active');
    if(pageId === 'hawala') document.getElementById('mn-hawala')?.classList.add('active');
    if(pageId === 'accounts') document.getElementById('mn-acc')?.classList.add('active');
    
    // Ø¨Ø³ØªÙ† Ù…Ù†ÙˆÛŒ Ø´Ù†Ø§ÙˆØ± Ø§Ú¯Ø± Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯
    const m = document.getElementById('fabMenu');
    if(m && m.style.display === 'flex') toggleFab();
    
    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡
    window.scrollTo({ top: 0, behavior: 'smooth' });
};
</script>
</body>
</html>
