<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Royal Salon AF | سیستم مدیریت جامع آرایشگاه (افغانستان)</title>
    <meta name="description" content="سیستم مدیریت حرفه‌ای آرایشگاه با استانداردهای مالی افغانستان">
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> <style>
    /* ========================================= 
       1. CSS VARIABLES (THE ROYAL THEME - FROM INDEX9)
       ========================================= */
    :root {
        /* --- Main Luxury Palette (Burgundy & Gold) --- */
        --gold-primary: #D4AF37;
        --gold-light: #FEDC56;
        --gold-dark: #AA8C2C;
        --gold-gradient: linear-gradient(135deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
        
        --burgundy-deep: #2D0008;
        --burgundy-main: #4A0410;
        --burgundy-light: #680818;
        --burgundy-glass: rgba(74, 4, 16, 0.85);
        
        /* --- Backgrounds --- */
        --bg-body: #1a0003;
        --bg-card: rgba(40, 0, 8, 0.7);
        --bg-input: rgba(0, 0, 0, 0.4);
        --bg-sidebar: rgba(45, 0, 8, 0.95);
        
        /* --- Text Colors --- */
        --text-main: #FFFFFF;
        --text-muted: #D4AF37; /* Gold as muted text for luxury feel */
        --text-gold: #F4E298;
        --text-dim: rgba(255, 255, 255, 0.6);
        
        /* --- Borders & Effects --- */
        --border-gold: 1px solid rgba(212, 175, 55, 0.4);
        --border-glow: 0 0 10px rgba(212, 175, 55, 0.3);
        
        --shadow-luxury: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        --glass-blur: blur(12px);
        
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;
        
        /* --- Status Colors --- */
        --success: #00C853;
        --danger: #FF1744;
        --warning: #FFAB00;
        --info: #00B0FF;

        /* --- Animations --- */
        --anim-fast: 0.2s ease;
        --anim-med: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        --anim-slow: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* =========================================
       2. LIGHT THEME OVERRIDES (Soft & Clean)
       ========================================= */
    [data-theme="light"] {
        /* Backgrounds */
        --bg-body: #F3F4F6;
        --bg-card: #FFFFFF;
        --bg-input: #F9FAFB;
        --bg-sidebar: #FFFFFF;
        
        /* Text */
        --text-main: #1F2937;
        --text-muted: #6B7280;
        --text-gold: #B45309;
        --text-dim: #9CA3AF;
        
        /* Gold Accents (Darker for light bg) */
        --gold-primary: #D97706;
        --gold-light: #F59E0B;
        --gold-dark: #B45309;
        --gold-gradient: linear-gradient(135deg, #F59E0B, #D97706);
        
        /* Burgundy Accents */
        --burgundy-deep: #FFFFFF; /* Inverted for text readability on buttons */
        --burgundy-main: #FFFFFF;
        
        /* Borders & Effects */
        --border-gold: 1px solid #E5E7EB;
        --shadow-luxury: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --glass-blur: none;
    }
/* =========================================
       3. GLOBAL RESET & TYPOGRAPHY
       ========================================= */
    * {
        margin: 0; 
        padding: 0; 
        box-sizing: border-box;
        font-family: 'Vazirmatn', sans-serif;
        -webkit-tap-highlight-color: transparent;
    }

    /* Custom Scrollbar */
    * {
        scrollbar-width: thin;
        scrollbar-color: var(--gold-dark) var(--bg-body);
    }
    *::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    *::-webkit-scrollbar-track {
        background: var(--bg-body);
    }
    *::-webkit-scrollbar-thumb {
        background: var(--gold-dark);
        border-radius: 10px;
    }
    *::-webkit-scrollbar-thumb:hover {
        background: var(--gold-primary);
    }

    /* Body Structure */
    body {
        background-color: var(--bg-body);
        /* Luxurious Pattern for Dark Mode */
        background-image: radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 20%);
        color: var(--text-main);
        height: 100vh; 
        overflow: hidden; 
        display: flex; 
        font-size: 14px;
        line-height: 1.6;
        transition: background-color 0.3s, color 0.3s;
    }

    [data-theme="light"] body {
        background-image: none;
    }

    /* Selection Highlighting */
    ::selection {
        background: var(--gold-primary);
        color: var(--burgundy-deep);
    }

    /* =========================================
       4. UTILITY CLASSES (GLASS & CARDS)
       ========================================= */
    .glass-panel, .card, .stat-card, .sidebar, .top-header {
        background: var(--bg-card);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: var(--border-gold);
        box-shadow: var(--shadow-luxury);
        transition: all var(--anim-med);
    }

    .card {
        border-radius: var(--radius-md); 
        padding: 25px; 
        margin-bottom: 25px; 
        position: relative;
        overflow: hidden;
    }

    /* Golden top border accent for cards */
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--gold-gradient);
        opacity: 0.7;
    }

    /* =========================================
       5. BUTTONS (ROYAL STYLE)
       ========================================= */
    .btn {
        padding: 10px 24px;
        border-radius: var(--radius-sm);
        border: none;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all var(--anim-fast);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
        outline: none;
    }

    /* Primary Gold Button */
    .gold-btn, .btn-primary {
        background: var(--gold-gradient);
        color: var(--burgundy-deep);
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }
    
    [data-theme="light"] .gold-btn, 
    [data-theme="light"] .btn-primary {
        color: #fff; /* White text on gold button in light mode */
    }

    .gold-btn:hover, .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
    }

    .gold-btn:active, .btn-primary:active {
        transform: translateY(0);
    }

    /* Icon Buttons (Square/Circle) */
    .icon-btn {
        width: 40px; 
        height: 40px; 
        border-radius: 12px;
        border: 1px solid var(--gold-dark); 
        background: rgba(0,0,0,0.3);
        color: var(--gold-light); 
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer; 
        transition: 0.3s; 
        font-size: 18px;
    }
    
    [data-theme="light"] .icon-btn {
        background: #fff;
        border-color: #E5E7EB;
        color: var(--text-muted);
    }

    .icon-btn:hover {
        background: var(--gold-primary); 
        color: var(--burgundy-deep);
        border-color: var(--gold-primary);
    }
<style>
    #loginPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: #2D0008; /* همان رنگ زرشکی اصلی */

        /* همان پترن طلایی اصلی */
        background-image: 
            repeating-linear-gradient(45deg, transparent 0, transparent 60px, rgba(212, 175, 55, 0.2) 60px, rgba(212, 175, 55, 0.2) 61px),
            repeating-linear-gradient(-45deg, transparent 0, transparent 60px, rgba(212, 175, 55, 0.2) 60px, rgba(212, 175, 55, 0.2) 61px),
            radial-gradient(circle at center, transparent 20%, #000000 100%);
    }

    #loginPage::before {
        content: '';
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        opacity: 0.5;
        animation: rotateBackground 200s linear infinite;
        pointer-events: none;
    }

    @keyframes rotateBackground {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

  .login-card {
    position: relative;
    width: 90%;
    /* تغییر از 700 به 420 برای تمرکز و زیبایی بیشتر */
    max-width: 420px; 
    
    background: rgba(45, 0, 8, 0.75); /* کمی شفاف‌تر برای دیده شدن پترن زیرین */
    backdrop-filter: blur(25px);      /* بلور بیشتر برای حس شیشه‌ای */
    -webkit-backdrop-filter: blur(25px);
    
    border: 1px solid rgba(212, 175, 55, 0.5); /* حاشیه ظریف‌تر */
    border-radius: 24px;
    padding: 40px 30px;
    
    /* سایه عمیق‌تر برای جدا شدن از پس‌زمینه */
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 
                inset 0 0 0 1px rgba(255, 255, 255, 0.1); 
    
    text-align: center;
    overflow: hidden;
    animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 10;
}

    .login-card::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(212, 175, 55, 0.1), transparent);
        transform: rotate(45deg);
        animation: shimmer 6s infinite linear;
        pointer-events: none;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%) rotate(45deg); }
        100% { transform: translateX(100%) rotate(45deg); }
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .brand-logo {
        width: 100px;
        height: 100px;
        margin: 0 auto 20px;
        background: var(--gold-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #2D0008;
        box-shadow: 0 0 25px var(--gold-dark);
        border: 3px solid #fff;
        position: relative;
        z-index: 2;
    }

    .login-title {
        font-size: 28px;
        font-weight: 900;
        margin-bottom: 5px;
        background: var(--gold-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .login-subtitle {
        font-size: 13px;
        color: var(--text-gold);
        margin-bottom: 30px;
        opacity: 0.8;
    }

    .login-input-group {
    position: relative;
    margin-bottom: 25px; /* فاصله بیشتر بین فیلدها */
    width: 100%;         /* عرض کامل نسبت به کارت جدید */
    margin-left: 0;
    margin-right: 0;
}

.login-input {
    width: 100%;
    padding: 16px 50px 16px 20px; /* فضای کافی برای آیکون */
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 12px; /* گردی کمتر برای حس مدرن‌تر (به جای 50px) */
    color: var(--gold-light);
    font-size: 15px;
    transition: all 0.3s ease;
    outline: none;
    text-align: right; /* راست‌چین برای خوانایی بهتر در فارسی */
    direction: rtl;
}

.login-input:focus {
    border-color: var(--gold-primary);
    background: rgba(0, 0, 0, 0.6);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
    transform: translateY(-2px);
}
    .login-input-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gold-primary);
        font-size: 18px;
    }

    .btn-login {
    width: 100%; /* تمام عرض */
    padding: 16px;
    border-radius: 12px; /* هماهنگ با اینپوت‌ها */
    /* بقیه استایل‌ها عالی هستند */
    background: var(--gold-gradient);
    color: #2D0008;
    font-weight: 800;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
    transition: transform 0.2s, box-shadow 0.2s;
}
    .btn-login:hover {
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
    }

    .forgot-pass {
        display: block;
        margin-top: 20px;
        color: var(--text-muted);
        font-size: 12px;
        text-decoration: none;
        transition: 0.3s;
    }
    
    #loginError {
        color: var(--danger);
        margin-top: 15px;
        font-size: 13px;
        display: none;
        animation: shake 0.3s;
    }
</style>
<style>
    /* =========================================
       7. FORMS & INPUTS (LUXURY STYLE)
       ========================================= */
    .form-group {
        margin-bottom: 20px;
        position: relative;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        color: var(--gold-light);
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .form-label.required::after {
        content: ' *';
        color: var(--danger);
    }

    /* Standard Luxury Input */
    .form-control, .lux-input, .lux-select, .lux-textarea {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-input);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 12px;
        color: var(--text-main);
        font-size: 14px;
        transition: 0.3s;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        outline: none;
    }

    /* Input Focus State */
    .form-control:focus, .lux-input:focus, .lux-select:focus, .lux-textarea:focus {
        border-color: var(--gold-primary);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.15);
        background: rgba(0, 0, 0, 0.6);
        transform: scale(1.01);
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }
    
    [data-theme="light"] .form-control::placeholder {
        color: rgba(0, 0, 0, 0.4);
    }

    /* Custom Select Arrow */
    select.form-control, select.lux-select {
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23D4AF37' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: left 15px center; /* RTL friendly */
    }

    /* Checkbox & Radio */
    .form-check {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .form-check input[type="checkbox"],
    .form-check input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: var(--gold-primary);
        cursor: pointer;
        filter: hue-rotate(45deg); /* Slight gold tint adjust */
    }

    /* =========================================
       8. TABLES (ROYAL DATA GRID)
       ========================================= */
    .table-container {
        width: 100%;
        overflow-x: auto;
        border-radius: 16px;
        border: 1px solid rgba(212, 175, 55, 0.2);
        background: rgba(0, 0, 0, 0.2);
        margin-top: 15px;
    }
    
    [data-theme="light"] .table-container {
        background: #fff;
    }

    .lux-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px;
    }

    .lux-table thead th {
        background: linear-gradient(90deg, rgba(45,0,8,0.9), rgba(60,0,10,0.9));
        color: var(--gold-primary);
        padding: 18px 20px;
        text-align: right;
        font-weight: 800;
        font-size: 13px;
        border-bottom: 2px solid var(--gold-dark);
        white-space: nowrap;
    }
    
    [data-theme="light"] .lux-table thead th {
        background: #F3F4F6;
        color: var(--gold-dark);
        border-bottom: 2px solid #D1D5DB;
    }

    .lux-table tbody td {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        color: var(--text-main);
        font-size: 14px;
        vertical-align: middle;
    }

    .lux-table tbody tr {
        transition: 0.2s;
    }

    .lux-table tbody tr:hover {
        background: rgba(212, 175, 55, 0.08);
    }

    .lux-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* =========================================
       9. BADGES & STATUS INDICATORS
       ========================================= */
    .status-badge, .badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 12px;
        border-radius: 30px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
    }

    /* Status Colors */
    .status-success, .badge-success { 
        background: rgba(0, 200, 83, 0.15); 
        color: #00E676; 
        border: 1px solid rgba(0, 200, 83, 0.3); 
    }
    
    .status-warning, .badge-warning { 
        background: rgba(255, 171, 0, 0.15); 
        color: #FFD740; 
        border: 1px solid rgba(255, 171, 0, 0.3); 
    }
    
    .status-danger, .badge-danger { 
        background: rgba(255, 23, 68, 0.15); 
        color: #FF5252; 
        border: 1px solid rgba(255, 23, 68, 0.3); 
    }
    
    .status-info, .badge-info { 
        background: rgba(0, 176, 255, 0.15); 
        color: #40C4FF; 
        border: 1px solid rgba(0, 176, 255, 0.3); 
    }
    
    .status-neutral, .badge-neutral { 
        background: rgba(255, 255, 255, 0.1); 
        color: #ccc; 
        border: 1px solid rgba(255, 255, 255, 0.2); 
    }
    
    [data-theme="light"] .status-neutral {
        background: #EEE; color: #555; border: 1px solid #CCC;
    }
</style>
<style>
    /* =========================================
       10. MAIN LAYOUT STRUCTURE
       ========================================= */
    #mainApp {
        display: none; /* Hidden by default until login */
        width: 100%;
        height: 100%;
        flex-direction: row;
        overflow: hidden;
        position: relative;
        z-index: 1;
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        position: relative;
    }

    .page-container {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        scroll-behavior: smooth;
    }

    /* Page Transitions */
    .page-section {
        display: none;
        animation: fadeInPage 0.4s ease-out;
    }
    
    .page-section.active {
        display: block;
    }

    @keyframes fadeInPage {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* =========================================
       11. SIDEBAR & NAVIGATION (ROYAL THEME)
       ========================================= */
    .sidebar {
        width: 280px;
        height: 100%;
        background: var(--bg-sidebar);
        backdrop-filter: blur(15px);
        border-left: 1px solid var(--gold-dark); /* RTL Border */
        display: flex;
        flex-direction: column;
        z-index: 100;
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 5px 0 25px rgba(0,0,0,0.5);
        flex-shrink: 0;
        overflow-y: auto;
    }

    .sidebar.collapsed {
        width: 80px;
    }

    .sidebar-header {
        text-align: center;
        padding: 25px 10px;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        background: linear-gradient(180deg, rgba(45,0,8,0.8), transparent);
    }

    .sidebar-logo {
        font-size: 28px;
        color: var(--gold-primary);
        margin-bottom: 5px;
        text-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    }

    .sidebar-title {
        font-size: 18px;
        font-weight: 900;
        background: var(--gold-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
        transition: opacity 0.3s;
    }

    .sidebar.collapsed .sidebar-title,
    .sidebar.collapsed .sidebar-subtitle {
        display: none;
    }

    /* Nav Items */
    .nav-menu {
        flex: 1;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .nav-item {
        position: relative;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 14px 15px;
        border-radius: 12px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        border: 1px solid transparent;
    }

    .nav-link:hover {
        background: rgba(212, 175, 55, 0.1);
        color: var(--gold-light);
        border-color: rgba(212, 175, 55, 0.2);
        transform: translateX(-5px); /* RTL move left */
    }

    .nav-link.active {
        background: var(--gold-gradient);
        color: #2D0008;
        font-weight: 800;
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
    }

    .nav-link i {
        width: 25px;
        text-align: center;
        font-size: 18px;
        margin-left: 10px;
    }

    .nav-link .arrow {
        margin-right: auto; /* Push to left in RTL */
        font-size: 12px;
        transition: transform 0.3s;
    }
    
    .nav-link.active .arrow {
        transform: rotate(-90deg); /* RTL Rotate */
    }

    /* Submenu */
    .submenu {
        max-height: 0;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        margin-top: 2px;
        transition: max-height 0.4s ease;
    }
    
    .submenu.open {
        max-height: 500px; /* Arbitrary large height */
    }

    .submenu-item {
        display: flex;
        align-items: center;
        padding: 10px 15px 10px 45px; /* Indent for RTL */
        color: var(--text-dim);
        font-size: 13px;
        cursor: pointer;
        transition: 0.2s;
        text-decoration: none;
    }

    .submenu-item:hover {
        color: var(--gold-light);
        background: rgba(255, 255, 255, 0.05);
    }
    
    .submenu-item i {
        font-size: 10px;
        margin-left: 10px;
        opacity: 0.7;
    }

    /* Sidebar Collapse Toggle */
    .sidebar-toggle {
        padding: 15px;
        text-align: center;
        cursor: pointer;
        color: var(--gold-dark);
        border-top: 1px solid rgba(212, 175, 55, 0.1);
    }
    
    .sidebar.collapsed .nav-link span,
    .sidebar.collapsed .nav-link .arrow,
    .sidebar.collapsed .submenu {
        display: none !important;
    }

    /* =========================================
       12. TOP HEADER
       ========================================= */
    .top-header {
        height: 70px;
        background: rgba(45, 0, 8, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        z-index: 90;
    }

    .page-title {
        font-size: 22px;
        font-weight: 900;
        color: var(--gold-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .page-title::before {
        content: '';
        display: block;
        width: 4px;
        height: 24px;
        background: var(--gold-gradient);
        border-radius: 4px;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    /* =========================================
       13. MODALS (POPUPS)
       ========================================= */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10, 0, 2, 0.9);
        backdrop-filter: blur(8px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }

    .lux-modal {
        background: linear-gradient(145deg, rgba(40, 0, 8, 0.95), #1a0003);
        border: 2px solid var(--gold-dark);
        border-radius: 20px;
        width: 95%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 0 60px rgba(0,0,0,0.8), 0 0 20px rgba(212, 175, 55, 0.15);
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        flex-direction: column;
    }
    
    [data-theme="light"] .lux-modal {
        background: #FFF;
        border-color: #DDD;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-overlay.active .lux-modal {
        transform: scale(1);
    }

    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(212, 175, 55, 0.05);
    }

    .modal-title {
        font-size: 18px;
        color: var(--gold-primary);
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .close-modal {
        background: none;
        border: none;
        color: var(--danger);
        font-size: 24px;
        cursor: pointer;
        transition: 0.3s;
        width: 30px; 
        height: 30px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }

    .close-modal:hover {
        background: rgba(255, 23, 68, 0.1);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 25px;
        flex: 1;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid rgba(212, 175, 55, 0.2);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        background: rgba(0, 0, 0, 0.2);
    }
</style>
<style>
    /* =========================================
       14. GRID SYSTEM
       ========================================= */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }

    /* =========================================
       15. STAT CARDS (DASHBOARD)
       ========================================= */
    .stat-card {
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::after {
        content: '';
        position: absolute;
        right: -20px; top: -20px;
        width: 100px; height: 100px;
        background: var(--gold-primary);
        filter: blur(60px);
        opacity: 0.1;
        border-radius: 50%;
    }

    .stat-icon-box {
        width: 60px; height: 60px;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(0, 0, 0, 0.4));
        border: 1px solid var(--gold-dark);
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        color: var(--gold-light);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 2;
    }
    
    [data-theme="light"] .stat-icon-box {
        background: #F3F4F6;
        border-color: #E5E7EB;
        color: var(--gold-dark);
    }

    .stat-info { flex: 1; z-index: 2; }

    .stat-label {
        font-size: 13px; color: var(--text-muted);
        margin-bottom: 5px; font-weight: 500;
    }

    .stat-value {
        font-size: 24px; font-weight: 900;
        color: var(--text-main);
        letter-spacing: 0.5px;
        font-family: 'Vazirmatn', sans-serif;
    }

    /* =========================================
       16. TABS (SETTINGS PAGE)
       ========================================= */
    .tabs {
        display: flex; gap: 10px;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        margin-bottom: 25px;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 10px 20px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 14px; font-weight: bold;
        cursor: pointer;
        position: relative;
        white-space: nowrap;
        transition: 0.3s;
    }

    .tab-btn:hover { color: var(--gold-light); }

    .tab-btn.active {
        color: var(--gold-primary);
    }
    
    .tab-btn.active::after {
        content: '';
        position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px;
        background: var(--gold-gradient);
        border-radius: 3px 3px 0 0;
    }

    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }

    /* =========================================
       17. TOAST NOTIFICATIONS
       ========================================= */
    .toast-container {
        position: fixed; top: 20px; left: 20px; /* LTR Position for RTL Layout */
        z-index: 10000;
        display: flex; flex-direction: column; gap: 10px;
    }
    
    html[dir="rtl"] .toast-container { left: auto; right: 20px; }

    .lux-toast {
        min-width: 300px;
        background: rgba(45, 0, 8, 0.95);
        backdrop-filter: blur(10px);
        border-right: 4px solid var(--gold-primary);
        border-radius: 8px;
        padding: 15px 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        display: flex; align-items: center; gap: 15px;
        animation: slideInToast 0.4s ease forwards;
        color: #fff;
    }

    .lux-toast.success { border-color: var(--success); }
    .lux-toast.error { border-color: var(--danger); }
    
    @keyframes slideInToast {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* =========================================
       18. RESPONSIVE MEDIA QUERIES
       ========================================= */
    @media (max-width: 900px) {
        .sidebar { position: absolute; right: -280px; height: 100%; }
        .sidebar.open { right: 0; box-shadow: -10px 0 30px rgba(0,0,0,0.8); }
        .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        .top-header { padding: 0 15px; }
        .lux-modal { width: 95%; max-height: 85vh; }
    }
</style>
</head>
<body>

<div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1a0003; z-index:10000; display:flex; align-items:center; justify-content:center; transition:opacity 0.5s;">
    <div class="spinner-dual" style="width:50px; height:50px; border:3px solid var(--gold-dark); border-top-color:var(--gold-light); border-radius:50%; animation:spin 1s infinite linear;"></div>
</div>
<style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

<div id="loginPage">
    <div class="login-card">
        <div class="brand-logo">
            <i class="fa-solid fa-scissors"></i>
        </div>
        <h1 class="login-title">Royal Salon AF</h1>
        <p class="login-subtitle">سیستم مدیریت آرایشگاه (افغانستان)</p>
        
        <form onsubmit="event.preventDefault(); handleLogin();">
            <div class="login-input-group">
                <i class="fa-solid fa-user login-input-icon"></i>
                <input type="text" id="loginUser" class="login-input" placeholder="نام کاربری" autocomplete="off" autofocus>
            </div>
            
            <div class="login-input-group">
                <i class="fa-solid fa-lock login-input-icon"></i>
                <input type="password" id="loginPass" class="login-input" placeholder="رمز عبور">
            </div>

            <button type="submit" class="btn-login">
                ورود به سیستم <i class="fa-solid fa-arrow-left" style="margin-right:8px"></i>
            </button>
        </form>
        
        <p id="loginError">نام کاربری یا رمز عبور اشتباه است</p>
        
        <div style="margin-top:20px; font-size:11px; color:rgba(255,255,255,0.3);">
            نسخه 2.0.1 | واحد پول: افغانی (AFN)
        </div>
    </div>
</div>
<div id="mainApp">
    
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fa-solid fa-crown fa-spin-pulse" style="--fa-animation-duration: 3s;"></i>
            </div>
            <h2 class="sidebar-title">Royal Salon AF</h2>
            <div class="sidebar-subtitle" style="font-size: 11px; color: var(--gold-dark); margin-top: 5px; opacity:0.8;">
                نسخه مدیریت افغانستان
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-item">
                <div class="nav-link active" onclick="navigateTo('dashboard', this)">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>داشبورد مدیریتی</span>
                </div>
            </div>
            
            <div class="nav-item">
                <div class="nav-link" onclick="toggleSubmenu(this)">
                    <i class="fa-solid fa-cash-register"></i>
                    <span>صندوق و فروش</span>
                    <i class="fa-solid fa-chevron-left arrow"></i>
                </div>
                <div class="submenu">
                    <div class="submenu-item" onclick="navigateTo('pos', this)">
                        <i class="fa-solid fa-cart-shopping"></i> فاکتور فروش جدید
                    </div>
                    <div class="submenu-item" onclick="openModal('modalRegister')">
                        <i class="fa-solid fa-door-open"></i> باز/بستن صندوق
                    </div>
                    <div class="submenu-item" onclick="navigateTo('invoices', this)">
                        <i class="fa-solid fa-receipt"></i> تاریخچه فاکتورها
                    </div>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-link" onclick="toggleSubmenu(this)">
                    <i class="fa-solid fa-calendar-check"></i>
                    <span>نوبت‌دهی و رزرو</span>
                    <i class="fa-solid fa-chevron-left arrow"></i>
                </div>
                <div class="submenu">
                    <div class="submenu-item" onclick="navigateTo('appointments', this)">
                        <i class="fa-solid fa-list-check"></i> لیست نوبت‌ها
                    </div>
                    <div class="submenu-item" onclick="openModal('modalAppointment')">
                        <i class="fa-solid fa-plus"></i> ثبت نوبت جدید
                    </div>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-link" onclick="toggleSubmenu(this)">
                    <i class="fa-solid fa-wallet"></i>
                    <span>حسابداری & مالیات</span>
                    <i class="fa-solid fa-chevron-left arrow"></i>
                </div>
                <div class="submenu">
                    <div class="submenu-item" onclick="navigateTo('accounting', this)">
                        <i class="fa-solid fa-money-bill-transfer"></i> درآمد و هزینه
                    </div>
                    <div class="submenu-item" onclick="navigateTo('debts', this)">
                        <i class="fa-solid fa-hand-holding-dollar"></i> دفتر بدهکاران
                    </div>
                    <div class="submenu-item" onclick="navigateTo('taxes', this)">
                        <i class="fa-solid fa-scale-balanced"></i> گزارش مالیاتی (BRT)
                    </div>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-link" onclick="toggleSubmenu(this)">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    <span>انبار محصولات</span>
                    <i class="fa-solid fa-chevron-left arrow"></i>
                </div>
                <div class="submenu">
                    <div class="submenu-item" onclick="navigateTo('inventory', this)">
                        <i class="fa-solid fa-list"></i> موجودی کالا
                    </div>
                    <div class="submenu-item" onclick="openModal('modalProduct')">
                        <i class="fa-solid fa-box-open"></i> تعریف کالا/مواد
                    </div>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-link" onclick="navigateTo('personnel', this)">
                    <i class="fa-solid fa-id-card-clip"></i>
                    <span>پرسنل و حقوق</span>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-link" onclick="navigateTo('customers', this)">
                    <i class="fa-solid fa-users"></i>
                    <span>باشگاه مشتریان</span>
                </div>
            </div>
            
             <div class="nav-item">
                <div class="nav-link" onclick="navigateTo('services', this)">
                    <i class="fa-solid fa-scissors"></i>
                    <span>مدیریت خدمات</span>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-link" onclick="navigateTo('settings', this)">
                    <i class="fa-solid fa-gear"></i>
                    <span>تنظیمات سیستم</span>
                </div>
            </div>
        </nav>

        <div style="margin-top: auto; padding: 20px; border-top: 1px solid rgba(212, 175, 55, 0.2); display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--gold-gradient); display: flex; align-items: center; justify-content: center; color: #2D0008; font-weight: bold;">
                <i class="fa-solid fa-user-tie"></i>
            </div>
            <div style="flex: 1; overflow: hidden;">
                <div id="sidebarUserName" style="font-weight: bold; color: var(--gold-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">مدیر سیستم</div>
                <div style="font-size: 11px; color: var(--text-muted);">دسترسی کامل</div>
            </div>
            <div onclick="handleLogout()" style="cursor:pointer; color:var(--danger)" title="خروج">
                <i class="fa-solid fa-power-off"></i>
            </div>
        </div>
    </aside>
<main class="main-content">
        
        <header class="top-header">
            <div class="page-title">
                <i class="fa-solid fa-bars" onclick="toggleSidebar()" style="cursor:pointer; margin-left:10px; font-size:18px; color:var(--text-muted);"></i>
                <span id="headerTitle">داشبورد مدیریتی</span>
            </div>

            <div class="header-actions">
                <div style="background: rgba(212, 175, 55, 0.1); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--gold-dark); color: var(--gold-light); font-size: 13px; font-weight: bold; display:flex; align-items:center; gap:8px;">
                    <i class="fa-regular fa-calendar"></i>
                    <span id="currentDateDisplay">1403/01/01</span>
                </div>

                <div class="d-none d-md-flex" style="gap:10px;">
                    <button class="icon-btn" onclick="openModal('modalAppointment')" title="نوبت جدید">
                        <i class="fa-solid fa-calendar-plus"></i>
                    </button>
                    <button class="icon-btn" onclick="navigateTo('pos')" title="فروش جدید">
                        <i class="fa-solid fa-cash-register"></i>
                    </button>
                </div>

                <button class="icon-btn" onclick="toggleTheme()" title="تغییر تم">
                    <i class="fa-solid fa-moon" id="themeIconBtn"></i>
                </button>

                <button class="icon-btn" onclick="showNotifications()" style="position:relative;">
                    <i class="fa-regular fa-bell"></i>
                    <span id="notifBadge" style="position:absolute; top:-2px; right:-2px; width:10px; height:10px; background:var(--danger); border-radius:50%; border:1px solid #000; display:none;"></span>
                </button>
            </div>
        </header>

        <div class="page-container">

            <div id="dashboard" class="page-section active">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--text-main); font-size:16px;">
                        <i class="fa-solid fa-gauge-high" style="color:var(--gold-primary); margin-left:8px;"></i>
                        نمای کلی روز
                    </h3>
                    <div style="display:flex; gap:10px;">
                        <button class="gold-btn btn-sm" onclick="navigateTo('pos')">
                            <i class="fa-solid fa-cart-plus"></i> فاکتور فروش
                        </button>
                    </div>
                </div>

                <div class="grid-4">
                    <div class="stat-card">
                        <div class="stat-icon-box" style="color:#00E676; border-color:rgba(0,230,118,0.3)">
                            <i class="fa-solid fa-sack-dollar"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">فروش امروز (افغانی)</div>
                            <div class="stat-value" id="dashTodayIncome" style="direction:ltr">0 ؋</div>
                            <div class="status-badge status-success" style="margin-top:5px;">
                                <i class="fa-solid fa-arrow-trend-up"></i> فعال
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon-box" style="color:#FF5252; border-color:rgba(255,82,82,0.3)">
                            <i class="fa-solid fa-money-bill-transfer"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">هزینه‌های امروز</div>
                            <div class="stat-value" id="dashTodayExpense" style="color:var(--danger); direction:ltr">0 ؋</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon-box" style="color:var(--info); border-color:rgba(0,176,255,0.3)">
                            <i class="fa-solid fa-users-line"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">نوبت‌های امروز</div>
                            <div class="stat-value" id="dashTodayApts">0</div>
                            <div style="font-size:11px; color:var(--text-muted); margin-top:5px;">
                                <span id="dashPendingApts">0</span> در انتظار
                            </div>
                        </div>
                    </div>

                    <div class="stat-card" style="border-color:var(--gold-primary); background: linear-gradient(160deg, rgba(212,175,55,0.15), rgba(0,0,0,0.6));">
                        <div class="stat-icon-box" style="background:var(--gold-gradient); color:#2D0008; border:none;">
                            <i class="fa-solid fa-cash-register"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label" style="color:var(--gold-light)">وضعیت صندوق</div>
                            <div class="stat-value" id="dashRegisterStatus" style="font-size:18px;">بسته است</div>
                            <button class="btn-sm" style="background:rgba(0,0,0,0.3); border:1px solid var(--gold-dark); color:var(--gold-light); margin-top:5px; border-radius:4px; cursor:pointer;" onclick="openModal('modalRegister')">
                                مدیریت صندوق
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid-2" style="margin-top:25px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title" style="font-weight:bold; color:var(--gold-light);">
                                <i class="fa-solid fa-chart-area" style="margin-left:8px"></i>نمودار درآمد و هزینه (هفتگی)
                            </div>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title" style="font-weight:bold; color:var(--gold-light);">
                                <i class="fa-solid fa-ranking-star" style="margin-left:8px"></i>خدمات پرطرفدار
                            </div>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="servicesChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title" style="font-weight:bold; color:var(--gold-light);">آخرین فعالیت‌ها و تراکنش‌ها</div>
                        <button class="gold-btn btn-sm" onclick="navigateTo('accounting')">مشاهده همه</button>
                    </div>
                    <div class="table-container">
                        <table class="lux-table">
                            <thead>
                                <tr>
                                    <th>زمان</th>
                                    <th>شرح فعالیت</th>
                                    <th>مبلغ (AFN)</th>
                                    <th>نوع</th>
                                    <th>کاربر</th>
                                </tr>
                            </thead>
                            <tbody id="dashRecentTxBody">
                                <tr><td colspan="5" class="text-center">در حال بارگذاری...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div> 
<div id="pos" class="page-section">
                <div class="card-header" style="border:none; padding:0; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="border:none; font-size:18px;">
                        <i class="fa-solid fa-cash-register" style="margin-left:10px;"></i>
                        صندوق فروشگاهی
                    </h2>
                    <div style="font-size:13px; color:var(--text-muted); background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:8px; border:1px solid var(--gold-dark);">
                        وضعیت صندوق: <span id="posRegisterStatus" style="font-weight:bold; color:var(--success)">باز</span>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; height: calc(100vh - 180px); flex-wrap: wrap;">
                    
                    <div style="flex: 2; display: flex; flex-direction: column; min-width: 300px;">
                        
                        <div class="glass-panel" style="padding: 15px; margin-bottom: 15px; display: flex; gap: 10px; border-radius: 12px; align-items:center;">
                            <div style="flex: 1; position: relative;">
                                <i class="fa-solid fa-search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                                <input type="text" id="posSearch" class="lux-input" style="padding-right: 35px;" placeholder="جستجوی خدمت یا کالا..." onkeyup="renderPosItems()">
                            </div>
                            <select id="posCatFilter" class="lux-select" style="width: 150px;" onchange="renderPosItems()">
                                <option value="all">همه دسته‌ها</option>
                                <option value="service">خدمات</option>
                                <option value="product">محصولات</option>
                            </select>
                        </div>

                        <div id="posItemsGrid" style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding-bottom: 10px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--text-muted);">
                                <i class="fa-solid fa-spinner fa-spin" style="font-size: 30px;"></i>
                                <div style="margin-top: 10px;">در حال بارگذاری خدمات و محصولات...</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel" style="flex: 1; min-width: 320px; display: flex; flex-direction: column; border-radius: 16px; overflow: hidden; height: 100%; border: 1px solid var(--gold-dark);">
                        
                        <div style="padding: 15px; border-bottom: 1px solid rgba(212, 175, 55, 0.2); background: rgba(0,0,0,0.2);">
                            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px; display: block;">مشتری:</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="posCustomer" class="lux-select" style="font-size: 13px;">
                                    <option value="guest">مشتری مهمان (Guest)</option>
                                    </select>
                                <button class="icon-btn" onclick="openModal('modalCustomer')" title="مشتری جدید" style="width: 40px; border-radius: 8px;">
                                    <i class="fa-solid fa-user-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div id="posCartItems" style="flex: 1; overflow-y: auto; padding: 10px;">
                            <div style="text-align: center; margin-top: 50px; color: var(--text-muted); opacity: 0.5;">
                                <i class="fa-solid fa-basket-shopping" style="font-size: 40px; margin-bottom: 10px;"></i>
                                <div>سبد خرید خالی است</div>
                            </div>
                        </div>

                       <div style="padding: 15px; background: rgba(0, 0, 0, 0.4); border-top: 2px solid var(--gold-dark);">
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
        <span style="color: var(--text-muted);">جمع جزء:</span>
        <span id="posSubtotal" style="color: #fff;">0 ؋</span>
    </div>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
        <span style="color: var(--text-muted);">مالیات:</span>
        <span id="posTax" style="color: var(--warning);">0 ؋</span>
    </div>

    <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 10px 0;"></div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;">
        <span style="font-weight: bold; font-size: 16px; color: var(--gold-primary);">مبلغ قابل پرداخت:</span>
        <span id="posTotal" style="font-weight: 900; font-size: 24px; color: var(--gold-light); direction: ltr;" data-raw="0">0 ؋</span>
    </div>

    <div class="grid-2" style="margin-bottom: 15px; gap: 10px;">
        <div class="form-group" style="margin:0;">
            <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:3px;">پرداخت نقدی</label>
            <input type="number" id="payCashInput" class="lux-input" style="font-size:14px; color:var(--success); font-weight:bold; height:35px;" onkeyup="autoCalcCard()">
        </div>
        <div class="form-group" style="margin:0;">
            <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:3px;">کارتخوان</label>
            <input type="number" id="payCardInput" class="lux-input" style="font-size:14px; color:var(--info); font-weight:bold; height:35px;" readonly>
        </div>
    </div>

    <div class="grid-2">
        <button class="btn" style="background: rgba(255, 23, 68, 0.2); color: var(--danger); border: 1px solid var(--danger);" onclick="clearCart()">
            <i class="fa-solid fa-trash"></i> لغو
        </button>
        <button class="gold-btn" style="font-size: 16px;" onclick="processCheckout()">
            <i class="fa-solid fa-check-circle"></i> ثبت نهایی
        </button>
    </div>
</div>
                    </div>
                </div>
            </div>
<div id="accounting" class="page-section">
                <div class="card-header" style="background: transparent; border:none; padding:0; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="border:none; margin:0; font-size:18px;">
                        <i class="fa-solid fa-money-bill-transfer" style="margin-left:10px;"></i>
                        امور مالی و حسابداری
                    </h2>
                    <div style="display:flex; gap:10px">
                        <button class="gold-btn btn-sm" onclick="openModal('modalNewTx', 'income')">
                            <i class="fa-solid fa-plus"></i> ثبت درآمد
                        </button>
                        <button class="btn-sm" style="background: linear-gradient(135deg, #8E0E00, #1F1C18); color:#fff; border:1px solid var(--danger); cursor:pointer; border-radius:8px;" onclick="openModal('modalNewTx', 'expense')">
                            <i class="fa-solid fa-minus"></i> ثبت هزینه
                        </button>
                        <button class="icon-btn" onclick="exportToExcel('accountingTable')" title="خروجی اکسل">
                            <i class="fa-solid fa-file-excel"></i>
                        </button>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="stat-card" style="border-right: 4px solid var(--success);">
                        <div class="stat-info">
                            <div class="stat-label">کل دریافتی‌ها</div>
                            <div class="stat-value" id="accTotalIncome" style="color:var(--success); direction:ltr">0 ؋</div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-right: 4px solid var(--danger);">
                        <div class="stat-info">
                            <div class="stat-label">کل هزینه‌ها</div>
                            <div class="stat-value" id="accTotalExpense" style="color:var(--danger); direction:ltr">0 ؋</div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-right: 4px solid var(--gold-primary);">
                        <div class="stat-info">
                            <div class="stat-label">تراز مالی کل</div>
                            <div class="stat-value" id="accBalance" style="direction:ltr">0 ؋</div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel" style="margin: 20px 0; padding: 15px; display:flex; flex-wrap:wrap; gap:15px; align-items:center; border-radius:12px;">
                    <i class="fa-solid fa-filter" style="color:var(--gold-primary)"></i>
                    <input type="text" class="lux-input" placeholder="جستجو در شرح..." id="accSearch" style="width:200px" onkeyup="filterAccounting()">
                    <select class="lux-select" id="accFilterType" onchange="filterAccounting()" style="width:150px">
                        <option value="all">همه تراکنش‌ها</option>
                        <option value="income">درآمدها</option>
                        <option value="expense">هزینه‌ها</option>
                    </select>
                    <input type="date" class="lux-input" id="accDateFilter" style="width:auto" onchange="filterAccounting()">
                    <button class="icon-btn" onclick="renderAccounting()" style="width:35px; height:35px;" title="بازنشانی"><i class="fa-solid fa-rotate-right"></i></button>
                </div>

                <div class="table-container">
                    <table class="lux-table" id="accountingTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>تاریخ & زمان</th>
                                <th>نوع</th>
                                <th>دسته‌بندی</th>
                                <th>شرح / بابت</th>
                                <th>مبلغ (AFN)</th>
                                <th>مالیات</th>
                                <th>کاربر</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="accountingBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="taxes" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-scale-balanced" style="margin-left:10px;"></i>
                        گزارش مالیاتی (BRT / VAT)
                    </h2>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3 style="color:var(--gold-light); margin-bottom:15px; font-size:16px;">
                            <i class="fa-solid fa-sliders"></i> تنظیمات نرخ مالیات
                        </h3>
                        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">
                            نرخ مالیات بر عواید (BRT) یا ارزش افزوده را طبق قانون جاری افغانستان تنظیم کنید.
                        </p>
                        <div style="display:flex; gap:10px; align-items:center; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; border:1px solid var(--gold-dark);">
                            <span style="font-weight:bold;">نرخ فعلی (%):</span>
                            <input type="number" id="taxRateDisplay" class="lux-input" style="width:80px; text-align:center; font-weight:bold;" value="4" readonly>
                            <button class="btn-sm" style="border:1px solid var(--gold-primary); background:transparent; color:var(--gold-primary); cursor:pointer;" onclick="navigateTo('settings')">تغییر نرخ</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="color:var(--gold-light); margin-bottom:15px; font-size:16px;">
                            <i class="fa-solid fa-print"></i> تهیه گزارش
                        </h3>
                        <div class="form-group">
                            <label class="form-label">دوره مالیاتی:</label>
                            <div style="display:flex; gap:10px;">
                                <select id="taxReportSeason" class="lux-select">
                                    <option value="1">سه ماهه اول (حمل - جوزا)</option>
                                    <option value="2">سه ماهه دوم (سرطان - سنبله)</option>
                                    <option value="3">سه ماهه سوم (میزان - قوس)</option>
                                    <option value="4">سه ماهه چهارم (جدی - حوت)</option>
                                    <option value="year">گزارش سالانه</option>
                                </select>
                                <button class="gold-btn" onclick="calculateTaxReport()">محاسبه</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="taxResultArea" style="display:none; animation:fadeIn 0.5s;">
                    <div class="glass-panel" style="padding:30px; border:2px solid var(--gold-primary); position:relative;">
                        <div style="position:absolute; top:20px; left:20px; opacity:0.1; font-size:100px; color:var(--gold-primary);">
                            <i class="fa-solid fa-stamp"></i>
                        </div>
                        
                        <div style="text-align:center; margin-bottom:30px;">
                            <h2 style="color:var(--gold-light);">فرم اظهارنامه مالیاتی</h2>
                            <p style="color:var(--text-muted); font-size:12px;" id="taxReportDateRange">دوره: نامشخص</p>
                        </div>

                        <table class="lux-table" style="border:1px solid var(--gold-dark);">
                            <tr>
                                <td style="width:70%;">مجموع فروش ناخالص (Gross Sales)</td>
                                <td style="font-weight:bold; direction:ltr;" id="taxGrossSales">0 ؋</td>
                            </tr>
                            <tr>
                                <td>کسورات مجاز / معافیت‌ها</td>
                                <td style="font-weight:bold; direction:ltr;" id="taxDeductions">0 ؋</td>
                            </tr>
                            <tr style="background:rgba(212,175,55,0.1);">
                                <td>درآمد مشمول مالیات (Taxable Income)</td>
                                <td style="font-weight:bold; direction:ltr; color:var(--gold-light);" id="taxableIncome">0 ؋</td>
                            </tr>
                            <tr style="background:rgba(255, 23, 68, 0.15); border-top:2px solid var(--danger);">
                                <td style="color:var(--danger); font-weight:bold; font-size:16px;">مالیات قابل پرداخت (Tax Due)</td>
                                <td style="color:var(--danger); font-weight:bold; font-size:18px; direction:ltr;" id="taxPayable">0 ؋</td>
                            </tr>
                        </table>

                        <div style="margin-top:20px; text-align:left;">
                            <button class="icon-btn" onclick="window.print()" title="چاپ گزارش" style="display:inline-flex; width:auto; padding:0 20px; gap:10px;">
                                <i class="fa-solid fa-print"></i> چاپ رسمی
                            </button>
                        </div>
                    </div>
                </div>
            </div>
<div id="debts" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-hand-holding-dollar" style="margin-left:10px;"></i>
                        دفتر بدهکاران و حساب‌های باز
                    </h2>
                    <div style="background:rgba(255, 23, 68, 0.1); padding:5px 15px; border-radius:8px; border:1px solid var(--danger); color:var(--danger); font-size:13px;">
                        مجموع مطالبات: <span id="totalDebtDisplay" style="font-weight:bold; font-size:16px; direction:ltr; margin-right:5px;">0 ؋</span>
                    </div>
                </div>

                <div class="card">
                    <div class="glass-panel" style="padding:15px; margin-bottom:15px; display:flex; gap:10px; align-items:center; background:rgba(0,0,0,0.2);">
                        <i class="fa-solid fa-search" style="color:var(--gold-dark)"></i>
                        <input type="text" id="debtSearch" class="lux-input" placeholder="جستجوی نام بدهکار..." onkeyup="renderDebts()">
                    </div>

                    <div class="table-container">
                        <table class="lux-table">
                            <thead>
                                <tr>
                                    <th>نام مشتری</th>
                                    <th>شماره تماس</th>
                                    <th>مبلغ بدهی (AFN)</th>
                                    <th>آخرین خرید/تراکنش</th>
                                    <th>وضعیت</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="debtsBody">
                                <tr><td colspan="6" class="text-center">در حال بارگذاری لیست بدهکاران...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="appointments" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-calendar-check" style="margin-left:10px;"></i>
                        لیست نوبت‌ها و رزروها
                    </h2>
                    <button class="gold-btn" onclick="openModal('modalAppointment')">
                        <i class="fa-solid fa-plus"></i> نوبت جدید
                    </button>
                </div>

                <div class="glass-panel" style="padding:15px; margin-bottom:20px; display:flex; flex-wrap:wrap; gap:15px; align-items:center; border-radius:12px;">
                    <div style="display:flex; align-items:center; gap:5px; flex:1; min-width:200px;">
                        <span style="font-size:12px; color:var(--text-muted);">تاریخ:</span>
                        <input type="text" id="aptDateFilter" class="lux-input" placeholder="انتخاب تاریخ" style="text-align:center;">
                        <button class="icon-btn" onclick="setTodayFilter()" title="امروز" style="width:35px; height:35px;"><i class="fa-solid fa-calendar-day"></i></button>
                    </div>

                    <select id="aptStatusFilter" class="lux-select" style="width:150px;" onchange="renderAppointments()">
                        <option value="all">همه وضعیت‌ها</option>
                        <option value="scheduled">رزرو شده</option>
                        <option value="confirmed">تایید شده</option>
                        <option value="completed">انجام شده</option>
                        <option value="canceled">لغو شده</option>
                    </select>

                    <select id="aptStaffFilter" class="lux-select" style="width:150px;" onchange="renderAppointments()">
                        <option value="all">همه پرسنل</option>
                        </select>
                </div>

                <div id="appointmentsList" class="grid-3">
                    <div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--text-muted); border:2px dashed var(--gold-dark); border-radius:15px;">
                        <i class="fa-solid fa-calendar-xmark" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
                        <div>هیچ نوبتی برای نمایش یافت نشد</div>
                    </div>
                </div>
            </div>
<div id="inventory" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-boxes-stacked" style="margin-left:10px;"></i>
                        انبار و محصولات
                    </h2>
                    <button class="gold-btn" onclick="openModal('modalProduct')">
                        <i class="fa-solid fa-box-open"></i> کالا جدید
                    </button>
                </div>

                <div class="grid-3">
                    <div class="stat-card" style="padding:15px; min-height:100px;">
                        <div class="stat-icon-box" style="width:45px; height:45px; font-size:18px; color:var(--text-main);">
                            <i class="fa-solid fa-cubes"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">تعداد اقلام</div>
                            <div class="stat-value" id="invTotalItems">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="padding:15px; min-height:100px;">
                        <div class="stat-icon-box" style="width:45px; height:45px; font-size:18px; color:var(--text-main);">
                            <i class="fa-solid fa-tags"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">ارزش کل انبار</div>
                            <div class="stat-value" id="invTotalValue" style="font-size:18px; direction:ltr;">0 ؋</div>
                        </div>
                    </div>

                    <div class="stat-card" style="padding:15px; min-height:100px; border-color:var(--danger);">
                        <div class="stat-icon-box" style="width:45px; height:45px; font-size:18px; color:var(--danger); border-color:var(--danger);">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">هشدار موجودی کم</div>
                            <div class="stat-value" id="invLowStock" style="color:var(--danger)">0</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top:20px;">
                    <div class="glass-panel" style="padding:15px; margin-bottom:15px; display:flex; gap:10px; align-items:center; background:rgba(0,0,0,0.2);">
                        <i class="fa-solid fa-search" style="color:var(--gold-dark)"></i>
                        <input type="text" id="invSearch" class="lux-input" placeholder="جستجوی نام کالا یا برند..." onkeyup="renderInventory()">
                    </div>

                    <div class="table-container">
                        <table class="lux-table">
                            <thead>
                                <tr>
                                    <th>نام کالا</th>
                                    <th>برند</th>
                                    <th>موجودی</th>
                                    <th>قیمت خرید</th>
                                    <th>قیمت فروش</th>
                                    <th>وضعیت</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody">
                                <tr><td colspan="7" class="text-center">در حال بارگذاری انبار...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="personnel" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-id-card-clip" style="margin-left:10px;"></i>
                        مدیریت پرسنل و حقوق
                    </h2>
                    <button class="gold-btn" onclick="openModal('modalStaff')">
                        <i class="fa-solid fa-user-plus"></i> استخدام جدید
                    </button>
                </div>

                <div class="table-container" style="margin-bottom:30px;">
                    <table class="lux-table">
                        <thead>
                            <tr>
                                <th>نام پرسنل</th>
                                <th>نقش / تخصص</th>
                                <th>حقوق ثابت (AFN)</th>
                                <th>درصد کمیسیون</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="personnelBody">
                            </tbody>
                    </table>
                </div>

                <div class="card" style="border:1px solid var(--gold-dark);">
                    <div class="card-header">
                        <h3 style="color:var(--gold-light); font-size:16px;">
                            <i class="fa-solid fa-calculator"></i> محاسبه حقوق و دستمزد ماهانه
                        </h3>
                    </div>
                    
                    <div class="grid-3" style="align-items:end;">
                        <div class="form-group">
                            <label class="form-label">انتخاب پرسنل</label>
                            <select class="lux-select" id="payrollStaffSel"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">دوره (ماه/سال)</label>
                            <div style="display:flex; gap:5px;">
                                <select class="lux-select" id="payrollMonth"></select>
                                <input type="number" id="payrollYear" class="lux-input" value="1403" style="width:80px; text-align:center;">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="gold-btn" style="width:100%" onclick="calculateSalary()">
                                <i class="fa-solid fa-file-invoice-dollar"></i> صدور فیش حقوقی
                            </button>
                        </div>
                    </div>

                    <div id="payrollResult" style="display:none; margin-top:20px; padding:20px; border:1px dashed var(--gold-primary); border-radius:12px; background:rgba(0,0,0,0.3);">
                        </div>
                </div>
            </div>
<div id="customers" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-users" style="margin-left:10px;"></i>
                        باشگاه مشتریان
                    </h2>
                    <button class="gold-btn" onclick="openModal('modalCustomer')">
                        <i class="fa-solid fa-user-plus"></i> مشتری جدید
                    </button>
                </div>

                <div class="grid-3">
                    <div class="stat-card">
                        <div class="stat-icon-box" style="color:var(--info); border-color:var(--info);">
                            <i class="fa-solid fa-address-book"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">تعداد کل مشتریان</div>
                            <div class="stat-value" id="crmTotalCust">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon-box" style="color:var(--success); border-color:var(--success);">
                            <i class="fa-solid fa-user-check"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">مشتریان فعال (ماه جاری)</div>
                            <div class="stat-value" id="crmActiveMonth">0</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top:20px;">
                    <div class="glass-panel" style="padding:15px; margin-bottom:15px; display:flex; gap:10px; align-items:center; background:rgba(0,0,0,0.2);">
                        <i class="fa-solid fa-search" style="color:var(--gold-dark)"></i>
                        <input type="text" id="crmSearch" class="lux-input" placeholder="جستجوی نام یا شماره موبایل..." onkeyup="renderCustomers()">
                    </div>

                    <div class="table-container">
                        <table class="lux-table" id="customersTable">
                            <thead>
                                <tr>
                                    <th>نام مشتری</th>
                                    <th>شماره تماس</th>
                                    <th>آخرین بازدید</th>
                                    <th>تعداد مراجعات</th>
                                    <th>امتیاز وفاداری</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="customersBody">
                                <tr><td colspan="6" class="text-center">در حال بارگذاری مشتریان...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="services" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-scissors" style="margin-left:10px;"></i>
                        مدیریت خدمات و نرخ‌ها
                    </h2>
                    <button class="gold-btn" onclick="openModal('modalService')">
                        <i class="fa-solid fa-plus"></i> خدمت جدید
                    </button>
                </div>

                <div class="glass-panel" style="padding:15px; margin-bottom:20px; display:flex; gap:10px; align-items:center; border-radius:12px;">
                    <input type="text" class="lux-input" placeholder="جستجوی نام خدمت..." onkeyup="renderServices(this.value)">
                </div>

                <div class="service-grid" id="servicesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    <div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--text-muted);">
                        <i class="fa-solid fa-spinner fa-spin"></i> در حال بارگذاری خدمات...
                    </div>
                </div>
            </div>
<div id="settings" class="page-section">
                <div class="card-header" style="border:none; margin-bottom:20px;">
                    <h2 class="page-title" style="font-size:18px;">
                        <i class="fa-solid fa-gear" style="margin-left:10px;"></i>
                        تنظیمات سیستم
                    </h2>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('tabGeneral', this)">مشخصات سالن</button>
                    <button class="tab-btn" onclick="switchTab('tabFinance', this)">امور مالی و مالیات</button>
                    <button class="tab-btn" onclick="switchTab('tabBackup', this)">پشتیبان‌گیری</button>
                    <button class="tab-btn" onclick="switchTab('tabSecurity', this)">امنیت و حساب</button>
                </div>

                <div id="tabGeneral" class="tab-content active">
                    <div class="card">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">نام سالن / آرایشگاه</label>
                                <input type="text" id="setSalonName" class="lux-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">تلفن تماس</label>
                                <input type="text" id="setPhone" class="lux-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">آدرس دقیق</label>
                            <input type="text" id="setAddress" class="lux-input">
                        </div>
                        <div style="text-align:left;">
                            <button class="gold-btn" onclick="saveGeneralSettings()">
                                <i class="fa-solid fa-save"></i> ذخیره تغییرات
                            </button>
                        </div>
                    </div>
                </div>

                <div id="tabFinance" class="tab-content">
                    <div class="card">
                        <h3 style="color:var(--gold-light); margin-bottom:15px; font-size:16px;">تنظیمات مالیاتی (افغانستان)</h3>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">واحد پول سیستم</label>
                                <select class="lux-select" disabled style="opacity:0.7; cursor:not-allowed;">
                                    <option selected>افغانی (AFN - ؋)</option>
                                </select>
                                <p style="font-size:11px; color:var(--text-muted); margin-top:5px;">طبق قوانین، واحد پول روی افغانی قفل شده است.</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">نوع مالیات (Tax Type)</label>
                                <select id="setTaxType" class="lux-select" onchange="toggleTaxInput()">
                                    <option value="none">بدون مالیات (معاف)</option>
                                    <option value="brt">مالیات بر عواید (BRT - 4%)</option>
                                    <option value="vat">مالیات بر ارزش افزوده (VAT - 10%)</option>
                                    <option value="custom">نرخ دلخواه</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="taxRateGroup" style="display:none;">
                            <label class="form-label">درصد مالیات (%)</label>
                            <input type="number" id="setTaxRate" class="lux-input" placeholder="مثلاً 4" style="width:100px; text-align:center;">
                        </div>

                        <div style="margin-top:20px; padding:15px; background:rgba(255, 171, 0, 0.1); border:1px dashed var(--warning); border-radius:10px;">
                            <i class="fa-solid fa-circle-info" style="color:var(--warning); margin-left:5px;"></i>
                            <span style="font-size:12px; color:var(--text-main);">تغییر نرخ مالیات بر روی محاسبات فاکتورهای آینده تاثیر می‌گذارد و فاکتورهای قبلی تغییر نمی‌کنند.</span>
                        </div>

                        <div style="text-align:left; margin-top:20px;">
                            <button class="gold-btn" onclick="saveFinanceSettings()">
                                <i class="fa-solid fa-check-circle"></i> ذخیره تنظیمات مالی
                            </button>
                        </div>
                    </div>
                </div>

                <div id="tabBackup" class="tab-content">
                    <div class="grid-2">
                        <div class="card" style="text-align:center; border:1px solid var(--success);">
                            <i class="fa-solid fa-cloud-arrow-down" style="font-size:40px; color:var(--success); margin-bottom:15px;"></i>
                            <h3 style="color:#fff; margin-bottom:10px;">تهیه نسخه پشتیبان</h3>
                            <p style="color:var(--text-muted); font-size:12px; margin-bottom:20px;">
                                دانلود تمام اطلاعات (مشتریان، حسابداری، انبار) در یک فایل امن.
                            </p>
                            <button class="gold-btn" onclick="exportBackup()" style="width:100%;">
                                دانلود فایل پشتیبان (Backup)
                            </button>
                        </div>

                        <div class="card" style="text-align:center; border:1px solid var(--info);">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size:40px; color:var(--info); margin-bottom:15px;"></i>
                            <h3 style="color:#fff; margin-bottom:10px;">بازگردانی اطلاعات</h3>
                            <p style="color:var(--text-muted); font-size:12px; margin-bottom:20px;">
                                بازگردانی اطلاعات از فایل پشتیبان قبلی. (اطلاعات فعلی جایگزین می‌شود)
                            </p>
                            <button class="btn" style="background:#333; color:#fff; border:1px solid #555; width:100%;" onclick="document.getElementById('importFile').click()">
                                انتخاب فایل و بازگردانی
                            </button>
                            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importBackup(this)">
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; text-align:center;">
                        <button class="btn" style="color:var(--danger); border:1px solid var(--danger); background:rgba(255,0,0,0.1);" onclick="factoryReset()">
                            <i class="fa-solid fa-triangle-exclamation"></i> بازگشت به تنظیمات کارخانه (حذف همه داده‌ها)
                        </button>
                    </div>
                </div>

                <div id="tabSecurity" class="tab-content">
                    <div class="card" style="max-width:500px; margin:0 auto;">
                        <h3 style="color:var(--gold-light); margin-bottom:20px; text-align:center;">تغییر رمز عبور مدیریت</h3>
                        
                        <div class="form-group">
                            <label class="form-label">نام کاربری جدید</label>
                            <input type="text" id="secNewUser" class="lux-input" placeholder="admin">
                        </div>
                        <div class="form-group">
                            <label class="form-label">رمز عبور جدید</label>
                            <input type="password" id="secNewPass" class="lux-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">تکرار رمز عبور</label>
                            <input type="password" id="secConfirmPass" class="lux-input">
                        </div>

                        <div style="text-align:center; margin-top:20px;">
                            <button class="gold-btn" onclick="saveSecuritySettings()">
                                <i class="fa-solid fa-lock"></i> بروزرسانی مشخصات ورود
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div> </main>
</div> 
<div class="modal-overlay" id="modalRegister">
    <div class="lux-modal" style="max-width:450px;">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-cash-register"></i> مدیریت صندوق</div>
            <button class="close-modal" onclick="closeModal('modalRegister')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="registerOpenForm">
                <p style="color:var(--text-muted); margin-bottom:15px; font-size:13px;">
                    برای شروع فروش، ابتدا باید صندوق را باز کنید و موجودی اول وقت را وارد نمایید.
                </p>
                <div class="form-group">
                    <label class="form-label">موجودی نقدی شروع (افغانی)</label>
                    <input type="number" id="regStartCash" class="lux-input" style="font-size:18px; font-weight:bold; color:var(--gold-light);" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">یادداشت (اختیاری)</label>
                    <textarea id="regOpenNote" class="lux-textarea" rows="2"></textarea>
                </div>
                <button class="gold-btn" style="width:100%;" onclick="openRegister()">
                    <i class="fa-solid fa-lock-open"></i> باز کردن صندوق
                </button>
            </div>

            <div id="registerCloseForm" style="display:none;">
                <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid var(--gold-dark);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>زمان بازگشایی:</span>
                        <span id="regStartTimeDisplay" style="color:var(--gold-light);">08:00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>فروش نقدی امروز:</span>
                        <span id="regTotalCashDisplay" style="color:var(--success);">0 ؋</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>فروش کارتی/آنلاین:</span>
                        <span id="regTotalCardDisplay" style="color:var(--info);">0 ؋</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">موجودی نقدی شمارش شده (پایان روز)</label>
                    <input type="number" id="regEndCash" class="lux-input" style="font-size:18px; font-weight:bold; color:var(--gold-light);">
                </div>

                <div class="form-group">
                    <label class="form-label">اختلاف صندوق</label>
                    <input type="text" id="regDifference" class="lux-input" readonly style="background:rgba(255,255,255,0.05);">
                </div>

                <button class="btn" style="width:100%; background:var(--danger); color:#fff; border:none;" onclick="closeRegister()">
                    <i class="fa-solid fa-lock"></i> بستن صندوق و چاپ گزارش
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalCustomer">
    <div class="lux-modal">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-user-plus"></i> ثبت مشتری جدید</div>
            <button class="close-modal" onclick="closeModal('modalCustomer')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label required">نام و نام خانوادگی</label>
                    <input type="text" id="custName" class="lux-input">
                </div>
                <div class="form-group">
                    <label class="form-label required">شماره تماس</label>
                    <input type="tel" id="custPhone" class="lux-input" style="direction:ltr; text-align:left;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">تاریخ تولد (جهت تخفیف تولد)</label>
                <input type="date" id="custBirth" class="lux-input">
            </div>

            <div class="form-group">
                <label class="form-label">یادداشت‌های خاص (حساسیت، سلیقه و...)</label>
                <textarea id="custNotes" class="lux-textarea" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="gold-btn" onclick="saveCustomer()">
                <i class="fa-solid fa-save"></i> افزودن به باشگاه مشتریان
            </button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modalNewTx">
    <div class="lux-modal">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-coins"></i> <span id="modalTxTitle">ثبت تراکنش جدید</span></div>
            <button class="close-modal" onclick="closeModal('modalNewTx')">&times;</button>
        </div>
        
        <div class="modal-body">
            <input type="hidden" id="txType">
            
            <div class="form-group" style="background:rgba(212,175,55,0.05); padding:10px; border-radius:8px; border:1px dashed var(--gold-dark); margin-bottom:15px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; color:var(--text-main);">
                    <input type="checkbox" id="txTaxApply" style="width:18px; height:18px; accent-color:var(--gold-primary);">
                    <span>محاسبه و کسر مالیات (طبق تنظیمات)</span>
                </label>
                <div id="taxCalcResult" style="font-size:12px; color:var(--gold-light); margin-top:5px; padding-right:28px;"></div>
            </div>

            <div class="form-group">
                <label class="form-label required">مبلغ (افغانی)</label>
                <input type="number" id="txAmount" class="lux-input" style="font-size:20px; font-weight:bold; color:var(--gold-light); direction:ltr; text-align:left;" placeholder="0">
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">دسته‌بندی</label>
                    <select id="txCategory" class="lux-select">
                        </select>
                </div>
                <div class="form-group">
                    <label class="form-label">طرف حساب (اختیاری)</label>
                    <select id="txRelatedUser" class="lux-select">
                        <option value="">-- انتخاب --</option>
                        </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">توضیحات / بابت</label>
                <input type="text" id="txDesc" class="lux-input" placeholder="مثلاً: بابت خدمات...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="gold-btn" onclick="submitTransaction()">
                <i class="fa-solid fa-check"></i> ثبت نهایی
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalAppointment">
    <div class="lux-modal">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-regular fa-calendar-plus"></i> ثبت نوبت رزرو</div>
            <button class="close-modal" onclick="closeModal('modalAppointment')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">مشتری</label>
                <div style="display:flex; gap:5px;">
                    <select id="aptCustomer" class="lux-select">
                        <option value="">-- انتخاب مشتری --</option>
                        </select>
                    <button class="icon-btn" onclick="openModal('modalCustomer')" title="مشتری جدید" style="border-radius:8px; width:45px;"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label required">تاریخ</label>
                    <input type="date" id="aptDateInput" class="lux-input">
                </div>
                <div class="form-group">
                    <label class="form-label required">ساعت شروع</label>
                    <input type="time" id="aptTimeInput" class="lux-input">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label required">خدمت درخواستی</label>
                    <select id="aptService" class="lux-select">
                        <option value="">-- انتخاب خدمت --</option>
                        </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">آرایشگر / پرسنل</label>
                    <select id="aptStaff" class="lux-select">
                        <option value="">-- انتخاب پرسنل --</option>
                        </select>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">وضعیت</label>
                    <select id="aptStatus" class="lux-select">
                        <option value="scheduled">رزرو شده</option>
                        <option value="confirmed">تایید شده</option>
                        <option value="completed">انجام شد</option>
                        <option value="canceled">لغو شد</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">بیعانه (اختیاری)</label>
                    <input type="number" id="aptDeposit" class="lux-input" placeholder="0">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">یادداشت</label>
                <textarea id="aptNote" class="lux-textarea" rows="2"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="gold-btn" onclick="saveAppointment()">
                <i class="fa-solid fa-calendar-check"></i> ثبت نوبت
            </button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modalService">
    <div class="lux-modal">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-scissors"></i> تعریف خدمت جدید</div>
            <button class="close-modal" onclick="closeModal('modalService')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">نام خدمت</label>
                <input type="text" id="srvName" class="lux-input" placeholder="مثلاً: کوتاهی مو کلاسیک">
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">دسته‌بندی</label>
                    <select id="srvCat" class="lux-select">
                        <option value="hair">مو و کوتاهی</option>
                        <option value="color">رنگ و مش</option>
                        <option value="skin">پوست و پاکسازی</option>
                        <option value="makeup">میکاپ و گریم</option>
                        <option value="nail">ناخن</option>
                        <option value="other">سایر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">زمان تقریبی (دقیقه)</label>
                    <input type="number" id="srvDuration" class="lux-input" placeholder="30">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label required">قیمت پایه (افغانی)</label>
                <input type="number" id="srvPrice" class="lux-input" style="font-weight:bold; color:var(--gold-light); direction:ltr; text-align:left;">
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">مشمول مالیات؟</label>
                    <select id="srvTaxable" class="lux-select">
                        <option value="true">بله (شامل مالیات)</option>
                        <option value="false">خیر (معاف)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">آیکون (FontAwesome)</label>
                    <input type="text" id="srvIcon" class="lux-input" placeholder="fa-solid fa-scissors" dir="ltr">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="gold-btn" onclick="saveService()">
                <i class="fa-solid fa-save"></i> ذخیره خدمت
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalProduct">
    <div class="lux-modal">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-box"></i> کالا / محصول جدید</div>
            <button class="close-modal" onclick="closeModal('modalProduct')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">نام کالا</label>
                <input type="text" id="prdName" class="lux-input" placeholder="مثلاً: شامپو کراتین">
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">برند</label>
                    <input type="text" id="prdBrand" class="lux-input">
                </div>
                <div class="form-group">
                    <label class="form-label required">تعداد موجودی اولیه</label>
                    <input type="number" id="prdStock" class="lux-input">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">قیمت خرید (AFN)</label>
                    <input type="number" id="prdBuyPrice" class="lux-input" style="direction:ltr; text-align:left;">
                </div>
                <div class="form-group">
                    <label class="form-label required">قیمت فروش (AFN)</label>
                    <input type="number" id="prdSellPrice" class="lux-input" style="color:var(--gold-light); font-weight:bold; direction:ltr; text-align:left;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">نقطه سفارش (هشدار کمبود)</label>
                <input type="number" id="prdLowStockAlert" class="lux-input" value="5" placeholder="مثلاً 5 عدد">
            </div>
        </div>
        <div class="modal-footer">
            <button class="gold-btn" onclick="saveProduct()">
                <i class="fa-solid fa-check"></i> افزودن به انبار
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalStaff">
    <div class="lux-modal">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-id-badge"></i> استخدام پرسنل</div>
            <button class="close-modal" onclick="closeModal('modalStaff')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">نام پرسنل</label>
                <input type="text" id="stfName" class="lux-input">
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">نقش / تخصص</label>
                    <input type="text" id="stfRole" class="lux-input" placeholder="مثلاً: هیر استایلیست">
                </div>
                <div class="form-group">
                    <label class="form-label required">موبایل</label>
                    <input type="tel" id="stfPhone" class="lux-input" dir="ltr">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">حقوق ثابت (AFN)</label>
                    <input type="number" id="stfBaseSalary" class="lux-input" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">درصد کمیسیون (%)</label>
                    <input type="number" id="stfComm" class="lux-input" placeholder="مثلاً 30">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">تاریخ شروع همکاری</label>
                <input type="date" id="stfJoinDate" class="lux-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="gold-btn" onclick="saveStaff()">
                <i class="fa-solid fa-user-plus"></i> تکمیل استخدام
            </button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastArea"></div>

<script>
/* PART 18 OF 20: CORE JAVASCRIPT & DATABASE LOGIC */

// =========================================
// 1. DATABASE STRUCTURE & STATE
// =========================================
let db = {
    settings: {
        name: 'Royal Salon AF',
        phone: '',
        address: '',
        currency: 'AFN',    // Locked to Afghani
        taxType: 'brt',     // brt (4%) or vat (10%) or none
        taxRate: 4,         // Default BRT rate
        theme: 'dark',
        auth: { user: 'admin', pass: 'admin' }
    },
    services: [],
    customers: [],
    staff: [],
    inventory: [],
    appointments: [],
    transactions: [],
    invoices: [],           // For POS history
    debts: [],             // Debt tracking
    posSession: {           // Cash Register State
        isOpen: false,
        startTime: null,
        startCash: 0,
        salesCash: 0,
        salesCard: 0
    }
};
// === این کد را اینجا اضافه کنید ===
const Money = {
    round: (num) => Math.round(num),
    format: (amount) => {
        if (amount === undefined || amount === null) amount = 0;
        return new Intl.NumberFormat('en-US').format(Math.round(amount)) + ' ؋';
    }
};
// جایگزین تابع قدیمی (این خط تابع قبلی را بازنویسی می‌کند)
function formatMoney(amount) { return Money.format(amount); }
// ================================
// Current Shopping Cart State (Not saved in DB permanently)
let posCart = [];
let currentCartCustomer = null;

const STORAGE_KEY = 'RoyalSalonAF_DB_V2';

// =========================================
// 2. INITIALIZATION & STORAGE
// =========================================
function initApp() {
    loadData();
    
    // UI Initializations
    updateDateDisplay();
    loadSettingsToInputs();
    
    // Check Theme
    if (db.settings.theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        const icon = document.getElementById('themeIconBtn');
        if(icon) icon.className = 'fa-solid fa-sun';
    }

    // Sidebar Name
    if(document.getElementById('sidebarUserName')) {
        document.getElementById('sidebarUserName').innerText = db.settings.name;
    }

    // Render Dashboard initially
    if(document.getElementById('dashboard').classList.contains('active')) {
        renderDashboard();
    }
    
    // Hide Loading Overlay
    setTimeout(() => {
        const loader = document.getElementById('loadingOverlay');
        if(loader) loader.style.opacity = '0';
        setTimeout(() => { if(loader) loader.style.display = 'none'; }, 500);
    }, 800);
}

function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            // Merge with default structure to prevent errors on updates
            db = { ...db, ...parsed };
            // Ensure settings exist
            if(!db.settings) db.settings = { currency: 'AFN', taxRate: 4 };
        } catch(e) {
            console.error("Data Load Error:", e);
            seedDummyData(); // Fallback
        }
    } else {
        seedDummyData();
    }
}

function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    // Trigger updates if needed (e.g. charts)
    if(document.getElementById('dashboard').classList.contains('active')) updateCharts();
}

function seedDummyData() {
    console.log("Seeding Dummy Data for Afghanistan Context...");
    
    // Services
    db.services = [
        { id: 1, name: 'اصلاح مو (کلاسیک)', category: 'hair', price: 200, duration: 30, icon: 'fa-solid fa-scissors', taxable: 'true' },
        { id: 2, name: 'فیشال صورت VIP', category: 'skin', price: 800, duration: 60, icon: 'fa-solid fa-spa', taxable: 'true' },
        { id: 3, name: 'کراتینه مو', category: 'hair', price: 3500, duration: 120, icon: 'fa-solid fa-wand-magic-sparkles', taxable: 'true' },
        { id: 4, name: 'گریم داماد', category: 'makeup', price: 5000, duration: 90, icon: 'fa-solid fa-user-tie', taxable: 'true' }
    ];

    // Staff
    db.staff = [
        { id: 101, name: 'احمد راشدی', role: 'استایلیست ارشد', phone: '0799123456', baseSalary: 15000, comm: 40, joinDate: '2023-01-01' },
        { id: 102, name: 'سهراب احمدی', role: 'دستیار', phone: '0788123456', baseSalary: 8000, comm: 10, joinDate: '2023-05-15' }
    ];

    // Customers
    db.customers = [
        { id: 'c1', name: 'جمشید خان', phone: '0700987654', joinDate: Date.now(), notes: 'مشتری VIP' },
        { id: 'c2', name: 'فرهاد نوری', phone: '0777123123', joinDate: Date.now(), notes: '' }
    ];

    // Inventory
    db.inventory = [
        { id: 501, name: 'ژل مو نیوآ', brand: 'Nivea', stock: 12, buyPrice: 150, sellPrice: 250, lowStockAlert: 5 },
        { id: 502, name: 'واکس مو گات‌تو‌بی', brand: 'Got2b', stock: 4, buyPrice: 300, sellPrice: 500, lowStockAlert: 5 }
    ];

    saveData();
}

// =========================================
// 3. HELPER FUNCTIONS
// =========================================

// Format Money (Afghan Afghani)
function formatMoney(amount) {
    if (amount === undefined || amount === null) amount = 0;
    // Format: 1,250 ؋
    return new Intl.NumberFormat('en-US').format(amount) + ' ؋';
}

// Generate Unique ID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 6);
}

// Date Helpers (Simple Jalali Mock)
function getTodayJalali() {
    // In a real production app, use 'jalaali-js' library.
    // For this single-file demo, we use native Intl with 'fa-AF' locale but force Gregorian numbers for logic
    // Or simply return a string for display.
    const d = new Date();
    return d.toLocaleDateString('fa-IR'); 
}

function updateDateDisplay() {
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('fa-IR', options);
}

// Toast Notification
function showToast(message, type = 'info') {
    const container = document.getElementById('toastArea');
    const toast = document.createElement('div');
    toast.className = `lux-toast ${type}`;
    
    let icon = 'fa-info-circle';
    if(type === 'success') icon = 'fa-check-circle';
    if(type === 'error') icon = 'fa-circle-xmark';
    
    toast.innerHTML = `
        <i class="fa-solid ${icon}" style="font-size:20px;"></i>
        <div style="flex:1;">
            <div style="font-weight:bold; font-size:13px;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="background:none; border:none; color:inherit; cursor:pointer;">&times;</button>
    `;
    
    container.appendChild(toast);
    
    // Auto remove
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}

// Navigation Logic
function navigateTo(pageId, btnEl) {
    // Hide all pages
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    
    // Show target page
    const target = document.getElementById(pageId);
    if(target) target.classList.add('active');
    
    // Update Sidebar
    if (btnEl) {
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        // If clicked from submenu, activate parent
        if(btnEl.classList.contains('submenu-item')) {
            // Logic to highlight parent can be added here
        } else {
            btnEl.classList.add('active');
        }
    }

    // Update Header Title
    const titleMap = {
        'dashboard': 'داشبورد مدیریتی',
        'pos': 'صندوق فروشگاهی (POS)',
        'accounting': 'امور مالی و حسابداری',
        'taxes': 'مرکز مالیاتی (BRT)',
        'debts': 'دفتر بدهکاران',
        'inventory': 'انبار و محصولات',
        'personnel': 'پرسنل و حقوق',
        'customers': 'باشگاه مشتریان',
        'services': 'مدیریت خدمات',
        'settings': 'تنظیمات سیستم'
    };
    document.getElementById('headerTitle').innerText = titleMap[pageId] || 'Royal Salon AF';

    // Refresh Data for that page
    if (pageId === 'dashboard') renderDashboard();
    if (pageId === 'pos') initPos();
    if (pageId === 'accounting') renderAccounting();
    if (pageId === 'inventory') renderInventory();
    if (pageId === 'customers') renderCustomers();
    if (pageId === 'services') renderServices();
    if (pageId === 'personnel') renderPersonnel();
    if (pageId === 'debts') renderDebts();
    if (pageId === 'appointments') renderAppointments();
    
    // Close sidebar on mobile
    if(window.innerWidth < 900) {
        document.getElementById('sidebar').classList.remove('open');
    }
}
/* PART 19 OF 20: POS LOGIC & CHECKOUT SYSTEM */

// =========================================
// 4. POS (POINT OF SALE) LOGIC
// =========================================

function initPos() {
    // Check if register is open
    const statusEl = document.getElementById('posRegisterStatus');
    const container = document.getElementById('pos');
    
    if (!db.posSession.isOpen) {
        if(statusEl) {
            statusEl.innerText = "بسته";
            statusEl.style.color = "var(--danger)";
        }
        // Block interaction if closed
        // (In a real app, we might show a blocker overlay here)
    } else {
        if(statusEl) {
            statusEl.innerText = "باز";
            statusEl.style.color = "var(--success)";
        }
    }
    
    renderPosItems();
    populatePosCustomers();
    renderCart();
}

function renderPosItems() {
    const grid = document.getElementById('posItemsGrid');
    const search = document.getElementById('posSearch').value.toLowerCase();
    const filter = document.getElementById('posCatFilter').value; // 'all', 'service', 'product'
    
    grid.innerHTML = '';
    
    let items = [];
    
    // 1. Get Services
    if (filter === 'all' || filter === 'service') {
        db.services.forEach(s => items.push({ ...s, type: 'service' }));
    }
    
    // 2. Get Products (Inventory)
    if (filter === 'all' || filter === 'product') {
        db.inventory.forEach(p => items.push({ ...p, type: 'product', price: p.sellPrice }));
    }
    
    // 3. Filter by Search
    items = items.filter(i => i.name.toLowerCase().includes(search));
    
    if (items.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:rgba(255,255,255,0.5);">موردی یافت نشد</div>';
        return;
    }

    // 4. Render Cards
    items.forEach(item => {
        const isProduct = item.type === 'product';
        let stockLabel = '';
        let disabledClass = '';
        
        if (isProduct) {
            if (item.stock <= 0) {
                stockLabel = '<span style="font-size:10px; color:var(--danger)">(ناموجود)</span>';
                disabledClass = 'opacity:0.6; cursor:not-allowed;';
            } else {
                stockLabel = `<span style="font-size:10px; color:var(--text-muted)">(${item.stock} موجود)</span>`;
            }
        }

        const card = document.createElement('div');
        card.className = 'glass-panel';
        card.style = `padding:15px; cursor:pointer; transition:0.2s; position:relative; overflow:hidden; border:1px solid rgba(212,175,55,0.1); ${disabledClass}`;
        card.onclick = () => { if(!isProduct || item.stock > 0) addToCart(item); };
        
        card.innerHTML = `
            <div style="font-size:24px; color:var(--gold-dark); margin-bottom:10px; text-align:center;">
                <i class="${item.icon || (isProduct ? 'fa-solid fa-box' : 'fa-solid fa-scissors')}"></i>
            </div>
            <div style="font-weight:bold; font-size:13px; margin-bottom:5px; text-align:center;">${item.name}</div>
            <div style="font-size:14px; color:var(--gold-light); text-align:center; direction:ltr;">${formatMoney(item.price)}</div>
            <div style="text-align:center; margin-top:5px;">${stockLabel}</div>
        `;
        
        grid.appendChild(card);
    });
}

function addToCart(item) {
    if (!db.posSession.isOpen) {
        showToast('ابتدا صندوق را باز کنید!', 'error');
        return;
    }

    // Check existing in cart
    const existing = posCart.find(x => x.id === item.id && x.type === item.type);
    
    if (existing) {
        // Stock Check for Products
        if (item.type === 'product' && existing.qty >= item.stock) {
            showToast('موجودی انبار کافی نیست', 'error');
            return;
        }
        existing.qty++;
    } else {
        posCart.push({
            id: item.id,
            name: item.name,
            type: item.type,
            price: item.price, // Store snapshot of price
            qty: 1,
            taxable: item.taxable === 'true' || item.type === 'product', // Products usually taxable
            maxStock: item.type === 'product' ? item.stock : 999
        });
    }
    
    renderCart();
}

function removeFromCart(index) {
    posCart.splice(index, 1);
    renderCart();
}

function updateCartQty(index, change) {
    const item = posCart[index];
    const newQty = item.qty + change;
    
    if (newQty <= 0) {
        removeFromCart(index);
        return;
    }
    
    if (item.type === 'product' && newQty > item.maxStock) {
        showToast('موجودی کافی نیست', 'error');
        return;
    }
    
    item.qty = newQty;
    renderCart();
}

function clearCart() {
    if(confirm('سبد خرید خالی شود؟')) {
        posCart = [];
        renderCart();
    }
}

function renderCart() {
    const container = document.getElementById('posCartItems');
    container.innerHTML = '';
    
    if (posCart.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; margin-top:50px; color:var(--text-muted); opacity:0.5;">
                <i class="fa-solid fa-basket-shopping" style="font-size:40px; margin-bottom:10px;"></i>
                <div>سبد خرید خالی است</div>
            </div>`;
    }

    posCart.forEach((item, index) => {
        const div = document.createElement('div');
        div.style = 'background:rgba(255,255,255,0.05); padding:10px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;';
        div.innerHTML = `
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px;">${item.name}</div>
                <div style="font-size:11px; color:var(--text-muted);">
                    ${formatMoney(item.price)} × ${item.qty}
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <button class="btn-sm" onclick="updateCartQty(${index}, -1)" style="width:25px; height:25px; padding:0;">-</button>
                <span style="font-weight:bold; width:20px; text-align:center;">${item.qty}</span>
                <button class="btn-sm" onclick="updateCartQty(${index}, 1)" style="width:25px; height:25px; padding:0;">+</button>
            </div>
            <div style="font-weight:bold; color:var(--gold-light); margin-right:10px; direction:ltr;">
                ${formatMoney(item.price * item.qty)}
            </div>
        `;
        container.appendChild(div);
    });

    updateCartTotals();
}
// === توابع جدید پرداخت ===
function autoCalcCard() {
    const total = parseFloat(document.getElementById('posTotal').getAttribute('data-raw')) || 0;
    const cash = parseFloat(document.getElementById('payCashInput').value) || 0;
    const card = total - cash;
    document.getElementById('payCardInput').value = card > 0 ? card : 0;
}

function updateCartTotals() {
    let subtotal = 0;
    let totalTax = 0;
    const taxType = db.settings.taxType || 'brt';
    const taxRate = db.settings.taxRate || 0;

    // محاسبه جمع کل و مالیات
    posCart.forEach(item => {
        const lineTotal = item.price * item.qty;
        subtotal += lineTotal;
        if (taxType !== 'none' && item.taxable) {
            totalTax += lineTotal * (taxRate / 100);
        }
    });

    // گرد کردن اعداد
    subtotal = Math.round(subtotal);
    totalTax = Math.round(totalTax);
    const finalTotal = subtotal + totalTax;

    // نمایش در صفحه (با چک کردن وجود المنت‌ها برای جلوگیری از خطا)
    const subtotalEl = document.getElementById('posSubtotal');
    if(subtotalEl) subtotalEl.innerText = formatMoney(subtotal);

    const taxEl = document.getElementById('posTax');
    if(taxEl) taxEl.innerText = formatMoney(totalTax);
    
    // اگر المنت تخفیف وجود نداشت، کد متوقف نمی‌شود
    const discountEl = document.getElementById('posDiscount');
    if(discountEl) discountEl.innerText = formatMoney(0);
    
    // بروزرسانی مبلغ قابل پرداخت
    const totalEl = document.getElementById('posTotal');
    if(totalEl) {
        totalEl.innerText = formatMoney(finalTotal);
        totalEl.setAttribute('data-raw', finalTotal);
    }

    // پر کردن خودکار فیلد پرداخت نقدی
    const cashInput = document.getElementById('payCashInput');
    const cardInput = document.getElementById('payCardInput');
    if(cashInput) cashInput.value = finalTotal;
    if(cardInput) cardInput.value = 0;
}

// === شروع کد جایگزین (تابع پرداخت نهایی) ===
function processCheckout() {
    // 1. بررسی باز بودن صندوق و پر بودن سبد
    if (!db.posSession.isOpen) return showToast('صندوق بسته است!', 'error');
    if (posCart.length === 0) return showToast('سبد خرید خالی است', 'error');

    // 2. محاسبه دقیق مبلغ از روی آیتم‌های سبد (امن‌ترین روش)
    let calcSubtotal = 0;
    let calcTax = 0;
    const taxRate = db.settings.taxRate || 0;
    const taxType = db.settings.taxType || 'none';

    posCart.forEach(item => {
        const lineTotal = item.price * item.qty;
        calcSubtotal += lineTotal;
        
        // محاسبه مالیات اگر آیتم مشمول باشد
        if (taxType !== 'none' && item.taxable) {
            calcTax += lineTotal * (taxRate / 100);
        }
    });

    // گرد کردن مبالغ برای حذف اعشار طولانی
    calcSubtotal = Math.round(calcSubtotal);
    calcTax = Math.round(calcTax);
    const finalTotal = calcSubtotal + calcTax;

    // 3. دریافت مبالغ پرداختی ورودی
    const cashPay = parseFloat(document.getElementById('payCashInput').value) || 0;
    const cardPay = parseFloat(document.getElementById('payCardInput').value) || 0;

    // بررسی اختلاف حساب (با تخفیف خطای 5 افغانی)
    if (Math.abs((cashPay + cardPay) - finalTotal) > 5) { 
        return showToast('مبلغ پرداختی (نقد + کارت) با مبلغ کل برابر نیست', 'error');
    }

    const customerId = document.getElementById('posCustomer').value;
    const customerName = document.getElementById('posCustomer').selectedOptions[0].text;

    // 4. ساخت فاکتور نهایی
    const invoice = {
        id: generateId(),
        no: 'INV-' + Date.now().toString().slice(-6),
        date: Date.now(),
        customer: customerName,
        customerId: customerId,
        items: [...posCart],
        // مقادیر محاسبه شده را اینجا قرار می‌دهیم:
        total: finalTotal,      
        subtotal: calcSubtotal,
        tax: calcTax,
        payCash: cashPay,
        payCard: cardPay,
        user: db.settings.auth.user
    };

    // ذخیره در دیتابیس
    if(!db.invoices) db.invoices = [];
    db.invoices.push(invoice);

    // ثبت تراکنش مالی
    if(cashPay > 0) {
        db.transactions.push({
            id: generateId(), date: Date.now(), type: 'income',
            category: 'فروش (POS) - نقد', desc: `فاکتور ${invoice.no}`,
            amount: cashPay, user: db.settings.auth.user
        });
        db.posSession.salesCash += cashPay;
    }
    
    if(cardPay > 0) {
        db.transactions.push({
            id: generateId(), date: Date.now(), type: 'income',
            category: 'فروش (POS) - کارت', desc: `فاکتور ${invoice.no}`,
            amount: cardPay, user: db.settings.auth.user
        });
        db.posSession.salesCard += cardPay;
    }

    // کسر از انبار
    posCart.forEach(item => {
        if (item.type === 'product') {
            const product = db.inventory.find(p => p.id === item.id);
            if (product) product.stock -= item.qty;
        }
    });

    // 5. چاپ فاکتور
    // مستقیم به چاپ می‌رود (اگر تاییدیه نمی‌خواهید خط زیر را ساده کنید)
    printInvoice(invoice); 

    // پاکسازی
    posCart = [];
    saveData();
    renderCart();
    renderInventory();
    renderDashboard();
    showToast('فاکتور با موفقیت ثبت شد', 'success');
}
function populatePosCustomers() {
    const select = document.getElementById('posCustomer');
    if(!select) return;
    
    // Keep 'Guest' option
    select.innerHTML = '<option value="guest">مشتری مهمان</option>';
    
    db.customers.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name + (c.phone ? ` (${c.phone})` : '');
        select.appendChild(opt);
    });
}
/* PART 20 OF 20: RENDERING, ACTIONS & FINAL INIT */

// =========================================
// 6. PAGE RENDERING FUNCTIONS
// =========================================

function renderDashboard() {
    // Calculate Daily Stats
    const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD local
    // Note: In real app, match timestamps properly. Here we use simple filters.
    
    // 1. Income & Expense
    let todayIncome = 0;
    let todayExpense = 0;
    
    // Filter transactions for "today" (approximate for demo)
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    
    db.transactions.forEach(tx => {
        if (tx.date >= startOfDay) {
            if (tx.type === 'income') todayIncome += tx.amount;
            if (tx.type === 'expense') todayExpense += tx.amount;
        }
    });

    document.getElementById('dashTodayIncome').innerText = formatMoney(todayIncome);
    document.getElementById('dashTodayExpense').innerText = formatMoney(todayExpense);

    // 2. Appointments
    const todayApts = db.appointments.filter(a => a.date === getTodayJalali());
    document.getElementById('dashTodayApts').innerText = todayApts.length;
    document.getElementById('dashPendingApts').innerText = todayApts.filter(a => a.status === 'scheduled').length;

    // 3. Register Status
    document.getElementById('dashRegisterStatus').innerText = db.posSession.isOpen ? 'باز است' : 'بسته است';

    // 4. Recent Transactions Table
    const tbody = document.getElementById('dashRecentTxBody');
    tbody.innerHTML = '';
    
    const recentTx = [...db.transactions].sort((a,b) => b.date - a.date).slice(0, 5);
    
    if(recentTx.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted)">تراکنشی ثبت نشده است</td></tr>';
    } else {
        recentTx.forEach(tx => {
            const dateStr = new Date(tx.date).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
            let typeColor = tx.type === 'income' ? 'var(--success)' : 'var(--danger)';
            let typeIcon = tx.type === 'income' ? 'arrow-up' : 'arrow-down';
            
            tbody.innerHTML += `
                <tr>
                    <td style="color:var(--text-muted)">${dateStr}</td>
                    <td>${tx.category} - <span style="font-size:12px; opacity:0.7">${tx.desc}</span></td>
                    <td style="color:${typeColor}; direction:ltr; font-weight:bold;">
                        ${formatMoney(tx.amount)}
                    </td>
                    <td><div class="status-badge" style="color:${typeColor}; border-color:${typeColor}20; background:${typeColor}10">
                        <i class="fa-solid fa-${typeIcon}"></i> ${tx.type === 'income' ? 'درآمد' : 'هزینه'}
                    </div></td>
                    <td style="font-size:12px;">${tx.user}</td>
                </tr>
            `;
        });
    }

    // Update Chart (Mock Data for Demo)
    renderCharts(); 
}

function renderAccounting() {
    const tbody = document.getElementById('accountingBody');
    const filterType = document.getElementById('accFilterType').value;
    const search = document.getElementById('accSearch').value.toLowerCase();
    
    tbody.innerHTML = '';

    let list = db.transactions.sort((a,b) => b.date - a.date);
    
    if (filterType !== 'all') list = list.filter(t => t.type === filterType);
    if (search) list = list.filter(t => t.desc.toLowerCase().includes(search) || t.category.includes(search));

    list.forEach((tx, index) => {
        const dateStr = new Date(tx.date).toLocaleDateString('fa-IR') + ' ' + new Date(tx.date).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
        const color = tx.type === 'income' ? 'var(--success)' : 'var(--danger)';
        
        tbody.innerHTML += `
            <tr>
                <td>${index + 1}</td>
                <td>${dateStr}</td>
                <td><span style="color:${color}">${tx.type === 'income' ? 'درآمد' : 'هزینه'}</span></td>
                <td>${tx.category}</td>
                <td>${tx.desc}</td>
                <td style="font-weight:bold; color:${color}; direction:ltr">${formatMoney(tx.amount)}</td>
                <td style="font-size:11px; color:var(--text-muted)">${tx.tax > 0 ? formatMoney(tx.tax) : '-'}</td>
                <td>${tx.user}</td>
                <td>
                    <button class="btn-sm" onclick="deleteItem('transactions', '${tx.id}')" style="color:var(--danger)"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
    });

    // Update Summary Cards
    const totalInc = list.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const totalExp = list.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    
    document.getElementById('accTotalIncome').innerText = formatMoney(totalInc);
    document.getElementById('accTotalExpense').innerText = formatMoney(totalExp);
    document.getElementById('accBalance').innerText = formatMoney(totalInc - totalExp);
}

function renderDebts() {
    const tbody = document.getElementById('debtsBody');
    tbody.innerHTML = '';
    
    // Mock Debt Calculation: For demo, using static 'db.debts' or filtering customers with debt
    // Here we'll iterate customers who have debt notes or negative balance simulation
    
    // Let's assume we store debts in db.debts manually for now
    if(!db.debts) db.debts = [];
    
    let totalDebt = 0;

    if(db.debts.length === 0) {
         tbody.innerHTML = '<tr><td colspan="6" class="text-center">هیچ بدهکاری ثبت نشده است</td></tr>';
    } else {
        db.debts.forEach(d => {
            totalDebt += d.amount;
            tbody.innerHTML += `
                <tr>
                    <td>${d.name}</td>
                    <td>${d.phone}</td>
                    <td style="color:var(--danger); font-weight:bold; direction:ltr">${formatMoney(d.amount)}</td>
                    <td>${d.lastDate}</td>
                    <td><span class="status-badge status-danger">پرداخت نشده</span></td>
                    <td>
                        <button class="gold-btn btn-sm" onclick="settleDebt('${d.id}')">تسویه</button>
                    </td>
                </tr>
            `;
        });
    }
    document.getElementById('totalDebtDisplay').innerText = formatMoney(totalDebt);
}

function renderInventory() {
    const tbody = document.getElementById('inventoryBody');
    tbody.innerHTML = '';
    
    let totalValue = 0;
    let lowStock = 0;

    db.inventory.forEach(item => {
        totalValue += item.stock * item.buyPrice;
        if(item.stock <= item.lowStockAlert) lowStock++;
        
        let status = item.stock > 0 ? '<span class="status-badge status-success">موجود</span>' : '<span class="status-badge status-danger">ناموجود</span>';
        if(item.stock > 0 && item.stock <= item.lowStockAlert) status = '<span class="status-badge status-warning">رو به اتمام</span>';

        tbody.innerHTML += `
            <tr>
                <td><strong>${item.name}</strong></td>
                <td>${item.brand || '-'}</td>
                <td style="font-weight:bold; ${item.stock <= item.lowStockAlert ? 'color:var(--danger)' : ''}">${item.stock}</td>
                <td style="direction:ltr">${formatMoney(item.buyPrice)}</td>
                <td style="direction:ltr; color:var(--gold-light)">${formatMoney(item.sellPrice)}</td>
                <td>${status}</td>
                <td>
                    <button class="icon-btn" onclick="deleteItem('inventory', ${item.id})" style="width:30px; height:30px;"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
    });

    document.getElementById('invTotalItems').innerText = db.inventory.length;
    document.getElementById('invTotalValue').innerText = formatMoney(totalValue);
    document.getElementById('invLowStock').innerText = lowStock;
}

// ... Simple renders for others ...
function renderCustomers() {
    const tbody = document.getElementById('customersBody');
    tbody.innerHTML = '';
    db.customers.forEach(c => {
        tbody.innerHTML += `
            <tr>
                <td>${c.name}</td>
                <td>${c.phone}</td>
                <td>-</td>
                <td>0</td>
                <td>0</td>
                <td><button class="btn-sm"><i class="fa-solid fa-pen"></i></button></td>
            </tr>`;
    });
    document.getElementById('crmTotalCust').innerText = db.customers.length;
}

function renderServices() {
    const grid = document.getElementById('servicesGrid');
    grid.innerHTML = '';
    db.services.forEach(s => {
        grid.innerHTML += `
            <div class="card" style="margin:0; padding:20px; text-align:center;">
                <div style="font-size:30px; color:var(--gold-dark); margin-bottom:10px;"><i class="${s.icon}"></i></div>
                <h4 style="color:var(--text-main);">${s.name}</h4>
                <div style="color:var(--gold-light); font-weight:bold; margin:10px 0; direction:ltr;">${formatMoney(s.price)}</div>
                <div style="font-size:12px; color:var(--text-muted);">زمان: ${s.duration} دقیقه</div>
            </div>`;
    });
}

// =========================================
// 7. ACTION FUNCTIONS & MODAL LOGIC
// =========================================

function handleLogin() {
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    
    // Simple check (Real app uses secure auth)
    if (u === db.settings.auth.user && p === db.settings.auth.pass) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        initApp();
    } else {
        const err = document.getElementById('loginError');
        err.style.display = 'block';
        setTimeout(() => err.style.display = 'none', 2000);
    }
}

function handleLogout() {
    if(confirm('آیا مطمئن هستید؟')) {
        location.reload();
    }
}

// Register Actions
function openRegister() {
    const cash = parseFloat(document.getElementById('regStartCash').value) || 0;
    db.posSession = {
        isOpen: true,
        startTime: Date.now(),
        startCash: cash,
        salesCash: 0,
        salesCard: 0
    };
    saveData();
    closeModal('modalRegister');
    initPos(); // Refresh UI
    showToast('صندوق با موفقیت باز شد', 'success');
}

function closeRegister() {
    if(confirm('آیا از بستن صندوق اطمینان دارید؟')) {
        db.posSession.isOpen = false;
        saveData();
        closeModal('modalRegister');
        initPos();
        showToast('صندوق بسته شد. گزارش چاپ شد.', 'info');
    }
}

// Transaction Actions
function submitTransaction() {
    const amount = parseFloat(document.getElementById('txAmount').value);
    if (!amount) return showToast('مبلغ را وارد کنید', 'error');
    
    const type = document.getElementById('txType').value || 'expense'; // Default to expense if triggered from expense button
    const cat = document.getElementById('txCategory').value || 'سایر';
    const desc = document.getElementById('txDesc').value;
    
    // Tax Logic
    let tax = 0;
    if (document.getElementById('txTaxApply').checked) {
        tax = amount * (db.settings.taxRate / 100);
    }

    db.transactions.push({
        id: generateId(),
        date: Date.now(),
        type: type,
        category: cat,
        desc: desc,
        amount: amount,
        tax: tax,
        user: db.settings.auth.user
    });

    saveData();
    closeModal('modalNewTx');
    renderAccounting();
    renderDashboard();
    showToast('تراکنش ثبت شد', 'success');
}

// Save Functions
function saveCustomer() {
    const name = document.getElementById('custName').value;
    const phone = document.getElementById('custPhone').value;
    if(!name || !phone) return showToast('نام و شماره تماس الزامی است', 'error');
    
    db.customers.push({ id: generateId(), name, phone, joinDate: Date.now() });
    saveData();
    closeModal('modalCustomer');
    renderCustomers();
    populatePosCustomers(); // Refresh dropdown
    showToast('مشتری ثبت شد', 'success');
}

function saveService() {
    const name = document.getElementById('srvName').value;
    const price = parseFloat(document.getElementById('srvPrice').value);
    if(!name || !price) return showToast('اطلاعات ناقص است', 'error');

    db.services.push({
        id: generateId(),
        name,
        price,
        icon: document.getElementById('srvIcon').value || 'fa-solid fa-scissors',
        duration: document.getElementById('srvDuration').value,
        category: document.getElementById('srvCat').value,
        taxable: document.getElementById('srvTaxable').value
    });
    saveData();
    closeModal('modalService');
    renderServices();
    showToast('خدمت جدید اضافه شد', 'success');
}

function saveProduct() {
    // Similar to saveService, get values from modalProduct inputs
    // Push to db.inventory
    // saveData(); closeModal...
    // Included in full code for brevity in split
    const name = document.getElementById('prdName').value;
    const sellPrice = parseFloat(document.getElementById('prdSellPrice').value);
    const stock = parseInt(document.getElementById('prdStock').value);
    
    if(!name || !sellPrice) return showToast('نام و قیمت فروش الزامی است', 'error');

    db.inventory.push({
        id: generateId(),
        name,
        brand: document.getElementById('prdBrand').value,
        stock: stock || 0,
        buyPrice: parseFloat(document.getElementById('prdBuyPrice').value) || 0,
        sellPrice,
        lowStockAlert: parseInt(document.getElementById('prdLowStockAlert').value) || 5
    });
    saveData();
    closeModal('modalProduct');
    renderInventory();
    showToast('کالا به انبار اضافه شد', 'success');
}

// Modal Helpers
function openModal(id, type) {
    document.getElementById(id).classList.add('active');
    
    // Specific logic for modals
    if (id === 'modalNewTx') {
        const title = type === 'income' ? 'ثبت درآمد جدید' : 'ثبت هزینه جدید';
        document.getElementById('modalTxTitle').innerText = title;
        document.getElementById('txType').value = type;
        
        // Populate Categories
        const catSelect = document.getElementById('txCategory');
        catSelect.innerHTML = '';
        const cats = type === 'income' ? ['فروش متفرقه', 'بیعانه', 'سایر'] : ['خرید مواد', 'اجاره', 'قبض برق/آب', 'حقوق', 'تعمیرات', 'سایر'];
        cats.forEach(c => catSelect.innerHTML += `<option>${c}</option>`);
    }

    if (id === 'modalRegister') {
        // Toggle Open/Close forms based on state
        if (db.posSession.isOpen) {
            document.getElementById('registerOpenForm').style.display = 'none';
            document.getElementById('registerCloseForm').style.display = 'block';
            
            // Fill Info
            document.getElementById('regStartTimeDisplay').innerText = new Date(db.posSession.startTime).toLocaleTimeString('fa-IR');
            document.getElementById('regTotalCashDisplay').innerText = formatMoney(db.posSession.salesCash);
        } else {
            document.getElementById('registerOpenForm').style.display = 'block';
            document.getElementById('registerCloseForm').style.display = 'none';
        }
    }
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// =========================================
// 8. TAX REPORT & PRINTING
// =========================================

function calculateTaxReport() {
    const period = document.getElementById('taxReportSeason').value;
    // Real app: filter db.invoices by date based on period
    // Demo: Sum all
    
    let grossSales = 0;
    let taxableIncome = 0;
    
    db.invoices.forEach(inv => {
        grossSales += inv.subtotal;
        if(inv.tax > 0) taxableIncome += inv.subtotal;
    });

    const taxRate = db.settings.taxRate;
    const taxPayable = taxableIncome * (taxRate / 100);

    document.getElementById('taxGrossSales').innerText = formatMoney(grossSales);
    document.getElementById('taxableIncome').innerText = formatMoney(taxableIncome);
    document.getElementById('taxPayable').innerText = formatMoney(taxPayable);
    
    document.getElementById('taxResultArea').style.display = 'block';
}

function printInvoice(invoice) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html dir="rtl" lang="fa">
        <head>
            <title>Faktor #${invoice.no}</title>
            <style>
                @page { size: 80mm auto; margin: 0; } /* تنظیم سایز کاغذ برای فیش پرینتر */
                body {
                    font-family: 'Tahoma', sans-serif;
                    width: 72mm; /* عرض استاندارد چاپ */
                    margin: 0 auto;
                    padding: 5px;
                    font-size: 12px;
                    color: #000;
                }
                .header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; }
                .logo { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
                .info { font-size: 10px; margin-bottom: 5px; }
                
                table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                th { text-align: right; border-bottom: 1px dashed #000; font-size: 11px; padding: 2px 0; }
                td { padding: 4px 0; border-bottom: 1px dotted #ccc; }
                
                .footer { margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; text-align: center; font-size: 10px; }
                .total-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-top: 5px; }
                
                /* مخفی کردن آدرس و تاریخ در چاپ اگر خیلی طولانی شود */
                .no-print { display: none; }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">✂️ ${db.settings.name}</div>
                <div class="info">تاریخ: ${new Date(invoice.date).toLocaleDateString('fa-IR')}</div>
                <div class="info">صندوق‌دار: ${invoice.user} | فاکتور: ${invoice.no}</div>
                <div class="info">مشتری: ${invoice.customer}</div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>شرح</th>
                        <th style="width:30px; text-align:center;">تعداد</th>
                        <th style="text-align:left;">قیمت</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.items.map(i => `
                    <tr>
                        <td>${i.name}</td>
                        <td style="text-align:center;">${i.qty}</td>
                        <td style="text-align:left;">${(i.price * i.qty).toLocaleString()}</td>
                    </tr>`).join('')}
                </tbody>
            </table>

            <div class="footer">
                <div style="display:flex; justify-content:space-between; font-size:11px;">
                    <span>جمع کل:</span>
                    <span>${formatMoney(invoice.subtotal)}</span>
                </div>
                ${invoice.tax > 0 ? `
                <div style="display:flex; justify-content:space-between; font-size:11px;">
                    <span>مالیات:</span>
                    <span>${formatMoney(invoice.tax)}</span>
                </div>` : ''}
                
                <div class="total-row">
                    <span>قابل پرداخت:</span>
                    <span>${formatMoney(invoice.total)}</span>
                </div>
                
                <div style="margin-top:15px; font-size:9px;">
                    از خرید شما سپاسگزاریم<br>
                    لطفاً فاکتور را نگه دارید
                </div>
                <br>
                <div style="background:#000; height:5px; width:100%;"></div>
                <div style="background:#000; height:5px; width:80%; margin:2px auto;"></div>
            </div>
            
            <script>
                window.onload = function() { window.print(); window.close(); }
            <\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
function renderCharts() {
    // Mock Chart.js implementation
    const ctx = document.getElementById('mainChart');
    if(ctx && window.Chart) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['شنبه', 'یکشنبه', 'دوشنبه', 'سه شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'],
                datasets: [{
                    label: 'درآمد',
                    data: [12000, 19000, 3000, 5000, 2000, 30000, 45000], // Random data
                    borderColor: '#D4AF37',
                    backgroundColor: 'rgba(212, 175, 55, 0.2)',
                    fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
}

function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const newVal = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newVal);
    db.settings.theme = newVal;
    saveData();
    
    // Icon update
    const icon = document.getElementById('themeIconBtn');
    if(icon) icon.className = newVal === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
}

// =========================================
// 9. MISSING UI & HELPER FUNCTIONS (FIXED)
// =========================================

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
}

function switchTab(tabId, btn) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // Show target
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}

function deleteItem(collection, id) {
    if(!confirm('آیا از حذف این مورد اطمینان دارید؟ این عملیات قابل بازگشت نیست.')) return;
    
    // Filter out the item
    db[collection] = db[collection].filter(item => item.id != id);
    saveData();
    
    // Refresh Views
    if(collection === 'inventory') renderInventory();
    if(collection === 'transactions') { renderAccounting(); renderDashboard(); }
    if(collection === 'customers') renderCustomers();
    if(collection === 'services') renderServices();
    if(collection === 'staff') renderPersonnel();
    
    showToast('آیتم با موفقیت حذف شد', 'info');
}

function filterAccounting() {
    renderAccounting(); // The logic is already inside renderAccounting, just re-trigger it
}

function setTodayFilter() {
    // Helper to set inputs to today's date (Simple String Match for now)
    const today = getTodayJalali(); 
    // Since we don't have a real date picker sync, we just alert or clear for demo
    document.getElementById('accDateFilter').valueAsDate = new Date();
    renderAccounting();
}

function loadSettingsToInputs() {
    if(!db.settings) return;
    document.getElementById('setSalonName').value = db.settings.name || '';
    document.getElementById('setPhone').value = db.settings.phone || '';
    document.getElementById('setAddress').value = db.settings.address || '';
    
    document.getElementById('setTaxType').value = db.settings.taxType || 'brt';
    document.getElementById('setTaxRate').value = db.settings.taxRate || 4;
    toggleTaxInput();
}

function toggleTaxInput() {
    const type = document.getElementById('setTaxType').value;
    const group = document.getElementById('taxRateGroup');
    if(type === 'custom') {
        group.style.display = 'block';
    } else {
        group.style.display = 'none';
        // Auto set rate
        if(type === 'brt') db.settings.taxRate = 4;
        if(type === 'vat') db.settings.taxRate = 10;
        if(type === 'none') db.settings.taxRate = 0;
    }
}
// =========================================
// 10. PERSONNEL, APPOINTMENTS & NAVIGATION (ADDED)
// =========================================

function toggleSubmenu(element) {
    element.classList.toggle('active');
    const submenu = element.nextElementSibling;
    if (submenu) {
        submenu.classList.toggle('open');
    }
}

function renderPersonnel() {
    const tbody = document.getElementById('personnelBody');
    const select = document.getElementById('payrollStaffSel');
    const aptSelect = document.getElementById('aptStaff'); 

    if(tbody) tbody.innerHTML = '';
    
    // Reset Dropdowns
    if(select) select.innerHTML = '<option value="">-- انتخاب پرسنل --</option>';
    if(aptSelect) aptSelect.innerHTML = '<option value="">-- انتخاب --</option>';

    db.staff.forEach(s => {
        // 1. Fill Table
        if(tbody) {
            tbody.innerHTML += `
                <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.role}</td>
                    <td style="direction:ltr">${formatMoney(s.baseSalary)}</td>
                    <td>${s.comm}%</td>
                    <td><span class="status-badge status-success">فعال</span></td>
                    <td>
                        <button class="icon-btn" onclick="deleteItem('staff', ${s.id})" style="width:30px; height:30px;"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }
        // 2. Fill Dropdowns
        if(select) select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        if(aptSelect) aptSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
}

function saveStaff() {
    const name = document.getElementById('stfName').value;
    const phone = document.getElementById('stfPhone').value;
    if(!name || !phone) return showToast('نام و موبایل الزامی است', 'error');

    db.staff.push({
        id: generateId(),
        name,
        role: document.getElementById('stfRole').value,
        phone,
        baseSalary: parseFloat(document.getElementById('stfBaseSalary').value) || 0,
        comm: parseFloat(document.getElementById('stfComm').value) || 0,
        joinDate: document.getElementById('stfJoinDate').value || getTodayJalali()
    });

    saveData();
    closeModal('modalStaff');
    renderPersonnel();
    showToast('پرسنل جدید استخدام شد', 'success');
}

function calculateSalary() {
    const staffId = document.getElementById('payrollStaffSel').value;
    if(!staffId) return showToast('لطفا پرسنل را انتخاب کنید', 'error');

    const staff = db.staff.find(s => s.id == staffId);
    if(!staff) return;

    // Simple Payroll Calculation
    const total = staff.baseSalary; // In future, add commission calc here

    const resDiv = document.getElementById('payrollResult');
    resDiv.style.display = 'block';
    resDiv.innerHTML = `
        <h4 style="color:var(--gold-light); border-bottom:1px solid var(--gold-dark); padding-bottom:5px; margin-bottom:10px;">
            فیش حقوقی: ${staff.name}
        </h4>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>حقوق پایه:</span>
            <span>${formatMoney(staff.baseSalary)}</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.2); font-weight:bold; color:var(--success);">
            <span>مبلغ قابل پرداخت:</span>
            <span>${formatMoney(total)}</span>
        </div>
    `;
}

function renderAppointments() {
    const container = document.getElementById('appointmentsList');
    const filterStatus = document.getElementById('aptStatusFilter').value;
    
    container.innerHTML = '';

    if(db.appointments.length === 0) {
        container.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--text-muted); border:2px dashed var(--gold-dark); border-radius:15px;">
                <i class="fa-solid fa-calendar-xmark" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
                <div>هیچ نوبتی ثبت نشده است</div>
            </div>`;
        return;
    }

    let list = db.appointments.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
    if(filterStatus !== 'all') list = list.filter(a => a.status === filterStatus);

    list.forEach(apt => {
        let statusColor = 'var(--info)';
        let statusText = 'رزرو شده';
        if(apt.status === 'confirmed') { statusColor = 'var(--success)'; statusText = 'تایید شده'; }
        if(apt.status === 'canceled') { statusColor = 'var(--danger)'; statusText = 'لغو شده'; }
        if(apt.status === 'completed') { statusColor = 'var(--text-muted)'; statusText = 'انجام شد'; }

        const srv = db.services.find(s => s.id == apt.serviceId) || {name: 'خدمت حذف شده'};
        const stf = db.staff.find(s => s.id == apt.staffId) || {name: 'نامشخص'};
        const cust = db.customers.find(c => c.id == apt.customerId) || {name: 'مشتری حذف شده'};

        container.innerHTML += `
            <div class="card" style="margin:0; border-left:4px solid ${statusColor};">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                    <div style="font-weight:bold; font-size:16px;">${cust.name}</div>
                    <div class="status-badge" style="background:${statusColor}20; color:${statusColor}; border:1px solid ${statusColor}40;">
                        ${statusText}
                    </div>
                </div>
                <div style="display:flex; gap:10px; font-size:13px; color:var(--text-muted); margin-bottom:5px;">
                    <span><i class="fa-regular fa-clock"></i> ${apt.time}</span>
                    <span><i class="fa-regular fa-calendar"></i> ${apt.date}</span>
                </div>
                <div style="font-size:14px; margin-bottom:5px; color:var(--gold-light);">
                    <i class="fa-solid fa-scissors"></i> ${srv.name}
                </div>
                <div style="font-size:12px; color:var(--text-dim);">
                    <i class="fa-solid fa-user-tie"></i> متخصص: ${stf.name}
                </div>
                <div style="margin-top:15px; display:flex; justify-content:end; gap:5px;">
                    <button class="btn-sm" style="color:var(--danger)" onclick="deleteItem('appointments', '${apt.id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        `;
    });
}
// === تابع جدید ثبت نوبت با تشخیص تداخل ===
function saveAppointment() {
    const custId = document.getElementById('aptCustomer').value;
    const date = document.getElementById('aptDateInput').value;
    const time = document.getElementById('aptTimeInput').value;
    const srvId = document.getElementById('aptService').value;
    const stfId = document.getElementById('aptStaff').value;
    
    if(!custId || !date || !time || !srvId) return showToast('اطلاعات ناقص است', 'error');

    // پیدا کردن زمان سرویس
    const service = db.services.find(s => s.id == srvId);
    const duration = service ? parseInt(service.duration) : 30;

    // تبدیل زمان به دقیقه
    const [h, m] = time.split(':').map(Number);
    const newStart = h * 60 + m;
    const newEnd = newStart + duration;

    // بررسی تداخل
    const hasConflict = db.appointments.some(apt => {
        if (apt.date !== date || apt.staffId != stfId || apt.status === 'canceled') return false;
        
        const [ah, am] = apt.time.split(':').map(Number);
        const aptStart = ah * 60 + am;
        const aptDuration = apt.duration || 30; 
        const aptEnd = aptStart + aptDuration;

        return (newStart < aptEnd && newEnd > aptStart);
    });

    if (hasConflict) {
        return showToast('❌ تداخل زمانی! پرسنل در این ساعت مشغول است.', 'error');
    }

    db.appointments.push({
        id: generateId(),
        customerId: custId,
        date, time, duration,
        serviceId: srvId, staffId: stfId,
        status: document.getElementById('aptStatus').value,
        note: document.getElementById('aptNote').value
    });

    saveData();
    closeModal('modalAppointment');
    renderAppointments();
    renderDashboard();
    showToast('نوبت با موفقیت ثبت شد', 'success');
}

function updateDropdowns() {
    // Fill Service Selects
    const srvSel = document.getElementById('aptService');
    const txCat = document.getElementById('txCategory'); // Optional
    
    if(srvSel) {
        srvSel.innerHTML = '<option value="">-- انتخاب خدمت --</option>';
        db.services.forEach(s => srvSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
    }

    // Fill Customer Selects
    const custSel = document.getElementById('aptCustomer');
    if(custSel) {
        custSel.innerHTML = '<option value="">-- انتخاب مشتری --</option>';
        db.customers.forEach(c => custSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
    }
}
// =========================================
// 11. SETTINGS & BACKUP (FINAL ADDITIONS)
// =========================================

function saveGeneralSettings() {
    db.settings.name = document.getElementById('setSalonName').value;
    db.settings.phone = document.getElementById('setPhone').value;
    db.settings.address = document.getElementById('setAddress').value;
    
    saveData();
    // Update Sidebar Name immediately
    if(document.getElementById('sidebarUserName')) {
        document.getElementById('sidebarUserName').innerText = db.settings.name;
    }
    showToast('مشخصات سالن ذخیره شد', 'success');
}

function saveFinanceSettings() {
    db.settings.taxType = document.getElementById('setTaxType').value;
    
    const rateInput = parseFloat(document.getElementById('setTaxRate').value);
    if (db.settings.taxType === 'custom' && isNaN(rateInput)) {
        return showToast('لطفاً نرخ مالیات را وارد کنید', 'error');
    }
    
    // Logic inside toggleTaxInput handles default rates (4/10/0), here we capture custom
    if(db.settings.taxType === 'custom') db.settings.taxRate = rateInput;
    
    // Re-apply logic to ensure defaults are saved if switched back from custom
    if(db.settings.taxType === 'brt') db.settings.taxRate = 4;
    if(db.settings.taxType === 'vat') db.settings.taxRate = 10;
    if(db.settings.taxType === 'none') db.settings.taxRate = 0;

    saveData();
    showToast('تنظیمات مالی اعمال شد', 'success');
}

function saveSecuritySettings() {
    const newUser = document.getElementById('secNewUser').value;
    const newPass = document.getElementById('secNewPass').value;
    const confirmPass = document.getElementById('secConfirmPass').value;
    
    if(!newUser || !newPass) return showToast('نام کاربری و رمز عبور نمی‌توانند خالی باشند', 'error');
    if(newPass !== confirmPass) return showToast('تکرار رمز عبور مطابقت ندارد', 'error');
    
    db.settings.auth.user = newUser;
    db.settings.auth.pass = newPass;
    
    saveData();
    showToast('اطلاعات ورود بروزرسانی شد. لطفاً دوباره وارد شوید.', 'success');
    setTimeout(() => location.reload(), 2000);
}

function exportBackup() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "RoyalSalon_Backup_" + new Date().toISOString().slice(0,10) + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function importBackup(input) {
    const file = input.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            if(!json.settings || !json.customers) throw new Error("Invalid Format");
            
            if(confirm('آیا مطمئن هستید؟ تمام اطلاعات فعلی جایگزین خواهد شد.')) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(json));
                alert('اطلاعات با موفقیت بازگردانی شد.');
                location.reload();
            }
        } catch(err) {
            alert('فایل انتخاب شده معتبر نیست یا خراب است.');
        }
    };
    reader.readAsText(file);
}

function factoryReset() {
    if(confirm('هشدار: تمام اطلاعات پاک خواهد شد و قابل بازگشت نیست. ادامه می‌دهید؟')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

// =========================================
// 12. FINAL INITIALIZATION & EXECUTION
// =========================================

// This closes the functionality and starts the app properly
// =========================================
// 14. NOTIFICATIONS SYSTEM (FINAL LOGIC)
// =========================================

function showNotifications() {
    const lowStock = db.inventory.filter(i => i.stock <= i.lowStockAlert);
    const pendingApts = db.appointments.filter(a => a.status === 'scheduled');
    
    // اگر هیچ هشداری نبود
    if(lowStock.length === 0 && pendingApts.length === 0) {
        return showToast('هیچ پیام جدیدی وجود ندارد', 'success');
    }

    // ساخت پیام هشدار
    let msg = '📊 گزارش وضعیت سیستم:\n\n';
    
    if(lowStock.length > 0) {
        msg += `⚠️ توجه: ${lowStock.length} کالا در انبار رو به اتمام است.\n`;
        // نمایش نام چند کالای اول
        lowStock.slice(0, 3).forEach(i => msg += `   - ${i.name} (موجودی: ${i.stock})\n`);
        if(lowStock.length > 3) msg += '   و ...\n';
        msg += '\n';
    }
    
    if(pendingApts.length > 0) {
        msg += `📅 یادآوری: ${pendingApts.length} نوبت در انتظار تایید دارید.\n`;
    }

    // نمایش آلرت (می‌توانید بعداً به مودال تغییر دهید)
    alert(msg); 
}

function updateNotificationBadge() {
    const badge = document.getElementById('notifBadge');
    if(!badge) return;

    // بررسی موجودی کم
    const lowStockCount = db.inventory ? db.inventory.filter(i => i.stock <= i.lowStockAlert).length : 0;
    
    // بررسی نوبت‌های در انتظار
    const pendingCount = db.appointments ? db.appointments.filter(a => a.status === 'scheduled').length : 0;
    
    const total = lowStockCount + pendingCount;

    if (total > 0) {
        badge.style.display = 'block';
        badge.innerText = total > 9 ? '+9' : total; // اگر عدد بزرگ بود
        badge.style.fontSize = '8px';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.color = '#fff';
    } else {
        badge.style.display = 'none';
    }
}

// هوشمند سازی تابع ذخیره
// این کار باعث می‌شود هر وقت چیزی ذخیره شد، بج و نمودارها آپدیت شوند
const _originalSaveData = saveData; // ذخیره تابع اصلی
saveData = function() {
    _originalSaveData(); // اجرای تابع اصلی
    updateNotificationBadge(); // آپدیت بج
    
    // اگر در صفحه داشبورد هستیم، نمودار را هم آپدیت کن
    if(document.getElementById('dashboard').classList.contains('active')) {
        renderDashboard();
    }
};

// =========================================
// 15. FINAL BOOTSTRAP (REPLACES OLD LISTENER)
// =========================================

// حذف لیسنرهای قبلی (اگر وجود داشته باشند) و اجرای نهایی
window.addEventListener('DOMContentLoaded', () => {
    console.log("System Booting...");
    
    // 1. راه اندازی پایگاه داده و ظاهر
    initApp();
    
    // 2. پر کردن لیست‌های کشویی
    if(typeof updateDropdowns === 'function') updateDropdowns();
    
    // 3. بررسی اولیه اعلانات
    updateNotificationBadge();
    
    // 4. تنظیم تایمر برای ساعت و تاریخ
    setInterval(() => {
        if(document.getElementById('currentDateDisplay')) updateDateDisplay();
    }, 60000);

    console.log("Royal Salon AF Loaded Successfully.");
});
// =========================================
// 16. FINAL POLISH: SHORTCUTS & PRINT STYLES
// =========================================

// 1. استایل‌های مخصوص چاپ (پرینتر)
// این بخش باعث می‌شود وقتی دکمه پرینت را می‌زنید، پس‌زمینه سیاه حذف شود و در مصرف جوهر صرفه‌جویی شود
const printStyle = document.createElement('style');
printStyle.innerHTML = `
    @media print {
        @page { size: auto; margin: 10mm; }
        body, .main-content, .page-container, .glass-panel, .card, .lux-modal {
            background: #ffffff !important;
            color: #000000 !important;
            box-shadow: none !important;
            border: none !important;
            overflow: visible !important;
            height: auto !important;
        }
        /* مخفی کردن عناصر اضافی در چاپ */
        .sidebar, .top-header, .btn, .gold-btn, .icon-btn, .tabs, .toast-container, 
        .card-header button, .nav-menu, #loadingOverlay, .close-modal { 
            display: none !important; 
        }
        /* تنظیم جداول برای چاپ */
        .lux-table th { background: #eee !important; color: #000 !important; border: 1px solid #000 !important; }
        .lux-table td { border: 1px solid #ccc !important; color: #000 !important; }
        .stat-card { border: 1px solid #ccc !important; page-break-inside: avoid; }
        .stat-value { color: #000 !important; }
        
        /* نمایش فقط بخش فعال */
        .page-section { display: none !important; }
        .page-section.active { display: block !important; }
        
        /* اگر مودال باز است، فقط مودال چاپ شود */
        .modal-overlay.active {
            position: absolute; top: 0; left: 0; width: 100%; height: auto;
            background: #fff !important; z-index: 99999;
        }
        .modal-overlay.active .lux-modal {
            transform: none !important; width: 100% !important; max-width: 100% !important;
            border: none !important;
        }
    }
`;
document.head.appendChild(printStyle);

// 2. کلیدهای میانبر کیبورد (Keyboard Shortcuts)
document.addEventListener('keydown', function(e) {
    // بستن مودال‌ها با دکمه ESC
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => {
            m.classList.remove('active');
        });
    }

    // اگر کاربر در حال تایپ در اینپوت است، میانبر اجرا نشود
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    // F2: رفتن سریع به صندوق فروش
    if (e.key === 'F2') {
        e.preventDefault();
        navigateTo('pos');
        showToast('کلید میانبر: صندوق فروش', 'info');
    }

    // F4: باز کردن فرم ثبت نوبت
    if (e.key === 'F4') {
        e.preventDefault();
        openModal('modalAppointment');
    }

    // F8: رفتن به حسابداری
    if (e.key === 'F8') {
        e.preventDefault();
        navigateTo('accounting');
    }
});

// 3. بستن منو در موبایل با کلیک بیرون
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.fa-bars');
    
    // اگر منو باز است و کاربر بیرون آن کلیک کرد
    if(sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== toggleBtn) {
        sidebar.classList.remove('open');
    }
});

// 4. اعتبارسنجی ورودی‌ها (قرمز شدن کادرهای خالی)
document.addEventListener('focusout', function(e) {
    if(e.target.classList.contains('lux-input') && e.target.hasAttribute('required')) {
        if(!e.target.value) {
            e.target.style.borderColor = 'var(--danger)';
        } else {
            e.target.style.borderColor = 'rgba(212, 175, 55, 0.3)';
        }
    }
});
function consumeProduct(id) {
    const item = db.inventory.find(i => i.id == id);
    if (!item) return;

    const qtyStr = prompt(`مصرف داخلی "${item.name}"\n\nتعداد مصرفی را وارد کنید:`, "1");
    if (!qtyStr) return;
    
    const qty = parseInt(qtyStr);
    if (isNaN(qty) || qty <= 0) return showToast('تعداد اشتباه است', 'error');
    if (qty > item.stock) return showToast('موجودی کافی نیست', 'error');

    item.stock -= qty;
    const totalCost = item.buyPrice * qty;

    db.transactions.push({
        id: generateId(), date: Date.now(), type: 'expense',
        category: 'مصرف مواد (Backbar)',
        desc: `مصرف داخلی ${qty} عدد ${item.name}`,
        amount: totalCost, user: db.settings.auth.user
    });

    saveData();
    renderInventory();
    renderDashboard();
    showToast('ثبت شد', 'success');
}
</script>
</body>
</html>
