<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="dark">
<head>
<meta charset="utf-8">
<title>System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4A0410">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<script src="xlsx.full.min.js"></script>
<script src="crypto-js.min.js"></script>
<style>
:root {
    --bg-body: #003035;
    --bg-sidebar: #002225;
    --bg-card: linear-gradient(145deg, #004d4d, #003333);
    --bg-input: rgba(0, 0, 0, 0.3);
    --gold-primary: #d4af37;
    --gold-hover: #f9d877;
    --gold-shadow: rgba(212, 175, 55, 0.5);
    --gold-border: rgba(212, 175, 55, 0.7);
    --gold-faint: rgba(212, 175, 55, 0.2);
    --text-main: #e0f2f1;
    --text-muted: #d4af37;
    --btn-bg: linear-gradient(145deg, #005252, #003d3d);
    --success: #00e676; 
    --danger: #ff5252;
    --radius: 12px;
}
[data-theme="light"] {
    --bg-body: #f8f9fa;
    --bg-sidebar: #ffffff;
    --bg-card: #ffffff;
    --bg-input: #f1f3f5;
    --gold-primary: #b8860b; 
    --gold-hover: #d4af37;
    --gold-shadow: rgba(184, 134, 11, 0.15);
    --gold-border: rgba(184, 134, 11, 0.3);
    --gold-faint: rgba(184, 134, 11, 0.08);
    --text-main: #1f2937;
    --text-muted: #856404;
    --btn-bg: linear-gradient(145deg, #ffffff, #f3f4f6);
    --success: #059669; 
    --danger: #dc2626;
    --radius: 12px;
}
input:focus, select:focus, button:focus, .nav-btn:focus, textarea:focus, .fx-box:focus-within {
    outline: 3px solid var(--success) !important;
    box-shadow: 0 0 20px rgba(0, 230, 118, 0.6) !important;
    border-color: var(--success) !important;
    z-index: 100;
    transform: scale(1.01);
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazirmatn', 'Segoe UI', 'Tahoma', 'Arial', sans-serif !important; transition: background 0.3s ease, color 0.2s; }
body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
html[dir="ltr"] body { direction: ltr; }
html[dir="rtl"] body { direction: rtl; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-sidebar); }
html[dir="rtl"] ::-webkit-scrollbar-track { border-left: 1px solid var(--gold-border); }
html[dir="ltr"] ::-webkit-scrollbar-track { border-right: 1px solid var(--gold-border); }
::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 4px; border: 1px solid var(--bg-body); }
#loginPage { 
    position: fixed; top: 0; right: 0; width: 100%; height: 100%; 
    background-color: #001a1c;
    background-image: radial-gradient(var(--gold-border) 1px, transparent 1px);
    background-size: 30px 30px;
    z-index: 9999; 
    display: flex; align-items: center; justify-content: center; 
}
.login-box { 
    background: linear-gradient(180deg, rgba(0,30,30,0.95), rgba(0,15,15,0.98));
    padding: 60px 40px; 
    border-radius: 15px; 
    width: 100%; max-width: 420px; 
    text-align: center; 
    border: 4px double var(--gold-primary); 
    box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px var(--gold-shadow);
    position: relative;
}
.login-box::before {
    content: "โ"; position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
    font-size: 40px; color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-shadow);
    background: #001a1c; padding: 0 10px; border-radius: 50%;
}
.login-header-text { color: var(--gold-primary); text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-bottom: 5px; font-weight: 900; letter-spacing: -1px; font-size: 28px; }
.login-sub-text { color: var(--gold-hover); margin-bottom: 30px; font-size: 13px; border-bottom: 1px solid var(--gold-border); display: inline-block; padding-bottom: 5px; font-weight: 300; }
.login-input { background: rgba(0,0,0,0.4) !important; border: 1px solid var(--gold-border) !important; color: var(--gold-primary) !important; text-align: center; border-radius: 50px !important; margin-bottom: 15px; transition: 0.3s; font-size: 16px; font-weight: bold; }
.login-input:focus { box-shadow: 0 0 15px var(--gold-shadow) !important; border-color: var(--gold-hover) !important; }
#loadingMsg { color: var(--gold-primary); margin-top: 20px; font-size: 14px; display: none; }
.lang-select-container { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
.lang-btn { background: transparent; border: 1px solid var(--gold-border); color: var(--gold-primary); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 12px; opacity: 0.6; }
.lang-btn.active { background: var(--gold-primary); color: #000; opacity: 1; font-weight: bold; }
#mainApp { display: flex; width: 100%; height: 100%; display: none; }
.sidebar { width: 280px; background: var(--bg-sidebar); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.05); z-index: 10; }
html[dir="rtl"] .sidebar { border-left: 1px solid var(--gold-border); }
html[dir="ltr"] .sidebar { border-right: 1px solid var(--gold-border); }
.content { flex-grow: 1; overflow-y: auto; padding: 30px; background-image: radial-gradient(circle at 10% 20%, var(--gold-faint) 0%, transparent 20%); }
.page { display: none; animation: fadeIn 0.4s; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.nav-btn { background: transparent; color: var(--text-muted); border: 1px solid transparent; padding: 15px; width: 100%; cursor: pointer; border-radius: var(--radius); margin-bottom: 8px; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: 700; }
html[dir="rtl"] .nav-btn { text-align: right; }
html[dir="ltr"] .nav-btn { text-align: left; }
.nav-btn:hover { color: var(--gold-primary); background: var(--gold-faint); transform: translateX(5px); border: 1px solid var(--gold-border); }
html[dir="rtl"] .nav-btn:hover { transform: translateX(-5px); }
.nav-btn.active { background: linear-gradient(90deg, var(--gold-faint), transparent); color: var(--gold-primary); border: 1px solid var(--gold-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
html[dir="rtl"] .nav-btn.active { border-right: 4px solid var(--gold-primary); }
html[dir="ltr"] .nav-btn.active { border-left: 4px solid var(--gold-primary); }
.card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid var(--gold-border); position: relative; overflow: hidden; }
.card-header { font-size: 20px; font-weight: 900; margin-bottom: 20px; color: var(--gold-primary); border-bottom: 1px solid var(--gold-border); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; letter-spacing: -0.5px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.input, select.input { width: 100%; padding: 10px 12px; border: 1px solid var(--gold-border); border-radius: var(--radius); margin-bottom: 10px; background: var(--bg-input); color: var(--text-main); outline: none; font-size: 14px; font-weight: 500; }
.input:focus { border-color: var(--gold-primary); box-shadow: 0 0 10px var(--gold-shadow); }
.label { font-size: 13px; color: var(--gold-primary); margin-bottom: 4px; display: block; font-weight: 700; }
.btn { padding: 10px 20px; border-radius: 50px; border: none; cursor: pointer; font-size: 14px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: 5px; border: 1px solid transparent; }
.btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
.btn-gold { background: linear-gradient(135deg, #b8860b 0%, #d4af37 50%, #b8860b 100%); color: #fff; box-shadow: 0 4px 15px rgba(184, 134, 11, 0.3); border: none; }
.btn-blue { background: linear-gradient(45deg, #1565c0, #42a5f5); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-green { background: linear-gradient(45deg, #059669, #34d399); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-red { background: linear-gradient(45deg, #b91c1c, #f87171); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-purple { background: linear-gradient(45deg, #6d28d9, #a78bfa); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-indigo { background: linear-gradient(45deg, #3730a3, #818cf8); color: white; border: 1px solid rgba(255,255,255,0.1); }
.btn-outline { background: transparent; border: 1px solid var(--gold-primary); color: var(--gold-primary); }
.btn-outline:hover { background: var(--gold-primary); color: #fff; }
.btn-sm { padding: 4px 8px !important; font-size: 11px !important; border-radius: 8px !important; min-width: auto !important; }
.fx-container { display: flex; flex-direction: column; gap: 15px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--gold-border); margin-top: 15px; }
.fx-box { flex: 1; background: var(--bg-input); padding: 15px; border-radius: 12px; border: 1px solid var(--gold-border); position: relative; transition: 0.3s; }
.fx-box:focus-within { border-color: var(--gold-primary); box-shadow: 0 0 15px var(--gold-shadow); }
.fx-box-label { font-size: 11px; color: var(--gold-primary); font-weight: 700; margin-bottom: 5px; display: block; text-transform: uppercase; }
.fx-input-group { display: flex; align-items: center; justify-content: space-between; }
.fx-amount { font-size: 24px; font-weight: 900; background: transparent; border: none; color: var(--text-main); width: 100%; outline: none; font-family: 'Arial', sans-serif !important; direction: ltr; text-align: left; }
.fx-currency { font-weight: 900; color: var(--gold-primary); font-size: 16px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; border: none; cursor: pointer; outline: none; }
.fx-rate-bar { display: flex; align-items: center; justify-content: center; gap: 10px; margin: -10px 0; z-index: 2; position: relative; }
.fx-rate-badge { background: var(--bg-card); border: 1px solid var(--gold-primary); padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; color: var(--gold-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; gap: 5px; align-items: center; cursor: pointer; transition: 0.2s; }
.fx-rate-badge:hover { transform: scale(1.05); background: var(--gold-faint); }
.fx-info { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-top: 5px; padding: 0 5px; }
.fx-type-switch { display: flex; background: rgba(0,0,0,0.2); border-radius: 50px; padding: 4px; border: 1px solid var(--gold-border); margin-bottom: 15px; }
.fx-type-opt { flex: 1; text-align: center; padding: 8px; border-radius: 40px; cursor: pointer; font-size: 13px; font-weight: bold; color: var(--text-muted); transition: 0.3s; }
.fx-type-opt.active.sell { background: var(--danger); color: white; box-shadow: 0 4px 10px rgba(255,82,82,0.3); }
.fx-type-opt.active.buy { background: var(--success); color: white; box-shadow: 0 4px 10px rgba(0,230,118,0.3); }
table { width: 100%; border-collapse: separate; border-spacing: 0 0; font-size: 14px; border: 1px solid var(--gold-border); border-radius: 8px; overflow: hidden; }
th { background: var(--gold-faint); color: var(--gold-primary); padding: 12px; border-bottom: 1px solid var(--gold-border); font-weight: 800; }
html[dir="rtl"] th { text-align: right; border-left: 1px solid var(--gold-border); }
html[dir="ltr"] th { text-align: left; border-right: 1px solid var(--gold-border); }
td { padding: 12px; background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--gold-border); color: var(--text-main); font-weight: 500; }
html[dir="rtl"] td { border-left: 1px solid var(--gold-border); }
html[dir="ltr"] td { border-right: 1px solid var(--gold-border); }
tr:last-child td { border-bottom: none; }
html[dir="rtl"] th:last-child, html[dir="rtl"] td:last-child { border-left: none; }
html[dir="ltr"] th:last-child, html[dir="ltr"] td:last-child { border-right: none; }
.badge { padding: 4px 8px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid var(--gold-border); }
.text-green { color: var(--success) !important; font-weight: bold; dir: ltr; }
.text-red { color: var(--danger) !important; font-weight: bold; dir: ltr; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
.modal-content { position: relative; background: var(--bg-body); border: 1px solid var(--gold-primary); padding: 30px; border-radius: 20px; width: 90%; max-width: 650px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; color: var(--text-main); }
.close-icon { position: absolute; top: 20px; font-size: 24px; font-weight: bold; color: var(--danger); cursor: pointer; transition: transform 0.2s; z-index: 10; }
html[dir="rtl"] .close-icon { left: 20px; }
html[dir="ltr"] .close-icon { right: 20px; }
.close-icon:hover { transform: scale(1.2); }
.account-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--gold-border); transition: 0.2s; cursor: pointer; background: rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 5px; }
.account-list-item:hover { background: var(--gold-faint); transform: translateX(5px); }
html[dir="rtl"] .account-list-item:hover { transform: translateX(-5px); }
.search-sticky { position: sticky; top: 0; background: var(--bg-body); z-index: 5; padding-bottom: 10px; border-bottom: 2px solid var(--gold-primary); margin-bottom: 15px; }
.stat-box { background: linear-gradient(to bottom right, var(--gold-faint), rgba(0,0,0,0.02)); padding: 15px; border-radius: 20px; border: 1px solid var(--gold-border); text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
.stat-val { font-size: 26px; font-weight: 900; margin-top: 8px; direction: ltr; color: var(--gold-primary); letter-spacing: 0.5px; }
.profit-section { background: linear-gradient(90deg, #0f2027, #203a43, #2c5364); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; display: flex; justify-content: space-around; border: 2px solid var(--gold-primary); box-shadow: 0 0 15px rgba(0,0,0,0.2); }
.theme-switch { position: absolute; top: 20px; cursor: pointer; font-size: 22px; background: var(--bg-card); padding: 12px; border-radius: 50%; border: 1px solid var(--gold-border); color: var(--gold-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; transition: 0.3s; }
html[dir="rtl"] .theme-switch { left: 20px; }
html[dir="ltr"] .theme-switch { right: 20px; }
.theme-switch:hover { transform: rotate(15deg) scale(1.1); background: var(--gold-faint); }
.radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
.radio-label { flex: 1; text-align: center; padding: 10px; border: 1px solid var(--gold-primary); border-radius: var(--radius); cursor: pointer; opacity: 0.7; color: var(--gold-primary); font-weight: bold; }
.radio-label.active { background: var(--gold-primary); color: #fff; opacity: 1; font-weight: 900; box-shadow: 0 0 15px var(--gold-shadow); }
#printHeaderGlobal { display: none; }
@media print {
    body { background: white !important; color: black !important; display: block !important; height: auto !important; }
    .sidebar, .no-print, .theme-switch, .header-bar .btn, #loginPage { display: none !important; }
    .content { padding: 0 !important; margin: 0 !important; background: none !important; width: 100% !important; overflow: visible !important; }
    .card { border: none !important; box-shadow: none !important; padding: 0 !important; background: white !important; color: black !important; margin-bottom: 20px !important; }
    .card-header { color: black !important; border-bottom: 2px solid black !important; }
    table { width: 100% !important; border-collapse: collapse !important; font-size: 10pt !important; border: 1px solid #000 !important; font-family: 'Vazirmatn', sans-serif !important; }
    th, td { border: 1px solid #000 !important; padding: 5px !important; color: black !important; background: transparent !important; }
    html[dir="rtl"] th, html[dir="rtl"] td { text-align: right !important; }
    html[dir="ltr"] th, html[dir="ltr"] td { text-align: left !important; }
    .stat-box { border: 1px solid #000 !important; color: black !important; page-break-inside: avoid; }
    .stat-val { color: black !important; text-shadow: none !important; }
    .input, input, select { border: none !important; background: transparent !important; color: black !important; padding: 0 !important; margin: 0 !important; height: auto !important; }
    ::-webkit-scrollbar { display: none; }
    #printHeaderGlobal { display: block !important; margin-bottom: 20px; }
}
/* --- ุดุฑูุน ฺฉุฏูุง ุฌุฏุฏ ููู ฺฉุดู --- */
.group-header {
    justify-content: space-between !important;
    background: rgba(0,0,0,0.2);
    border: 1px dashed var(--gold-border);
}
.group-header:hover {
    background: var(--gold-faint);
}
.submenu {
    display: none;
    flex-direction: column;
    padding-right: 15px;
    border-right: 2px solid var(--gold-primary);
    margin-right: 10px;
    margin-bottom: 10px;
    background: rgba(0,0,0,0.1);
    border-radius: 8px;
    animation: slideDown 0.3s ease;
}
html[dir="ltr"] .submenu {
    padding-right: 0;
    padding-left: 15px;
    border-right: none;
    border-left: 2px solid var(--gold-primary);
    margin-right: 0;
    margin-left: 10px;
}
.submenu.open {
    display: flex;
}
.arrow-icon {
    font-size: 10px;
    transition: 0.3s;
}
.submenu.open + .group-header .arrow-icon {
    transform: rotate(180deg);
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ุดุฑูุน ฺฉุฏูุง ุฌุฏุฏ ุชูุธูุงุช --- */
#modalSettings .modal-content {
    width: 95% !important;
    height: 90% !important;
    max-width: 1200px !important;
    max-height: 90vh !important;
    padding: 0 !important;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-body);
}
.settings-container { display: flex; flex: 1; height: 100%; overflow: hidden; }
.settings-sidebar { width: 260px; background: rgba(0,0,0,0.15); border-left: 1px solid var(--gold-border); display: flex; flex-direction: column; padding: 20px 10px; overflow-y: auto; }
.settings-menu-btn { text-align: right; padding: 15px 20px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: var(--text-muted); transition: 0.3s; border: 1px solid transparent; display: flex; align-items: center; gap: 10px; }
.settings-menu-btn:hover { background: var(--gold-faint); color: var(--gold-primary); }
.settings-menu-btn.active { background: var(--gold-primary); color: #000; box-shadow: 0 5px 15px var(--gold-shadow); }
.settings-content-area { flex: 1; padding: 40px; overflow-y: auto; background: rgba(0,0,0,0.05); }
.settings-tab { display: none; animation: fadeIn 0.4s; }
.settings-tab.active { display: block; }
.setting-card { background: var(--bg-card); border: 1px solid var(--gold-border); border-radius: 16px; padding: 30px; max-width: 800px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.setting-header-large { font-size: 24px; font-weight: 900; color: var(--gold-primary); margin-bottom: 10px; border-bottom: 2px solid var(--gold-border); padding-bottom: 15px; }
.city-detail-group { background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px dashed var(--gold-border); }
@media print {
    .thermal-receipt {
        width: 80mm !important;
        font-size: 10pt !important;
        padding: 5px !important;
        margin: 0 auto !important;
        border: none !important;
        font-family: 'Tahoma', sans-serif !important;
    }
    .a4-receipt {
        width: 210mm !important;
        height: 290mm !important;
        padding: 20mm !important;
        border: none !important;
        position: relative;
    }
    .id-copy-area {
        margin-top: 50px;
        height: 300px;
        border: 2px dashed #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-weight: bold;
        background: #fdfdfd;
    }
    .print-logo-img {
        max-width: 150px;
        max-height: 80px;
        display: block;
        margin: 0 auto 10px auto;
    }
}
@media screen and (max-width: 768px) {
    body { flex-direction: column; overflow-y: auto !important; overflow-x: hidden; }
    .sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100vh; z-index: 9999; transition: right 0.3s ease; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
    .sidebar.mobile-active { right: 0; }
    .content { width: 100%; padding: 15px; padding-top: 70px; overflow: visible; }
    #mobileMenuBtn { display: block !important; }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr !important; gap: 15px; }
    .table-container { overflow-x: auto; white-space: nowrap; }
    .card-header { font-size: 16px; }
    .nav-btn { padding: 12px; font-size: 14px; }
    .header-bar h2 { font-size: 20px !important; }
    .modal-content { width: 95% !important; max-height: 95vh !important; padding: 15px !important; }
    .profit-section { flex-direction: column; gap: 15px; }
    .profit-section > div { border-right: none !important; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin: 0 !important; }
}
</style>
</head>
<body>
<div id="mobileOverlay" onclick="toggleMobileMenu()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9998; backdrop-filter:blur(3px);"></div>
<button id="mobileMenuBtn" onclick="toggleMobileMenu()" style="display:none; position:fixed; top:15px; right:15px; z-index:10000; background:var(--gold-primary); border:none; border-radius:8px; padding:10px; box-shadow:0 4px 10px rgba(0,0,0,0.5); color:#000; font-size:24px; cursor:pointer;">โฐ</button>
<div id="printHeaderGlobal"></div>
<div class="theme-switch no-print" onclick="toggleTheme()" title="Theme/ุชู">๐</div>

<div id="loginPage">
    <div class="login-box">
        <h2 class="login-header-text" data-i18n="app_title">ุตุฑุงู ูุฑุงุชโูุง</h2>
        <span class="login-sub-text" data-i18n="company_subtitle">ุดุฑฺฉุช ุตุฑุงู ู ุฎุฏูุงุช ูพูู ูุฑุงุชูุง</span>
        <br><br>
        <input type="text" id="loginUser" class="input login-input" placeholder="Username / ูุงู ฺฉุงุฑุจุฑ" autocomplete="off" autofocus>
        <input type="password" id="loginPass" class="input login-input" placeholder="Password / ุฑูุฒ ุนุจูุฑ">
        <button class="btn btn-gold" style="width:100%; padding: 15px; font-size: 16px; margin-top: 10px;" onclick="auth()" data-i18n="login_btn">ูุฑูุฏ ุจู ุณุณุชู (Enter)</button>
        
        <div class="lang-select-container">
            <button class="lang-btn active" onclick="setLanguage('fa')" id="btn-lang-fa">ูุงุฑุณ</button>
            <button class="lang-btn" onclick="setLanguage('en')" id="btn-lang-en">English</button>
            <button class="lang-btn" onclick="setLanguage('tr')" id="btn-lang-tr">Tรผrkรงe</button>
            <button class="lang-btn" onclick="setLanguage('ar')" id="btn-lang-ar">ุงูุนุฑุจูุฉ</button>
        </div>

        <p id="loginErr" style="color:var(--danger); margin-top:15px; display:none; font-size:12px" data-i18n="login_error">ุงุทูุงุนุงุช ุงุดุชุจุงู ุงุณุช</p>
        <div id="loadingMsg" data-i18n="loading_db">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงฺฏุงู ุฏุงุฏู ุงููุช...</div>
    </div>
</div>
<div id="mainApp">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid var(--gold-border); padding-bottom:15px">
            <h2 style="color:var(--gold-primary); text-shadow: 0 0 10px var(--gold-shadow); font-weight: 900; font-size: 22px;" data-i18n="app_title">ุดุฑฺฉุช ูุฑุงุชโูุง</h2>
            <div style="font-size:12px; margin-top:5px; color: var(--gold-primary); opacity:0.8; font-weight:500;" id="sidebarUserInfo">User</div>
        </div>
        
        <button class="nav-btn active admin-only-btn" onclick="go('dashboard')" id="nav-dashboard">
            <span data-i18n="nav_dashboard">๐ ุฏุงุดุจูุฑุฏ (F1)</span>
        </button>
        
        <button class="nav-btn group-header" onclick="toggleGroup('grp-ops')">
            <span>๐ ุนููุงุช ูพูู</span>
            <span class="arrow-icon">โผ</span>
        </button>
        <div id="grp-ops" class="submenu">
            <button class="nav-btn" onclick="go('hawala')" id="nav-hawala">
                <span data-i18n="nav_hawala">โ๏ธ ุญูุงููโุฌุงุช (F2)</span>
            </button>
            <button class="nav-btn" onclick="go('ttPage')" id="nav-tt">
                <span data-i18n="nav_tt">๐ ุงูุชูุงู ุงุฑุฒ (TT) (F6)</span>
            </button>
            <button class="nav-btn" onclick="go('exchange')" id="nav-exchange">
                <span data-i18n="nav_exchange">๐ฑ ุฎุฑุฏ ู ูุฑูุด (F4)</span>
            </button>
            <button class="nav-btn" onclick="go('cryptoFX')" id="nav-crypto">
                <span data-i18n="nav_crypto">๐ช ุงุฑุฒ ุฏุฌุชุงู</span>
            </button>
        </div>

        <button class="nav-btn group-header" onclick="toggleGroup('grp-people')">
            <span>๐ฅ ูุฏุฑุช ุงุดุฎุงุต</span>
            <span class="arrow-icon">โผ</span>
        </button>
        <div id="grp-people" class="submenu">
            <button class="nav-btn" onclick="go('accounts')" id="nav-accounts">
                <span data-i18n="nav_accounts">๐ฅ ุญุณุงุจ ูุดุชุฑุงู (F3)</span>
            </button>
            <button class="nav-btn admin-only-btn" onclick="go('employees')" id="nav-employees">
                <span>๐ ฺฉุงุฑููุฏุงู</span>
            </button>
        </div>

        <button class="nav-btn group-header admin-only-btn" onclick="toggleGroup('grp-reports')">
            <span>๐ ฺฏุฒุงุฑุด ู ุขูุงูุฒ</span>
            <span class="arrow-icon">โผ</span>
        </button>
        <div id="grp-reports" class="submenu">
            <button class="nav-btn admin-only-btn" onclick="go('analysis')" id="nav-analysis">
                <span data-i18n="nav_analysis">๐งฎ ุขูุงูุฒ ุณุฑูุงู (F7)</span>
            </button>
<button class="nav-btn admin-only-btn" onclick="go('commissions')" id="nav-commissions">
                <span>๐ฐ ุญุณุงุจ ฺฉูุดูโูุง</span>
            </button>
            <button class="nav-btn admin-only-btn" onclick="go('reports')" id="nav-reports">
                <span data-i18n="nav_reports">๐ ูุงฺฏ ุณุณุชู</span>
            </button>
        </div>
        
        <div style="margin-top:auto; border-top:1px solid var(--gold-border); padding-top:10px">
            <button class="nav-btn" onclick="openSettings()">
                <span data-i18n="nav_settings">โ๏ธ ุชูุธูุงุช</span>
            </button>
            <button class="nav-btn" style="color:var(--danger); border-color:rgba(255, 82, 82, 0.3)" onclick="logout()">
                <span data-i18n="nav_logout">๐ช ุฎุฑูุฌ</span>
            </button>
        </div>
    </div>
<div class="content">
        <div class="header-bar" style="display:flex; justify-content:space-between; margin-bottom:30px; align-items: center;">
            <h2 id="pageTitle" style="border-right:5px solid var(--gold-primary); padding-right:20px; color:var(--gold-primary); font-size: 30px; font-weight: 900;" data-i18n="nav_dashboard">ุฏุงุดุจูุฑุฏ</h2>
            <div style="font-size:14px; background:var(--bg-card); padding:10px 20px; border-radius:50px; border:1px solid var(--gold-primary); color: var(--gold-primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-weight: bold; margin-left: 60px;">
                ๐ <span id="displayDate"></span>
            </div>
        </div>

        <div id="dashboard" class="page active admin-only-view">
            <div class="profit-section">
                <div class="profit-details" style="min-width: 30%; text-align: center;">
                    <div style="font-size:13px; opacity:0.8; border-bottom: 1px solid var(--gold-border); padding-bottom:10px; margin-bottom:10px; color: var(--gold-primary);" data-i18n="lbl_initial_capital">ุณุฑูุงู ุงููู ุซุจุช ุดุฏู</div>
                    <div id="dispInitialCap" style="font-size:20px; font-weight:800; direction:ltr; display:flex; flex-wrap:wrap; justify-content:center; gap: 15px;">0</div>
                </div>
                
                <div style="border-right:1px solid var(--gold-border); margin:0 15px"></div>

                <div class="profit-details" style="min-width: 30%; text-align: center;">
                    <div style="font-size:13px; opacity:0.8; border-bottom: 1px solid var(--gold-border); padding-bottom:10px; margin-bottom:10px; color: var(--text-main);">ุณูุฏ ุงูุฑูุฒ (Today)</div>
                    <div id="dispDailyProfit" style="font-size:20px; font-weight:900; color:var(--success)">0</div>
                </div>

                <div style="border-right:1px solid var(--gold-border); margin:0 15px"></div>

                <div class="profit-details" style="min-width: 30%; text-align: center;">
                    <div style="font-size:13px; opacity:0.8; border-bottom: 1px solid var(--gold-border); padding-bottom:10px; margin-bottom:10px; color: var(--gold-primary);" data-i18n="lbl_profit_loss">ุณูุฏ ฺฉู (Total/Yearly)</div>
                    <div id="dispProfit" style="font-size:20px; font-weight:900; color:var(--success)">0</div>
                </div>
            </div>

            <div style="text-align: right; color: var(--gold-primary); margin-bottom: 15px; font-size: 18px; font-weight: 800; border-bottom: 2px solid var(--gold-faint); display:inline-block; padding-bottom:5px;" data-i18n="lbl_cash_balance">ููุฌูุฏ ูุฒฺฉ ุตูุฏูู (ุฎุฒุงูู)</div>
            <div class="grid-4" id="cashStats" style="margin-bottom: 30px;"></div>

            <div style="text-align: right; color: #42a5f5; margin-bottom: 15px; font-size: 18px; font-weight: 800; border-bottom: 2px solid rgba(66, 165, 245, 0.3); display:inline-block; padding-bottom:5px;" data-i18n="lbl_crypto_assets">ุฏุงุฑุงโูุง ุฏุฌุชุงู (Crypto Assets)</div>
            <div class="grid-4" id="cryptoStats" style="margin-bottom: 30px;"></div>
<div class="card">
                <div class="card-header">
                    <span data-i18n="lbl_city_balance">ุจุงูุงูุณ ฺฉุชุงุจ ุดูุฑูุง (ุจุฏูฺฉุงุฑ/ุจุณุชุงูฺฉุงุฑ ููุงูุฏฺฏุงู)</span>
                    <button class="btn btn-outline" style="font-size:11px" onclick="renderDashboard()">
                        <span data-i18n="btn_refresh">๐ ุจุฑูุฒุฑุณุงู</span>
                    </button>
                </div>
                <div class="grid-3" id="cityStats"></div>
                <p style="font-size:11px; color:var(--text-muted); margin-top:15px; border-top: 1px dashed var(--gold-primary); padding-top: 10px;" data-i18n="msg_city_balance_hint">* ุงุนุฏุงุฏ ูุซุจุช (ุณุจุฒ): ููุงูุฏู ุจู ูุง ุจุฏูฺฉุงุฑ ุงุณุช. ุงุนุฏุงุฏ ููู (ูุฑูุฒ): ูุง ุจู ููุงูุฏู ุจุฏูฺฉุงุฑู.</p>
            </div>
            
            <div class="card">
                <div class="card-header"><span data-i18n="lbl_total_commissions">ูุฌููุน ฺฉูุดูโูุง ุญูุงูู (ุณูุฏ ุฎุงูุต)</span></div>
                <div class="grid-4" id="cityCommissions"></div>
            </div>
        </div>
<div id="hawala" class="page">
            <div class="card">
                <div class="grid-2" style="align-items:center">
                    <h3 style="color:var(--gold-primary); font-weight:800" data-i18n="header_hawala_manage">ูุฏุฑุช ุญูุงููโุฌุงุช</h3>
                    <div style="text-align:left">
                        <button class="btn btn-gold" onclick="openModal('modalNewHawala')" id="btnNewHawala">
                            <span data-i18n="btn_new_hawala">โ ุซุจุช ุญูุงูู ุฌุฏุฏ (F9)</span>
                        </button>
                    </div>
                </div>
                <div class="grid-4" style="margin-top:25px">
                    <div>
                        <label class="label" data-i18n="lbl_filter_city">ููุชุฑ ุดูุฑ</label>
                        <select id="filterHCity" class="input" onchange="filterHawala()"></select>
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_type">ููุน</label>
                        <select id="filterHType" class="input" onchange="filterHawala()">
                            <option value="All" data-i18n="opt_all">ููู</option>
                            <option value="Outgoing" data-i18n="opt_outgoing">ุงุฑุณุงู (Out)</option>
                            <option value="Incoming" data-i18n="opt_incoming">ุฏุฑุงูุช (In)</option>
                        </select>
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_status">ูุถุนุช</label>
                        <select id="filterHStatus" class="input" onchange="filterHawala()">
                            <option value="All" data-i18n="opt_all">ููู</option>
                            <option value="Pending" data-i18n="opt_pending">ุฏุฑ ุงูุชุธุงุฑ ุงุฌุฑุง</option>
                            <option value="Done" data-i18n="opt_done">ุงุฌุฑุง/ุชุณูู ุดุฏู</option>
                        </select>
                    </div>
                    <div style="padding-top:25px; display:flex; gap:10px">
                        <button class="btn btn-outline" style="font-size:12px; flex:1" onclick="exportHawalaToExcel()">
                            <span data-i18n="btn_excel">๐ ุงฺฉุณู ุนุงู</span>
                        </button>
                        <button class="btn btn-outline" style="font-size:12px; flex:1" onclick="printHawalaList()">
                            <span data-i18n="btn_print_book">๐จ ูพุฑูุช ฺฉุชุงุจ</span>
                        </button>
                    </div>
                </div>
            </div>
<div class="card table-container" style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="th_hawala_no">ููุจุฑ ุญูุงูู</th>
                            <th data-i18n="th_type">ููุน</th>
                            <th data-i18n="th_city_book">ุดูุฑ / ฺฉุชุงุจ</th>
                            <th data-i18n="th_amount">ูุจูุบ</th>
                            <th data-i18n="th_commission">ฺฉูุดู</th>
                            <th data-i18n="th_reg_date">ุชุงุฑุฎ ุซุจุช</th>
                            <th data-i18n="th_exec_date">ุชุงุฑุฎ ุงุฌุฑุง</th>
                            <th data-i18n="th_status">ูุถุนุช</th>
                            <th style="min-width: 200px;" data-i18n="th_ops">ุนููุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="hawalaBody"></tbody>
                </table>
            </div>
        </div>
<div id="accounts" class="page">
            <div class="card">
                <div class="card-header" data-i18n="header_accounts_manage">ูุฏุฑุช ุญุณุงุจ ูุดุชุฑุงู</div>
                <div class="grid-2">
                    <div>
                        <label class="label" data-i18n="lbl_search_customer">ุฌุณุชุฌู ูุดุชุฑ</label>
                        <select id="selCustomer" class="input" onchange="loadCustomerLedger()"></select>
                    </div>
                    <div style="text-align:left; padding-top:25px; display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end;">
                        <button class="btn btn-green" onclick="openModal('modalNewCust')" id="btnNewCust">
                            <span data-i18n="btn_new_customer">โ ูุดุชุฑ ุฌุฏุฏ (F9)</span>
                        </button>
                        <button class="btn btn-blue" onclick="openModal('modalTx')">
                            <span data-i18n="btn_deposit_withdraw">๐ฐ ูุงุฑุฒ/ุจุฑุฏุงุดุช</span>
                        </button>
                        <button class="btn btn-indigo" onclick="openModalClientTransfer()">
                            <span data-i18n="btn_transfer">๐ ุงูุชูุงู ุญุณุงุจ</span>
                        </button>
                        <button class="btn btn-gold admin-only-btn" onclick="openAllAccountsModal()">
                            <span data-i18n="btn_all_accounts">๐ ูุถุนุช ฺฉู ุญุณุงุจโูุง</span>
                        </button>
                    </div>
                </div>
            </div>
<div class="card" id="ledgerCard" style="display:none">
                <div class="card-header">
                    <span>
                        <span data-i18n="lbl_statement">ุตูุฑุชโุญุณุงุจ:</span> 
                        <b id="ledgerName" style="color:var(--text-main); text-shadow: 0 0 10px var(--gold-faint);"></b> 
                        <span id="ledgerPhone" style="font-size:13px; color:var(--text-muted); margin-right:10px; font-weight:400;"></span>
                    </span>
                    <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                        <span id="ledgerFinalSum" dir="ltr" style="font-size:15px; margin-left:10px; font-weight: 900;"></span>
                        <button class="btn btn-outline btn-sm" onclick="openEditCustomerModal()">
                            <span data-i18n="btn_edit">โ๏ธ ูุฑุงุด</span>
                        </button>
                        <button class="btn btn-red btn-sm" onclick="deleteCustomer()">
                            <span data-i18n="btn_delete">๐ ุญุฐู</span>
                        </button>
                        <button class="btn btn-outline btn-sm no-print" onclick="exportLedgerToExcel()">
                            <span data-i18n="btn_excel">๐ ุงฺฉุณู</span>
                        </button>
                        <button class="btn btn-outline btn-sm no-print" onclick="printLedger()">
                            <span data-i18n="btn_print">๐จ ูพุฑูุช</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="th_date">ุชุงุฑุฎ</th>
                                <th data-i18n="th_desc">ุดุฑุญ</th>
                                <th data-i18n="th_currency">ุงุฑุฒ</th>
                                <th data-i18n="th_debit">ุจุฏูฺฉุงุฑ</th>
                                <th data-i18n="th_credit">ุจุณุชุงูฺฉุงุฑ</th>
                                <th data-i18n="th_balance">ูุงูุฏู (ุชุดุฎุต)</th>
                                <th class="no-print" data-i18n="th_ops">ุนููุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="ledgerBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
<div id="ttPage" class="page">
            <div class="card" style="max-width:850px; margin:0 auto">
                <div class="card-header">
                    <span data-i18n="header_tt_app">ุฏุฑุฎูุงุณุช ุญูุงูู ุงุฑุฒ (TT Application)</span>
                </div>
                <div class="radio-group">
                    <div id="ttOptInternal" class="radio-label active" onclick="setTTType('internal')" tabindex="0">
                        <span data-i18n="opt_internal_cust">ูุดุชุฑ ุฏุงุฎู (ุญุณุงุจุฏุงุฑ)</span>
                    </div>
                    <div id="ttOptExternal" class="radio-label" onclick="setTTType('external')" tabindex="0">
                        <span data-i18n="opt_external_cust">ูุดุชุฑ ุฎุงุฑุฌ (ููุฏ)</span>
                    </div>
                </div>
                <div class="grid-2" style="background:rgba(212,175,55,0.05); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid var(--gold-border)">
                    <div id="ttInternalSec">
                         <label class="label" data-i18n="lbl_select_account">ุงูุชุฎุงุจ ุญุณุงุจ ูุดุชุฑ (ุจุฑุฏุงุดุช ุงุฒ ุญุณุงุจ)</label>
                         <select id="ttCustomer" class="input"></select>
                    </div>
                    <div id="ttExternalSec" style="display:none">
                        <label class="label" data-i18n="lbl_payer_name">ูุงู ูุดุชุฑ (ูพุฑุฏุงุฎุช ููุฏ)</label>
                        <input type="text" id="ttExtName" class="input" placeholder="...">
                        <label class="label" style="margin-top:5px" data-i18n="lbl_phone">ุชููู ุชูุงุณ</label>
                        <input type="text" id="ttExtPhone" class="input" placeholder="07...">
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_amount">ูุจูุบ ุญูุงูู</label>
                        <div style="display:flex; gap:5px">
                            <input type="number" id="ttAmt" class="input" placeholder="0.00" oninput="updateTTAutoWords()">
                            <select id="ttCurr" class="input" style="width:100px"></select>
                        </div>
                        <label class="label">Amount in Words (Auto - English)</label>
                        <input type="text" id="ttAmtWords" class="input" placeholder="Amount in letters...">
                    </div>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--gold-primary)">
                <h4 style="color:var(--gold-primary); margin-bottom:15px; font-weight:800;" data-i18n="header_beneficiary">ูุดุฎุตุงุช ุฐููุน (Beneficiary)</h4>
                <div class="grid-2">
                     <div>
                        <label class="label" data-i18n="lbl_ben_name">ูุงู ุฐููุน (ูุงุฑุณ)</label>
                        <input type="text" id="ttBenName" class="input">
                     </div>
                     <div>
                        <label class="label">Beneficiary Name (English)</label>
                        <input type="text" id="ttBenNameEn" class="input" style="text-align:left; direction:ltr" placeholder="Full Name in English">
                     </div>
                </div>
                <div class="grid-2">
                     <div><label class="label">ฺฉุดูุฑ (Country)</label><input type="text" id="ttCountry" class="input"></div>
                     <div><label class="label">ุดูุฑ (City)</label><input type="text" id="ttCityDest" class="input"></div>
                </div>
                <label class="label">ุขุฏุฑุณ (Address)</label><input type="text" id="ttAddress" class="input">
                <div class="grid-2" style="margin-top:10px">
                     <div><label class="label">ุจุงูฺฉ ููุตุฏ (Dest. Bank)</label><input type="text" id="ttDestBank" class="input"></div>
                     <div><label class="label">ุณูุฆูุช ฺฉุฏ (Swift Code)</label><input type="text" id="ttSwift" class="input" style="text-transform:uppercase"></div>
                </div>
                <label class="label">ุดูุงุฑู ุญุณุงุจ / IBAN</label><input type="text" id="ttIban" class="input" style="direction:ltr; text-align:left">
                <div class="grid-2" style="margin-top:10px">
                     <div><label class="label">ุจุงูฺฉ ฺฉุงุฑฺฏุฒุงุฑ (Intermediary Bank)</label><input type="text" id="ttInterBank" class="input"></div>
                     <div><label class="label">ุณูุฆูุช ฺฉุงุฑฺฏุฒุงุฑ (Intermediary Swift)</label><input type="text" id="ttInterSwift" class="input"></div>
                </div>
                <label class="label">ุฑูุฑูุณ (Reference)</label><input type="text" id="ttRef" class="input">
                <label class="label" data-i18n="lbl_desc">ุชูุถุญุงุช ุชฺฉูู</label><input type="text" id="ttDesc" class="input">
                <div style="margin-top:25px; display:flex; gap:10px">
                    <button class="btn btn-purple" style="flex:2; padding:15px" onclick="submitNewTT()">
                        <span data-i18n="btn_submit_tt">ุซุจุช ุฏุฑุฎูุงุณุช ู ุฏุฑุงูุช ูุฌู (F10)</span>
                    </button>
                    <button class="btn btn-outline" style="flex:1" onclick="printCurrentTTForm()">
                        <span data-i18n="btn_print_form">๐จ ฺุงูพ ูุฑู ุฑุณู</span>
                    </button>
                </div>
            </div>
        </div>
<div id="cryptoFX" class="page">
            <div class="card" style="max-width:750px; margin:0 auto">
                <div class="card-header">
                    <span data-i18n="header_crypto_deal">ูุนุงููุงุช ุงุฑุฒ ุฏุฌุชุงู (Crypto)</span>
                    <button class="btn btn-outline" style="font-size:12px;" onclick="printCryptoFx()">
                        <span data-i18n="btn_print_receipt">๐จ ฺุงูพ ุฑุณุฏ</span>
                    </button>
                </div>
                
                <div class="radio-group">
                    <div id="cryptoOptExternal" class="radio-label active" onclick="setCryptoCustType('external')" tabindex="0">
                        <span data-i18n="opt_external_cust">ูุดุชุฑ ุขุฒุงุฏ (ููุฏ)</span>
                    </div>
                    <div id="cryptoOptInternal" class="radio-label" onclick="setCryptoCustType('internal')" tabindex="0">
                        <span data-i18n="opt_internal_cust">ูุดุชุฑ ุญุณุงุจโุฏุงุฑ</span>
                    </div>
                </div>
                <div id="cryptoInternalSec" style="display:none; margin-bottom:15px; padding:10px; border:1px solid var(--gold-border); border-radius:12px;">
                    <label class="label" data-i18n="lbl_select_customer">ุงูุชุฎุงุจ ูุดุชุฑ</label>
                    <select id="cryptoCustomer" class="input" style="margin-bottom:0"></select>
                </div>

                <div class="grid-2">
                    <div style="background:rgba(212,175,55,0.05); padding:15px; border-radius:15px; border:1px solid var(--gold-primary)">
                        <label class="label" style="font-weight:900; color:var(--text-main)" data-i18n="lbl_deal_type">ููุน ูุนุงููู</label>
                        <select id="cryptoTxType" class="input" style="margin-bottom:0">
                            <option value="Buy" data-i18n="opt_buy">ุฎุฑุฏ (ูพุฑุฏุงุฎุช ูพูู)</option>
                            <option value="Sell" data-i18n="opt_sell">ูุฑูุด (ุฏุฑุงูุช ูพูู)</option>
                        </select>
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_desc">ุชูุถุญุงุช</label>
                        <input type="text" id="cryptoDesc" class="input" placeholder="..." style="margin-bottom:0">
                    </div>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--gold-primary)">
                <div class="grid-2">
                    <div>
                        <label class="label" data-i18n="lbl_crypto_name">ูุงู ุงุฑุฒ (USDT)</label>
                        <input type="text" id="cryptoName" class="input" placeholder="USDT, BTC...">
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_volume">ููุฏุงุฑ (Volume)</label>
                        <input type="number" id="cryptoAmt" class="input" placeholder="0.00">
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <label class="label" data-i18n="lbl_payment_curr">ููุน ุงุฑุฒ ูพุฑุฏุงุฎุช/ุฏุฑุงูุช</label>
                        <select class="input" id="cryptoCurr"></select>
                    </div>
                    <div>
                        <label class="label" data-i18n="lbl_total_fiat">ูุจูุบ ฺฉู (Total Fiat)</label>
                        <input type="number" id="fiatAmt" class="input" placeholder="0">
                    </div>
                </div>
                <div style="background:rgba(212,175,55,0.05); padding:15px; border-radius:15px; border:1px solid var(--gold-border); margin-top: 15px;">
                    <label class="label" style="color:var(--text-muted)" data-i18n="lbl_cost_basis">ูุญุงุณุจู ุณูุฏ (ููุท ุจุฑุง ูุฑูุด): ููุช ุฎุฑุฏ ุงููู ฺูุฏุฑ ุจูุฏูุ</label>
                    <input type="number" id="cryptoCostBasis" class="input" placeholder="" style="margin-bottom: 0;">
                </div>
                <button class="btn btn-blue" style="width:100%; margin-top:25px; padding: 15px;" onclick="submitCryptoFx()">
                    <span data-i18n="btn_submit_deal">ุซุจุช ููุง ูุนุงููู (F10)</span>
                </button>
            </div>
        </div>
<div id="exchange" class="page">
            <div class="card" style="max-width:800px; margin:0 auto">
                <div class="card-header">
                    <span data-i18n="header_fx_deal">ูุนุงููู ุงุฑุฒ (FX Deal Ticket)</span>
                    <button class="btn btn-outline btn-sm" onclick="printExchangeReceipt()">
                        <span data-i18n="btn_print_receipt">๐จ ฺุงูพ ุฑุณุฏ</span>
                    </button>
                </div>

                <div class="radio-group">
                    <div id="exOptExternal" class="radio-label active" onclick="setExType('external')" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                        <span data-i18n="opt_external_cust">ูุดุชุฑ ุขุฒุงุฏ (ููุฏ)</span>
                    </div>
                    <div id="exOptInternal" class="radio-label" onclick="setExType('internal')" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                        <span data-i18n="opt_internal_cust">ูุดุชุฑ ุญุณุงุจโุฏุงุฑ</span>
                    </div>
                </div>

                <div id="exInternalSec" style="display:none; margin-bottom:15px; padding:10px; border:1px solid var(--gold-border); border-radius:12px;">
                    <label class="label" data-i18n="lbl_select_customer">ุงูุชุฎุงุจ ูุดุชุฑ</label>
                    <select id="exCustomer" class="input" style="margin-bottom:0"></select>
                </div>

                <div class="fx-container">
                    <div class="fx-type-switch">
                        <div id="btnFxBuy" class="fx-type-opt active buy" onclick="setFxDirection('Buy')" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                            <span data-i18n="btn_fx_buy">ุฎุฑุฏ (BUY)</span>
                        </div>
                        <div id="btnFxSell" class="fx-type-opt" onclick="setFxDirection('Sell')" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                            <span data-i18n="btn_fx_sell">ูุฑูุด (SELL)</span>
                        </div>
                    </div>

                    <div class="fx-box">
                        <span class="fx-box-label" data-i18n="lbl_volume">ููุฏุงุฑ (Volume)</span>
                        <div class="fx-input-group">
                            <input type="number" id="fxBaseAmt" class="fx-amount" placeholder="1000" oninput="calcFx()">
                            <select id="fxBaseCurr" class="fx-currency" onchange="calcFx()"></select>
                        </div>
                    </div>

                    <div class="fx-rate-bar">
                        <div class="fx-rate-badge">
                            <span data-i18n="lbl_rate">Rate:</span>
                            <input type="number" id="fxRate" style="background:transparent; border:none; color:var(--gold-primary); font-weight:bold; width:80px; text-align:center;" value="1" oninput="calcFx()">
                        </div>
                        <div class="fx-rate-badge" onclick="toggleFxOperator()" title="Operator" tabindex="0" onkeypress="if(event.key==='Enter') this.click()">
                            <span id="fxOpDisplay">โ</span>
                        </div>
                    </div>

                    <div class="fx-box">
                        <span class="fx-box-label" data-i18n="lbl_total">ูุจูุบ ููุง (Total)</span>
                        <div class="fx-input-group">
                            <input type="number" id="fxQuoteAmt" class="fx-amount" placeholder="0" readonly>
                            <select id="fxQuoteCurr" class="fx-currency" onchange="calcFx()"></select>
                        </div>
                    </div>
                    
                    <div class="fx-info">
                        <span id="fxDirText">---</span>
                        <span data-i18n="lbl_cash_balance_after">ุชุฑุงุฒ ุตูุฏูู ูพุณ ุงุฒ ุงูุฌุงู</span>
                    </div>
                </div>

                <div style="margin-top:15px">
                    <label class="label" data-i18n="lbl_desc_opt">ุชูุถุญุงุช (ุงุฎุชุงุฑ)</label>
                    <input type="text" id="exDesc" class="input" placeholder="...">
                </div>

                <div style="margin-top:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <label class="label" style="font-weight:normal; opacity:0.8" data-i18n="lbl_cost_basis_fx">ูุญุงุณุจู ุณูุฏ ูุญุธูโุง (Cost Basis)</label>
                    <div style="display:flex; gap:10px; align-items:center">
                        <input type="number" id="exCostBasis" class="input" placeholder="..." style="margin-bottom:0">
                        <span id="estimatedProfit" style="font-weight:bold; color:var(--success)">---</span>
                    </div>
                </div>

                <button class="btn btn-blue" style="width:100%; margin-top:20px; padding:15px; font-size:16px;" onclick="submitExchange()">
                    <span data-i18n="btn_submit_deal">ุซุจุช ูุนุงููู (Submit Deal) (F10)</span>
                </button>
            </div>
        </div>
<div id="analysis" class="page admin-only-view">
    <div class="card">
        <div class="card-header">
            <span>ุขูุงูุฒ ุฏูู ุณุฑูุงู (ุชุจุฏู ุจู ุฏูุงุฑ)</span>
            <button class="btn btn-gold" onclick="renderAnalysis()">
                <span>๐ ูุญุงุณุจู ูุฌุฏุฏ</span>
            </button>
        </div>
        
        <div style="margin-bottom:20px; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; border:1px solid var(--gold-primary);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:18px; font-weight:bold; color:var(--text-main);">ูุฌููุน ฺฉู ุณุฑูุงู ุดูุง ุจู ุฏูุงุฑ:</span>
                <span id="grandTotalUSD" style="font-size:24px; font-weight:900; color:var(--success); direction:ltr; text-shadow:0 0 10px rgba(0,230,118,0.5);">0.00 $</span>
            </div>
            <p style="font-size:11px; color:var(--text-muted); margin-top:10px;">
                * ูุฑุฎ ุชุจุฏู: ุงุฑุฒุด ฑ ูุงุญุฏ ุงุฒ ุขู ุงุฑุฒ ุจู ุฏูุงุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ (ูุซูุงู ุจุฑุง ูุฑู 1.05ุ ุจุฑุง ุชุชุฑ 1).
                <br>
                * ุณุชูู ุณุฑูุงู ุฎุงูุต = (ููุฌูุฏ ฺฏุงูุตูุฏูู) + (ุทูุจ ุงุฒ ููุงูุฏฺฏุงู) + (ุทูุจ ุงุฒ ูุดุชุฑุงู).
            </p>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:10%">ุงุฑุฒ</th>
                        <th style="width:15%">ููุฌูุฏ ฺฏุงูุตูุฏูู</th>
                        <th style="width:15%">ูุงูุฏู ุญุณุงุจ ูุดุชุฑุงู</th>
                        <th style="width:15%">ูุงูุฏู ฺฉุชุงุจ ุญูุงูู</th>
                        <th style="width:15%; background:rgba(212,175,55,0.1)">โ ุณุฑูุงู ุฎุงูุต</th>
                        <th style="width:15%">ูุฑุฎ ุชุจุฏู ุจู ุฏูุงุฑ ($)</th>
                        <th style="width:15%">ูุนุงุฏู ุฏูุงุฑ</th>
                    </tr>
                </thead>
                <tbody id="analysisBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="employees" class="page admin-only-view">
    <div class="card">
        <div class="card-header">
            <span>ูุฏุฑุช ฺฉุงุฑููุฏุงู ู ุญููู ู ุฏุณุชูุฒุฏ</span>
            <button class="btn btn-green" onclick="openModal('modalNewEmp')">โ ุงุณุชุฎุฏุงู ฺฉุงุฑููุฏ ุฌุฏุฏ</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ูุงู ฺฉุงุฑููุฏ</th>
                        <th>ุณูุช / ูุธูู</th>
                        <th>ุญููู ุชูุงูู (ูุงูุงูู)</th>
                        <th>ูุถุนุช ุญุณุงุจ (ุทูุจ ฺฉุงุฑููุฏ)</th>
                        <th style="min-width: 250px;">ุนููุงุช ุญููู</th>
                    </tr>
                </thead>
                <tbody id="employeeBody"></tbody>
            </table>
        </div>
        <p style="font-size:12px; color:var(--text-muted); margin-top:10px;">
            * <b>ุณุฑุฑุณุฏ ุญููู:</b> ุนู ูุงู ุชูุงู ุดุฏู ู ุญููู ุจู ุทูุจ ฺฉุงุฑููุฏ ุงุถุงูู ูโุดูุฏ (ูพูู ูพุฑุฏุงุฎุช ููโุดูุฏ).<br>
            * <b>ูพุฑุฏุงุฎุช ููุฏ:</b> ุนู ูพูู ููุฏ ุงุฒ ุตูุฏูู ุจู ฺฉุงุฑููุฏ ุฏุงุฏู ูโุดูุฏ ู ุญุณุงุจุด ุชุณูู ูโุดูุฏ.
        </p>
    </div>
</div>

<div id="modalNewEmp" class="modal">
    <div class="modal-content" style="max-width:400px; border: 2px solid var(--gold-primary);">
        <span class="close-icon" onclick="closeModal('modalNewEmp')">&times;</span>
        <div class="card-header">ุงุณุชุฎุฏุงู ฺฉุงุฑููุฏ ุฌุฏุฏ</div>
        
        <label class="label">ูุงู ู ูุงู ุฎุงููุงุฏฺฏ</label>
        <input id="empName" class="input" placeholder="ูุซูุงู: ุงุญูุฏ ุฑุถุง">
        
        <label class="label">ุณูุช / ุดุบู</label>
        <input id="empJob" class="input" placeholder="ูุซูุงู: ุขุจุฏุงุฑฺุ ุญุณุงุจุฏุงุฑ...">
        
        <div class="grid-2">
            <div>
                <label class="label">ูุจูุบ ุญููู ูุงูุงูู</label>
                <input type="number" id="empSalary" class="input" placeholder="0">
            </div>
            <div>
                <label class="label">ุงุฑุฒ ุญููู</label>
                <select id="empCurr" class="input"></select>
            </div>
        </div>

        <button class="btn btn-green" style="width:100%" onclick="saveNewEmployee()">
            ุซุจุช ฺฉุงุฑููุฏ (F10)
        </button>
    </div>
</div>
<div id="commissions" class="page admin-only-view">
    <div class="card">
        <div class="card-header">
            <span>ูุญุงุณุจู ู ุชูุณู ุณูุฏ (ุจู ุชูฺฉฺฉ ุดูุฑ)</span>
            <button class="btn btn-gold" onclick="renderCommissionCalc()">๐ ูุญุงุณุจู ูุฌุฏุฏ</button>
        </div>
        
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">
            * ุฏุฑุตุฏูุง ุฑุง ุจุฑุง ูุฑ ุดูุฑ ุฌุฏุงฺฏุงูู ูุงุฑุฏ ฺฉูุฏ ุชุง ุณููโูุง ูุญุงุณุจู ุดูุฏ.
        </p>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ุดูุฑ / ฺฉุชุงุจ</th>
                        <th>ุงุฑุฒ</th>
                        <th>ฺฉู ฺฉูุดู</th>
                        <th style="color:var(--success)">ุณูู ุฏูุชุฑ (ูุง)</th>
                        <th style="color:var(--gold-primary)">ุณูู ููุงูุฏู</th>
                        <th style="color:var(--danger)">ูุงูุงุช/ูุฒูู</th>
                    </tr>
                </thead>
                <tbody id="commCalcBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="reports" class="page admin-only-view">
    <div class="card" style="margin-bottom:15px">
        <div class="card-header"><span data-i18n="header_backup">ูพุดุชุจุงูโฺฏุฑ (Backup)</span></div>
        <div style="display:flex; gap:15px">
            <button class="btn btn-blue" onclick="exportDB()">
                <span data-i18n="btn_download_backup">โฌ๏ธ ุฏุงูููุฏ ุจฺฉโุขูพ ฺฉุงูู</span>
            </button>
            <button class="btn btn-gold" onclick="importDB()">
                <span data-i18n="btn_restore_backup">โฌ๏ธ ุจุงุฒุงุจ ุจฺฉโุขูพ (Restore)</span>
            </button>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <span data-i18n="header_journal">ุฏูุชุฑ ุฑูุฒูุงูู (Log) - ุงูฺฉุงู ุจุงุฒฺฏุดุช ุชุฑุงฺฉูุด</span>
            <button class="btn btn-outline no-print" style="font-size:12px;" onclick="printTodayJournal()">
                <span data-i18n="btn_print_log">๐จ ูพุฑูุช ุฑุณู ฺฏุฒุงุฑุด</span>
            </button>
        </div>
        <div class="table-container" style="height:500px; overflow-y:auto">
            <table id="journalTable">
                <thead>
                    <tr>
                        <th data-i18n="th_time">ุฒูุงู</th>
                        <th data-i18n="th_section">ุจุฎุด</th>
                        <th data-i18n="th_desc">ุชูุถุญุงุช</th>
                        <th data-i18n="th_amount">ูุจูุบ</th>
                        <th data-i18n="th_user">ฺฉุงุฑุจุฑ</th>
                        <th class="admin-only-col" data-i18n="th_ops">ุนููุงุช</th>
                    </tr>
                </thead>
                <tbody id="journalBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="modalNewHawala" class="modal">
    <div class="modal-content" style="max-width:900px;">
        <span class="close-icon" onclick="closeModal('modalNewHawala')">&times;</span>
        <div class="card-header" data-i18n="modal_new_hawala">ุซุจุช ุญูุงูู ุฌุฏุฏ (ุฌุงูุน)</div>
        
        <div class="grid-3">
             <div class="radio-group" style="margin-bottom: 0;">
                <div id="hOptExternal" class="radio-label active" onclick="setHawalaCustType('external')">ููุฏ (ุขุฒุงุฏ)</div>
                <div id="hOptInternal" class="radio-label" onclick="setHawalaCustType('internal')">ุญุณุงุจโุฏุงุฑ</div>
            </div>
            <div>
                <label class="label">ููุน ุนููุงุช</label>
                <select id="hType" class="input">
                    <option value="Outgoing">ุงุฑุณุงู (Sender)</option>
                    <option value="Incoming">ุฏุฑุงูุช (Receiver)</option>
                </select>
            </div>
            <div>
                <label class="label">ฺฉุชุงุจ ุดูุฑ</label>
                <select id="hCityBook" class="input"></select>
            </div>
        </div>

        <div id="hInternalSec" style="display:none; background:rgba(212,175,55,0.1); padding:10px; border-radius:8px; margin-bottom:15px;">
            <label class="label">ุงูุชุฎุงุจ ูุดุชุฑ ุญุณุงุจโุฏุงุฑ</label>
            <select id="hCustomerSelect" class="input" onchange="fillHawalaCustName()"></select>
        </div>

        <div style="background:rgba(255,255,255,0.03); padding:10px; border:1px dashed var(--gold-border); border-radius:10px; margin:10px 0;">
            <div class="grid-4">
                <div><label class="label">ูุจูุบ ุงุตู ุญูุงูู</label><input type="number" id="hAmt" class="input"></div>
                <div><label class="label">ุงุฑุฒ ุญูุงูู</label><select id="hCurr" class="input"></select></div>
                <div>
                    <label class="label">ูุจูุบ ฺฉูุดู</label>
                    <div style="display:flex; gap:2px;">
                        <input type="number" id="hComm" class="input" value="0">
                        <select id="hCommType" class="input" style="width:70px; padding:0 5px;">
                             <option value="in">ุณูุฏ (+)</option>
                             <option value="out">ูุฒูู (-)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="label">ุงุฑุฒ ฺฉูุดู</label>
                    <select id="hCommCurr" class="input"></select>
                </div>
            </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--gold-border); margin:15px 0;">

        <div class="grid-2" style="gap:20px;">
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
                <h4 style="color:var(--gold-primary); margin-bottom:10px; border-bottom:1px solid var(--gold-faint);">ุงุทูุงุนุงุช ูุฑุณุชูุฏู (Sender)</h4>
                <div class="grid-2">
                    <div><label class="label">ูุงู</label><input id="hSender" class="input"></div>
                    <div><label class="label">ุชุฎูุต</label><input id="hSenderLast" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">ูุงู ูพุฏุฑ</label><input id="hSenderFather" class="input"></div>
                    <div><label class="label">ููุจุงู</label><input id="hPhone" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">ุดูุงุฑู ุชุฐฺฉุฑู/ID</label><input id="hSenderID" class="input"></div>
                    <div><label class="label">ููุจุน ุนุงุฏ</label><input id="hSenderSource" class="input"></div>
                </div>
                <div><label class="label">ูุฏู ุงุฑุณุงู / ุฌุฒุฆุงุช</label><input id="hSenderPurpose" class="input"></div>
            </div>

            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
                <h4 style="color:#42a5f5; margin-bottom:10px; border-bottom:1px solid rgba(66, 165, 245, 0.3);">ุงุทูุงุนุงุช ฺฏุฑูุฏู (Receiver)</h4>
                <div class="grid-2">
                    <div><label class="label">ูุงู</label><input id="hReceiver" class="input"></div>
                    <div><label class="label">ุชุฎูุต</label><input id="hReceiverLast" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">ูุงู ูพุฏุฑ</label><input id="hReceiverFather" class="input"></div>
                    <div><label class="label">ููุจุงู</label><input id="hReceiverPhone" class="input"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">ุดูุงุฑู ุชุฐฺฉุฑู/ID</label><input id="hReceiverID" class="input"></div>
                    <div><label class="label">ููุจุน ุนุงุฏ/ุดุบู</label><input id="hReceiverSource" class="input"></div>
                </div>
                <div><label class="label">ูุฏู ุฏุฑุงูุช / ุฌุฒุฆุงุช</label><input id="hReceiverPurpose" class="input"></div>
            </div>
        </div>

        <div style="margin-top:15px; text-align:left">
            <button class="btn btn-outline" onclick="closeModal('modalNewHawala')">ุงูุตุฑุงู (Esc)</button>
            <button class="btn btn-gold" onclick="submitHawala()">ุตุฏูุฑ ู ุซุจุช (F10)</button>
        </div>
    </div>
</div>
<div id="modalEditHawala" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('modalEditHawala')">&times;</span>
        <div class="card-header">
            <span data-i18n="modal_edit_hawala">ูุฑุงุด ุญูุงูู</span> 
            <span id="editHawalaId" style="color:var(--gold-primary)"></span>
        </div>
        
        <input type="hidden" id="editHId">

        <div class="label" style="background: rgba(255, 82, 82, 0.1); color: var(--danger); padding: 5px; margin-bottom: 10px; border-radius: 4px;" data-i18n="msg_security_warning">ุชูุฌู: ุชุบุฑ ูุจูุบ ุฏุฑ ุญูุงููโูุง ุงุฌุฑุง ุดุฏูุ ูุณุชููุงู ุฑู ููุฌูุฏ ุตูุฏูู ุชุงุซุฑ ูโฺฏุฐุงุฑุฏ.</div>
        
        <div class="grid-2">
            <div>
                <label class="label" data-i18n="lbl_operation_type">ููุน ุนููุงุช</label>
                <select id="editHType" class="input">
                    <option value="Outgoing" data-i18n="opt_outgoing_full">ุงุฑุณุงู (ุจู ุดูุฑ ุฏฺฏุฑ)</option>
                    <option value="Incoming" data-i18n="opt_incoming_full">ุฏุฑุงูุช (ุงุฒ ุดูุฑ ุฏฺฏุฑ)</option>
                </select>
            </div>
            <div>
                <label class="label" data-i18n="lbl_city_book">ฺฉุชุงุจ ุดูุฑ</label>
                <select id="editHCityBook" class="input"></select>
            </div>
        </div>
        <div class="grid-2">
            <div>
                <label class="label" data-i18n="lbl_amount_fixed">ูุจูุบ</label>
                <input type="number" id="editHAmt" class="input">
            </div>
            <div>
                <label class="label" data-i18n="lbl_currency_fixed">ุงุฑุฒ</label>
                <select id="editHCurr" class="input"></select>
            </div>
        </div>
        <hr style="margin:10px 0; border:0; border-top:1px dashed var(--gold-border)">
        <div class="grid-2">
            <div><label class="label" data-i18n="lbl_sender">ูุงู ูุฑุณุชูุฏู</label><input id="editHSender" class="input"></div>
            <div><label class="label" data-i18n="lbl_receiver">ูุงู ฺฏุฑูุฏู</label><input id="editHReceiver" class="input"></div>
        </div>
        <div class="grid-2">
            <div><label class="label" data-i18n="lbl_phone">ุชููู ุชูุงุณ</label><input id="editHPhone" class="input"></div>
            <div><label class="label" data-i18n="lbl_id_card">ุดูุงุฑู ุชุฐฺฉุฑู/ูพุงุณูพูุฑุช</label><input id="editHIDCard" class="input"></div>
        </div>
        <div style="margin-top:15px; text-align:left">
            <button class="btn btn-outline" onclick="closeModal('modalEditHawala')">
                <span data-i18n="btn_cancel">ุงูุตุฑุงู (Esc)</span>
            </button>
            <button class="btn btn-blue" onclick="submitEditHawala()">
                <span data-i18n="btn_save_edit">ุซุจุช ูุฑุงุด (F10)</span>
            </button>
        </div>
    </div>
</div>
<div id="modalTx" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('modalTx')">&times;</span>
        <div class="card-header" data-i18n="modal_tx_header">ุซุจุช ุชุฑุงฺฉูุด ุญุณุงุจ ูุดุชุฑ</div>
        <label class="label" data-i18n="lbl_account_party">ุทุฑู ุญุณุงุจ</label>
        <select id="txCust" class="input"></select>
        <div class="grid-2">
            <div>
                <label class="label" data-i18n="lbl_type">ููุน</label>
                <select id="txType" class="input">
                    <option value="credit" data-i18n="opt_deposit">ูุงุฑุฒ ุจู ุญุณุงุจ (ุฏุฑุงูุช ูพูู)</option>
                    <option value="debit" data-i18n="opt_withdraw">ุจุฑุฏุงุดุช ุงุฒ ุญุณุงุจ (ูพุฑุฏุงุฎุช ูพูู)</option>
                </select>
            </div>
            <div>
                <label class="label" data-i18n="lbl_currency">ุงุฑุฒ</label>
                <select id="txCurr" class="input"></select>
            </div>
        </div>
        <label class="label" data-i18n="lbl_amount">ูุจูุบ</label>
        <input type="number" id="txAmt" class="input">
        <label class="label" data-i18n="lbl_desc">ุดุฑุญ</label>
        <input type="text" id="txDesc" class="input">
        <button class="btn btn-gold" style="width:100%; margin-top:15px" onclick="submitTx()">
            <span data-i18n="btn_submit_tx">ุซุจุช ุณูุฏ ู ุงูุฌุงู (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalTx')">
            <span data-i18n="btn_close">ุจุณุชู (Esc)</span>
        </button>
    </div>
</div>
<div id="modalClientTransfer" class="modal">
    <div class="modal-content" style="max-width:500px">
        <span class="close-icon" onclick="closeModal('modalClientTransfer')">&times;</span>
        <div class="card-header" data-i18n="modal_transfer_header">ุงูุชูุงู ุจู ุญุณุงุจ ูุดุชุฑโูุง</div>
        <div style="background:rgba(212, 175, 55, 0.1); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid var(--gold-primary)">
            <span style="font-size:12px; color:var(--text-main)" data-i18n="lbl_source_account">ูุจุฏุง (ฺฉุณุฑ ุงุฒ ุญุณุงุจ): </span>
            <b id="ctSender" style="color:var(--gold-primary); font-size:14px"></b>
        </div>
        <label class="label" data-i18n="lbl_dest_account">ููุตุฏ (ูุงุฑุฒ ุจู ุญุณุงุจ)</label>
        <select id="ctReceiver" class="input"></select>
        <div class="grid-2">
            <div><label class="label" data-i18n="lbl_transfer_amount">ูุจูุบ ุงูุชูุงู</label><input type="number" id="ctAmt" class="input"></div>
            <div><label class="label" data-i18n="lbl_currency">ุงุฑุฒ</label><select id="ctCurr" class="input"></select></div>
        </div>
        <label class="label" data-i18n="lbl_desc">ุชูุถุญุงุช</label>
        <input type="text" id="ctDesc" class="input" placeholder="...">
        <button class="btn btn-indigo" style="width:100%; margin-top:15px" onclick="submitClientTransfer()">
            <span data-i18n="btn_do_transfer">ุงูุฌุงู ุงูุชูุงู (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalClientTransfer')">
            <span data-i18n="btn_cancel">ุงูุตุฑุงู (Esc)</span>
        </button>
    </div>
</div>

<div id="modalNewCust" class="modal">
    <div class="modal-content" style="max-width:400px; border: 2px solid var(--gold-primary);">
        <span class="close-icon" onclick="closeModal('modalNewCust')">&times;</span>
        <div class="card-header" data-i18n="modal_new_cust">ูุดุชุฑ ุฌุฏุฏ</div>
        <div class="label" data-i18n="lbl_cust_name">ูุงู ฺฉุงูู ูุดุชุฑ</div>
        <input id="newCustName" class="input" placeholder="...">
        <div class="label" data-i18n="lbl_phone">ุดูุงุฑู ุชููู</div>
        <input id="newCustPhone" class="input" placeholder="07...">
        <button class="btn btn-green" style="width:100%" onclick="addCustomer()">
            <span data-i18n="btn_add_list">ุงูุฒูุฏู ุจู ูุณุช (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalNewCust')">
            <span data-i18n="btn_cancel">ูุบู (Esc)</span>
        </button>
    </div>
</div>

<div id="modalEditCust" class="modal">
    <div class="modal-content" style="max-width:400px; border: 2px solid var(--gold-primary);">
        <span class="close-icon" onclick="closeModal('modalEditCust')">&times;</span>
        <div class="card-header" data-i18n="modal_edit_cust">ูุฑุงุด ูุดุฎุตุงุช ูุดุชุฑ</div>
        <div class="label" style="color:var(--danger); font-size:11px; margin-bottom:5px" data-i18n="msg_edit_name_warning">ุชูุฌู: ุชุบุฑ ูุงู ุจุงุนุซ ุชุบุฑ ูุงู ุฏุฑ ุชูุงู ฺฏุฒุงุฑุดุงุช ูุจู ูุฒ ูโุดูุฏ.</div>
        <div class="label" data-i18n="lbl_new_name">ูุงู ุฌุฏุฏ</div>
        <input id="editCustName" class="input">
        <div class="label" data-i18n="lbl_new_phone">ุชููู ุฌุฏุฏ</div>
        <input id="editCustPhone" class="input">
        <button class="btn btn-blue" style="width:100%" onclick="submitEditCustomer()">
            <span data-i18n="btn_save_changes">ุซุจุช ุชุบุฑุงุช (F10)</span>
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="closeModal('modalEditCust')">
            <span data-i18n="btn_cancel">ูุบู (Esc)</span>
        </button>
    </div>
</div>

<div id="modalAllAcc" class="modal">
    <div class="modal-content" style="max-width:800px; max-height: 90vh; display: flex; flex-direction: column;">
        <span class="close-icon" onclick="closeModal('modalAllAcc')">&times;</span>
        <div class="card-header" data-i18n="modal_all_acc_status">ูุถุนุช ฺฉู ุญุณุงุจโูุง ูุดุชุฑุงู</div>
        
        <div class="search-sticky">
            <div class="label" style="font-size: 11px; margin-bottom: 5px; color: var(--gold-primary);" data-i18n="msg_click_to_view">* ุฌูุช ูุดุงูุฏู ุฑุฒุญุณุงุจุ ุฑู ฺฉุงุฑุช ูุดุชุฑ ฺฉูฺฉ ฺฉูุฏ.</div>
            <input type="text" id="searchAllAcc" class="input" placeholder="๐ ..." oninput="filterAllAccounts()" style="margin-bottom: 0;">
        </div>

        <div id="allAccountsList" style="flex-grow: 1; overflow-y: auto; padding-right: 5px;"></div>

        <div style="margin-top:15px; text-align:left; border-top: 1px solid var(--gold-border); padding-top: 10px;">
            <button class="btn btn-red" onclick="closeModal('modalAllAcc')">
                <span data-i18n="btn_close">ุจุณุชู (Esc)</span>
            </button>
        </div>
    </div>
</div>
<div id="modalSettings" class="modal">
    <div class="modal-content">
        <div style="padding: 15px 25px; border-bottom: 1px solid var(--gold-border); display:flex; justify-content:space-between; align-items:center; background: var(--bg-sidebar);">
            <span style="font-size:18px; font-weight:900; color:var(--gold-primary)">โ๏ธ ุชูุธูุงุช ุณุณุชู (System Settings)</span>
            <span class="close-icon" onclick="closeModal('modalSettings')" style="position:static; font-size:28px;">&times;</span>
        </div>

        <div class="settings-container">
            <div class="settings-sidebar">
                <div class="settings-menu-btn active" onclick="switchSettingsTab('tab-profile', this)">๐ข ูพุฑููุงู ุตุฑุงู</div>
                <div class="settings-menu-btn" onclick="switchSettingsTab('tab-print', this)">๐จ ุชูุธูุงุช ฺุงูพ</div>
                
                <div id="adminMenuSection" style="display:none; margin-top:20px; border-top:1px dashed var(--gold-border); padding-top:10px">
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px; padding-right:10px">ูุฏุฑุช (Admin)</div>
                    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-capital', this)">๐ฐ ุณุฑูุงู ุงููู</div>
                    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-currency', this)">๐ต ูุฏุฑุช ุงุฑุฒูุง</div>
                    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-cities', this)">๐ ูุฏุฑุช ุดูุฑูุง (ฺฉุชุงุจ)</div>
                    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-users', this)">๐ฅ ูุฏุฑุช ฺฉุงุฑุจุฑุงู</div>
                    <div class="settings-menu-btn" style="color:var(--danger)" onclick="switchSettingsTab('tab-reset', this)">โ๏ธ ุฑุณุชุงุฑุช ุจุฑูุงูู</div>
                </div>
                
                <div style="margin-top:auto">
                    <div class="settings-menu-btn" onclick="switchSettingsTab('tab-password', this)">๐ ุชุบุฑ ุฑูุฒ ุนุจูุฑ</div>
                </div>
            </div>

            <div class="settings-content-area">
                
                <div id="tab-profile" class="settings-tab active">
                    <div class="setting-card">
                        <div class="setting-header-large">ูพุฑููุงู ู ูุดุฎุตุงุช ุตุฑุงู</div>
                        <p style="color:var(--text-muted); margin-bottom:20px; font-size:13px;">ุงู ุงุทูุงุนุงุช ุฏุฑ ุณุฑุจุฑฺฏ ุชูุงู ุฑุณุฏูุง ู ูุงฺฉุชูุฑูุง ฺุงูพ ูโุดูุฏ.</p>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">ูุงู ุตุฑุงู (ุจุฒุฑฺฏ ุฏุฑ ุณุฑุจุฑฺฏ)</label>
                                <input id="setCompName" class="input" placeholder="ูุซูุงู: ุตุฑุงู ุจุฑุงุฏุฑุงู...">
                            </div>
                            <div>
                                <label class="label">ุดุนุงุฑ ุชุจูุบุงุช (ุฒุฑ ูุงู)</label>
                                <input id="setCompSlogan" class="input" placeholder="ุณุฑุนุ ูุทูุฆู...">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div>
                                <label class="label">ุดูุงุฑูโูุง ุชูุงุณ</label>
                                <input id="setCompPhone" class="input" placeholder="0799...">
                            </div>
                            <div>
                                <label class="label">ุขุฏุฑุณ ุฏูุชุฑ ูุฑฺฉุฒ</label>
                                <input id="setCompAddress" class="input" placeholder="ูุฑุงุชุ ฺูฺฉ ฺฏููุง...">
                            </div>
                        </div>
                        <div>
                            <label class="label">ูพุงู ุชุดฺฉุฑ (ูพุงูุฑู ูุงฺฉุชูุฑ)</label>
                            <input id="setCompFooter" class="input" placeholder="ุงุฒ ุงูุชุฎุงุจ ุดูุง ูุชุดฺฉุฑู">
                        </div>
                        <div style="margin-top:15px; border-top:1px dashed var(--gold-border); padding-top:15px;">
    <label class="label">ููฺฏู ุตุฑุงู (ุฌูุช ฺุงูพ ุฏุฑ ุฑุณุฏ)</label>
    <input type="file" id="logoUploader" accept="image/*" class="input" onchange="saveLogo()">
    <img id="logoPreview" style="max-height:60px; display:none; margin-top:5px; border:1px solid #ccc;">
    <button class="btn btn-red btn-sm" onclick="clearLogo()" style="margin-top:5px">ุญุฐู ููฺฏู</button>
</div>

<button class="btn btn-gold" style="width:100%; padding:15px; margin-top:15px" onclick="saveCompanyProfile()">
    ุซุจุช ู ุฐุฎุฑู ูุดุฎุตุงุช (Save)
</button>
                    </div>
                </div>

                <div id="tab-print" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ุชูุธูุงุช ฺุงูพ (Print Options)</div>
                        
                        <div style="display:flex; align-items:center; gap:15px; background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; border:1px solid var(--gold-border)">
                            <input type="checkbox" id="printHeaderOpt" style="width:25px; height:25px; cursor:pointer" onchange="togglePrintHeaderSetting()">
                            <div>
                                <label for="printHeaderOpt" style="font-size:16px; font-weight:bold; cursor:pointer; color:var(--text-main)">ููุงุด ยซุณุฑุจุฑฺฏ ุดุฑฺฉุชยป ุฏุฑ ฺุงูพโูุง</label>
                                <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">ุจุง ูุนุงู ฺฉุฑุฏู ุงู ฺฏุฒููุ ูุงู ู ููฺฏู ุตุฑุงู ุดูุง ุฏุฑ ุจุงูุง ุชูุงู ุฑุณุฏูุง ฺุงูพ ูโุดูุฏ. ุงฺฏุฑ ุงุฒ ฺฉุงุบุฐ ุณุฑุจุฑฺฏโุฏุงุฑ ุขูุงุฏู ุงุณุชูุงุฏู ูโฺฉูุฏุ ุงู ฺฏุฒูู ุฑุง ุฎุงููุด ฺฉูุฏ.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-capital" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ุณุฑูุงู ุงููู (Initial Capital)</div>
                        <p style="color:var(--text-muted); margin-bottom:20px;">ุงู ูุจุงูุบ ููุท ุฌูุช ูุญุงุณุจู ุณูุฏ ู ุฒุงู ุงุณุชูุงุฏู ูโุดูุฏ ู ุจู ููุฌูุฏ ุตูุฏูู ุงุถุงูู ููโุดูุฏ.</p>
                        <div id="initialCapitalInputs"></div>
                        <button class="btn btn-blue" style="width:100%; margin-top:15px" onclick="setInitialCapital()">
                            ุซุจุช ุณุฑูุงู ุงููู
                        </button>
                    </div>
                </div>

                <div id="tab-currency" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ูุฏุฑุช ุงุฑุฒูุง</div>
                        <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; margin-bottom:20px">
                            <label class="label" style="color:var(--success)">ุงูุฒูุฏู ุงุฑุฒ ุฌุฏุฏ</label>
                            <div style="display:flex; gap:10px">
                                <input id="newCurrCode" class="input" placeholder="Code (e.g. TOMAN)" style="margin-bottom:0">
                                <button class="btn btn-green" onclick="addCurrency()">ุงูุฒูุฏู</button>
                            </div>
                        </div>
                        <div style="background:rgba(255,0,0,0.1); padding:20px; border-radius:12px;">
                            <label class="label" style="color:var(--danger)">ุญุฐู ุงุฑุฒ</label>
                            <div style="display:flex; gap:10px">
                                <select id="currToDelete" class="input" style="margin-bottom:0"></select>
                                <button class="btn btn-red" onclick="deleteCurrency()">ุญุฐู</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-cities" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ูุฏุฑุช ุดูุฑูุง ู ููุงูุฏฺฏุงู</div>
                        <p style="color:var(--gold-primary); font-size:13px; margin-bottom:15px">
                            * ุงุทูุงุนุงุช ูุงุฑุฏ ุดุฏู ุฏุฑ ุงูุฌุง (ูุงู ุตุฑุงู/ููุงูุฏู) ูุณุชููุงู ุฏุฑ ุฑุณุฏ ฺุงูพ ุญูุงูู ุฏุฑุฌ ูโุดูุฏ.
                        </p>
                        
                        <div class="city-detail-group">
                            <div class="grid-2">
                                <div>
                                    <label class="label">ูุงู ุดูุฑ</label>
                                    <input id="newCityName" class="input" placeholder="ูุซูุงู: ูุฒุงุฑุดุฑู">
                                </div>
                                <div>
                                    <label class="label">ฺฉุฏ ุดูุฑ (ูุฎูู)</label>
                                    <input id="newCityCode" class="input" placeholder="MZR" style="text-transform:uppercase">
                                </div>
                            </div>
                            <div class="grid-2">
                                <div>
                                    <label class="label" style="color:var(--gold-primary)">ูุงู ููุงูุฏู / ุตุฑุงู ููฺฉุงุฑ</label>
                                    <input id="newCityRep" class="input" placeholder="ูุซูุงู: ุตุฑุงู ุตุฏุงูุช (ุญุงุฌ ุงุญูุฏ)">
                                </div>
                                <div>
                                    <label class="label" style="color:var(--gold-primary)">ุขุฏุฑุณ / ุชููู ููุงูุฏู</label>
                                    <input id="newCityContact" class="input" placeholder="ูุงุฑฺฉุช... / 0799...">
                                </div>
                            </div>
                            <button class="btn btn-gold" style="width:100%" onclick="addCity()">
                                ุซุจุช ุดูุฑ ู ูุดุฎุตุงุช ููุงูุฏู
                            </button>
                        </div>

                        <div style="margin-top:30px; border-top:1px dashed var(--gold-border); padding-top:20px">
                            <label class="label" style="color:var(--danger)">ุญุฐู ุดูุฑ</label>
                            <div style="display:flex; gap:10px; align-items:flex-start">
                                <div style="flex:1">
                                    <select id="cityToDelete" class="input" onchange="checkCityForDelete()"></select>
                                    <div id="transferCitySection" style="display:none; background:rgba(255,82,82,0.1); padding:10px; border-radius:8px; margin-top:5px">
                                        <label class="label" style="color:var(--danger)">ุงูุชูุงู ุงุทูุงุนุงุช ุจู:</label>
                                        <select id="cityTransferTarget" class="input"></select>
                                    </div>
                                </div>
                                <button id="btnDeleteCity" class="btn btn-red" onclick="deleteCityProcess()" style="height:45px">ุญุฐู</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-users" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ูุฏุฑุช ฺฉุงุฑุจุฑุงู ุณุณุชู</div>
                        <div class="grid-2" style="gap:10px">
                            <input id="newUName" class="input" placeholder="ูุงู ฺฉุงุฑุจุฑ (Username)">
                            <input id="newUPass" class="input" placeholder="ุฑูุฒ ุนุจูุฑ (Password)">
                        </div>
                        <label class="label">ุฏุณุชุฑุณโูุง:</label>
                        <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px">
                            <label><input type="checkbox" id="perm_hawala" checked> ุญูุงูู</label>
                            <label><input type="checkbox" id="perm_exchange" checked> ุตุฑุงู</label>
                            <label><input type="checkbox" id="perm_accounts"> ุญุณุงุจโูุง</label>
                            <label><input type="checkbox" id="perm_tt"> TT</label>
                            <label><input type="checkbox" id="perm_admin" onchange="toggleAdminAccess(this)"> <span style="color:var(--gold-primary); font-weight:bold">ูุฏุฑ ฺฉู</span></label>
                        </div>
                        <button class="btn btn-green" style="width:100%" onclick="addUser()">ุงูุฒูุฏู ฺฉุงุฑุจุฑ ุฌุฏุฏ</button>
                        
                        <div style="margin-top:20px">
                            <label class="label">ูุณุช ฺฉุงุฑุจุฑุงู:</label>
                            <div id="userListManage"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-reset" class="settings-tab">
                    <div class="setting-card" style="border-color:var(--danger)">
                        <div class="setting-header-large" style="color:var(--danger); border-color:var(--danger)">ุฑุณุช ูฺฉุชูุฑ (Factory Reset)</div>
                        <p style="color:var(--danger); font-weight:bold; margin-bottom:20px">
                            ูุดุฏุงุฑ: ุจุง ุฒุฏู ุฏฺฉูู ุฒุฑุ ุชูุงู ุงุทูุงุนุงุช ุญุณุงุจโูุงุ ุญูุงููโูุงุ ูุดุชุฑุงู ู ฺฏุฒุงุฑุดุงุช ุจุฑุง ููุดู ูพุงฺฉ ูโุดูุฏ ู ูุงุจู ุจุงุฒฺฏุดุช ูุณุช.
                        </p>
                        <button class="btn btn-red" style="width:100%; padding:20px; font-size:16px" onclick="resetData()">
                            โ๏ธ ุญุฐู ุชูุงู ุงุทูุงุนุงุช ู ุดุฑูุน ุฏูุจุงุฑู
                        </button>
                    </div>
                </div>

                <div id="tab-password" class="settings-tab">
                    <div class="setting-card">
                        <div class="setting-header-large">ุชุบุฑ ุฑูุฒ ุนุจูุฑ ูู</div>
                        <input type="password" id="myNewPass" class="input" placeholder="ุฑูุฒ ุนุจูุฑ ุฌุฏุฏ...">
                        <button class="btn btn-blue" style="width:100%" onclick="changeMyPass()">
                            ุชุบุฑ ุฑูุฒ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function numberToPersianWords(number) {
    const units = ['', 'ฺฉ', 'ุฏู', 'ุณู', 'ฺูุงุฑ', 'ูพูุฌ', 'ุดุด', 'ููุช', 'ูุดุช', 'ูู'];
    const teens = ['ุฏู', 'ุงุฒุฏู', 'ุฏูุงุฒุฏู', 'ุณุฒุฏู', 'ฺูุงุฑุฏู', 'ูพุงูุฒุฏู', 'ุดุงูุฒุฏู', 'ููุฏู', 'ูุฌุฏู', 'ููุฒุฏู'];
    const tens = ['', '', 'ุจุณุช', 'ุณ', 'ฺูู', 'ูพูุฌุงู', 'ุดุตุช', 'ููุชุงุฏ', 'ูุดุชุงุฏ', 'ููุฏ'];
    const hundreds = ['', 'ฺฉุตุฏ', 'ุฏูุณุช', 'ุณุตุฏ', 'ฺูุงุฑุตุฏ', 'ูพุงูุตุฏ', 'ุดุดุตุฏ', 'ููุชุตุฏ', 'ูุดุชุตุฏ', 'ููุตุฏ'];
    if (number === 0) return 'ุตูุฑ';
    const str = number.toString();
    function convertGroup(n) {
        let res = '';
        const h = Math.floor(n / 100);
        const t = n % 100;
        if (h > 0) {
            res += hundreds[h];
            if (t > 0) res += ' ู ';
        }
        if (t > 0) {
            if (t < 10) res += units[t];
            else if (t < 20) res += teens[t - 10];
            else {
                res += tens[Math.floor(t / 10)];
                if (t % 10 > 0) res += ' ู ' + units[t % 10];
            }
        }
        return res;
    }
    const parts = [];
    let n = Math.floor(number);
    const scales = ['', ' ูุฒุงุฑ', ' ูููู', ' ููุงุฑุฏ', ' ุชุฑููู'];
    let scaleIndex = 0;
    while(n > 0) {
        let chunk = n % 1000;
        if(chunk > 0) {
            let chunkStr = convertGroup(chunk);
            parts.push(chunkStr + scales[scaleIndex]);
        }
        n = Math.floor(n / 1000);
        scaleIndex++;
    }
    return parts.reverse().join(' ู ').trim();
}

function numberToEnglishWords(n) {
    if (n < 0) return "Minus " + numberToEnglishWords(-n);
    if (n === 0) return "Zero";
    const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
    const scales = ["", "Thousand", "Million", "Billion", "Trillion"];
    let result = "";
    let scaleIndex = 0;
    function convertChunk(num) {
        let chunkStr = "";
        if (num >= 100) {
            chunkStr += units[Math.floor(num / 100)] + " Hundred ";
            num %= 100;
        }
        if (num >= 20) {
            chunkStr += tens[Math.floor(num / 10)] + " ";
            num %= 10;
        }
        if (num > 0) {
            chunkStr += units[num] + " ";
        }
        return chunkStr;
    }
    while (n > 0) {
        let chunk = n % 1000;
        if (chunk > 0) {
            let str = convertChunk(chunk).trim();
            result = str + (scales[scaleIndex] ? " " + scales[scaleIndex] : "") + " " + result;
        }
        n = Math.floor(n / 1000);
        scaleIndex++;
    }
    return result.trim();
}

function updateTTAutoWords() {
    const amt = parseInt(document.getElementById('ttAmt').value);
    if (!isNaN(amt)) document.getElementById('ttAmtWords').value = numberToEnglishWords(amt);
    else document.getElementById('ttAmtWords').value = '';
}
const TRANSLATIONS = {
    fa: {
        dir: 'rtl',
        app_title: "ุตุฑุงู ูุฑุงุชโูุง",
        company_subtitle: "ุดุฑฺฉุช ุตุฑุงู ู ุฎุฏูุงุช ูพูู ูุฑุงุชูุง",
        login_btn: "ูุฑูุฏ ุจู ุณุณุชู (Enter)",
        login_error: "ุงุทูุงุนุงุช ุงุดุชุจุงู ุงุณุช",
        loading_db: "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงฺฏุงู ุฏุงุฏู ุงููุช...",
        nav_dashboard: "๐ ุฏุงุดุจูุฑุฏ (F1)",
        nav_hawala: "โ๏ธ ุญูุงููโุฌุงุช (F2)",
        nav_accounts: "๐ฅ ุญุณุงุจ ูุดุชุฑุงู (F3)",
        nav_tt: "๐ ุงูุชูุงู ุงุฑุฒ (TT) (F6)",
        nav_exchange: "๐ฑ ุฎุฑุฏ ู ูุฑูุด (FX) (F4)",
        nav_crypto: "๐ช ุงุฑุฒ ุฏุฌุชุงู (Crypto)",
        nav_reports: "๐ ฺฏุฒุงุฑุดุงุช (Logs)",
        nav_settings: "โ๏ธ ุชูุธูุงุช",
        nav_logout: "๐ช ุฎุฑูุฌ ุงูู",
        lbl_initial_capital: "ุณุฑูุงู ุงููู ุซุจุช ุดุฏู",
        lbl_profit_loss: "ุณูุฏ / ุฒุงู (FX & Crypto)",
        lbl_cash_balance: "ููุฌูุฏ ูุฒฺฉ ุตูุฏูู (ุฎุฒุงูู)",
        lbl_crypto_assets: "ุฏุงุฑุงโูุง ุฏุฌุชุงู (Crypto Assets)",
        lbl_city_balance: "ุจุงูุงูุณ ฺฉุชุงุจ ุดูุฑูุง (ุจุฏูฺฉุงุฑ/ุจุณุชุงูฺฉุงุฑ ููุงูุฏฺฏุงู)",
        btn_refresh: "๐ ุจุฑูุฒุฑุณุงู",
        msg_city_balance_hint: "* ุงุนุฏุงุฏ ูุซุจุช (ุณุจุฒ): ููุงูุฏู ุจู ูุง ุจุฏูฺฉุงุฑ ุงุณุช. ุงุนุฏุงุฏ ููู (ูุฑูุฒ): ูุง ุจู ููุงูุฏู ุจุฏูฺฉุงุฑู.",
        lbl_total_commissions: "ูุฌููุน ฺฉูุดูโูุง ุญูุงูู (ุณูุฏ ุฎุงูุต)",
        header_hawala_manage: "ูุฏุฑุช ุญูุงููโุฌุงุช",
        btn_new_hawala: "โ ุซุจุช ุญูุงูู ุฌุฏุฏ (F9)",
        lbl_filter_city: "ููุชุฑ ุดูุฑ",
        lbl_type: "ููุน",
        opt_all: "ููู",
        opt_outgoing: "ุงุฑุณุงู (Out)",
        opt_incoming: "ุฏุฑุงูุช (In)",
        lbl_status: "ูุถุนุช",
        opt_pending: "ุฏุฑ ุงูุชุธุงุฑ ุงุฌุฑุง",
        opt_done: "ุงุฌุฑุง/ุชุณูู ุดุฏู",
        btn_excel: "๐ ุงฺฉุณู ุนุงู",
        btn_print_book: "๐จ ูพุฑูุช ฺฉุชุงุจ",
        th_hawala_no: "ููุจุฑ ุญูุงูู",
        th_type: "ููุน",
        th_city_book: "ุดูุฑ / ฺฉุชุงุจ",
        th_amount: "ูุจูุบ",
        th_commission: "ฺฉูุดู",
        th_reg_date: "ุชุงุฑุฎ ุซุจุช",
        th_exec_date: "ุชุงุฑุฎ ุงุฌุฑุง",
        th_status: "ูุถุนุช",
        th_ops: "ุนููุงุช",
        header_accounts_manage: "ูุฏุฑุช ุญุณุงุจ ูุดุชุฑุงู",
        lbl_search_customer: "ุฌุณุชุฌู ูุดุชุฑ",
        btn_new_customer: "โ ูุดุชุฑ ุฌุฏุฏ (F9)",
        btn_deposit_withdraw: "๐ฐ ูุงุฑุฒ/ุจุฑุฏุงุดุช",
        btn_transfer: "๐ ุงูุชูุงู ุญุณุงุจ",
        btn_all_accounts: "๐ ูุถุนุช ฺฉู ุญุณุงุจโูุง",
        lbl_statement: "ุตูุฑุชโุญุณุงุจ:",
        btn_edit: "โ๏ธ ูุฑุงุด",
        btn_delete: "๐ ุญุฐู",
        btn_print: "๐จ ูพุฑูุช",
        th_date: "ุชุงุฑุฎ",
        th_desc: "ุดุฑุญ",
        th_currency: "ุงุฑุฒ",
        th_debit: "ุจุฏูฺฉุงุฑ",
        th_credit: "ุจุณุชุงูฺฉุงุฑ",
        th_balance: "ูุงูุฏู (ุชุดุฎุต)",
        header_tt_app: "ุฏุฑุฎูุงุณุช ุญูุงูู ุงุฑุฒ (TT Application)",
        opt_internal_cust: "ูุดุชุฑ ุฏุงุฎู (ุญุณุงุจุฏุงุฑ)",
        opt_external_cust: "ูุดุชุฑ ุฎุงุฑุฌ (ููุฏ)",
        lbl_select_account: "ุงูุชุฎุงุจ ุญุณุงุจ ูุดุชุฑ (ุจุฑุฏุงุดุช ุงุฒ ุญุณุงุจ)",
        lbl_payer_name: "ูุงู ูุดุชุฑ (ูพุฑุฏุงุฎุช ููุฏ)",
        lbl_phone: "ุชููู ุชูุงุณ",
        lbl_amount: "ูุจูุบ",
        header_beneficiary: "ูุดุฎุตุงุช ุฐููุน (Beneficiary)",
        lbl_ben_name: "ูุงู ุฐููุน (ูุงุฑุณ)",
        lbl_desc: "ุชูุถุญุงุช ุชฺฉูู",
        btn_submit_tt: "ุซุจุช ุฏุฑุฎูุงุณุช ู ุฏุฑุงูุช ูุฌู (F10)",
        btn_print_form: "๐จ ฺุงูพ ูุฑู ุฑุณู",
        header_crypto_deal: "ูุนุงููุงุช ุงุฑุฒ ุฏุฌุชุงู (Crypto)",
        btn_print_receipt: "๐จ ฺุงูพ ุฑุณุฏ",
        lbl_select_customer: "ุงูุชุฎุงุจ ูุดุชุฑ",
        lbl_deal_type: "ููุน ูุนุงููู",
        opt_buy: "ุฎุฑุฏ (ูพุฑุฏุงุฎุช ูพูู)",
        opt_sell: "ูุฑูุด (ุฏุฑุงูุช ูพูู)",
        lbl_crypto_name: "ูุงู ุงุฑุฒ (USDT)",
        lbl_volume: "ููุฏุงุฑ (Volume)",
        lbl_payment_curr: "ููุน ุงุฑุฒ ูพุฑุฏุงุฎุช/ุฏุฑุงูุช",
        lbl_total_fiat: "ูุจูุบ ฺฉู (Total Fiat)",
        lbl_cost_basis: "ูุญุงุณุจู ุณูุฏ (ููุท ุจุฑุง ูุฑูุด): ููุช ุฎุฑุฏ ุงููู ฺูุฏุฑ ุจูุฏูุ",
        btn_submit_deal: "ุซุจุช ููุง ูุนุงููู (F10)",
        header_fx_deal: "ูุนุงููู ุงุฑุฒ (FX Deal Ticket)",
        btn_fx_buy: "ุฎุฑุฏ (BUY)",
        btn_fx_sell: "ูุฑูุด (SELL)",
        lbl_rate: "Rate:",
        lbl_total: "ูุจูุบ ููุง (Total)",
        lbl_cash_balance_after: "ุชุฑุงุฒ ุตูุฏูู ูพุณ ุงุฒ ุงูุฌุงู",
        lbl_desc_opt: "ุชูุถุญุงุช (ุงุฎุชุงุฑ)",
        lbl_cost_basis_fx: "ูุญุงุณุจู ุณูุฏ ูุญุธูโุง (Cost Basis)",
        header_backup: "ูพุดุชุจุงูโฺฏุฑ (Backup)",
        btn_download_backup: "โฌ๏ธ ุฏุงูููุฏ ุจฺฉโุขูพ ฺฉุงูู",
        btn_restore_backup: "โฌ๏ธ ุจุงุฒุงุจ ุจฺฉโุขูพ (Restore)",
        header_journal: "ุฏูุชุฑ ุฑูุฒูุงูู (Log) - ุงูฺฉุงู ุจุงุฒฺฏุดุช ุชุฑุงฺฉูุด",
        btn_print_log: "๐จ ูพุฑูุช ุฑุณู ฺฏุฒุงุฑุด",
        th_time: "ุฒูุงู",
        th_section: "ุจุฎุด",
        th_user: "ฺฉุงุฑุจุฑ",
        modal_new_hawala: "ุซุจุช ุญูุงูู ุฌุฏุฏ",
        lbl_operation_type: "ููุน ุนููุงุช",
        opt_outgoing_full: "ุงุฑุณุงู (ุจู ุดูุฑ ุฏฺฏุฑ)",
        opt_incoming_full: "ุฏุฑุงูุช (ุงุฒ ุดูุฑ ุฏฺฏุฑ)",
        lbl_city_book: "ฺฉุชุงุจ ุดูุฑ (ุทุฑู ุญุณุงุจ)",
        lbl_currency: "ุงุฑุฒ",
        lbl_commission: "ฺฉูุดู (ุฏุณุช)",
        lbl_sender: "ูุงู ูุฑุณุชูุฏู",
        lbl_receiver: "ูุงู ฺฏุฑูุฏู",
        lbl_id_card: "ุดูุงุฑู ุชุฐฺฉุฑู/ูพุงุณูพูุฑุช",
        btn_cancel: "ุงูุตุฑุงู (Esc)",
        btn_issue_hawala: "ุตุฏูุฑ ู ุซุจุช (F10)",
        modal_edit_hawala: "ูุฑุงุด ุญูุงูู",
        msg_security_warning: "ุชูุฌู: ุฌูุช ุงููุช ุตูุฏููุ ุงูฺฉุงู ุชุบุฑ ูุจูุบ ูุฌูุฏ ูุฏุงุฑุฏ. ุจุฑุง ุงุตูุงุญ ูุจูุบุ ุญูุงูู ุฑุง ุญุฐู ู ูุฌุฏุฏ ุงุฌุงุฏ ฺฉูุฏ.",
        lbl_amount_fixed: "ูุจูุบ (ุบุฑูุงุจู ุชุบุฑ)",
        lbl_currency_fixed: "ุงุฑุฒ (ุบุฑูุงุจู ุชุบุฑ)",
        btn_save_edit: "ุซุจุช ูุฑุงุด (F10)",
        modal_tx_header: "ุซุจุช ุชุฑุงฺฉูุด ุญุณุงุจ ูุดุชุฑ",
        lbl_account_party: "ุทุฑู ุญุณุงุจ",
        opt_deposit: "ูุงุฑุฒ ุจู ุญุณุงุจ (ุฏุฑุงูุช ูพูู)",
        opt_withdraw: "ุจุฑุฏุงุดุช ุงุฒ ุญุณุงุจ (ูพุฑุฏุงุฎุช ูพูู)",
        btn_submit_tx: "ุซุจุช ุณูุฏ ู ุงูุฌุงู (F10)",
        btn_close: "ุจุณุชู (Esc)",
        modal_transfer_header: "ุงูุชูุงู ุจู ุญุณุงุจ ูุดุชุฑโูุง",
        lbl_source_account: "ูุจุฏุง (ฺฉุณุฑ ุงุฒ ุญุณุงุจ):",
        lbl_dest_account: "ููุตุฏ (ูุงุฑุฒ ุจู ุญุณุงุจ)",
        lbl_transfer_amount: "ูุจูุบ ุงูุชูุงู",
        btn_do_transfer: "ุงูุฌุงู ุงูุชูุงู (F10)",
        modal_new_cust: "ูุดุชุฑ ุฌุฏุฏ",
        lbl_cust_name: "ูุงู ฺฉุงูู ูุดุชุฑ",
        btn_add_list: "ุงูุฒูุฏู ุจู ูุณุช (F10)",
        modal_edit_cust: "ูุฑุงุด ูุดุฎุตุงุช ูุดุชุฑ",
        msg_edit_name_warning: "ุชูุฌู: ุชุบุฑ ูุงู ุจุงุนุซ ุชุบุฑ ูุงู ุฏุฑ ุชูุงู ฺฏุฒุงุฑุดุงุช ูุจู ูุฒ ูโุดูุฏ.",
        lbl_new_name: "ูุงู ุฌุฏุฏ",
        lbl_new_phone: "ุชููู ุฌุฏุฏ",
        btn_save_changes: "ุซุจุช ุชุบุฑุงุช (F10)",
        modal_all_acc_status: "ูุถุนุช ฺฉู ุญุณุงุจโูุง ูุดุชุฑุงู",
        msg_click_to_view: "* ุฌูุช ูุดุงูุฏู ุฑุฒุญุณุงุจุ ุฑู ฺฉุงุฑุช ูุดุชุฑ ฺฉูฺฉ ฺฉูุฏ.",
        header_settings: "ุชูุธูุงุช ุณุณุชู",
        lbl_print_settings: "ุชูุธูุงุช ฺุงูพ",
        lbl_print_header_opt: "ููุงุด ยซูุงู ุดุฑฺฉุชยป ุฏุฑ ุณุฑุจุฑฺฏ ุชูุงู ฺุงูพโูุง",
        lbl_initial_capital_set: "ุณุฑูุงู ุงููู (ุฌูุช ูุญุงุณุจู ุณูุฏ/ุฒุงู)",
        btn_save_capital: "ุซุจุช ุณุฑูุงู ุงููู",
        lbl_user_mgmt: "ูุฏุฑุช ฺฉุงุฑุจุฑุงู",
        lbl_permissions: "ุณุทูุญ ุฏุณุชุฑุณ:",
        perm_hawala: "ุญูุงููโุฌุงุช",
        perm_exchange: "ุฎุฑุฏ/ูุฑูุด",
        perm_accounts: "ุญุณุงุจ ูุดุชุฑุงู",
        perm_tt: "ุงูุชูุงู ุงุฑุฒ (TT)",
        perm_admin: "ุฏุณุชุฑุณ ฺฉุงูู (ูุฏุฑ)",
        btn_add_user: "ุงูุฒูุฏู ฺฉุงุฑุจุฑ",
        lbl_add_city: "ุงูุฒูุฏู ุดูุฑ (ฺฉุชุงุจ ุญูุงูู)",
        btn_add: "ุงูุฒูุฏู",
        lbl_delete_city: "ุญุฐู ุดูุฑ (Delete City)",
        msg_city_has_data: "ุชูุฌู: ุงู ุดูุฑ ุฏุงุฑุง ุญูุงูู ุงุณุช. ููุตุฏ ุงูุชูุงู:",
        btn_delete_city: "ุญุฐู ุดูุฑ",
        lbl_currency_mgmt: "ูุฏุฑุช ุงุฑุฒูุง (ุงูุฒูุฏู ู ุญุฐู)",
        lbl_reset_app: "ุฑุณุชุงุฑุช ุจุฑูุงูู (ุญุฐู ุชูุงู ุงุทูุงุนุงุช ู ูุดุชุฑุงู)",
        btn_full_reset: "ุฑุณุชุงุฑุช ฺฉุงูู ุจุฑูุงูู",
        lbl_change_pass: "ุชุบุฑ ุฑูุฒ ุนุจูุฑ ูู",
        btn_change_pass: "ุชุบุฑ ุฑูุฒ"
    },
    en: {
        dir: 'ltr',
        app_title: "Heratiha Exchange",
        company_subtitle: "Money Exchange & Services Co.",
        login_btn: "Login (Enter)",
        login_error: "Invalid Credentials",
        loading_db: "Loading Secure Database...",
        nav_dashboard: "๐ Dashboard (F1)",
        nav_hawala: "โ๏ธ Hawala (F2)",
        nav_accounts: "๐ฅ Accounts (F3)",
        nav_tt: "๐ TT Transfer (F6)",
        nav_exchange: "๐ฑ Exchange (FX) (F4)",
        nav_crypto: "๐ช Crypto Assets",
        nav_reports: "๐ Reports (Logs)",
        nav_settings: "โ๏ธ Settings",
        nav_logout: "๐ช Secure Logout",
        lbl_initial_capital: "Initial Capital Registered",
        lbl_profit_loss: "Profit / Loss (FX & Crypto)",
        lbl_cash_balance: "Physical Cash Balance (Vault)",
        lbl_crypto_assets: "Digital Assets (Crypto)",
        lbl_city_balance: "City Ledgers Balance (Agents)",
        btn_refresh: "๐ Refresh",
        msg_city_balance_hint: "* Positive (Green): Agent owes us. Negative (Red): We owe agent.",
        lbl_total_commissions: "Total Hawala Commissions (Net Profit)",
        header_hawala_manage: "Hawala Management",
        btn_new_hawala: "โ New Hawala (F9)",
        lbl_filter_city: "Filter City",
        lbl_type: "Type",
        opt_all: "All",
        opt_outgoing: "Outgoing",
        opt_incoming: "Incoming",
        lbl_status: "Status",
        opt_pending: "Pending",
        opt_done: "Done/Settled",
        btn_excel: "๐ Export Excel",
        btn_print_book: "๐จ Print Book",
        th_hawala_no: "Hawala No",
        th_type: "Type",
        th_city_book: "City/Book",
        th_amount: "Amount",
        th_commission: "Comm",
        th_reg_date: "Date",
        th_exec_date: "Exec Date",
        th_status: "Status",
        th_ops: "Actions",
        header_accounts_manage: "Customer Accounts",
        lbl_search_customer: "Search Customer",
        btn_new_customer: "โ New Customer (F9)",
        btn_deposit_withdraw: "๐ฐ Dep/Withdraw",
        btn_transfer: "๐ Transfer",
        btn_all_accounts: "๐ All Balances",
        lbl_statement: "Statement:",
        btn_edit: "โ๏ธ Edit",
        btn_delete: "๐ Delete",
        btn_print: "๐จ Print",
        th_date: "Date",
        th_desc: "Description",
        th_currency: "Curr",
        th_debit: "Debit",
        th_credit: "Credit",
        th_balance: "Balance",
        header_tt_app: "TT Application Form",
        opt_internal_cust: "Internal Customer (Account)",
        opt_external_cust: "Walk-in Customer (Cash)",
        lbl_select_account: "Select Account (Debit)",
        lbl_payer_name: "Payer Name (Cash)",
        lbl_phone: "Phone Number",
        lbl_amount: "Amount",
        header_beneficiary: "Beneficiary Details",
        lbl_ben_name: "Beneficiary Name",
        lbl_desc: "Additional Description",
        btn_submit_tt: "Submit Application (F10)",
        btn_print_form: "๐จ Print Official Form",
        header_crypto_deal: "Crypto Currency Deals",
        btn_print_receipt: "๐จ Print Receipt",
        lbl_select_customer: "Select Customer",
        lbl_deal_type: "Deal Type",
        opt_buy: "Buy (Pay Cash)",
        opt_sell: "Sell (Receive Cash)",
        lbl_crypto_name: "Asset Name (USDT)",
        lbl_volume: "Volume",
        lbl_payment_curr: "Payment Currency",
        lbl_total_fiat: "Total Fiat Amount",
        lbl_cost_basis: "Profit Calc (For Sells): Buy Price?",
        btn_submit_deal: "Submit Deal (F10)",
        header_fx_deal: "FX Deal Ticket",
        btn_fx_buy: "BUY",
        btn_fx_sell: "SELL",
        lbl_rate: "Rate:",
        lbl_total: "Total Amount",
        lbl_cash_balance_after: "Vault Balance After Deal",
        lbl_desc_opt: "Description (Optional)",
        lbl_cost_basis_fx: "Est. Profit Calc (Cost Basis)",
        header_backup: "Backup & Restore",
        btn_download_backup: "โฌ๏ธ Download Full Backup",
        btn_restore_backup: "โฌ๏ธ Restore Backup",
        header_journal: "Journal Log (Reversal)",
        btn_print_log: "๐จ Print Journal",
        th_time: "Time",
        th_section: "Section",
        th_user: "User",
        modal_new_hawala: "New Hawala Entry",
        lbl_operation_type: "Operation Type",
        opt_outgoing_full: "Outgoing (Send)",
        opt_incoming_full: "Incoming (Receive)",
        lbl_city_book: "City Book",
        lbl_currency: "Currency",
        lbl_commission: "Commission",
        lbl_sender: "Sender Name",
        lbl_receiver: "Receiver Name",
        lbl_id_card: "ID Card / Passport",
        btn_cancel: "Cancel (Esc)",
        btn_issue_hawala: "Issue & Save (F10)",
        modal_edit_hawala: "Edit Hawala",
        msg_security_warning: "Security: Amount cannot be changed. Delete and re-create if needed.",
        lbl_amount_fixed: "Amount (Fixed)",
        lbl_currency_fixed: "Currency (Fixed)",
        btn_save_edit: "Save Changes (F10)",
        modal_tx_header: "Customer Transaction",
        lbl_account_party: "Account Holder",
        opt_deposit: "Deposit (Receive Cash)",
        opt_withdraw: "Withdraw (Pay Cash)",
        btn_submit_tx: "Submit Transaction (F10)",
        btn_close: "Close (Esc)",
        modal_transfer_header: "Internal Transfer",
        lbl_source_account: "From (Debit):",
        lbl_dest_account: "To (Credit)",
        lbl_transfer_amount: "Transfer Amount",
        btn_do_transfer: "Execute Transfer (F10)",
        modal_new_cust: "New Customer",
        lbl_cust_name: "Full Name",
        btn_add_list: "Add to List (F10)",
        modal_edit_cust: "Edit Customer",
        msg_edit_name_warning: "Warning: Changing name updates all past records.",
        lbl_new_name: "New Name",
        lbl_new_phone: "New Phone",
        btn_save_changes: "Save Changes (F10)",
        modal_all_acc_status: "All Accounts Status",
        msg_click_to_view: "* Click on a customer card to view ledger.",
        header_settings: "System Settings",
        lbl_print_settings: "Print Settings",
        lbl_print_header_opt: "Show Company Name on Header",
        lbl_initial_capital_set: "Initial Capital (Profit Calc)",
        btn_save_capital: "Save Capital",
        lbl_user_mgmt: "User Management",
        lbl_permissions: "Permissions:",
        perm_hawala: "Hawala",
        perm_exchange: "Exchange",
        perm_accounts: "Accounts",
        perm_tt: "TT Transfer",
        perm_admin: "Full Admin",
        btn_add_user: "Add User",
        lbl_add_city: "Add City",
        btn_add: "Add",
        lbl_delete_city: "Delete City",
        msg_city_has_data: "City has data. Transfer to:",
        btn_delete_city: "Delete City",
        lbl_currency_mgmt: "Currency Management",
        lbl_reset_app: "Factory Reset (Wipe Data)",
        btn_full_reset: "Full Reset",
        lbl_change_pass: "Change My Password",
        btn_change_pass: "Change Password"
    },
    tr: {
        dir: 'ltr',
        app_title: "Heratiha Dรถviz",
        company_subtitle: "Para Transfer ve Dรถviz Hizmetleri",
        login_btn: "Giriล (Enter)",
        login_error: "Hatalฤฑ Bilgi",
        loading_db: "Veritabanฤฑ Yรผkleniyor...",
        nav_dashboard: "๐ Gรถsterge Paneli",
        nav_hawala: "โ๏ธ Havale (F2)",
        nav_accounts: "๐ฅ Mรผลteri Hesaplarฤฑ",
        nav_tt: "๐ TT Transfer",
        nav_exchange: "๐ฑ Dรถviz Alฤฑm/Satฤฑm",
        nav_crypto: "๐ช Kripto Para",
        nav_reports: "๐ Raporlar",
        nav_settings: "โ๏ธ Ayarlar",
        nav_logout: "๐ช รฤฑkฤฑล",
        lbl_initial_capital: "Kayฤฑtlฤฑ Sermaye",
        lbl_profit_loss: "Kar / Zarar",
        lbl_cash_balance: "Kasa Bakiyesi",
        lbl_crypto_assets: "Dijital Varlฤฑklar",
        lbl_city_balance: "ลehir Bakiyeleri",
        btn_refresh: "๐ Yenile",
        msg_city_balance_hint: "* Yeลil: Alacaklฤฑyฤฑz. Kฤฑrmฤฑzฤฑ: Borรงluyuz.",
        lbl_total_commissions: "Toplam Komisyonlar",
        header_hawala_manage: "Havale Yรถnetimi",
        btn_new_hawala: "โ Yeni Havale (F9)",
        lbl_filter_city: "ลehir Filtrele",
        lbl_type: "Tip",
        opt_all: "Hepsi",
        opt_outgoing: "Giden (Out)",
        opt_incoming: "Gelen (In)",
        lbl_status: "Durum",
        opt_pending: "Beklemede",
        opt_done: "Tamamlandฤฑ",
        btn_excel: "๐ Excel ฤฐndir",
        btn_print_book: "๐จ Yazdฤฑr",
        th_hawala_no: "Havale No",
        th_type: "Tip",
        th_city_book: "ลehir",
        th_amount: "Tutar",
        th_commission: "Komisyon",
        th_reg_date: "Tarih",
        th_exec_date: "ฤฐลlem Tarihi",
        th_status: "Durum",
        th_ops: "ฤฐลlem",
        header_accounts_manage: "Hesap Yรถnetimi",
        lbl_search_customer: "Mรผลteri Ara",
        btn_new_customer: "โ Yeni Mรผลteri",
        btn_deposit_withdraw: "๐ฐ Yatฤฑr/รek",
        btn_transfer: "๐ Transfer",
        btn_all_accounts: "๐ Tรผm Hesaplar",
        lbl_statement: "Ekstre:",
        btn_edit: "โ๏ธ Dรผzenle",
        btn_delete: "๐ Sil",
        btn_print: "๐จ Yazdฤฑr",
        th_date: "Tarih",
        th_desc: "Aรงฤฑklama",
        th_currency: "Dรถviz",
        th_debit: "Borรง",
        th_credit: "Alacak",
        th_balance: "Bakiye",
        header_tt_app: "TT Transfer Formu",
        opt_internal_cust: "Kayฤฑtlฤฑ Mรผลteri",
        opt_external_cust: "Nakit Mรผลteri",
        lbl_select_account: "Hesap Seรงimi",
        lbl_payer_name: "รdeyen Adฤฑ",
        lbl_phone: "Telefon",
        lbl_amount: "Tutar",
        header_beneficiary: "Alฤฑcฤฑ Bilgileri",
        lbl_ben_name: "Alฤฑcฤฑ Adฤฑ",
        lbl_desc: "Aรงฤฑklama",
        btn_submit_tt: "Onayla ve Gรถnder (F10)",
        btn_print_form: "๐จ Form Yazdฤฑr",
        header_crypto_deal: "Kripto ฤฐลlemleri",
        btn_print_receipt: "๐จ Makbuz",
        lbl_select_customer: "Mรผลteri Seรง",
        lbl_deal_type: "ฤฐลlem Tipi",
        opt_buy: "Alฤฑล",
        opt_sell: "Satฤฑล",
        lbl_crypto_name: "Kripto (USDT)",
        lbl_volume: "Miktar",
        lbl_payment_curr: "รdeme Birimi",
        lbl_total_fiat: "Toplam Tutar",
        lbl_cost_basis: "Maliyet (Kar Hesaplama)",
        btn_submit_deal: "Kaydet (F10)",
        header_fx_deal: "Dรถviz ฤฐลlemi",
        btn_fx_buy: "ALIล",
        btn_fx_sell: "SATIล",
        lbl_rate: "Kur:",
        lbl_total: "Sonuรง",
        lbl_cash_balance_after: "ฤฐลlem Sonrasฤฑ Kasa",
        lbl_desc_opt: "Not",
        lbl_cost_basis_fx: "Kar Hesaplama (Opsiyonel)",
        header_backup: "Yedekleme",
        btn_download_backup: "โฌ๏ธ ฤฐndir",
        btn_restore_backup: "โฌ๏ธ Yรผkle",
        header_journal: "ฤฐลlem Gรผnlรผฤรผ",
        btn_print_log: "๐จ Gรผnlรผk Yazdฤฑr",
        th_time: "Saat",
        th_section: "Bรถlรผm",
        th_user: "Kullanฤฑcฤฑ",
        modal_new_hawala: "Yeni Havale",
        lbl_operation_type: "ฤฐลlem Tรผrรผ",
        opt_outgoing_full: "Gรถnderim",
        opt_incoming_full: "Alฤฑm",
        lbl_city_book: "ลehir Kitabฤฑ",
        lbl_currency: "Para Birimi",
        lbl_commission: "Komisyon",
        lbl_sender: "Gรถnderen",
        lbl_receiver: "Alฤฑcฤฑ",
        lbl_id_card: "Kimlik No",
        btn_cancel: "ฤฐptal",
        btn_issue_hawala: "Oluลtur",
        modal_edit_hawala: "Havale Dรผzenle",
        msg_security_warning: "Gรผvenlik: Tutar deฤiลtirilemez.",
        lbl_amount_fixed: "Tutar (Sabit)",
        lbl_currency_fixed: "Para Birimi (Sabit)",
        btn_save_edit: "Kaydet",
        modal_tx_header: "Hesap ฤฐลlemi",
        lbl_account_party: "Hesap Sahibi",
        opt_deposit: "Para Yatฤฑrma",
        opt_withdraw: "Para รekme",
        btn_submit_tx: "Onayla",
        btn_close: "Kapat",
        modal_transfer_header: "Transfer",
        lbl_source_account: "Gรถnderen:",
        lbl_dest_account: "Alฤฑcฤฑ:",
        lbl_transfer_amount: "Tutar",
        btn_do_transfer: "Transfer Et",
        modal_new_cust: "Yeni Mรผลteri",
        lbl_cust_name: "Ad Soyad",
        btn_add_list: "Ekle",
        modal_edit_cust: "Mรผลteri Dรผzenle",
        msg_edit_name_warning: "Uyarฤฑ: ฤฐsim deฤiลirse eski kayฤฑtlar da gรผncellenir.",
        lbl_new_name: "Yeni ฤฐsim",
        lbl_new_phone: "Yeni Telefon",
        btn_save_changes: "Kaydet",
        modal_all_acc_status: "Hesap Durumlarฤฑ",
        msg_click_to_view: "* Detay iรงin tฤฑklayฤฑn",
        header_settings: "Ayarlar",
        lbl_print_settings: "Yazdฤฑrma Ayarlarฤฑ",
        lbl_print_header_opt: "Baลlฤฑkta ลirket Adฤฑ Gรถster",
        lbl_initial_capital_set: "Baลlangฤฑรง Sermayesi",
        btn_save_capital: "Kaydet",
        lbl_user_mgmt: "Kullanฤฑcฤฑ Yรถnetimi",
        lbl_permissions: "Yetkiler:",
        perm_hawala: "Havale",
        perm_exchange: "Dรถviz",
        perm_accounts: "Hesaplar",
        perm_tt: "TT",
        perm_admin: "Yรถnetici",
        btn_add_user: "Ekle",
        lbl_add_city: "ลehir Ekle",
        btn_add: "Ekle",
        lbl_delete_city: "ลehir Sil",
        msg_city_has_data: "Bu ลehirde veri var. Transfer et:",
        btn_delete_city: "Sil",
        lbl_currency_mgmt: "Dรถviz Yรถnetimi",
        lbl_reset_app: "Sฤฑfฤฑrla",
        btn_full_reset: "Tam Sฤฑfฤฑrlama",
        lbl_change_pass: "ลifre Deฤiลtir",
        btn_change_pass: "Deฤiลtir"
    },
    ar: {
        dir: 'rtl',
        app_title: "ุตุฑุงูุฉ ุงููุฑุงุชููู",
        company_subtitle: "ุดุฑูุฉ ูุฑุงุช ููุฎุฏูุงุช ุงููุงููุฉ ูุงูุตุฑุงูุฉ",
        login_btn: "ุฏุฎูู (Enter)",
        login_error: "ุจูุงูุงุช ุฎุงุทุฆุฉ",
        loading_db: "ุฌุงุฑ ุชุญููู ูุงุนุฏุฉ ุงูุจูุงูุงุช...",
        nav_dashboard: "๐ ููุญุฉ ุงูุชุญูู",
        nav_hawala: "โ๏ธ ุงูุญูุงูุงุช (F2)",
        nav_accounts: "๐ฅ ุญุณุงุจุงุช ุงูุนููุงุก (F3)",
        nav_tt: "๐ ุญูุงูุงุช ุฎุงุฑุฌูุฉ (TT)",
        nav_exchange: "๐ฑ ุจูุน ูุดุฑุงุก (FX)",
        nav_crypto: "๐ช ุงูุนููุงุช ุงูุฑูููุฉ",
        nav_reports: "๐ ุงูุชูุงุฑูุฑ",
        nav_settings: "โ๏ธ ุงูุฅุนุฏุงุฏุงุช",
        nav_logout: "๐ช ุฎุฑูุฌ",
        lbl_initial_capital: "ุฑุฃุณ ุงููุงู ุงููุณุฌู",
        lbl_profit_loss: "ุงูุฑุจุญ / ุงูุฎุณุงุฑุฉ",
        lbl_cash_balance: "ุฑุตูุฏ ุงูุตูุฏูู ุงูููุฏู",
        lbl_crypto_assets: "ุงูุฃุตูู ุงูุฑูููุฉ",
        lbl_city_balance: "ุฃุฑุตุฏุฉ ุงููุฏู ูุงููุฑูุน",
        btn_refresh: "๐ ุชุญุฏูุซ",
        msg_city_balance_hint: "* ุงูุฃุฎุถุฑ: ููุงุ ุงูุฃุญูุฑ: ุนูููุง.",
        lbl_total_commissions: "ูุฌููุน ุงูุนูููุงุช (ุงูุฑุจุญ ุงูุตุงูู)",
        header_hawala_manage: "ุฅุฏุงุฑุฉ ุงูุญูุงูุงุช",
        btn_new_hawala: "โ ุญูุงูุฉ ุฌุฏูุฏุฉ (F9)",
        lbl_filter_city: "ููุชุฑ ุงููุฏููุฉ",
        lbl_type: "ุงูููุน",
        opt_all: "ุงููู",
        opt_outgoing: "ุตุงุฏุฑุฉ",
        opt_incoming: "ูุงุฑุฏุฉ",
        lbl_status: "ุงูุญุงูุฉ",
        opt_pending: "ููุฏ ุงูุงูุชุธุงุฑ",
        opt_done: "ููุชููุฉ",
        btn_excel: "๐ ููู ุฅูุณู",
        btn_print_book: "๐จ ุทุจุงุนุฉ ุงููุดู",
        th_hawala_no: "ุฑูู ุงูุญูุงูุฉ",
        th_type: "ุงูููุน",
        th_city_book: "ุงููุฏููุฉ",
        th_amount: "ุงููุจูุบ",
        th_commission: "ุงูุนูููุฉ",
        th_reg_date: "ุงูุชุงุฑูุฎ",
        th_exec_date: "ุชุงุฑูุฎ ุงูุชูููุฐ",
        th_status: "ุงูุญุงูุฉ",
        th_ops: "ุนูููุงุช",
        header_accounts_manage: "ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช",
        lbl_search_customer: "ุจุญุซ ุนู ุนููู",
        btn_new_customer: "โ ุนููู ุฌุฏูุฏ",
        btn_deposit_withdraw: "๐ฐ ุฅูุฏุงุน/ุณุญุจ",
        btn_transfer: "๐ ุชุญููู",
        btn_all_accounts: "๐ ุฌููุน ุงูุฃุฑุตุฏุฉ",
        lbl_statement: "ูุดู ุญุณุงุจ:",
        btn_edit: "โ๏ธ ุชุนุฏูู",
        btn_delete: "๐ ุญุฐู",
        btn_print: "๐จ ุทุจุงุนุฉ",
        th_date: "ุงูุชุงุฑูุฎ",
        th_desc: "ุงูุจูุงู",
        th_currency: "ุงูุนููุฉ",
        th_debit: "ูุฏูู (ุนููู)",
        th_credit: "ุฏุงุฆู (ูู)",
        th_balance: "ุงูุฑุตูุฏ",
        header_tt_app: "ุทูุจ ุญูุงูุฉ ุฎุงุฑุฌูุฉ (TT)",
        opt_internal_cust: "ุนููู ูุณุฌู",
        opt_external_cust: "ุนููู ููุฏู",
        lbl_select_account: "ุงุฎุชุฑ ุงูุญุณุงุจ (ุฎุตู)",
        lbl_payer_name: "ุงุณู ุงูุฏุงูุน (ููุฏู)",
        lbl_phone: "ุฑูู ุงููุงุชู",
        lbl_amount: "ุงููุจูุบ",
        header_beneficiary: "ุจูุงูุงุช ุงููุณุชููุฏ",
        lbl_ben_name: "ุงุณู ุงููุณุชููุฏ",
        lbl_desc: "ููุงุญุธุงุช ุฅุถุงููุฉ",
        btn_submit_tt: "ุชุฃููุฏ ุงูุทูุจ (F10)",
        btn_print_form: "๐จ ุทุจุงุนุฉ ุงูุงุณุชูุงุฑุฉ",
        header_crypto_deal: "ุงูุนููุงุช ุงููุดูุฑุฉ (Crypto)",
        btn_print_receipt: "๐จ ุฅูุตุงู",
        lbl_select_customer: "ุงุฎุชุฑ ุงูุนููู",
        lbl_deal_type: "ููุน ุงูุนูููุฉ",
        opt_buy: "ุดุฑุงุก",
        opt_sell: "ุจูุน",
        lbl_crypto_name: "ุงุณู ุงูุนููุฉ (USDT)",
        lbl_volume: "ุงููููุฉ",
        lbl_payment_curr: "ุนููุฉ ุงูุฏูุน/ุงููุจุถ",
        lbl_total_fiat: "ุงููุจูุบ ุงูุฅุฌูุงูู",
        lbl_cost_basis: "ุณุนุฑ ุงูุดุฑุงุก (ูุญุณุงุจ ุงูุฑุจุญ)",
        btn_submit_deal: "ุชูููุฐ (F10)",
        header_fx_deal: "ุดุงุดุฉ ุงูุตุฑุงูุฉ (FX)",
        btn_fx_buy: "ุดุฑุงุก (BUY)",
        btn_fx_sell: "ุจูุน (SELL)",
        lbl_rate: "ุงูุณุนุฑ:",
        lbl_total: "ุงูุฅุฌูุงูู",
        lbl_cash_balance_after: "ุงูุฑุตูุฏ ุจุนุฏ ุงูุนูููุฉ",
        lbl_desc_opt: "ููุงุญุธุงุช",
        lbl_cost_basis_fx: "ุญุณุงุจ ุงูุฑุจุญ ุงููุญุธู",
        header_backup: "ุงููุณุฎ ุงูุงุญุชูุงุทู",
        btn_download_backup: "โฌ๏ธ ุชุญููู ูุณุฎุฉ",
        btn_restore_backup: "โฌ๏ธ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ",
        header_journal: "ุณุฌู ุงูุนูููุงุช (Journal)",
        btn_print_log: "๐จ ุทุจุงุนุฉ ุงูุณุฌู",
        th_time: "ุงูููุช",
        th_section: "ุงููุณู",
        th_user: "ุงููุณุชุฎุฏู",
        modal_new_hawala: "ุชุณุฌูู ุญูุงูุฉ ุฌุฏูุฏุฉ",
        lbl_operation_type: "ููุน ุงูุนูููุฉ",
        opt_outgoing_full: "ุฅุฑุณุงู (ุตุงุฏุฑุฉ)",
        opt_incoming_full: "ุงุณุชูุงู (ูุงุฑุฏุฉ)",
        lbl_city_book: "ุฏูุชุฑ ุงููุฏููุฉ",
        lbl_currency: "ุงูุนููุฉ",
        lbl_commission: "ุงูุนูููุฉ",
        lbl_sender: "ุงุณู ุงููุฑุณู",
        lbl_receiver: "ุงุณู ุงููุณุชูู",
        lbl_id_card: "ุฑูู ุงููููุฉ",
        btn_cancel: "ุฅูุบุงุก",
        btn_issue_hawala: "ุฅุตุฏุงุฑ (F10)",
        modal_edit_hawala: "ุชุนุฏูู ุญูุงูุฉ",
        msg_security_warning: "ูุฃูุงู ุงูุตูุฏููุ ูุง ูููู ุชุบููุฑ ุงููุจูุบ.",
        lbl_amount_fixed: "ุงููุจูุบ (ุซุงุจุช)",
        lbl_currency_fixed: "ุงูุนููุฉ (ุซุงุจุชุฉ)",
        btn_save_edit: "ุญูุธ ุงูุชุนุฏูู",
        modal_tx_header: "ุญุฑูุฉ ุญุณุงุจ",
        lbl_account_party: "ุตุงุญุจ ุงูุญุณุงุจ",
        opt_deposit: "ุฅูุฏุงุน (ูุจุถ)",
        opt_withdraw: "ุณุญุจ (ุฏูุน)",
        btn_submit_tx: "ุชูููุฐ",
        btn_close: "ุฅุบูุงู",
        modal_transfer_header: "ุชุญููู ุฏุงุฎูู",
        lbl_source_account: "ูู ุญุณุงุจ:",
        lbl_dest_account: "ุฅูู ุญุณุงุจ:",
        lbl_transfer_amount: "ูุจูุบ ุงูุชุญููู",
        btn_do_transfer: "ุชุญููู",
        modal_new_cust: "ุนููู ุฌุฏูุฏ",
        lbl_cust_name: "ุงูุงุณู ุงููุงูู",
        btn_add_list: "ุฅุถุงูุฉ",
        modal_edit_cust: "ุชุนุฏูู ุจูุงูุงุช ุนููู",
        msg_edit_name_warning: "ุชูุจูู: ุชุบููุฑ ุงูุงุณู ุณูุญุฏุซ ุฌููุน ุงูุณุฌูุงุช ุงูุณุงุจูุฉ.",
        lbl_new_name: "ุงูุงุณู ุงูุฌุฏูุฏ",
        lbl_new_phone: "ุงููุงุชู ุงูุฌุฏูุฏ",
        btn_save_changes: "ุญูุธ",
        modal_all_acc_status: "ุญุงูุฉ ุงูุญุณุงุจุงุช",
        msg_click_to_view: "* ุงุถุบุท ุนูู ุงูุนููู ูุนุฑุถ ุงูุชูุงุตูู.",
        header_settings: "ุงูุฅุนุฏุงุฏุงุช",
        lbl_print_settings: "ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ",
        lbl_print_header_opt: "ุฅุธูุงุฑ ุงุณู ุงูุดุฑูุฉ ูู ุงูุทุจุงุนุฉ",
        lbl_initial_capital_set: "ุฑุฃุณ ุงููุงู ุงูุฃููู",
        btn_save_capital: "ุญูุธ",
        lbl_user_mgmt: "ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู",
        lbl_permissions: "ุงูุตูุงุญูุงุช:",
        perm_hawala: "ุงูุญูุงูุงุช",
        perm_exchange: "ุงูุตุฑุงูุฉ",
        perm_accounts: "ุงูุญุณุงุจุงุช",
        perm_tt: "TT",
        perm_admin: "ูุฏูุฑ ุงููุธุงู",
        btn_add_user: "ุฅุถุงูุฉ ูุณุชุฎุฏู",
        lbl_add_city: "ุฅุถุงูุฉ ูุฏููุฉ",
        btn_add: "ุฅุถุงูุฉ",
        lbl_delete_city: "ุญุฐู ูุฏููุฉ",
        msg_city_has_data: "ููุฌุฏ ุจูุงูุงุช ููุฐู ุงููุฏููุฉ. ุงููู ุฅูู:",
        btn_delete_city: "ุญุฐู",
        lbl_currency_mgmt: "ุฅุฏุงุฑุฉ ุงูุนููุงุช",
        lbl_reset_app: "ุถุจุท ุงููุตูุน",
        btn_full_reset: "ุญุฐู ูู ุงูุจูุงูุงุช",
        lbl_change_pass: "ุชุบููุฑ ูููุฉ ุงููุฑูุฑ",
        btn_change_pass: "ุชุบููุฑ"
    }
};

let currentLang = localStorage.getItem('heratiha_lang') || 'fa';

function setLanguage(lang) {
    if(!TRANSLATIONS[lang]) return;
    currentLang = lang;
    localStorage.setItem('heratiha_lang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = TRANSLATIONS[lang].dir;
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(`btn-lang-${lang}`);
    if(activeBtn) activeBtn.classList.add('active');
    applyTranslations();
}

function applyTranslations() {
    const t = TRANSLATIONS[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(t[key]) {
            if(el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
                el.placeholder = t[key];
            } else {
                el.innerText = t[key];
            }
        }
    });
    if(document.getElementById('mainApp').style.display === 'flex') {
        updateUI(); 
    }
}
class DBAdapter {
    constructor(dbName, version) { this.dbName = dbName; this.version = version; this.db = null; }
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                ['users', 'customers', 'cashBox', 'currencies', 'hawalas', 'accounts', 'journal', 'cities', 'initialCapital', 'cityHawalaCounters', 'fxProfit', 'settings'].forEach(store => {
                    if (!db.objectStoreNames.contains(store)) db.createObjectStore(store);
                });
            };
            request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e.target.error);
        });
    }
    async loadAll() {
        const data = {};
        const stores = ['users', 'customers', 'cashBox', 'currencies', 'hawalas', 'accounts', 'journal', 'cities', 'initialCapital', 'cityHawalaCounters', 'fxProfit', 'settings'];
        const tx = this.db.transaction(stores, 'readonly');
        const promises = stores.map(store => new Promise(resolve => {
            const req = tx.objectStore(store).get('root');
            req.onsuccess = (e) => resolve({ [store]: e.target.result });
            req.onerror = () => resolve({ [store]: null });
        }));
        (await Promise.all(promises)).forEach(res => Object.assign(data, res));
        return data;
    }
    async saveAll(dbObj) {
        const stores = Object.keys(dbObj).filter(k => ['users', 'customers', 'cashBox', 'currencies', 'hawalas', 'accounts', 'journal', 'cities', 'initialCapital', 'cityHawalaCounters', 'fxProfit', 'settings'].includes(k));
        const tx = this.db.transaction(stores, 'readwrite');
        stores.forEach(s => tx.objectStore(s).put(dbObj[s], 'root'));
        return new Promise((res, rej) => { tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); });
    }
}
const dbAdapter = new DBAdapter('heratiha_secure_db_v3', 3);

function generateSalt() { return CryptoJS.lib.WordArray.random(128/8).toString(); }
function hashPassword(pwd, salt) { return CryptoJS.PBKDF2(pwd, salt, { keySize: 256/32, iterations: 1000 }).toString(); }
function escapeHtml(text) { if (!text) return ''; return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

let db = { 
    users: [], 
    customers: [], 
    cashBox: { 'USD': 0, 'AFN': 0, 'EUR': 0 }, 
    currencies: ['USD', 'AFN', 'EUR', 'USDT', 'BTC', 'ETH'], 
    hawalas: [], 
    accounts: {}, 
    journal: [], 
    cities: [{ name: 'ฺฉุงุจู', code: 'KBL' }, { name: 'ูุฑุงุช', code: 'HRT' }], 
    initialCapital: { 'USD': 0, 'AFN': 0, 'EUR': 0 }, 
    cityHawalaCounters: {}, 
    fxProfit: {}, 
    settings: { printHeader: false } 
};

let currentUser = null; 
let fxProfit = {};
let ttType = 'internal'; 
let exType = 'external';
let hawalaCustType = 'external'; 
let cryptoCustType = 'external'; 
let fxDirection = 'Buy'; 
let fxOperator = 'multiply';
const CRYPTO_LIST = ['USDT', 'BTC', 'ETH', 'TRX', 'LTC', 'DOGE', 'BNB'];
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
}

// --- ุดุฑูุน ฺฉุฏ ุฌุฏุฏ ุจุฑุง ููู ฺฉุดู ---
function toggleGroup(id) {
    const submenu = document.getElementById(id);
    if (submenu.classList.contains('open')) {
        submenu.classList.remove('open');
    } else {
        document.querySelectorAll('.submenu').forEach(el => el.classList.remove('open'));
        submenu.classList.add('open');
    }
}
// --- ูพุงุงู ฺฉุฏ ุฌุฏุฏ ---
function getPrintHeaderHTML() {
    if (!db.settings || db.settings.printHeader === false) return '';
    const title = db.settings.companyName || "ุตุฑุงู ูุฑุงุชโูุง";
    const sub = db.settings.slogan || "";
    const logoImg = db.settings.logo ? `<img src="${db.settings.logo}" class="print-logo-img">` : '';
    
    return `<div style="text-align:center; margin-bottom:10px; border-bottom:2px solid #000; padding-bottom:10px;">
                ${logoImg}
                <h2 style="margin:0; font-family:'Vazirmatn'; font-weight:900;">${title}</h2>
                <div style="font-size:12px;">${sub}</div>
                <div style="font-size:11px; margin-top:5px;">${db.settings.phone || ''} | ${db.settings.address || ''}</div>
            </div>`;
}

async function loadDB() {
    try {
        await dbAdapter.init();
        const savedData = await dbAdapter.loadAll();
        if (savedData.users && savedData.users.length > 0) { db = Object.assign(db, savedData); } 
        else { const s = generateSalt(); db.users = [{ u: 'admin', salt: s, hash: hashPassword('123456', s), perms: { hawala: true, exchange: true, accounts: true, tt: true, admin: true } }]; }
        fxProfit = db.fxProfit || {};
        if (!db.settings) db.settings = { printHeader: false };
if (!db.avgRates) db.avgRates = {};
        db.currencies.forEach(c => { if (db.cashBox[c] === undefined) db.cashBox[c] = 0; if (db.initialCapital[c] === undefined) db.initialCapital[c] = 0; });
        db.cityHawalaCounters = db.cityHawalaCounters || {};
        db.cities.forEach(city => { if (!db.cityHawalaCounters[city.code]) { db.cityHawalaCounters[city.code] = { Outgoing: 1001, Incoming: 1001 }; } });
        await dbAdapter.saveAll(db);
    } catch (e) { console.error("DB Load Error", e); alert("ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ูพุงฺฏุงู ุฏุงุฏู"); }
}

async function saveDB() { db.fxProfit = fxProfit; try { await dbAdapter.saveAll(db); updateUI(); } catch (err) { console.error("Save Failed", err); alert("ุฎุทุง ุฏุฑ ุฐุฎุฑู ุงุทูุงุนุงุช!"); } }

function go(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if (pageId === 'hawala' && !currentUser.perms.hawala && !currentUser.perms.admin) return;
    if (pageId === 'accounts' && !currentUser.perms.accounts && !currentUser.perms.admin) return;
    if (pageId === 'exchange' && !currentUser.perms.exchange && !currentUser.perms.admin) return;
    if (pageId === 'ttPage' && !currentUser.perms.tt && !currentUser.perms.admin) return;
    const targetPage = document.getElementById(pageId);
    targetPage.classList.add('active');
    const btn = document.querySelector(`.nav-btn[onclick="go('${pageId}')"]`);
    if(btn) btn.classList.add('active');
    const t = TRANSLATIONS[currentLang];
    let titleKey = "";
    switch(pageId) {
        case 'dashboard': titleKey = 'nav_dashboard'; break;
        case 'hawala': titleKey = 'nav_hawala'; break;
        case 'accounts': titleKey = 'nav_accounts'; break;
        case 'exchange': titleKey = 'nav_exchange'; break;
        case 'ttPage': titleKey = 'nav_tt'; break;
        case 'cryptoFX': titleKey = 'nav_crypto'; break;
        case 'reports': titleKey = 'nav_reports'; break;
    }
    let titleText = t[titleKey] || pageId;
    document.getElementById('pageTitle').innerText = titleText;
    updateUI();
    setTimeout(() => { const firstInput = targetPage.querySelector('input, select'); if(firstInput) firstInput.focus(); }, 100);
}

function openModal(id) { const modal = document.getElementById(id); modal.style.display = 'flex'; setTimeout(() => { const firstInput = modal.querySelector('input:not([type="hidden"]), select'); if(firstInput) firstInput.focus(); }, 100); }
function closeModal(id) { const modal = document.getElementById(id); modal.style.display = 'none'; modal.querySelectorAll('input').forEach(inp => inp.value = ''); modal.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0); }

function logTx(section, desc, amt, type = null, data = null) { db.journal.push({ id: Date.now() + Math.random(), time: new Date().getTime(), section: section, desc: desc, amt: amt, user: currentUser.u, type: type, data: data }); }

async function init() {
    setLanguage(currentLang);
    const loadingMsg = document.getElementById('loadingMsg'); loadingMsg.style.display = 'block';
    await loadDB(); loadingMsg.style.display = 'none';
    document.getElementById('displayDate').innerText = new Date().toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');
    document.addEventListener('keydown', handleGlobalKeydown);
}

function handleGlobalKeydown(e) {
    if (e.key === 'Enter') {
        const target = e.target;
        if (target.tagName === 'BUTTON') return;
        if (target.tagName === 'TEXTAREA' && !e.shiftKey) { e.preventDefault(); } else if (target.tagName !== 'TEXTAREA') { e.preventDefault(); }
        const formElements = Array.from(document.querySelectorAll('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled])')).filter(el => { return el.offsetWidth > 0 && el.offsetHeight > 0 && el.closest('.modal') === document.querySelector('.modal[style*="flex"]') || (!document.querySelector('.modal[style*="flex"]') && el.closest('.page.active')); });
        const index = formElements.indexOf(target);
        if (index > -1 && index < formElements.length - 1) { formElements[index + 1].focus(); } else if (index === formElements.length - 1) { handleF10(); }
    }
    if (e.key.startsWith('F')) {
        const key = e.key;
        if(['F1','F2','F3','F4','F6','F9','F10'].includes(key)) e.preventDefault();
        switch (key) {
            case 'F1': go('dashboard'); break;
            case 'F2': go('hawala'); break;
            case 'F3': go('accounts'); break;
            case 'F4': go('exchange'); break;
            case 'F6': go('ttPage'); break;
            case 'F9': handleF9(); break; 
            case 'F10': handleF10(); break; 
        }
    }
    if (e.key === 'Escape') { document.querySelectorAll('.modal').forEach(m => { if(m.style.display === 'flex') { const closeBtn = m.querySelector('.close-icon'); if(closeBtn) closeBtn.click(); else m.style.display = 'none'; } }); }
}
function handleF9() {
    if (document.querySelector('.modal[style*="flex"]')) return;
    const activePage = document.querySelector('.page.active').id;
    if (activePage === 'hawala') openModal('modalNewHawala');
    else if (activePage === 'accounts') openModal('modalNewCust');
    else if (activePage === 'exchange') document.getElementById('fxBaseAmt').focus();
    else if (activePage === 'ttPage') document.getElementById('ttAmt').focus();
}

function handleF10() {
    const openModals = document.querySelectorAll('.modal');
    for (let m of openModals) {
        if (m.style.display === 'flex' || getComputedStyle(m).display === 'flex') {
            if (m.id === 'modalNewHawala') submitHawala();
            else if (m.id === 'modalEditHawala') submitEditHawala();
            else if (m.id === 'modalTx') submitTx();
            else if (m.id === 'modalClientTransfer') submitClientTransfer();
            else if (m.id === 'modalNewCust') addCustomer();
            else if (m.id === 'modalEditCust') submitEditCustomer();
            return;
        }
    }
    const activePage = document.querySelector('.page.active').id;
    if (activePage === 'exchange') submitExchange();
    else if (activePage === 'cryptoFX') submitCryptoFx();
    else if (activePage === 'ttPage') submitNewTT();
}

function auth() {
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value;
    const user = db.users.find(x => x.u === u);
    document.getElementById('loginErr').style.display = 'none';
    if (user && hashPassword(p, user.salt) === user.hash) {
        currentUser = user; 
        document.getElementById('loginPage').style.display = 'none'; 
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('sidebarUserInfo').innerText = `${u}`;
        applyPermissions(); 
        go('dashboard'); 
        applyTranslations();
        return;
    } 
    document.getElementById('loginErr').style.display = 'block';
}

function logout() { location.reload(); }
function applyPermissions() {
    const isFullAdmin = currentUser?.perms.admin; 
    document.querySelectorAll('.admin-only-btn').forEach(el => { el.style.display = isFullAdmin ? 'flex' : 'none'; });
    document.querySelectorAll('.admin-only-view').forEach(el => { if(!isFullAdmin) el.classList.remove('active'); });
    document.querySelectorAll('.admin-only-col').forEach(el => { el.style.display = isFullAdmin ? 'table-cell' : 'none'; });
    const settingsAdminSection = document.getElementById('settingsAdminSection');
    if (settingsAdminSection) settingsAdminSection.style.display = isFullAdmin ? 'block' : 'none';
    if (!isFullAdmin) {
        if(!currentUser.perms.hawala) {
             const btn = document.querySelector("button[onclick=\"go('hawala')\"]");
             if(btn) btn.style.display = 'none';
        }
        if(!currentUser.perms.accounts) {
             const btn = document.querySelector("button[onclick=\"go('accounts')\"]");
             if(btn) btn.style.display = 'none';
        }
    }
    if (isFullAdmin) renderUserManagement();
}

function updateUI() {
    const t = TRANSLATIONS[currentLang];
    const currOptions = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    // ุงุถุงูู ุดุฏู hCommCurr ุจู ูุณุช ุฒุฑ
    document.querySelectorAll('#hCurr, #editHCurr, #txCurr, #exSellCurr, #exBuyCurr, #cryptoCurr, #ttCurr, #ctCurr, #fxBaseCurr, #fxQuoteCurr, #hCommCurr').forEach(select => { 
        select.innerHTML = currOptions; 
    });
    const cityOptions = db.cities.map(c => `<option value="${c.code}">${escapeHtml(c.name)}</option>`).join('');
    document.querySelectorAll('#hCityBook, #editHCityBook').forEach(select => { select.innerHTML = cityOptions; });
    document.getElementById('filterHCity').innerHTML = `<option value="All">${t.opt_all || 'All'}</option>` + cityOptions;
    document.getElementById('cityToDelete').innerHTML = `<option value="">...</option>` + cityOptions;
    document.getElementById('cityTransferTarget').innerHTML = cityOptions;
    const custOptions = db.customers.map(c => `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
    document.querySelectorAll('#selCustomer, #txCust, #ttCustomer, #hCustomerSelect, #cryptoCustomer, #exCustomer').forEach(sel => { 
        sel.innerHTML = `<option value="">...</option>` + custOptions; 
    });
    document.getElementById('ctReceiver').innerHTML = custOptions;
    const currToDelete = document.getElementById('currToDelete'); 
    if (currToDelete) currToDelete.innerHTML = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    
    // ููุงุด ูพุดโููุงุด ููฺฏู
    if(db.settings && db.settings.logo) {
        const img = document.getElementById('logoPreview');
        if(img) { img.src = db.settings.logo; img.style.display = 'block'; }
    }

    if(document.getElementById('hawala').classList.contains('active')) filterHawala(); 
    if(document.getElementById('accounts').classList.contains('active')) loadCustomerLedger();
    if(document.getElementById('dashboard').classList.contains('active')) renderDashboard();
    if (db.settings) {
        if(document.getElementById('reports').classList.contains('active')) renderJournal();
        if(document.getElementById('setCompName')) document.getElementById('setCompName').value = db.settings.companyName || '';
        if(document.getElementById('setCompSlogan')) document.getElementById('setCompSlogan').value = db.settings.slogan || '';
        if(document.getElementById('setCompPhone')) document.getElementById('setCompPhone').value = db.settings.phone || '';
        if(document.getElementById('setCompAddress')) document.getElementById('setCompAddress').value = db.settings.address || '';
        if(document.getElementById('setCompFooter')) document.getElementById('setCompFooter').value = db.settings.footerMsg || '';
        applyCompanySettings();
    }
}
async function togglePrintHeaderSetting() { if (!db.settings) db.settings = {}; db.settings.printHeader = document.getElementById('printHeaderOpt').checked; await saveDB(); }
// --- ุดุฑูุน ฺฉุฏ ุขูุงูุฒ ุณุฑูุงู ---
// 1. ุงู ุชุงุจุน ฺฉู ุฌุฏูู ุขูุงูุฒ ุฑุง ู ุณุงุฒุฏ (ุชุบุฑ ฺฉุฑุฏู)
function renderAnalysis() {
    const tbody = document.getElementById('analysisBody');
    tbody.innerHTML = '';
    
    // 1. ูุญุงุณุจู ูุงูุฏู ุญุณุงุจ ูุดุชุฑุงู
    let customerBalances = {};
    for (let custName in db.accounts) {
        db.accounts[custName].forEach(tx => {
            if (!customerBalances[tx.curr]) customerBalances[tx.curr] = 0;
            // ุจุฏูฺฉุงุฑ (+) ุนู ูุดุชุฑ ุจุงุฏ ุจุฏูุฏุ ุจุณุชุงูฺฉุงุฑ (-) ุนู ูุง ุจุงุฏ ุจุฏูู
            customerBalances[tx.curr] += (tx.debit - tx.credit);
        });
    }

    // 2. ูุญุงุณุจู ูุงูุฏู ฺฉุชุงุจ ุญูุงูู (ุงุตูุงุญ ุดุฏู)
    let cityBalances = {};
    db.hawalas.forEach(h => {
        if (!cityBalances[h.curr]) cityBalances[h.curr] = 0;
        
        // ููุท ูุจูุบ ุงุตู ุญูุงูู (amt) ุฑู ุญุณุงุจ ุดูุฑ ุชุงุซุฑ ูโฺฏุฐุงุฑุฏ
        if (h.type === 'Outgoing') {
            // ูุง ูุฑุณุชุงุฏูุ ูพุณ ุจู ููุงูุฏู ุจุฏูฺฉุงุฑ ุดุฏู (ูพูู ููุฏ ฺฏุฑูุชู)
            cityBalances[h.curr] += h.amt; 
        } 
        else if (h.type === 'Incoming') {
            // ูุง ุฏุฑุงูุช ฺฉุฑุฏู (ุจุงุฏ ูพุฑุฏุงุฎุช ฺฉูู)ุ ูพุณ ุงุฒ ููุงูุฏู ุทูุจฺฉุงุฑ ุดุฏู
            cityBalances[h.curr] -= h.amt; 
        } 
        
        // *** ุฎุท ุงุดุชุจุงู ูุจู ุญุฐู ุดุฏ ***
        // ุฏฺฏุฑ ฺฉูุดู ุจู ุญุณุงุจ ุดูุฑ ุงุถุงูู ููโุดูุฏ ฺูู ุณูุฏ ุดูุงุณุช ู ุฏุฑ ุตูุฏูู ููุฌูุฏ ุงุณุช.
    });

    // 3. ููุงุด ุฌุฏูู
    let grandTotalUSD = 0;

    db.currencies.forEach(curr => {
        // ููุฌูุฏ ูุฒฺฉ + ุณุฑูุงู ุงููู
        const cash = (db.cashBox[curr] || 0) + (db.initialCapital[curr] || 0);
        
        // ุทูุจ ูุง ุงุฒ ูุดุชุฑุงู (ุงฺฏุฑ ูุซุจุช ุจุงุดุฏ ุณุฑูุงู ูุงุณุช)
        // ุงูุง ุฏุฑ ูุฑููู ุฎุงูุต: (ุตูุฏูู) - (ุจุฏู ุจู ูุฑุฏู/ููุงูุฏู)
        // ุงฺฏุฑ customerBalances ูุซุจุช ุจุงุดุฏ ุนู ูุดุชุฑ ุจุฏูฺฉุงุฑ ุงุณุช (ุฏุงุฑุง ูุง)
        // ุงฺฏุฑ cityBalances ูุซุจุช ุจุงุดุฏ ุนู ูุง ุจู ููุงูุฏู ุจุฏูฺฉุงุฑู (ุจุฏู ูุง)
        
        const custBal = customerBalances[curr] || 0; 
        const cityBal = cityBalances[curr] || 0;

        // ูุฑููู ุตุญุญ ุณุฑูุงู ุฎุงูุต:
        // ููุฌูุฏ ููุฏ + (ุทูุจ ุงุฒ ูุดุชุฑ) - (ุจุฏู ุจู ููุงูุฏู)
        // ูฺฉุชู: ุฏุฑ ุงู ุณุณุชู debt/credit ุทูุฑ ุชูุธู ุดุฏู ฺฉู:
        // custBal ูุซุจุช = ูุดุชุฑ ุจุฏูฺฉุงุฑ ุงุณุช (ูพูู ูุง ุฏุณุช ูุฑุฏู) -> ุจุงุฏ ุฌูุน ุดูุฏ
        // cityBal ูุซุจุช = ูุง ุจุฏูฺฉุงุฑู (ูพูู ููุงูุฏู ุฏุณุช ูุง) -> ุจุงุฏ ฺฉู ุดูุฏ
        
        // ุงูุง ุจุฑุง ุณุงุฏฺฏ ุฏุฑ ฺฉุฏ ูุจู ุงุฒ ููุทู Cash - Obligations ุงุณุชูุงุฏู ุดุฏู ุจูุฏ.
        // ุจุงุฏ ููุทู ุตุญุญ ุญุณุงุจุฏุงุฑ ุฑุง ูพุงุฏู ฺฉูู:
        // Net = Cash + (Receivables) - (Payables)
        
        // ุฏุฑ ุณุณุชู ุดูุง:
        // custBal: (debit - credit). ูุซุจุช ุนู ูุดุชุฑ ุจุฏูฺฉุงุฑ ุงุณุช. (ุงู ุฏุงุฑุง ุงุณุช +)
        // cityBal: (Outgoing - Incoming). ูุซุจุช ุนู ูุง ูพูู ฺฏุฑูุชู ูุฑุณุชุงุฏู (ุจุฏูฺฉุงุฑู ุจู ููุงูุฏู). (ุงู ุจุฏู ุงุณุช -)
        
        const netCapital = cash + custBal - cityBal;

        // ูุฑุฎ ูพุด ูุฑุถ
        let defaultRate = '';
        if(db.avgRates && db.avgRates[curr]) defaultRate = db.avgRates[curr];
        else if(curr === 'USD' || curr === 'USDT' || curr === 'DAI') defaultRate = '1';
        
        let op = 'multiply';
        if(curr !== 'EUR' && curr !== 'GBP' && curr !== 'KWD' && curr !== 'USD' && curr !== 'USDT') {
             op = 'divide'; 
        }
        if(curr === 'USD' || curr === 'USDT') op = 'multiply';

        const opIcon = op === 'multiply' ? 'โ' : 'โ';
        const opColor = op === 'multiply' ? 'var(--text-muted)' : 'var(--gold-primary)';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold">${curr}</td>
            <td dir="ltr" style="color:${cash >= 0 ? 'var(--text-main)' : 'var(--danger)'}">${cash.toLocaleString()}</td>
            <td dir="ltr" style="color:${custBal >= 0 ? 'var(--success)' : 'var(--danger)'}">${custBal.toLocaleString()}</td>
            <td dir="ltr" style="color:${cityBal >= 0 ? 'var(--danger)' : 'var(--success)'}">${cityBal.toLocaleString()}</td>
            <td dir="ltr" style="font-weight:900; background:rgba(212,175,55,0.05); color:${netCapital >= 0 ? 'var(--gold-primary)' : 'var(--danger)'}">${netCapital.toLocaleString()}</td>
            <td>
                <div style="display:flex; align-items:center; gap:5px">
                    <button class="btn btn-outline btn-sm no-print" 
                            style="padding:2px 8px; font-size:14px; color:${opColor}; border-color:${opColor}" 
                            id="btnOp_${curr}" 
                            data-op="${op}"
                            onclick="toggleAnalysisOp(this, '${curr}', ${netCapital})">
                        ${opIcon}
                    </button>
                    <input type="number" class="input" style="margin:0; text-align:center; direction:ltr" 
                           placeholder="Rate..." value="${defaultRate}" id="rate_${curr}" 
                           oninput="calculateRowUSD('${curr}', ${netCapital})">
                </div>
            </td>
            <td dir="ltr" style="font-weight:bold" id="usdResult_${curr}">0</td>
        `;
        tbody.appendChild(tr);
        
        setTimeout(() => calculateRowUSD(curr, netCapital), 100);
    });
}
function toggleAnalysisOp(btn, curr, netCapital) {
    const currentOp = btn.getAttribute('data-op');
    if(currentOp === 'multiply') {
        btn.setAttribute('data-op', 'divide');
        btn.innerText = 'โ';
        btn.style.color = 'var(--gold-primary)';
        btn.style.borderColor = 'var(--gold-primary)';
    } else {
        btn.setAttribute('data-op', 'multiply');
        btn.innerText = 'โ';
        btn.style.color = 'var(--text-muted)';
        btn.style.borderColor = 'var(--text-muted)';
    }
    calculateRowUSD(curr, netCapital);
}

// 3. ุชุงุจุน ูุญุงุณุจู ฺฉู ุญุงูุง ุจู ุฏฺฉูู ูฺฏุงู ู ฺฉูุฏ (ุถุฑุจ ุง ุชูุณู)
function calculateRowUSD(curr, netCapital) {
    const rateInput = document.getElementById(`rate_${curr}`).value;
    const resultCell = document.getElementById(`usdResult_${curr}`);
    const btnOp = document.getElementById(`btnOp_${curr}`);
    const op = btnOp ? btnOp.getAttribute('data-op') : 'multiply';
    
    if (rateInput && !isNaN(rateInput)) {
        const rate = parseFloat(rateInput);
        let totalUSD = 0;
        
        if(op === 'multiply') {
            totalUSD = netCapital * rate;
        } else {
            // ุฌููฺฏุฑ ุงุฒ ุชูุณู ุจุฑ ุตูุฑ
            if(rate !== 0) totalUSD = netCapital / rate;
        }

        resultCell.innerText = totalUSD.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
        resultCell.style.color = totalUSD >= 0 ? 'var(--success)' : 'var(--danger)';
        resultCell.dataset.value = totalUSD; 
    } else {
        resultCell.innerText = "0";
        resultCell.dataset.value = 0;
    }
    updateGrandTotal();
}
function updateGrandTotal() {
    let total = 0;
    db.currencies.forEach(c => {
        const cell = document.getElementById(`usdResult_${c}`);
        if(cell && cell.dataset.value) {
            total += parseFloat(cell.dataset.value);
        }
    });
    document.getElementById('grandTotalUSD').innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " $";
}
function renderDashboard() { 
    // --- ูุญุงุณุจู ุณูุฏ ฺฉู (ูุซู ูุจู) ---
    let totalProfit = {}; 
    for (const c in fxProfit) { 
        if (fxProfit[c] !== 0) totalProfit[c] = (totalProfit[c] || 0) + fxProfit[c]; 
    }

    // --- ูุญุงุณุจู ุณูุฏ ุงูุฑูุฒ (ุจุฎุด ุฌุฏุฏ) ---
    let dailyProfit = {};
    const startOfDay = new Date();
    startOfDay.setHours(0,0,0,0); // ุชูุธู ุณุงุนุช ุฑู 12 ุดุจ
    const startTime = startOfDay.getTime();

    // ุจุฑุฑุณ ุฏูุชุฑ ุฑูุฒูุงูู ุจุฑุง ูพุฏุง ฺฉุฑุฏู ุณูุฏูุง ุงูุฑูุฒ
    db.journal.forEach(log => {
        if (log.time >= startTime) {
            // ุงฺฏุฑ ูุนุงููู ุงุฑุฒ (EXCHANGE) ุจูุฏ
            if (log.type === 'EXCHANGE' && log.data && log.data.profit) {
                const curr = log.data.quoteCurr; // ุณูุฏ ูุนูููุง ุจู ุงุฑุฒ ุฏูู (ูุซู ุงูุบุงู) ุงุณุช
                if(curr) dailyProfit[curr] = (dailyProfit[curr] || 0) + log.data.profit;
            }
            // ุงฺฏุฑ ูุนุงููู ฺฉุฑูพุชู (CRYPTO) ุจูุฏ
            if (log.type === 'CRYPTO' && log.data && log.data.profit) {
                const curr = log.data.curr; 
                if(curr) dailyProfit[curr] = (dailyProfit[curr] || 0) + log.data.profit;
            }
        }
    });

    // --- ููุงุด ุณุฑูุงู ุงููู ---
    let initHtml = ''; 
    db.currencies.forEach(c => { 
        if (db.initialCapital[c] > 0) initHtml += `<span style="margin-left:10px">${db.initialCapital[c].toLocaleString()} ${c}</span>`; 
    });
    document.getElementById('dispInitialCap').innerHTML = initHtml || `<span style="opacity:0.6">-</span>`;

    // --- ููุงุด ุณูุฏ ฺฉู ---
    let profitHtml = ''; 
    for (const c in totalProfit) { 
        const val = totalProfit[c]; 
        if (Math.abs(val) > 0.001) { 
            const color = val >= 0 ? 'var(--success)' : 'var(--danger)'; 
            profitHtml += `<div style="color:${color}; direction:ltr">${val >= 0 ? '+' : ''}${val.toLocaleString()} ${c}</div>`; 
        } 
    }
    document.getElementById('dispProfit').innerHTML = profitHtml || `0`;

    // --- ููุงุด ุณูุฏ ุงูุฑูุฒ (ุฌุฏุฏ) ---
    let dailyHtml = '';
    for (const c in dailyProfit) {
        const val = dailyProfit[c];
        if (Math.abs(val) > 0.001) {
            const color = val >= 0 ? '#4caf50' : '#f44336'; // ุณุจุฒ ุฑูุดู ุง ูุฑูุฒ
            dailyHtml += `<div style="color:${color}; direction:ltr">${val >= 0 ? '+' : ''}${val.toLocaleString()} ${c}</div>`;
        }
    }
    document.getElementById('dispDailyProfit').innerHTML = dailyHtml || `<span style="opacity:0.5; font-size:14px">ุจุฏูู ุณูุฏ</span>`;

    // --- ุจูู ฺฉุฏูุง ุฏุงุดุจูุฑุฏ (ููุงุด ุตูุฏูู ู ...) ---
    const cashStatsDiv = document.getElementById('cashStats'); 
    const cryptoStatsDiv = document.getElementById('cryptoStats');
    cashStatsDiv.innerHTML = ''; 
    cryptoStatsDiv.innerHTML = '';
    db.currencies.forEach(c => {
        const amount = (db.cashBox[c] || 0) + (db.initialCapital[c] || 0);
        const colorClass = amount < 0 ? 'var(--danger)' : 'var(--gold-primary)';
        const boxHtml = `<div class="stat-box"><div class="label" style="color:var(--text-muted); font-weight:800">${c}</div><div class="stat-val" style="color:${colorClass}">${amount.toLocaleString()}</div></div>`;
        if (CRYPTO_LIST.includes(c)) cryptoStatsDiv.innerHTML += boxHtml; 
        else cashStatsDiv.innerHTML += boxHtml;
    });

    const cityStatsDiv = document.getElementById('cityStats'); 
    cityStatsDiv.innerHTML = '';
    const cityBalances = {}; 
    const totalCommissions = {};
    db.hawalas.forEach(h => { 
        if (!cityBalances[h.cityBook]) cityBalances[h.cityBook] = {}; 
        if (!cityBalances[h.cityBook][h.curr]) cityBalances[h.cityBook][h.curr] = 0; 
        if (h.type === 'Outgoing') cityBalances[h.cityBook][h.curr] += h.amt; 
        else if (h.type === 'Incoming') cityBalances[h.cityBook][h.curr] -= h.amt; 
        if (h.comm && h.comm > 0) { 
            // ุงุตูุงุญ: ุงุณุชูุงุฏู ุงุฒ ุงุฑุฒ ุฎูุฏ ฺฉูุดูุ ูู ุงุฑุฒ ุญูุงูู
            const cC = h.commCurr || h.curr; 
            if (!totalCommissions[cC]) totalCommissions[cC] = 0; 
            totalCommissions[cC] += h.comm; 
        }
    });
    db.cities.forEach(city => {
        let balanceHtml = ''; 
        const cityBal = cityBalances[city.code];
        if (cityBal) { 
            for (const curr in cityBal) { 
                const bal = cityBal[curr]; 
                if (Math.abs(bal) > 0.001) { 
                    const color = bal >= 0 ? 'var(--success)' : 'var(--danger)'; 
                    balanceHtml += `<div style="font-size:14px; font-weight:900; color:${color}; direction:ltr">${bal >= 0 ? '+' : ''}${bal.toLocaleString()} ${curr}</div>`; 
                } 
            } 
        }
        cityStatsDiv.innerHTML += `<div class="stat-box" style="text-align:right"><div class="label" style="font-size:14px; font-weight:bold">${escapeHtml(city.name)}</div>${balanceHtml || '<div style="font-size:12px; color:gray">0</div>'}</div>`;
    });

    const commDiv = document.getElementById('cityCommissions'); 
    commDiv.innerHTML = '';
    if (Object.keys(totalCommissions).length === 0) { 
        commDiv.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:var(--text-muted); font-size:12px;">...</div>'; 
    } else { 
        for (const curr in totalCommissions) { 
            commDiv.innerHTML += `<div class="stat-box" style="background:rgba(0, 230, 118, 0.05); border-color:var(--success);"><div class="label" style="color:var(--success)">${curr}</div><div class="stat-val" style="color:var(--success)">+${totalCommissions[curr].toLocaleString()}</div></div>`; 
        } 
    }
}
function renderJournal() {
    if (!currentUser.perms.admin) return;
    const t = TRANSLATIONS[currentLang];
    const tbody = document.getElementById('journalBody');
    const logs = db.journal.sort((a, b) => b.time - a.time);
    tbody.innerHTML = logs.map(j => {
        const timeStr = new Date(j.time).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US', { hour: '2-digit', minute: '2-digit' });
        const canReverse = j.type ? true : false;
        const btnStyle = canReverse ? "btn-red" : "btn-outline";
        const btnText = canReverse ? (currentLang === 'fa' ? "ุญุฐู ู ุจุงุฒฺฏุดุช" : "Reverse") : (currentLang === 'fa' ? "ุญุฐู ูุงฺฏ" : "Delete Log");
        return `<tr><td style="font-size:11px">${timeStr}</td><td>${j.section}</td><td>${escapeHtml(j.desc)}</td><td dir="ltr" style="font-size:11px; font-weight:bold">${j.amt}</td><td style="font-size:11px">${j.user}</td><td class="admin-only-col"><button class="btn ${btnStyle}" style="padding:2px 5px; font-size:10px" onclick="deleteLog(${j.time}, ${j.id})">${btnText}</button></td></tr>`;
    }).join('');
}

async function deleteLog(time, logId) {
    // ูพุฏุง ฺฉุฑุฏู ูุงฺฏ ููุฑุฏ ูุธุฑ
    const logIndex = db.journal.findIndex(j => (j.id && j.id === logId) || j.time === time);
    if (logIndex === -1) return;
    const logEntry = db.journal[logIndex];

    const msg = currentLang === 'fa' ? 
        'ุขุง ุงุฒ ุญุฐู ุงู ุนููุงุช ู ุจุงุฒฺฏุดุช ุชูุงู ูุจุงูุบ ุจู ุญุงูุช ูุจู ุงุทููุงู ุฏุงุฑุฏุ' : 
        'Are you sure you want to reverse this transaction completely?';
    
    if (!confirm(msg)) return;

    // ุดุฑูุน ุนููุงุช ุจุงุฒฺฏุดุช
    if (logEntry.type && logEntry.data) {
        const d = logEntry.data;
        try {
            // --- 1. ุจุงุฒฺฏุดุช ุญูุงูู ุซุจุช ุดุฏู (ูููุชุฑู ุจุฎุด ุจุฑุง ูุดฺฉู ุดูุง) ---
            if (logEntry.type === 'HAWALA_SUBMIT') {
                const hIndex = db.hawalas.findIndex(h => h.id === d.hawalaId);
                
                // ุงฺฏุฑ ุญูุงูู ูููุฒ ุฏุฑ ูุณุช ูุฌูุฏ ุฏุงุฑุฏ
                if (hIndex > -1) {
                    const h = db.hawalas[hIndex];
                    
                    // ุงูู) ุจุงุฒฺฏุดุช ูพูู ููุฏ (ุญูุงูู ุงุฑุณุงู)
                    // ููุช ุญูุงูู ุงุฑุณุงู ฺฉุฑุฏุฏุ ูพูู ฺฏุฑูุชุฏ (+). ูพุณ ุงูุงู ุจุงุฏ ฺฉู ุดูุฏ (-).
                    if (h.type === 'Outgoing' && !h.isInternal) { 
                        db.cashBox[h.curr] = (db.cashBox[h.curr] || 0) - h.amt; // ุงุตูุงุญ ุดุฏ: ุชูุฑู
                        
                        // ฺฉูุดู ูู ุจุงุฏ ุจุฑฺฏุฑุฏุฏ (ฺฉู ุดูุฏ)
                        if(h.comm) {
                            const cCurr = h.commCurr || h.curr;
                            db.cashBox[cCurr] = (db.cashBox[cCurr] || 0) - h.comm; // ุงุตูุงุญ ุดุฏ: ุชูุฑู
                        }
                    }
                    // ุจ) ุจุงุฒฺฏุดุช ูพูู ููุฏ (ุญูุงูู ุฏุฑุงูุช) - ูุนูููุง ุฏุฑ ุฒูุงู ุงุฌุฑุง ูพูู ฺฉู ูุดูุฏ ูู ุซุจุช
                    // ุงูุง ุงฺฏุฑ ุฏุฑ ุณุณุชู ุดูุง ูููุน ุซุจุช ุฏุฑุงูุช ูพูู ุฌุงุจุฌุง ุดุฏู ุจุงุดุฏ ุงูุฌุง ูุฏุฑุช ูุดูุฏ.
                    // (ุฏุฑ ุณุณุชู ูุนู ุซุจุช ุฏุฑุงูุช Pending ุงุณุช ู ูพูู ุฌุงุจุฌุง ููฺฉูุฏุ ูพุณ ฺฉุงุฑ ูุฏุงุฑู)

                    // ูพ) ุญุฐู ุงุฒ ุญุณุงุจ ูุดุชุฑ (ุงฺฏุฑ ุญุณุงุจโุฏุงุฑ ุจูุฏู)
                    if (h.isInternal && h.internalCust && db.accounts[h.internalCust]) {
                        if(d.accId) {
                             db.accounts[h.internalCust] = db.accounts[h.internalCust].filter(acc => acc.id !== d.accId);
                        }
                    }

                    // ุช) ุญุฐู ุฎูุฏ ุญูุงูู ุงุฒ ูุณุช
                    db.hawalas.splice(hIndex, 1);
                }

                // ุซ) ุจุงุฒฺฏุดุช ุดูุงุฑู ุงูุฏุงุฒ (Counter)
                if (d.hawalaId) {
                    const parts = d.hawalaId.split('-');
                    if(parts.length >= 3) {
                        const city = parts[0];
                        const typeChar = parts[1]; 
                        const num = parseInt(parts[2]);
                        const typeKey = typeChar === 'O' ? 'Outgoing' : 'Incoming';

                        if (db.cityHawalaCounters[city] && db.cityHawalaCounters[city][typeKey] === num + 1) {
                            db.cityHawalaCounters[city][typeKey]--;
                        }
                    }
                }
            }

            // --- 2. ุจุงุฒฺฏุดุช ุตุฑุงู (Exchange) ---
            else if (logEntry.type === 'EXCHANGE') {
                if (d.isInternal) {
                    if (d.cust && db.accounts[d.cust]) {
                        db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId1 && acc.id !== d.accId2);
                    }
                } else {
                    if (d.direction === 'Buy') { 
                        // ูุง ุฎุฑุฏ ฺฉุฑุฏู ุจูุฏู (ุงุฑุฒ ฺฏุฑูุชู +ุ ูพูู ุฏุงุฏู -)
                        // ุจุงุฒฺฏุดุช: ุงุฑุฒ ุฑุง ูุฏูู -ุ ูพูู ุฑุง ูพุณ ูฺฏุฑู +
                        db.cashBox[d.baseCurr] -= d.baseAmt; 
                        db.cashBox[d.quoteCurr] += d.quoteAmt; 
                    } else { 
                        // ูุง ูุฑูุฎุชู ุจูุฏู (ุงุฑุฒ ุฏุงุฏู -ุ ูพูู ฺฏุฑูุชู +)
                        // ุจุงุฒฺฏุดุช: ุงุฑุฒ ุฑุง ูพุณ ูฺฏุฑู +ุ ูพูู ุฑุง ูพุณ ูุฏูู -
                        db.cashBox[d.baseCurr] += d.baseAmt; 
                        db.cashBox[d.quoteCurr] -= d.quoteAmt; 
                    }
                }
                if (d.profit && d.quoteCurr) {
                    fxProfit[d.quoteCurr] = (fxProfit[d.quoteCurr] || 0) - d.profit;
                }
            } 

            // --- 3. ุจุงุฒฺฏุดุช ุชุฑุงฺฉูุด ุฏุณุช (ูุงุฑุฒ/ุจุฑุฏุงุดุช) ---
            else if (logEntry.type === 'TX') {
                if (d.type === 'debit') {
                    // ุจุฑุฏุงุดุช ุจูุฏู (ูพูู ฺฉู ุดุฏู) -> ูพูู ุจุฑูฺฏุฑุฏุฏ (+)
                    db.cashBox[d.curr] += d.amt; 
                } else {
                    // ูุงุฑุฒ ุจูุฏู (ูพูู ุฒุงุฏ ุดุฏู) -> ูพูู ฺฉู ูุดูุฏ (-)
                    db.cashBox[d.curr] -= d.amt; 
                }
                if (db.accounts[d.cust]) {
                    db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId);
                }
            }

            // --- 4. ุจุงุฒฺฏุดุช ุงุฌุฑุง ุญูุงูู ูุฑูุฏ (ุชุณูู) ---
            else if (logEntry.type === 'HAWALA_EXEC_IN') {
                const h = db.hawalas.find(h => h.id === d.hawalaId);
                if(h) {
                    h.status = 'Pending'; 
                    h.execDate = 0;
                    
                    if (d.isInternal && d.cust) {
                        if(db.accounts[d.cust] && d.accId) {
                            db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId);
                        }
                    } else {
                        // ุฏุฑ ุงุฌุฑุง ุญูุงูู ูุฑูุฏุ ูุง ูพูู ูพุฑุฏุงุฎุช ฺฉุฑุฏู ุจูุฏู (ุตูุฏูู ฺฉู ุดุฏู ุจูุฏ)
                        // ุญุงูุง ุญุฐู ูฺฉููุ ูพุณ ูพูู ุจู ุตูุฏูู ุจุฑูฺฏุฑุฏุฏ (+)
                        db.cashBox[d.curr] += d.amt;
                    }
                }
            }

            // --- 5. ุจุงุฒฺฏุดุช TT ---
            else if (logEntry.type === 'TT_EXTERNAL') {
                // ุฏุฑ TT ููุฏุ ูพูู ุฏุฑุงูุช ฺฉุฑุฏู (+)
                // ุญุงูุง ุญุฐู ูฺฉููุ ูพูู ฺฉู ูุดูุฏ (-)
                db.cashBox[d.curr] -= d.amt;
            }
            else if (logEntry.type === 'TT_INTERNAL') {
                if(db.accounts[d.cust]) db.accounts[d.cust] = db.accounts[d.cust].filter(acc => acc.id !== d.accId);
            }

            // --- 6. ุณุงุฑ ููุงุฑุฏ ---
            else if (logEntry.type === 'ACC_TRANSFER') {
                if(db.accounts[d.s]) db.accounts[d.s] = db.accounts[d.s].filter(a => a.id !== d.id1);
                if(db.accounts[d.r]) db.accounts[d.r] = db.accounts[d.r].filter(a => a.id !== d.id2);
            }
            else if (logEntry.type === 'CRYPTO') {
                if (d.type === 'Buy') {
                    db.cashBox[d.cName] -= d.vol;
                    if(d.isInternal && d.cust) {
                         db.accounts[d.cust] = db.accounts[d.cust].filter(a => a.id !== d.accId);
                    } else {
                        db.cashBox[d.curr] += d.fiatAmt;
                    }
                } else {
                    db.cashBox[d.cName] += d.vol;
                    if(d.isInternal && d.cust) {
                         db.accounts[d.cust] = db.accounts[d.cust].filter(a => a.id !== d.accId);
                    } else {
                        db.cashBox[d.curr] -= d.fiatAmt;
                    }
                    if(d.profit) fxProfit[d.curr] = (fxProfit[d.curr] || 0) - d.profit;
                }
            }

        } catch (err) { 
            console.error(err); 
            alert("ุฎุทุง ุฏุฑ ุจุงุฒฺฏุดุช ุงุทูุงุนุงุช."); 
            return; 
        }
    }

    // ุญุฐู ุฎูุฏ ูุงฺฏ
    db.journal.splice(logIndex, 1);
    
    await saveDB(); 
    renderJournal(); 
    renderDashboard(); 
    if(document.getElementById('hawala').classList.contains('active')) filterHawala();
    if(document.getElementById('accounts').classList.contains('active')) loadCustomerLedger();

    alert(currentLang === 'fa' ? "ุนููุงุช ุจุงุฒฺฏุฑุฏุงู ุดุฏ ู ููุฌูุฏโูุง ุงุตูุงุญ ฺฏุฑุฏุฏ." : "Reversed successfully.");
}
function openSettings() { 
    updateUI(); 
    if(currentUser && currentUser.perms.admin) {
        document.getElementById('adminMenuSection').style.display = 'block';
    } else {
        document.getElementById('adminMenuSection').style.display = 'none';
    }
    openModal('modalSettings'); 
    switchSettingsTab('tab-profile', document.querySelector('.settings-menu-btn'));
}

function getNewHawalaNumber(cityCode, type) {
    // 1. ูุณุช ุชูุงู ุดูุงุฑู ฺฉุชุงุจโูุง ููุฌูุฏ ุจุฑุง ุงู ุดูุฑ ู ุงู ููุน (ุงุฑุณุงู/ุฏุฑุงูุช) ุฑุง ูโฺฏุฑู
    const existingNumbers = db.hawalas
        .filter(h => h.cityBook === cityCode && h.type === type)
        .map(h => parseInt(h.bookNum)) // ุชุจุฏู ุจู ุนุฏุฏ
        .sort((a, b) => a - b); // ูุฑุชุจโุณุงุฒ ุงุฒ ฺฉูฺฺฉ ุจู ุจุฒุฑฺฏ

    // 2. ุงุฒ 1001 ุดุฑูุน ูโฺฉูู ู ฺฺฉ ูโฺฉูู ฺฉุฏุงู ุนุฏุฏ ุฎุงู ุงุณุช
    let nextNum = 1001;
    for (let num of existingNumbers) {
        if (num === nextNum) {
            nextNum++; // ุงฺฏุฑ ุงู ุดูุงุฑู ูุฌูุฏ ุฏุงุฑุฏุ ุจุฑู ุณุฑุงุบ ุจุนุฏ
        } else if (num > nextNum) {
            // ุงฺฏุฑ ุดูุงุฑู ููุฌูุฏ ุจุฒุฑฺฏุชุฑ ุงุฒ ุดูุงุฑู ููุฑุฏ ูุธุฑ ูุงุณุชุ ุนู ุงูุฌุง (nextNum) ุฎุงู ุงุณุช
            return nextNum;
        }
    }
    // 3. ุงฺฏุฑ ูฺ ุฌุง ุฎุงู ุฏุฑ ุจู ุงุนุฏุงุฏ ูุจูุฏุ ุนุฏุฏ ุจุนุฏ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ
    return nextNum;
}

function setHawalaCustType(type) {
    hawalaCustType = type;
    document.getElementById('hOptInternal').classList.toggle('active', type === 'internal');
    document.getElementById('hOptExternal').classList.toggle('active', type === 'external');
    document.getElementById('hInternalSec').style.display = type === 'internal' ? 'block' : 'none';
}

function fillHawalaCustName() {
    const sel = document.getElementById('hCustomerSelect');
    if(hawalaCustType === 'internal' && sel.value) {
        document.getElementById('hSender').value = sel.value; 
    }
}
async function submitHawala() {
    const hType = document.getElementById('hType').value; 
    const hCityBook = document.getElementById('hCityBook').value; 
    const hAmt = parseFloat(document.getElementById('hAmt').value); 
    const hCurr = document.getElementById('hCurr').value; 
    
    // ูุฑุณุชูุฏู
    const hSender = document.getElementById('hSender').value.trim(); 
    const hSenderLast = document.getElementById('hSenderLast').value.trim(); 
    const hSenderFather = document.getElementById('hSenderFather').value.trim(); 
    const hSenderPhone = document.getElementById('hPhone').value.trim(); 
    const hSenderID = document.getElementById('hSenderID').value.trim(); 
    const hSenderSource = document.getElementById('hSenderSource').value.trim(); 
    const hSenderPurpose = document.getElementById('hSenderPurpose').value.trim(); 

    // ฺฏุฑูุฏู
    const hReceiver = document.getElementById('hReceiver').value.trim();
    const hReceiverLast = document.getElementById('hReceiverLast').value.trim();
    const hReceiverFather = document.getElementById('hReceiverFather').value.trim();
    const hReceiverPhone = document.getElementById('hReceiverPhone').value.trim();
    const hReceiverID = document.getElementById('hReceiverID').value.trim();
    const hReceiverSource = document.getElementById('hReceiverSource').value.trim();
    const hReceiverPurpose = document.getElementById('hReceiverPurpose').value.trim();

    let rawComm = parseFloat(document.getElementById('hComm').value) || 0; 
    const commType = document.getElementById('hCommType').value;
    const commCurr = document.getElementById('hCommCurr').value; 
    const hComm = (commType === 'out') ? -rawComm : rawComm; 

    if (!hCityBook || hAmt <= 0 || !hSender || !hReceiver) { alert("ุงุทูุงุนุงุช ูุงูุต ุงุณุช"); return; }
    
    const isInternal = (hawalaCustType === 'internal');
    const custName = document.getElementById('hCustomerSelect').value;
    if (isInternal && !custName) { alert("ูุดุชุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ"); return; }

    const bookNum = getNewHawalaNumber(hCityBook, hType);
    const uniqueId = `${hCityBook}-${hType === 'Outgoing' ? 'O' : 'I'}-${bookNum}`;
    const displayNum = `${hCityBook}-${bookNum}`;

    const newHawala = { 
        id: uniqueId, displayId: displayNum, bookNum: bookNum, type: hType, 
        cityBook: hCityBook, amt: hAmt, curr: hCurr, 
        comm: hComm, commCurr: commCurr,
        sender: hSender, senderLast: hSenderLast, senderFather: hSenderFather, 
        senderPhone: hSenderPhone, senderID: hSenderID, senderSource: hSenderSource, senderPurpose: hSenderPurpose,
        receiver: hReceiver, receiverLast: hReceiverLast, receiverFather: hReceiverFather,
        receiverPhone: hReceiverPhone, receiverID: hReceiverID, receiverSource: hReceiverSource, receiverPurpose: hReceiverPurpose,
        regDate: Date.now(), 
        execDate: hType === 'Outgoing' ? Date.now() : 0, 
        status: hType === 'Outgoing' ? 'Done' : 'Pending',
        isInternal: isInternal,
        internalCust: isInternal ? custName : null
    };

    let logData = { hawalaId: uniqueId, isInternal: isInternal };

    if (hType === 'Outgoing') { 
        if (isInternal) {
            const accId = Date.now();
            db.accounts[custName].push({ id: accId, date: Date.now(), desc: `Hawala Out ${displayNum} (Comm: ${hComm} ${commCurr})`, curr: hCurr, debit: hAmt, credit: 0, type: 'debit' });
        } else {
            db.cashBox[hCurr] = (db.cashBox[hCurr] || 0) + hAmt; 
            db.cashBox[commCurr] = (db.cashBox[commCurr] || 0) + hComm;
            logTx('ุญูุงูู', `Out (Cash) ${displayNum}`, `In: ${hAmt}${hCurr}`, 'HAWALA_SUBMIT', logData); 
        }
    } else { 
        logTx('ุญูุงูู', `In ${displayNum}`, `Pending ${hAmt}`, 'HAWALA_SUBMIT', logData); 
    }

    db.hawalas.push(newHawala); 
    await saveDB(); 
    closeModal('modalNewHawala'); filterHawala(); renderDashboard(); 
    alert(`ุญูุงูู ${displayNum} ุซุจุช ุดุฏ.`);
}

async function execHawala(id) {
    if (!currentUser.perms.admin && !currentUser.perms.hawala) return;
    const h = db.hawalas.find(x => x.id === id); if (!h || h.status !== 'Pending') return;
    
    let confirmMsg = currentLang === 'fa' ? `ุขุง ุญูุงูู ${h.displayId || h.id} ูพุฑุฏุงุฎุช ุดุฏุ` : `Is Hawala ${h.displayId || h.id} Paid?`;
    
    if (h.type === 'Incoming' && confirm(confirmMsg)) {
        let logData = { hawalaId: h.id, curr: h.curr, amt: h.amt, isInternal: false };
        const currentCash = (db.cashBox[h.curr] || 0) + (db.initialCapital[h.curr] || 0);
        if (currentCash < h.amt) { alert(`Low Cash`); return; }
        db.cashBox[h.curr] -= h.amt; 
        logTx('ุญูุงูู', `Paid Hawala (Cash) ${h.displayId}`, `Cash Out: ${h.amt} ${h.curr}`, 'HAWALA_EXEC_IN', logData);

        h.status = 'Done'; h.execDate = new Date().getTime(); 
        await saveDB(); filterHawala(); renderDashboard();
    }
}

async function submitEditHawala() {
     const id = document.getElementById('editHId').value; const h = db.hawalas.find(x => x.id === id); if (!h) return;
     h.cityBook = document.getElementById('editHCityBook').value; 
h.type = document.getElementById('editHType').value;
     h.amt = parseFloat(document.getElementById('editHAmt').value);
     h.curr = document.getElementById('editHCurr').value;
     h.sender = document.getElementById('editHSender').value; 
     h.receiver = document.getElementById('editHReceiver').value; 
     h.phone = document.getElementById('editHPhone').value; 
     h.idCard = document.getElementById('editHIDCard').value;
     logTx('ุญูุงูู', `Edited Hawala ${h.displayId || id}`, `Edited Info`);
     await saveDB(); closeModal('modalEditHawala'); filterHawala(); renderDashboard(); alert(`Saved.`);
}

async function deleteHawala(id) {
    if (!currentUser.perms.admin) return;
    const hIndex = db.hawalas.findIndex(x => x.id === id); if (hIndex === -1) return; const h = db.hawalas[hIndex];
    if (!confirm(`Delete ${h.displayId || id}?`)) return;
    
    if (h.type === 'Outgoing' && h.status === 'Done' && !h.isInternal) {
        db.cashBox[h.curr] -= (h.amt + (h.comm || 0)); 
    } else if (h.type === 'Incoming' && h.status === 'Done' && !h.isInternal) {
        db.cashBox[h.curr] += h.amt;
    }
    db.hawalas.splice(hIndex, 1); logTx('ุญูุงูู', `Deleted Hawala ${h.displayId || id}`, `Reversed: ${h.amt} ${h.curr}`);
    await saveDB(); filterHawala(); renderDashboard();
}
function filterHawala() {
    const list = db.hawalas.filter(h => (document.getElementById('filterHCity').value === 'All' || h.cityBook === document.getElementById('filterHCity').value) && (document.getElementById('filterHType').value === 'All' || h.type === document.getElementById('filterHType').value) && (document.getElementById('filterHStatus').value === 'All' || h.status === document.getElementById('filterHStatus').value))
    .sort((a, b) => b.regDate - a.regDate);
    const t = TRANSLATIONS[currentLang];
    document.getElementById('hawalaBody').innerHTML = list.map(h => {
        let opBtns = `<button class="btn btn-outline no-print" style="padding:5px 8px; font-size:12px; margin-left:5px" onclick="printH('${h.id}')">๐จ</button>`;
        if (h.status === 'Pending' && h.type === 'Incoming') opBtns += `<button class="btn btn-green no-print" style="padding:5px" onclick="execHawala('${h.id}')">โ</button>`; 
        if (currentUser.perms.admin) { opBtns += ` <button class="btn btn-outline" style="padding:5px" onclick="openEditHawalaModal('${h.id}')">โ๏ธ</button>`; opBtns += ` <button class="btn btn-red no-print" style="padding:5px" onclick="deleteHawala('${h.id}')">๐</button>`; }
        const commDisp = h.comm ? h.comm.toLocaleString() : '0';
        const typeLabel = h.type === 'Outgoing' ? `<span class="badge" style="background:#fff3cd; color:#856404">${t.opt_outgoing || 'Out'}</span>` : `<span class="badge" style="background:#d4edda; color:#155724">${t.opt_incoming || 'In'}</span>`;
        const statusLabel = h.status === 'Done' ? (t.opt_done || 'Done') : (t.opt_pending || 'Pending');
        return `<tr><td style="font-weight:900; direction:ltr">${h.displayId || h.id}</td><td>${typeLabel}</td><td>${h.cityBook}</td><td dir="ltr" style="font-weight:bold">${h.amt.toLocaleString()} ${h.curr}</td><td dir="ltr" style="color:var(--text-muted); font-weight:bold">${commDisp}</td><td>${new Date(h.regDate).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US')}</td><td>${h.execDate ? new Date(h.execDate).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US') : '-'}</td><td>${statusLabel}</td><td>${opBtns}</td></tr>`;
    }).join('');
}

function openEditHawalaModal(id) {
    const h = db.hawalas.find(x => x.id === id); if (!h) return;
    document.getElementById('editHId').value = h.id; document.getElementById('editHawalaId').innerText = h.displayId || h.id; document.getElementById('editHType').value = h.type; document.getElementById('editHCityBook').value = h.cityBook; document.getElementById('editHAmt').value = h.amt; document.getElementById('editHCurr').value = h.curr; document.getElementById('editHSender').value = h.sender; document.getElementById('editHReceiver').value = h.receiver; document.getElementById('editHPhone').value = h.phone; document.getElementById('editHIDCard').value = h.idCard; openModal('modalEditHawala');
}

function printH(id) {
    const h = db.hawalas.find(x => x.id === id); 
    if (!h) { alert('ุญูุงูู ุงูุช ูุดุฏ.'); return; }
    
    const typeText = h.type === 'Outgoing' ? 'ุญูุงูู ุตุงุฏุฑู (Out)' : 'ุญูุงูู ูุงุฑุฏู (In)';
    const cityObj = db.cities.find(c => c.code === h.cityBook);
    const cityName = cityObj ? cityObj.name : h.cityBook;
    
    let repInfoHTML = '';
    if (cityObj && (cityObj.rep || cityObj.contact)) {
        const label = h.type === 'Outgoing' ? 'ููุงูุฏู ููุตุฏ:' : 'ุตุฑุงู ูุฑุณุชูุฏู:';
        repInfoHTML = `<div style="margin-top:10px; background:#f0f0f0; padding:5px; border:1px dashed #999; font-size:10pt;"><div style="font-weight:bold">${label} ${cityObj.rep || ''}</div><div style="font-size:9pt">${cityObj.contact || ''}</div></div>`;
    }

    const amtInWords = numberToPersianWords(h.amt) + " " + h.curr;
    const win = window.open('', '_blank', 'width=800,height=600');
    
    win.document.write(`<html><head><title>${typeText}</title><style>@page{size:A5 landscape;margin:10mm}body{font-family:'Vazirmatn',tahoma;direction:rtl;padding:0;margin:0;font-size:11pt;color:#000}.receipt{width:100%;max-width:95%;margin:0 auto;padding:15px;border:3px double #000;background:#ffffff}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}.info-item{border-bottom:1px dotted #999;padding-bottom:5px;margin-bottom:5px;display:flex;justify-content:space-between}.info-item b{font-weight:bold}.amount-box{border:2px solid #000;padding:10px;text-align:center;margin-top:15px;background:#f9f9f9}.footer-grid{display:grid;grid-template-columns:1fr 1fr;margin-top:30px;text-align:center;font-size:10pt}</style></head><body>${getPrintHeaderHTML()}<div class="receipt"><div style="text-align:center;font-weight:bold;margin-bottom:15px;font-size:14pt;border-bottom:1px solid #000;padding-bottom:10px">ุฑุณุฏ ${typeText} (ฺฉุฏ: ${h.displayId || h.id})</div><div class="info-grid"><div class="info-item"><b>ุชุงุฑุฎ:</b><span>${new Date(h.regDate).toLocaleDateString('fa-IR')}</span></div><div class="info-item"><b>ุทุฑู ุญุณุงุจ:</b><span>${escapeHtml(cityName)}</span></div></div>${repInfoHTML}<div class="info-grid" style="margin-top:10px"><div class="info-item"><b>ูุฑุณุชูุฏู:</b><span>${escapeHtml(h.sender)}</span></div><div class="info-item"><b>ฺฏุฑูุฏู:</b><span>${escapeHtml(h.receiver)}</span></div></div><div class="info-grid"><div class="info-item"><b>ุชููู:</b><span>${escapeHtml(h.phone || '-')}</span></div><div class="info-item"><b>ุขุฏ/ุชุฐฺฉุฑู:</b><span>${escapeHtml(h.idCard || '-')}</span></div></div><div class="amount-box"><div>ูุจูุบ ุญูุงูู:</div><b dir="ltr" style="font-size:16pt;">${h.amt.toLocaleString()} ${h.curr}</b><div style="font-weight:bold;margin-top:5px;font-size:12px">ุญุฑูู: ${amtInWords}</div></div><div class="footer-grid"><div>ุงูุถุงุก ูุดุชุฑ</div><div>ููุฑ ู ุงูุถุงุก ุตุฑุงู</div></div></div></body></html>`);
    win.document.close(); win.print();
}

function printHawalaList() {
    const filterCity = document.getElementById('filterHCity').value; const filterType = document.getElementById('filterHType').value; const filterStatus = document.getElementById('filterHStatus').value;
    const filteredHawalas = db.hawalas.filter(h => (filterCity === 'All' || h.cityBook === filterCity) && (filterType === 'All' || h.type === filterType) && (filterStatus === 'All' || h.status === filterStatus)).sort((a, b) => b.regDate - a.regDate);
    const t = TRANSLATIONS[currentLang];
    let printableBody = filteredHawalas.map(h => `<tr><td style="font-weight:bold;text-align:center">${h.displayId||h.id}</td><td>${escapeHtml(h.sender)}</td><td>${escapeHtml(h.receiver)}</td><td dir="ltr" style="text-align:center">${h.amt.toLocaleString()} ${h.curr}</td></tr>`).join('');
    const win = window.open('', '_blank', 'width=1100,height=800'); 
    const dir = t.dir;
    win.document.write(`<html><head><title>Book</title><style>table{width:100%;border-collapse:collapse;font-family:'Vazirmatn','Tahoma';direction:${dir}}th,td{border:1px solid #000;padding:5px;text-align:${dir==='rtl'?'right':'left'}}@page{size:A4 landscape}</style></head><body>${getPrintHeaderHTML()}<h3>${t.header_hawala_manage || 'Book'}</h3><table><thead><tr><th>${t.th_hawala_no}</th><th>${t.lbl_sender}</th><th>${t.lbl_receiver}</th><th>${t.th_amount}</th></tr></thead><tbody>${printableBody}</tbody></table></body></html>`);
    win.document.close(); win.print();
}

function setTTType(type) { 
    ttType = type; 
    document.getElementById('ttOptInternal').classList.toggle('active', type === 'internal'); 
    document.getElementById('ttOptExternal').classList.toggle('active', type === 'external'); 
    document.getElementById('ttInternalSec').style.display = type === 'internal' ? 'block' : 'none'; 
    document.getElementById('ttExternalSec').style.display = type === 'external' ? 'block' : 'none'; 
}

async function submitNewTT() {
    const amt = parseFloat(document.getElementById('ttAmt').value); 
    const curr = document.getElementById('ttCurr').value; 
    const ref = document.getElementById('ttRef').value || `TT-${Math.floor(Math.random()*10000)}`; 
    const ben = document.getElementById('ttBenName').value;

    if (!amt || amt <= 0 || !ben) { alert('Invalid Data'); return; }

    if (ttType === 'internal') {
        const custName = document.getElementById('ttCustomer').value;
        if (!custName) { alert('Select Customer'); return; }
        const accId = Date.now();
        db.accounts[custName].push({ id: accId, date: Date.now(), desc: `TT Request (${ref}) - Ben: ${ben}`, curr: curr, debit: amt, credit: 0, type: 'debit' });
        logTx('TT', `TT Internal ${custName}`, `Acc Deduct: ${amt} ${curr}`, 'TT_INTERNAL', { cust: custName, accId: accId, amt: amt, curr: curr });
    } else {
        const extName = document.getElementById('ttExtName').value;
        db.cashBox[curr] = (db.cashBox[curr] || 0) + amt; 
        logTx('TT', `TT Cash (${extName})`, `Cash Recieved: ${amt} ${curr}`, 'TT_EXTERNAL', { amt: amt, curr: curr });
    }
    await saveDB(); renderDashboard(); alert(`TT Registered. Ref: ${ref}`); 
}

function printCurrentTTForm() { 
    const amt = document.getElementById('ttAmt').value; 
    const curr = document.getElementById('ttCurr').value; 
    const t = TRANSLATIONS[currentLang];
    const win = window.open('', '_blank', 'width=900,height=1000'); 
    win.document.write(`<html><head><title>TT Form</title><style>body{font-family:'Vazirmatn';direction:${t.dir}}</style></head><body>${getPrintHeaderHTML()}<h3>TT Application</h3><div>Amount: ${amt} ${curr}</div></body></html>`); 
    win.document.close(); win.print(); 
}

function setCryptoCustType(type) {
    cryptoCustType = type;
    document.getElementById('cryptoOptInternal').classList.toggle('active', type === 'internal');
    document.getElementById('cryptoOptExternal').classList.toggle('active', type === 'external');
    document.getElementById('cryptoInternalSec').style.display = type === 'internal' ? 'block' : 'none';
}

async function submitCryptoFx() {
    const t = document.getElementById('cryptoTxType').value; 
    const n = document.getElementById('cryptoName').value; 
    const v = parseFloat(document.getElementById('cryptoAmt').value); 
    const fc = document.getElementById('cryptoCurr').value; 
    const fa = parseFloat(document.getElementById('fiatAmt').value);
    const desc = document.getElementById('cryptoDesc').value;

    if(!n || !v || !fa) { alert("Incomplete Data"); return; }

    let logData = { type: t, curr: fc, fiatAmt: fa, profit: 0, isInternal: false, cName: n, vol: v };
    const isInternal = (cryptoCustType === 'internal');
    const cust = document.getElementById('cryptoCustomer').value;

    if(isInternal && !cust) { alert("Select Customer"); return; }

    if (t === 'Buy') { 
        if (!isInternal && ((db.cashBox[fc]||0)+(db.initialCapital[fc]||0)) < fa) return alert('Low Cash'); 
        
        if (isInternal) {
            const id1 = Date.now();
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `Crypto Buy: ${v} ${n} (${desc})`, curr: fc, debit: 0, credit: fa, type: 'credit' });
            logData.isInternal = true; logData.cust = cust; logData.accId = id1;
        } else {
            db.cashBox[fc] -= fa; 
        }
        db.cashBox[n] = (db.cashBox[n] || 0) + v; 
        logTx('ฺฉุฑูพุชู', `Buy ${v} ${n}`, `Paid ${fa} ${fc}`, 'CRYPTO', logData); 

    } else { 
        const cost = parseFloat(document.getElementById('cryptoCostBasis').value) || 0; 
        if (cost > 0) { logData.profit = fa - cost; fxProfit[fc] = (fxProfit[fc] || 0) + logData.profit; } 
        
        if (isInternal) {
            const id1 = Date.now();
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `Crypto Sell: ${v} ${n} (${desc})`, curr: fc, debit: fa, credit: 0, type: 'debit' });
            logData.isInternal = true; logData.cust = cust; logData.accId = id1;
        } else {
            db.cashBox[fc] += fa; 
        }
        db.cashBox[n] = (db.cashBox[n] || 0) - v; 
        logTx('ฺฉุฑูพุชู', `Sell ${v} ${n}`, `Recvd ${fa} ${fc}`, 'CRYPTO', logData); 
    }

    if (!db.currencies.includes(n)) db.currencies.push(n); 
    await saveDB(); renderDashboard(); alert('Crypto Deal Saved.');
}

function printCryptoFx() { 
    const win = window.open('', '_blank', 'width=500,height=600'); 
    win.document.write(`<html><head><title>Crypto</title><style>body{font-family:'Vazirmatn';direction:${TRANSLATIONS[currentLang].dir}}</style></head><body>${getPrintHeaderHTML()}<h3>Crypto Receipt</h3></body></html>`); 
    win.document.close(); win.print(); 
}
async function addCustomer() { const n = document.getElementById('newCustName').value.trim(); if (!n || db.customers.some(c => c.name === n)) { alert("Invalid Name"); return; } db.customers.push({ name: n, phone: document.getElementById('newCustPhone').value }); db.accounts[n] = []; await saveDB(); closeModal('modalNewCust'); updateUI(); alert("Added."); }
function openEditCustomerModal() { const custName = document.getElementById('selCustomer').value; if (!custName) return; const custObj = db.customers.find(c => c.name === custName); document.getElementById('editCustName').value = custObj.name; document.getElementById('editCustPhone').value = custObj.phone || ''; openModal('modalEditCust'); }
async function submitEditCustomer() { const oldName = document.getElementById('selCustomer').value; const newName = document.getElementById('editCustName').value.trim(); if (!newName) return; const custIndex = db.customers.findIndex(c => c.name === oldName); if (custIndex !== -1) { db.customers[custIndex].name = newName; db.customers[custIndex].phone = document.getElementById('editCustPhone').value.trim(); } if (newName !== oldName && db.accounts[oldName]) { db.accounts[newName] = db.accounts[oldName]; delete db.accounts[oldName]; } await saveDB(); closeModal('modalEditCust'); updateUI(); document.getElementById('selCustomer').value = newName; loadCustomerLedger(); alert('Edited.'); }

async function submitTx() {
    const c = document.getElementById('txCust').value; const t = document.getElementById('txType').value; const a = parseFloat(document.getElementById('txAmt').value); const cur = document.getElementById('txCurr').value; const d = document.getElementById('txDesc').value.trim();
    if (!c || !a || a <= 0) { alert("Data Error"); return; }
    if (t === 'debit') { if (((db.cashBox[cur]||0) + (db.initialCapital[cur]||0)) < a) { alert('Low Cash'); return; } db.cashBox[cur] -= a; } else { db.cashBox[cur] += a; }
    const accId = Date.now();
    db.accounts[c].push({ id: accId, date: Date.now(), desc: d, curr: cur, debit: t === 'debit' ? a : 0, credit: t === 'credit' ? a : 0, type: t });
    logTx('ุญุณุงุจ', `${t} ${c}`, `${a} ${cur}`, 'TX', { type: t, cust: c, accId: accId, amt: a, curr: cur }); 
    await saveDB(); closeModal('modalTx'); loadCustomerLedger(); renderDashboard(); alert("Saved.");
}

function loadCustomerLedger() {
    const c = document.getElementById('selCustomer').value; const div = document.getElementById('ledgerCard');
    if (!c) { div.style.display = 'none'; return; }
    div.style.display = 'block'; 
    const custObj = db.customers.find(customer => customer.name === c);
    document.getElementById('ledgerName').innerText = c;
    document.getElementById('ledgerPhone').innerText = custObj ? `(${custObj.phone || ''})` : '';
    const list = db.accounts[c] || []; list.sort((a, b) => a.date - b.date); 
    const bal = {};
    const t = TRANSLATIONS[currentLang];
    document.getElementById('ledgerBody').innerHTML = list.map(x => {
        bal[x.curr] = (bal[x.curr] || 0) + (x.credit - x.debit);
        return `<tr><td>${new Date(x.date).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US')}</td><td>${escapeHtml(x.desc)}</td><td>${x.curr}</td><td class="${x.debit > 0 ? 'text-red' : ''}">${x.debit > 0 ? x.debit.toLocaleString() : '-'}</td><td class="${x.credit > 0 ? 'text-green' : ''}">${x.credit > 0 ? x.credit.toLocaleString() : '-'}</td><td dir="ltr" style="font-weight:bold">${bal[x.curr].toLocaleString()}</td><td class="no-print"><button class="btn btn-red admin-only-col" style="padding:2px 5px; font-size:10px" onclick="delTx('${c}',${x.id})">x</button></td></tr>`;
    }).join('');
    let s = ''; for (let k in bal) if (Math.abs(bal[k]) > 0.1) s += `<span class="${bal[k] > 0 ? 'text-red' : 'text-green'}" style="margin-right:10px">${bal[k].toLocaleString()} ${k}</span>`;
    document.getElementById('ledgerFinalSum').innerHTML = s || '0'; applyPermissions();
}

async function delTx(c, id) { if (!currentUser.perms.admin || !confirm('Delete?')) return; const idx = db.accounts[c].findIndex(x => x.id === id); const tx = db.accounts[c][idx]; if (tx.type === 'debit') db.cashBox[tx.curr] += tx.debit; else db.cashBox[tx.curr] -= tx.credit; db.accounts[c].splice(idx, 1); await saveDB(); loadCustomerLedger(); renderDashboard(); }
async function deleteCustomer() { const c = document.getElementById('selCustomer').value; if (!c || !confirm('Delete Customer?')) return; delete db.accounts[c]; db.customers = db.customers.filter(cust => cust.name !== c); await saveDB(); updateUI(); document.getElementById('ledgerCard').style.display = 'none'; }
function openModalClientTransfer() { const s = document.getElementById('selCustomer').value; if(!s) { alert("Select Source"); return; } document.getElementById('ctSender').innerText = s; openModal('modalClientTransfer'); }
async function submitClientTransfer() { 
    const s = document.getElementById('selCustomer').value; const r = document.getElementById('ctReceiver').value; const a = parseFloat(document.getElementById('ctAmt').value); const cur = document.getElementById('ctCurr').value; const desc = document.getElementById('ctDesc').value || '';
    if(!s || !r || s===r || !a || a<=0) return alert("Error");
    const id1 = Date.now(); const id2 = Date.now()+1;
    db.accounts[s].push({id:id1,date:Date.now(),desc:`Trf to ${r} - ${desc}`,curr:cur,debit:a,credit:0,type:'debit'}); 
    db.accounts[r].push({id:id2,date:Date.now(),desc:`Trf from ${s} - ${desc}`,curr:cur,debit:0,credit:a,type:'credit'}); 
    logTx('ุงูุชูุงู ุญุณุงุจ', `Trf ${s}->${r}`, `${a} ${cur}`, 'ACC_TRANSFER', {s:s, r:r, amt:a, curr:cur, id1:id1, id2:id2});
    await saveDB(); closeModal('modalClientTransfer'); alert('Done'); loadCustomerLedger();
}

function setExType(type) { exType = type; document.getElementById('exOptInternal').classList.toggle('active', type === 'internal'); document.getElementById('exOptExternal').classList.toggle('active', type === 'external'); document.getElementById('exInternalSec').style.display = type === 'internal' ? 'block' : 'none'; }
function setFxDirection(dir) { 
    fxDirection = dir; 
    document.getElementById('btnFxBuy').classList.remove('active', 'buy'); 
    document.getElementById('btnFxSell').classList.remove('active', 'sell'); 
    if (dir === 'Buy') { 
        document.getElementById('btnFxBuy').classList.add('active', 'buy'); 
        document.getElementById('fxDirText').innerText = currentLang === 'fa' ? "ูุง ูโุฎุฑู (ุงุฑุฒ ูพุงู ูุงุฑุฏ ุตูุฏูู ูุง ูโุดูุฏ)" : "We Buy (Base Currency IN)"; 
        document.getElementById('fxDirText').style.color = "var(--success)"; 
    } else { 
        document.getElementById('btnFxSell').classList.add('active', 'sell'); 
        document.getElementById('fxDirText').innerText = currentLang === 'fa' ? "ูุง ูโูุฑูุดู (ุงุฑุฒ ูพุงู ุงุฒ ุตูุฏูู ูุง ุฎุงุฑุฌ ูโุดูุฏ)" : "We Sell (Base Currency OUT)"; 
        document.getElementById('fxDirText').style.color = "var(--danger)"; 
    } 
    calcFx(); 
}
function toggleFxOperator() { fxOperator = fxOperator === 'multiply' ? 'divide' : 'multiply'; document.getElementById('fxOpDisplay').innerText = fxOperator === 'multiply' ? 'โ' : 'โ'; calcFx(); }
// 1. ูุญุงุณุจู ูุญุธูโุง ุณูุฏ ุฏุฑ ุฒูุงู ุชุงูพ ฺฉุฑุฏู
function calcFx() { 
    const baseAmt = parseFloat(document.getElementById('fxBaseAmt').value) || 0; 
    const rate = parseFloat(document.getElementById('fxRate').value) || 1; 
    const quoteCurr = document.getElementById('fxQuoteCurr').value; 
    const baseCurr = document.getElementById('fxBaseCurr').value; 

    // --- ูพุฑ ฺฉุฑุฏู ุฎูุฏฺฉุงุฑ ูุฑุฎ ุฎุฑุฏ (ูุงูฺฏู) ุงุฒ ุญุงูุธู ---
    if (fxDirection === 'Sell') {
        if (db.avgRates && db.avgRates[baseCurr]) {
            document.getElementById('exCostBasis').value = db.avgRates[baseCurr];
        } else {
            document.getElementById('exCostBasis').value = '';
        }
    }

    // --- ูุญุงุณุจู ูุจูุบ ููุง (ุถุฑุจ ุง ุชูุณู ุจุฑ ุงุณุงุณ ุงูุชุฎุงุจ ุดูุง) ---
    let quoteAmt = 0; 
    if (rate !== 0) { 
        if (fxOperator === 'multiply') quoteAmt = baseAmt * rate; 
        else quoteAmt = baseAmt / rate; 
    } 
    document.getElementById('fxQuoteAmt').value = quoteAmt.toFixed(2); 

    // --- ูุญุงุณุจู ููุดููุฏ ุณูุฏ (ููุทู ฺฉูุฏ) ---
    const costRate = parseFloat(document.getElementById('exCostBasis').value); 
    
    if(costRate && fxDirection === 'Sell') { 
        const totalSell = quoteAmt; 
        let totalBuy = 0;

        // ุงฺฏุฑ ูุฑุฎ ุฎุฑุฏ ุจุฒุฑฺฏุชุฑ ุงุฒ 2 ุจุงุดุฏ (ูุซู 70 ุงูุบุงู)ุ ุณุณุชู ูโูููุฏ ุจุงุฏ ุชูุณู ฺฉูุฏ
        // ุงฺฏุฑ ูุฑุฎ ฺฉูฺฺฉ ุจุงุดุฏ (ูุซู 0.014 ุง 1.1)ุ ุถุฑุจ ูโฺฉูุฏ
        if (costRate > 2) {
            totalBuy = baseAmt / costRate;
        } else {
            totalBuy = baseAmt * costRate;
        }

        const profit = totalSell - totalBuy;
        
        document.getElementById('estimatedProfit').innerText = profit.toLocaleString(undefined, {maximumFractionDigits: 2}) + " " + quoteCurr; 
        
        if(profit >= 0) document.getElementById('estimatedProfit').style.color = "var(--success)"; 
        else document.getElementById('estimatedProfit').style.color = "var(--danger)"; 
    } else { 
        document.getElementById('estimatedProfit').innerText = "---"; 
    } 
}

// 2. ุซุจุช ููุง ูุนุงููู ู ุขูพุฏุช ูุฑุฎ ูุงูฺฏู ู ุณูุฏ
async function submitExchange() {
    const baseAmt = parseFloat(document.getElementById('fxBaseAmt').value); 
    const quoteAmt = parseFloat(document.getElementById('fxQuoteAmt').value); 
    const baseCurr = document.getElementById('fxBaseCurr').value; 
    const quoteCurr = document.getElementById('fxQuoteCurr').value; 
    const desc = document.getElementById('exDesc').value; 
    const rate = parseFloat(document.getElementById('fxRate').value);

    if (!baseAmt || baseAmt <= 0 || !quoteAmt || baseCurr === quoteCurr) { 
        alert("ุงุทูุงุนุงุช ูุงูุต ุงุณุช"); return; 
    }

    if (!db.avgRates) db.avgRates = {};
    let profit = 0; 

    // --- ุงูู) ูุญุงุณุจู ุณูุฏ ุจุฑุง ูุฑูุด ---
    if (fxDirection === 'Sell') {
        const avgBuyRate = db.avgRates[baseCurr] || 0; 
        if (avgBuyRate > 0) {
            let totalCost = 0;
            // ููุงู ููุทู ููุดููุฏ: ุงฺฏุฑ ูุฑุฎ ุฐุฎุฑู ุดุฏู ุจุงูุง 2 ุจูุฏุ ุชูุณู ฺฉู
            if (avgBuyRate > 2) {
                totalCost = baseAmt / avgBuyRate;
            } else {
                totalCost = baseAmt * avgBuyRate;
            }
            profit = quoteAmt - totalCost; 
        }
    }

    // --- ุจ) ุขูพุฏุช ูุฑุฎ ูุงูฺฏู ุจุฑุง ุฎุฑุฏ ---
    if (fxDirection === 'Buy') {
        const oldQty = (db.cashBox[baseCurr] || 0) + (db.initialCapital[baseCurr] || 0);
        const oldRate = db.avgRates[baseCurr] || 0;
        
        let oldTotalValue = 0;
        // ุงฺฏุฑ ููุฌูุฏ ูุจู ุฏุงุฑูุ ุงุฑุฒุด ุฏูุงุฑโุงุด ุฑุง ุญุณุงุจ ฺฉู
        if(oldRate > 0) {
             if(oldRate > 2) oldTotalValue = oldQty / oldRate; // ุงฺฏุฑ ูุฑุฎ ูุจู ุฏุณุช ูุงุฑุฏ ุดุฏู ู ุจุฒุฑฺฏ ุงุณุช (ูุซู 70)
             else oldTotalValue = oldQty * oldRate; // ุงฺฏุฑ ูุฑุฎ ุงุชููุงุชฺฉ ุง ฺฉูฺฺฉ ุงุณุช
        }

        const newTradeValue = quoteAmt; // ูพูู ฺฉู ุฏุงุฏู (ุงุฑุฒุด ุฎุฑุฏ ุฌุฏุฏ)
        const totalNewQty = oldQty + baseAmt; // ููุฌูุฏ ุฌุฏุฏ

        if (totalNewQty > 0) {
            // ูุญุงุณุจู ูุฑุฎ ูุงูฺฏู ุฌุฏุฏ
            // ุณุณุชู ูุฑุฎ ุฑุง ุจู ุตูุฑุช "ุถุฑุจ" (Multiplier) ุฐุฎุฑู ูโฺฉูุฏ ุชุง ุฏููโุชุฑ ุจุงุดุฏ
            // ูฺฏุฑ ุงูฺฉู ฺฉุงุฑุจุฑ ุฏุณุช ุฏุฑ ุชูุธูุงุช ุชุบุฑุด ุฏูุฏ
            const newAvgRate = (oldTotalValue + newTradeValue) / totalNewQty;
            
            // ุงูุง ุงฺฏุฑ ฺฉุงุฑุจุฑ ุนุงุฏุช ุฏุงุฑุฏ ูุฑุฎ ุฑุง ุจุฒุฑฺฏ (ูุซู 70) ุจุจูุฏุ ูุง ูู ุจุฒุฑฺฏ ุฐุฎุฑู ฺฉููุ
            // ุฎุฑุ ุจูุชุฑ ุงุณุช ูุฑุฎ ูุงูุน (Cost per Unit) ุฐุฎุฑู ุดูุฏ ุชุง ูุญุงุณุจุงุช ุจุนุฏ ุฏูู ุจุงุดุฏ.
            // ุงู ุนุฏุฏ ููฺฉู ุงุณุช 0.0142 ุดูุฏ ฺฉู ุตุญุญ ุงุณุช.
            db.avgRates[baseCurr] = (oldTotalValue + newTradeValue) / totalNewQty; 
        }
    }

    const logData = { baseCurr: baseCurr, baseAmt: baseAmt, quoteCurr: quoteCurr, quoteAmt: quoteAmt, direction: fxDirection, profit: profit, isInternal: false };
    const actionText = fxDirection === 'Buy' ? `Buy ${baseAmt} ${baseCurr}` : `Sell ${baseAmt} ${baseCurr}`;

    if (exType === 'internal') {
        const cust = document.getElementById('exCustomer').value; 
        if (!cust) { alert('ูุดุชุฑ ุงูุชุฎุงุจ ูุดุฏู'); return; }
        const id1 = Date.now(); const id2 = Date.now() + 1;

        if (fxDirection === 'Buy') {
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `ูุฑูุด ุงุฑุฒ ุจู ุตุฑุงู (${actionText} @ ${rate})`, curr: baseCurr, debit: baseAmt, credit: 0, type: 'debit' });
            db.accounts[cust].push({ id: id2, date: Date.now(), desc: `ุฏุฑุงูุช ูุนุงุฏู (${quoteAmt} ${quoteCurr})`, curr: quoteCurr, debit: 0, credit: quoteAmt, type: 'credit' });
        } else {
            db.accounts[cust].push({ id: id1, date: Date.now(), desc: `ุฎุฑุฏ ุงุฑุฒ ุงุฒ ุตุฑุงู (${actionText} @ ${rate})`, curr: baseCurr, debit: 0, credit: baseAmt, type: 'credit' });
            db.accounts[cust].push({ id: id2, date: Date.now(), desc: `ูพุฑุฏุงุฎุช ูุนุงุฏู (${quoteAmt} ${quoteCurr})`, curr: quoteCurr, debit: quoteAmt, credit: 0, type: 'debit' });
        }
        logData.isInternal = true; logData.cust = cust; logData.accId1 = id1; logData.accId2 = id2;
        logTx('ุตุฑุงู (ุฏุงุฎู)', `Int FX ${cust}`, `${actionText}`, 'EXCHANGE', logData);

    } else {
        if (fxDirection === 'Buy') { 
            if ((db.cashBox[quoteCurr] || 0) + (db.initialCapital[quoteCurr] || 0) < quoteAmt) { alert(`ููุฌูุฏ ุตูุฏูู ${quoteCurr} ฺฉู ุงุณุช!`); return; } 
            db.cashBox[baseCurr] = (db.cashBox[baseCurr] || 0) + baseAmt; 
            db.cashBox[quoteCurr] = (db.cashBox[quoteCurr] || 0) - quoteAmt; 
        } else { 
            if ((db.cashBox[baseCurr] || 0) + (db.initialCapital[baseCurr] || 0) < baseAmt) { alert(`ููุฌูุฏ ุตูุฏูู ${baseCurr} ฺฉู ุงุณุช!`); return; } 
            db.cashBox[baseCurr] = (db.cashBox[baseCurr] || 0) - baseAmt; 
            db.cashBox[quoteCurr] = (db.cashBox[quoteCurr] || 0) + quoteAmt; 
        }
        
        if (profit !== 0 && fxDirection === 'Sell') { 
            fxProfit[quoteCurr] = (fxProfit[quoteCurr] || 0) + profit; 
        }
        logTx('ุตุฑุงู', 'Cash FX', `${actionText} -> ${quoteAmt} ${quoteCurr}`, 'EXCHANGE', logData);
    }

    await saveDB(); 
    renderDashboard(); 
    
    document.getElementById('exCostBasis').value = '';
    document.getElementById('estimatedProfit').innerText = '---';
    
    let msg = 'ูุนุงููู ุงูุฌุงู ุดุฏ.';
    if(profit !== 0 && fxDirection === 'Sell') {
        if(profit > 0) msg += `\nโ ุณูุฏ ุงู ูุนุงููู: ${profit.toLocaleString(undefined, {maximumFractionDigits: 2})} ${quoteCurr}`;
        else msg += `\nโ ุฒุงู ุงู ูุนุงููู: ${profit.toLocaleString(undefined, {maximumFractionDigits: 2})} ${quoteCurr}`;
    }
    alert(msg);
}

function printLedger() { 
    const c = document.getElementById('selCustomer').value; 
    if (!c) { alert('ูุดุชุฑ ุงูุชุฎุงุจ ูุดุฏู ุงุณุช.'); return; }
    const list = db.accounts[c] || []; list.sort((a, b) => a.date - b.date);
    const balances = {};
    const rows = list.map(x => { 
        balances[x.curr] = (balances[x.curr] || 0) + (x.credit - x.debit); 
        return `<tr><td style="text-align:center">${new Date(x.date).toLocaleDateString('fa-IR')}</td><td>${escapeHtml(x.desc)}</td><td style="text-align:center">${x.curr}</td><td dir="ltr" style="text-align:center">${x.debit > 0 ? x.debit.toLocaleString() : '-'}</td><td dir="ltr" style="text-align:center">${x.credit > 0 ? x.credit.toLocaleString() : '-'}</td><td dir="ltr" style="text-align:center; font-weight:bold">${balances[x.curr].toLocaleString()}</td></tr>`; 
    }).join('');
    const finalSum = Object.entries(balances).map(([curr, val]) => `<div style="margin-left:20px"><b>${curr}:</b> <span dir="ltr">${val.toLocaleString()}</span></div>`).join('');
    const accNum = `ACC-${Math.abs(c.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)||0).toString().substring(0,8)}`; 
    const win = window.open('', '_blank', 'width=900,height=1000');
    win.document.write(`<html><head><title>Bank Statement - ${c}</title><style>@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap'); body { font-family: 'Vazirmatn', sans-serif; direction: rtl; padding: 40px; color: #000; font-size: 12px; } .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #b8860b; padding-bottom: 10px; margin-bottom: 20px; } .cust-box { border: 1px solid #b8860b; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: flex; justify-content: space-between; } table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; } th { border: 1px solid #b8860b; background: #eee; padding: 8px; font-weight: bold; text-align: center; } td { border: 1px solid #ccc; padding: 6px; } .summary { display: flex; justify-content: flex-end; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; } @media print { @page { margin: 10mm; } }</style></head><body>${getPrintHeaderHTML()}<div class="header"><div class="title" style="font-size:20px; font-weight:bold">ุตูุฑุชโุญุณุงุจ ูุงู</div><div class="meta">Date: ${new Date().toLocaleDateString('fa-IR')}</div></div><div class="cust-box"><div><div style="color:#555; font-size:10px">ูุงู ุตุงุญุจ ุญุณุงุจ</div><div style="font-size:16px; font-weight:bold">${c}</div></div><div style="text-align:left"><div style="color:#555; font-size:10px">ุดูุงุฑู ุญุณุงุจ</div><div style="font-size:14px; font-weight:bold">${accNum}</div></div></div><table><thead><tr><th style="width:15%">ุชุงุฑุฎ</th><th style="width:40%">ุดุฑุญ</th><th style="width:10%">ุงุฑุฒ</th><th style="width:10%">ุจุฏูฺฉุงุฑ</th><th style="width:10%">ุจุณุชุงูฺฉุงุฑ</th><th style="width:15%">ูุงูุฏู</th></tr></thead><tbody>${rows}</tbody></table><div class="summary"><div style="font-weight:bold; margin-left:10px">ูุงูุฏู ููุง:</div><div style="display:flex">${finalSum}</div></div></body></html>`); 
    win.document.close(); win.print();
}

function printHawalaList() {
    // 1. ฺฏุฑูุชู ููุชุฑูุง
    const filterCity = document.getElementById('filterHCity').value;
    const filterType = document.getElementById('filterHType').value;
    const filterStatus = document.getElementById('filterHStatus').value;

    if (filterType === 'All') {
        alert("ูุทูุงู ููุน (ุงุฑุณุงู ุง ุฏุฑุงูุช) ุฑุง ูุดุฎุต ฺฉูุฏ.");
        return;
    }

    // 2. ููุชุฑ ฺฉุฑุฏู ุฏุงุฏูโูุง
    const filtered = db.hawalas.filter(h =>
        (filterCity === 'All' || h.cityBook === filterCity) &&
        (h.type === filterType) &&
        (filterStatus === 'All' || h.status === filterStatus)
    ).sort((a, b) => a.regDate - b.regDate);

    if (filtered.length === 0) {
        alert("ูฺ ุญูุงููโุง ุงูุช ูุดุฏ.");
        return;
    }

    // 3. ุดูุงุณุง ุงุฑุฒูุง ููุฌูุฏ ุฏุฑ ูุณุช (ุจุฑุง ุณุชููโูุง ูุจูุบ)
    const presentCurrencies = [...new Set(filtered.map(h => h.curr))];

    // 4. ูุญุงุณุจู ุฌูุน ฺฉู ูุจุงูุบ ู ุฌูุน ฺฉู ฺฉูุดูโูุง (ุจู ุชูฺฉฺฉ ุงุฑุฒ)
    let amountTotals = {};
    let commTotals = {}; // ุขุจุฌฺฉุช ุฌุฏุฏ ุจุฑุง ูฺฏูุฏุงุฑ ุฌูุน ฺฉูุดู ูุฑ ุงุฑุฒ

    // ููุฏุงุฑุฏู ุงููู
    presentCurrencies.forEach(c => amountTotals[c] = 0);

    filtered.forEach(h => {
        // ุฌูุน ูุจูุบ ุญูุงูู
        amountTotals[h.curr] += h.amt;

        // ุฌูุน ฺฉูุดู (ุจุง ุชุดุฎุต ุงุฑุฒ ฺฉูุดู)
        if(h.comm && h.comm !== 0) {
            // ุงฺฏุฑ ุงุฑุฒ ฺฉูุดู ุฌุฏุงฺฏุงูู ุซุจุช ุดุฏู ุจูุฏ (commCurr) ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุ ูฺฏุฑูู ุงุฒ ุงุฑุฒ ุฎูุฏ ุญูุงูู
            const cCurr = h.commCurr || h.curr;
            
            if(!commTotals[cCurr]) commTotals[cCurr] = 0;
            commTotals[cCurr] += h.comm;
        }
    });

    // 5. ุณุงุฎุช ูุฏุฑ ุฌุฏูู ุจุฑุง ุงุฑุฒูุง
    let currencyHeaders = presentCurrencies.map(c => 
        `<th style="background:#e0e0e0;">ูุจูุบ (${c})</th>`
    ).join('');

    // 6. ุณุงุฎุช ุฑุฏูโูุง ุฌุฏูู
    const tableRows = filtered.map((h, i) => {
        const sName = `${h.sender} ${h.senderLast||''}`;
        const sFather = h.senderFather ? `ููุฏ: ${h.senderFather}` : '';
        const sPhone = h.senderPhone ? `ููุจุงู: ${h.senderPhone}` : '';
        const sID = h.senderID ? `ุชุฐฺฉุฑู: ${h.senderID}` : '';

        const rName = `${h.receiver} ${h.receiverLast||''}`;
        const rFather = h.receiverFather ? `ููุฏ: ${h.receiverFather}` : '';
        const rPhone = h.receiverPhone ? `ููุจุงู: ${h.receiverPhone}` : '';
        const rID = h.receiverID ? `ุชุฐฺฉุฑู: ${h.receiverID}` : ''; 

        const dateStr = new Date(h.regDate).toLocaleDateString('fa-IR');
        const desc = h.receiverPurpose || h.senderPurpose || '-';
        const commText = h.comm ? `${h.comm} <span style="font-size:9px">(${h.commCurr||h.curr})</span>` : '0';

        // ุณุงุฎุช ุณุชููโูุง ูุจูุบ (ุชูฺฉฺฉ ุดุฏู)
        const amountCells = presentCurrencies.map(curr => {
            if (h.curr === curr) {
                return `<td style="text-align:center; font-weight:bold; font-size:13px;">${h.amt.toLocaleString()}</td>`;
            } else {
                return `<td style="text-align:center; color:#ccc;">-</td>`;
            }
        }).join('');

        return `
            <tr>
                <td style="text-align:center;">${i + 1}</td>
                <td style="text-align:center;"><b style="font-size:12px">${h.displayId || h.id}</b></td>
                
                <td class="info-cell">
                    <div class="main-name">${sName}</div>
                    ${sFather ? `<div><span class="sub-label">${sFather}</span></div>` : ''}
                    ${sPhone ? `<div><span class="sub-label">${sPhone}</span></div>` : ''}
                    ${sID ? `<div><span class="sub-label">${sID}</span></div>` : ''}
                </td>

                <td class="info-cell">
                    <div class="main-name">${rName}</div>
                    ${rFather ? `<div><span class="sub-label">${rFather}</span></div>` : ''}
                    ${rPhone ? `<div><span class="sub-label">${rPhone}</span></div>` : ''}
                    ${rID ? `<div><span class="sub-label">${rID}</span></div>` : ''}
                </td>

                ${amountCells} <td style="text-align:center; font-weight:bold;" dir="ltr">${commText}</td>
                <td style="text-align:center; font-size:11px;">${desc}</td>
                <td style="text-align:center; font-size:11px;">${dateStr}</td>
            </tr>
        `;
    }).join('');

    // 7. ุณุงุฎุช HTML ุจุฑุง ุฌูุน ูุจุงูุบ (ุจุงูุง ุตูุญู)
    let summaryAmountsHtml = presentCurrencies.map(c => 
        `<div class="summary-item">ูุฌููุน ${c}: <b dir="ltr">${amountTotals[c].toLocaleString()}</b></div>`
    ).join('');

    // 8. ุณุงุฎุช HTML ุจุฑุง ุฌูุน ฺฉูุดูโูุง (ุงุตูุงุญ ุดุฏู: ููุงุด ุชูฺฉฺฉ)
    let summaryCommsHtml = '';
    const commCurrencies = Object.keys(commTotals);
    if (commCurrencies.length === 0) {
        summaryCommsHtml = '<b dir="ltr">0</b>';
    } else {
        summaryCommsHtml = commCurrencies.map(c => 
            `<span style="margin:0 5px; color:#d32f2f;"><b dir="ltr">${commTotals[c].toLocaleString()}</b> ${c}</span>`
        ).join(' | '); // ุฌุฏุงฺฉููุฏู ุจู ุงุฑุฒูุง ฺฉูุดู
    }

    // 9. ุจุงุฒ ฺฉุฑุฏู ุตูุญู ฺุงูพ
    const title = filterType === 'Outgoing' ? 'ฺฉุชุงุจ ุญูุงูุฌุงุช ุงุฑุณุงู' : 'ฺฉุชุงุจ ุญูุงูุฌุงุช ุฏุฑุงูุช';
    const win = window.open('', '_blank', 'width=1200,height=800');

    win.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="fa">
        <head>
            <title>${title}</title>
            <style>
                @page { size: A4 landscape; margin: 1cm; }
                body { font-family: 'Tahoma', 'Vazirmatn', sans-serif; background: #fff; padding: 10px; margin: 0; }
                
                .summary-box {
                    display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
                    border: 2px solid #000; background: #f0f0f0; border-radius: 5px;
                    padding: 15px; margin-bottom: 15px; font-size: 13px; align-items:center;
                }
                .summary-item { border: 1px dashed #999; padding: 5px 10px; background: #fff; border-radius: 4px; }
                .summary-item b { font-size: 15px; margin-right: 5px; color: #000; }
                
                /* ุงุณุชุงู ูุฎุตูุต ุจุฎุด ฺฉูุดู ุฏุฑ ูุฏุฑ */
                .comm-summary { border: 2px solid #d32f2f; background: #fff; padding: 5px 10px; border-radius: 4px; }

                table { width: 100%; border-collapse: collapse; font-size: 11px; }
                th, td { border: 1px solid #444; padding: 5px; vertical-align: top; }
                th { background: #e0e0e0; font-weight: bold; text-align: center; font-size: 12px; padding: 8px 0; }
                
                .info-cell div { margin-bottom: 2px; line-height: 1.3; }
                .main-name { font-weight: bold; font-size: 12px; border-bottom: 1px dashed #ccc; padding-bottom: 2px; margin-bottom: 3px !important; display:block; }
                .sub-label { color: #555; font-size: 10px; }

                @media print {
                    body { margin: 0; }
                    .summary-box { background: #fff !important; border: 2px solid #000; }
                    th { background: #eee !important; -webkit-print-color-adjust: exact; }
                }
            </style>
        </head>
        <body>
            ${getPrintHeaderHTML()}
            <h3 style="text-align:center; margin:5px 0 10px 0;">${title}</h3>

            <div class="summary-box">
                <div class="summary-item" style="background:#e8f5e9">ุชุนุฏุงุฏ: <b>${filtered.length}</b></div>
                
                ${summaryAmountsHtml} <div class="comm-summary">
                    ูุฌููุน ฺฉูุดู: ${summaryCommsHtml}
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width:4%">#</th>
                        <th style="width:8%">ุดูุงุฑู</th>
                        <th style="width:20%">ูุดุฎุตุงุช ูุฑุณุชูุฏู</th>
                        <th style="width:20%">ูุดุฎุตุงุช ฺฏุฑูุฏู</th>
                        
                        ${currencyHeaders} <th style="width:8%">ฺฉูุดู</th>
                        <th style="width:10%">ุฌุฒุฆุงุช</th>
                        <th style="width:8%">ุชุงุฑุฎ</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </body>
        </html>
    `);

    win.document.close();
    win.focus();
    setTimeout(() => { win.print(); }, 500); 
}

function printH(id) {
    const h = db.hawalas.find(x => x.id === id); 
    if (!h) { alert('ุญูุงูู ุงูุช ูุดุฏ.'); return; }
    
    // ูพุฏุง ฺฉุฑุฏู ุงุทูุงุนุงุช ุดูุฑ ุจุฑุง ุงุณุชุฎุฑุงุฌ ูุงู ููุงูุฏู
    const cityObj = db.cities.find(c => c.code === h.cityBook);
    const repName = cityObj && cityObj.rep ? cityObj.rep : '---';
    const cityName = cityObj ? cityObj.name : h.cityBook;

    // ุชุจุฏู ูุจูุบ ุจู ุญุฑูู
    const amtInWords = numberToPersianWords(h.amt) + " " + h.curr;
    const win = window.open('', '_blank', 'width=1000,height=1200');
    
    let content = '';

    if (h.type === 'Outgoing') {
        // --- ุฑุณุฏ ุงุฑุณุงู (ุจุฏูู ุชุบุฑ) ---
        content = `
        <html><head><title>${h.displayId}</title>
        <style>@page { size: 80mm auto; margin: 0; } body { font-family: 'Vazirmatn', Tahoma; direction: rtl; padding: 5px; font-size: 10pt; width: 78mm; } .line { display: flex; justify-content: space-between; border-bottom: 1px dashed #000; padding: 3px 0; } .center { text-align: center; } .big { font-size: 14pt; font-weight: bold; }</style>
        </head><body>
            ${getPrintHeaderHTML()}
            <div class="center">ุฑุณุฏ ุงุฑุณุงู ุญูุงูู</div>
            <div class="center big">${h.displayId}</div><br>
            <div class="line"><span>ุชุงุฑุฎ:</span><span>${new Date(h.regDate).toLocaleDateString('fa-IR')}</span></div>
            <div class="line"><span>ูุฑุณุชูุฏู:</span><span>${h.sender} ${h.senderLast||''}</span></div>
            <div class="line"><span>ฺฏุฑูุฏู:</span><span>${h.receiver} ${h.receiverLast||''}</span></div>
            <div class="line"><span>ููุตุฏ:</span><span>${cityName}</span></div>
            <div class="line"><span>ูุจูุบ:</span><span class="big" dir="ltr">${h.amt.toLocaleString()} ${h.curr}</span></div>
            <div class="line"><span>ฺฉูุดู:</span><span>${h.comm} ${h.commCurr || h.curr}</span></div>
            <div style="text-align:center; margin-top:10px; font-size:9pt;">${amtInWords}</div><br>
            <div class="center">ุงูุถุงุก ูุฑุณุชูุฏู / ูุชุตุฏ</div><br><br>.
        </body></html>`;
    } else {
        // --- ุฑุณุฏ ุฏุฑุงูุช (ุงุตูุงุญ ุดุฏู: ุฌุงุจุฌุง ุชุงุฑุฎโูุง) ---
        content = `
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <meta charset="utf-8">
            <title>${h.displayId}</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap');
                @page { size: A4; margin: 0; }
                body { font-family: 'Vazirmatn', 'Tahoma', sans-serif; background: white; margin: 0; padding: 40px; color: #222; }
                .voucher-container { width: 100%; max-width: 210mm; border: 2px solid #333; border-radius: 12px; padding: 30px; box-sizing: border-box; position: relative; }
                .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 25px; }
                .doc-title { font-size: 24px; font-weight: 900; color: #000; letter-spacing: -1px; border: 2px solid #000; padding: 8px 30px; border-radius: 50px; background: #fff; }
                .meta-info { text-align: left; font-size: 13px; line-height: 1.6; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
                .info-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; }
                .box-header { font-size: 14px; font-weight: 900; color: #555; border-bottom: 1px dashed #ddd; padding-bottom: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; }
                .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
                .label { color: #777; font-weight: 500; }
                .value { font-weight: 700; color: #000; }
                .amount-panel { background: #f4f4f4; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #ddd; margin-bottom: 40px; }
                .amt-label { font-size: 14px; color: #666; margin-bottom: 5px; }
                .amt-digit { font-size: 32px; font-weight: 900; font-family: 'Courier New', monospace; color: #000; direction: ltr; letter-spacing: 1px; }
                .amt-text { font-size: 16px; font-weight: 700; margin-top: 5px; color: #333; }
                .footer-grid { display: flex; justify-content: space-around; margin-top: 20px; }
                .sign-box { text-align: center; width: 200px; }
                .sign-title { font-weight: bold; font-size: 14px; margin-bottom: 60px; }
                .sign-line { border-top: 1px solid #000; width: 100%; display: block; }
                .rep-footer { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; text-align: center; font-size: 12px; color: #444; background: #fff; }
                @media print { body { -webkit-print-color-adjust: exact; } }
            </style>
        </head>
        <body>
            <div class="voucher-container">
                <div class="header-section">
                    <div style="flex:1">${getPrintHeaderHTML()}</div>
                    <div style="flex:1; text-align:center;">
                        <div class="doc-title">ุฑุณุฏ ุฏุฑุงูุช ูพูู ุญูุงูู </div>
                        <div style="font-size:12px; color:#666; margin-top:5px;">INCOMING TRANSFER VOUCHER</div>
                    </div>
                    <div class="meta-info" style="flex:1">
                        <div class="meta-item">ุดูุงุฑู ุณูุฏ: <b style="font-size:16px;">${h.displayId}</b></div>
                        <div class="meta-item">ุชุงุฑุฎ ุงุฌุฑุง: <b>${new Date().toLocaleDateString('fa-IR')}</b></div>
                        <div class="meta-item">ูุถุนุช: <b>ูพุฑุฏุงุฎุช ุดุฏู (ุชุณูู)</b></div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <div class="box-header"><span>ูุดุฎุตุงุช (ฺฏุฑูุฏู)</span><span>BENEFICIARY</span></div>
                        <div class="row"><span class="label">ูุงู ู ูุงู ุฎุงููุงุฏฺฏ:</span><span class="value">${h.receiver} ${h.receiverLast||''}</span></div>
                        <div class="row"><span class="label">ูุงู ูพุฏุฑ:</span><span class="value">${h.receiverFather||'-'}</span></div>
                        <div class="row"><span class="label">ุดูุงุฑู ุชูุงุณ:</span><span class="value" dir="ltr">${h.receiverPhone||'-'}</span></div>
                        <div class="row"><span class="label">ุดูุงุฑู ุชุฐฺฉุฑู/ID:</span><span class="value">${h.receiverID||'-'}</span></div>
                    </div>
                    <div class="info-box">
                        <div class="box-header"><span>ูุดุฎุตุงุช ูุฑุณุชูุฏู</span><span>SENDER</span></div>
                        <div class="row"><span class="label">ูุงู ูุฑุณุชูุฏู:</span><span class="value">${h.sender} ${h.senderLast||''}</span></div>
                        <div class="row"><span class="label">ุดูุฑ ูุจุฏุฃ:</span><span class="value">${cityName}</span></div>
                        <div class="row"><span class="label">ุจุงุจุช / ุชูุถุญุงุช:</span><span class="value">${h.receiverPurpose || h.senderPurpose || '-'}</span></div>
                        <div class="row"><span class="label">ุชุงุฑุฎ ุตุฏูุฑ:</span><span class="value">${new Date(h.regDate).toLocaleDateString('fa-IR')}</span></div>
                    </div>
                </div>

                <div class="amount-panel">
                    <div class="amt-label">ูุจูุบ ุฏุฑุงูุช / AMOUNT RECEIVED</div>
                    <div class="amt-digit">*** ${h.amt.toLocaleString()} ${h.curr} ***</div>
                    <div class="amt-text">${amtInWords}</div>
                </div>

                <div class="footer-grid">
                    <div class="sign-box">
                        <div class="sign-title">ููุฑ ู ุงูุถุงุก ุตุฑุงู (ุชุญูู ุฏููุฏู)</div>
                        <span class="sign-line"></span>
                    </div>
                    <div class="sign-box">
                        <div class="sign-title">ุงูุถุงุก ู ุงุซุฑ ุงูฺฏุดุช ูุดุชุฑ (ฺฏุฑูุฏู)</div>
                        <span class="sign-line"></span>
                    </div>
                </div>

                <div class="rep-footer">
                    ุญูุงูู ูุงุฑุฏู ุงุฒ ุทุฑู: <span style="font-weight:900; font-size:14px; color:#000;">${repName}</span>
                </div>
            </div>
        </body>
        </html>`;
    }
    
    win.document.write(content); 
    win.document.close(); 
    win.print();
}

function printCurrentTTForm() {
    const amt = document.getElementById('ttAmt').value; const curr = document.getElementById('ttCurr').value; const amtWords = document.getElementById('ttAmtWords').value; const benName = document.getElementById('ttBenName').value; const benNameEn = document.getElementById('ttBenNameEn').value; const country = document.getElementById('ttCountry').value; const city = document.getElementById('ttCityDest').value; const address = document.getElementById('ttAddress').value; const bank = document.getElementById('ttDestBank').value; const swift = document.getElementById('ttSwift').value; const iban = document.getElementById('ttIban').value; const ref = document.getElementById('ttRef').value || '---';
    if (!amt || !benName) { alert('ูุทูุงู ุงุจุชุฏุง ูุฑู ุฑุง ูพุฑ ฺฉูุฏ.'); return; }
    const win = window.open('', '_blank', 'width=900,height=1000');
    win.document.write(`<html><head><title>TT Application - ${ref}</title><style>@page { size: A4; margin: 10mm; } body { font-family: 'Times New Roman', sans-serif; padding: 20px; border: 2px solid #000; margin: 0; font-size: 11pt; } .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; } .title { font-size: 22px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; } .row { display: flex; margin-bottom: 5px; border-bottom: 1px dotted #eee; padding-bottom: 2px; } .lbl { font-weight: bold; width: 180px; } .val { flex: 1; font-family: 'Courier New', monospace; font-weight: 600; } .legal-text { direction: rtl; text-align: justify; font-family: 'Vazirmatn'; font-size: 9pt; margin-top: 30px; border-top: 2px solid #000; padding-top: 10px; background: #f9f9f9; padding: 10px; }</style></head><body>${getPrintHeaderHTML()}<div class="header"><div class="title">Telegraphic Transfer Application</div><div>REF: ${ref}</div><div>Date: ${new Date().toLocaleDateString('en-GB')}</div></div><div class="row"><span class="lbl">Beneficiary (FA):</span><span class="val" style="font-family:'Vazirmatn'">${benName}</span></div><div class="row"><span class="lbl">Beneficiary (EN):</span><span class="val">${benNameEn}</span></div><div class="row"><span class="lbl">Destination:</span><span class="val">${city}, ${country}</span></div><div class="row"><span class="lbl">Bank:</span><span class="val">${bank}</span></div><div class="row"><span class="lbl">Swift:</span><span class="val">${swift}</span></div><div class="row"><span class="lbl">IBAN:</span><span class="val">${iban}</span></div><div class="row"><span class="lbl">Amount:</span><span class="val">*** ${Number(amt).toLocaleString()} ${curr} ***</span></div><div class="row"><span class="lbl">Words:</span><span class="val">${amtWords}</span></div><div class="legal-text"><strong>ููุงูู ู ููุฑุฑุงุช / Terms & Conditions:</strong><br>ฑ. ุตุญุช ุงุทูุงุนุงุช ุจุฑ ุนูุฏู ูุดุชุฑ ุงุณุช.<br>ฒ. ูุณุฆููุช ุชุญุฑู ู ุจููฺฉู ุดุฏู ูุฌู ุจุง ูุดุชุฑ ุงุณุช.<br>ณ. ุชุงุฏ ูุตูู ุจุนุฏ ุงุฒ ท ุฑูุฒ ฺฉุงุฑ ุงุนูุงู ุดูุฏ.</div><br><br><div style="display:flex; justify-content:space-between;"><div>Signature</div><div>Company Stamp</div></div></body></html>`);
    win.document.close(); win.print();
}

function printTodayJournal() { 
    const win = window.open('', '_blank', 'width=1000,height=800');
    const originalBody = document.getElementById('journalBody');
    let rowsHTML = ""; if (originalBody) { Array.from(originalBody.rows).forEach(row => { let newRow = "<tr>"; for (let i = 0; i < 5; i++) { if (row.cells[i]) newRow += `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${row.cells[i].innerHTML}</td>`; } newRow += "</tr>"; rowsHTML += newRow; }); }
    win.document.write(`<html><head><title>Journal Report</title><style>@page { size: A4 landscape; margin: 15mm; } body { font-family: 'Vazirmatn', Tahoma, sans-serif; direction: rtl; padding: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; } th { background-color: #f2f2f2; font-weight: bold; border: 1px solid #999; padding: 10px; text-align: center; } td { border: 1px solid #ddd; padding: 8px; text-align: right; } </style></head><body>${getPrintHeaderHTML()}<h2 style="text-align:center">ฺฏุฒุงุฑุด ุฌุงูุน ุฏูุชุฑ ุฑูุฒูุงูู (Log)</h2><table><thead><tr><th style="width: 15%">ุฒูุงู</th><th style="width: 15%">ุจุฎุด ุนููุงุช</th><th style="width: 40%">ุดุฑุญ ุชุฑุงฺฉูุด</th><th style="width: 15%">ูุจูุบ / ุชุบุฑุงุช</th><th style="width: 15%">ฺฉุงุฑุจุฑ</th></tr></thead><tbody>${rowsHTML}</tbody></table></body></html>`);
    win.document.close(); win.print();
}

function printExchangeReceipt() {
    const baseAmt = document.getElementById('fxBaseAmt').value; const quoteAmt = document.getElementById('fxQuoteAmt').value; const baseCurr = document.getElementById('fxBaseCurr').value; const quoteCurr = document.getElementById('fxQuoteCurr').value; const rate = document.getElementById('fxRate').value; const desc = document.getElementById('exDesc').value || '---'; const type = fxDirection === 'Buy' ? 'ุฎุฑุฏ ุงุฑุฒ (Purchase)' : 'ูุฑูุด ุงุฑุฒ (Sale)';
    const win = window.open('', '_blank', 'width=500,height=600');
    win.document.write(`<html><head><title>Exchange Receipt</title><style>body{font-family:'Vazirmatn',tahoma;direction:rtl;padding:10px;text-align:center}.box{border:2px dashed #000;padding:20px;margin:0 auto;width:90%}.row{display:flex;justify-content:space-between;border-bottom:1px dotted #ccc;padding:5px 0}.val{font-weight:bold}</style></head><body>${getPrintHeaderHTML()}<div class="box"><h3>ุฑุณุฏ ูุนุงููู ุงุฑุฒ (Deal Ticket)</h3><div class="row"><span>ุชุงุฑุฎ:</span><span class="val">${new Date().toLocaleDateString('fa-IR')}</span></div><div class="row"><span>ููุน ุนููุงุช:</span><span class="val">${type}</span></div><div class="row"><span>ุงุฑุฒ ูพุงู (Base):</span><span class="val" dir="ltr">${baseAmt} ${baseCurr}</span></div><div class="row"><span>ุงุฑุฒ ูุชูุงุจู (Quote):</span><span class="val" dir="ltr">${quoteAmt} ${quoteCurr}</span></div><div class="row"><span>ูุฑุฎ (Rate):</span><span class="val">${rate}</span></div><div class="row"><span>ุชูุถุญุงุช:</span><span class="val">${desc}</span></div><br><p>ุจุง ุชุดฺฉุฑ ุงุฒ ุงูุชุฎุงุจ ุดูุง</p></div></body></html>`);
    win.document.close(); win.print();
}

function printCryptoFx() {
    const t = document.getElementById('cryptoTxType').value === 'Buy' ? 'ุฎุฑุฏ (Buy)' : 'ูุฑูุด (Sell)'; const n = document.getElementById('cryptoName').value; const v = document.getElementById('cryptoAmt').value; const fc = document.getElementById('cryptoCurr').value; const fa = document.getElementById('fiatAmt').value; const desc = document.getElementById('cryptoDesc').value || '---';
    const win = window.open('', '_blank', 'width=500,height=600');
    win.document.write(`<html><head><title>Crypto Receipt</title><style>body{font-family:'Vazirmatn',tahoma;direction:rtl;padding:10px;text-align:center}.box{border:3px double #000;padding:20px;margin:0 auto;width:90%}.row{display:flex;justify-content:space-between;border-bottom:1px dotted #ccc;padding:8px 0}.val{font-weight:bold}</style></head><body>${getPrintHeaderHTML()}<div class="box"><h3>ุฑุณุฏ ุงุฑุฒ ุฏุฌุชุงู (Crypto)</h3><div class="row"><span>ููุน ูุนุงููู:</span><span class="val">${t}</span></div><div class="row"><span>ูุงู ุงุฑุฒ:</span><span class="val" style="text-transform:uppercase">${n}</span></div><div class="row"><span>ููุฏุงุฑ (Volume):</span><span class="val" dir="ltr">${v}</span></div><div class="row"><span>ูุจูุบ ฺฉู (Fiat):</span><span class="val" dir="ltr">${fa} ${fc}</span></div><div class="row"><span>ูุดุชุฑ/ุชูุถุญุงุช:</span><span class="val">${desc}</span></div><br><div style="font-size:12px; border-top:1px solid #000; padding-top:10px;">ุงูุถุงุก ู ููุฑ</div></div></body></html>`);
    win.document.close(); win.print();
}

function exportDB() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], { type: "application/json" })); a.download = `Backup_${Date.now()}.json`; a.click(); }
function importDB() { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => { const r = new FileReader(); r.onload = async ev => { try { db = JSON.parse(ev.target.result); await dbAdapter.saveAll(db); location.reload(); } catch (x) { alert('File Error'); } }; r.readAsText(e.target.files[0]); }; i.click(); }
// --- ุดุฑูุน ฺฉุฏูุง ุงฺฉุณู ---

// 1. ุฎุฑูุฌ ุงฺฉุณู ุจุฑุง ูุณุช ุญูุงููโูุง
function exportHawalaToExcel() { 
    // ฺฏุฑูุชู ููุชุฑูุง ุงุนูุงู ุดุฏู ุชูุณุท ฺฉุงุฑุจุฑ
    const filterCity = document.getElementById('filterHCity').value; 
    const filterType = document.getElementById('filterHType').value; 
    const filterStatus = document.getElementById('filterHStatus').value;
    
    // ููุชุฑ ฺฉุฑุฏู ุฏุงุฏูโูุง ุจุฑ ุงุณุงุณ ุงูุชุฎุงุจ ฺฉุงุฑุจุฑ
    const filteredHawalas = db.hawalas.filter(h => 
        (filterCity === 'All' || h.cityBook === filterCity) && 
        (filterType === 'All' || h.type === filterType) && 
        (filterStatus === 'All' || h.status === filterStatus)
    ).sort((a, b) => b.regDate - a.regDate); // ูุฑุชุจโุณุงุฒ ุจุฑ ุงุณุงุณ ุชุงุฑุฎ (ุฌุฏุฏ ุจู ูุฏู)
    
    const data = []; 
    
    // ุจุฎุด ุงูู: ูุญุงุณุจู ูุฌููุน ูุจุงูุบ ุจุฑุง ูุฑ ุงุฑุฒ
    data.push({ 'ููุจุฑ_ุญูุงูู': '--- ุฎูุงุตู ููุฌูุฏ ุงุฑุฒูุง ุฏุฑ ุงู ูุณุช ---' });
    
    let currencyTotals = {}; 
    filteredHawalas.forEach(h => { 
        if(!currencyTotals[h.curr]) currencyTotals[h.curr] = 0; 
        currencyTotals[h.curr] += h.amt; 
    }); 
    
    for(let c in currencyTotals) { 
        data.push({ 'ููุจุฑ_ุญูุงูู': c, 'ูุจูุบ': currencyTotals[c] }); 
    } 
    
    // ุงุฌุงุฏ ูุงุตูู ุฏุฑ ุงฺฉุณู
    data.push({}); 
    data.push({});
    
    // ุจุฎุด ุฏูู: ูุณุช ฺฉุงูู ุญูุงููโูุง
    filteredHawalas.forEach(h => { 
        data.push({ 
            'ููุจุฑ_ุญูุงูู': h.displayId || h.id, 
            'ููุน': h.type === 'Outgoing' ? 'ุตุงุฏุฑู (ุงุฑุณุงู)' : 'ูุงุฑุฏู (ุฏุฑุงูุช)', 
            'ุดูุฑ_ฺฉุชุงุจ': db.cities.find(c => c.code === h.cityBook)?.name || h.cityBook, 
            'ูุจูุบ': h.amt, 
            'ฺฉูุดู': h.comm || 0, 
            'ุงุฑุฒ': h.curr, 
            'ูุฑุณุชูุฏู': h.sender, 
            'ฺฏุฑูุฏู': h.receiver, 
            'ุชููู': h.phone, 
            'ุชุงุฑุฎ_ุซุจุช': new Date(h.regDate).toLocaleDateString('fa-IR'), 
            'ูุถุนุช': h.status === 'Done' ? 'ุงุฌุฑุง ุดุฏู' : 'ุฏุฑ ุงูุชุธุงุฑ' 
        }); 
    });
    
    // ุชุจุฏู ุฏุงุฏูโูุง ุจู ุดุช ุงฺฉุณู
    const ws = XLSX.utils.json_to_sheet(data); 
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "ูุณุช ุญูุงูุฌุงุช"); 
    
    // ุฏุงูููุฏ ูุงู
    XLSX.writeFile(wb, `Hawala_List_${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.xlsx`);
}

// 2. ุฎุฑูุฌ ุงฺฉุณู ุจุฑุง ุตูุฑุชโุญุณุงุจ ูุดุชุฑ (Ledger)
function exportLedgerToExcel() {
    const c = document.getElementById('selCustomer').value; 
    if(!c) {
        alert("ูุทูุง ุงุจุชุฏุง ฺฉ ูุดุชุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.");
        return;
    }
    
    const list = db.accounts[c] || []; 
    // ูุฑุชุจโุณุงุฒ ุชุฑุงฺฉูุดโูุง ุงุฒ ูุฏู ุจู ุฌุฏุฏ ุจุฑุง ุตูุฑุชโุญุณุงุจ
    list.sort((a, b) => a.date - b.date);
    
    // ูุญุงุณุจู ูุงูุฏู ููุง ูุฑ ุงุฑุฒ
    const balances = {}; 
    list.forEach(x => { 
        balances[x.curr] = (balances[x.curr] || 0) + (x.credit - x.debit); 
    });
    
    const balanceString = Object.entries(balances)
        .map(([curr, val]) => `${val.toLocaleString()} ${curr}`)
        .join(' | ');
    
    const data = []; 
    
    // ูุฏุฑ ฺฏุฒุงุฑุด
    data.push({ 'ุชุงุฑุฎ': `ูุงู ูุดุชุฑ: ${c}`, 'ุดุฑุญ': `ูุงูุฏู ููุง ุญุณุงุจ: ${balanceString}` }); 
    data.push({}); 
    
    // ุฑุฏูโูุง ุตูุฑุชโุญุณุงุจ
    list.forEach(x => { 
        data.push({ 
            'ุชุงุฑุฎ': new Date(x.date).toLocaleDateString('fa-IR'), 
            'ุดุฑุญ': x.desc, 
            'ุงุฑุฒ': x.curr, 
            'ุจุฏูฺฉุงุฑ': x.debit > 0 ? x.debit : 0, 
            'ุจุณุชุงูฺฉุงุฑ': x.credit > 0 ? x.credit : 0 
        }); 
    });
    
    // ุณุงุฎุช ุดุช ุงฺฉุณู
    const ws = XLSX.utils.json_to_sheet(data); 
    
    // ุชูุธู ุนุฑุถ ุณุชููโูุง ุจุฑุง ุฒุจุง ุจุดุชุฑ
    const wscols = [
        {wch:15}, // ุนุฑุถ ุณุชูู ุชุงุฑุฎ
        {wch:50}, // ุนุฑุถ ุณุชูู ุดุฑุญ
        {wch:10}, // ุนุฑุถ ุณุชูู ุงุฑุฒ
        {wch:15}, // ุนุฑุถ ุณุชูู ุจุฏูฺฉุงุฑ
        {wch:15}  // ุนุฑุถ ุณุชูู ุจุณุชุงูฺฉุงุฑ
    ]; 
    ws['!cols'] = wscols;
    
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Ledger"); 
    
    // ุฏุงูููุฏ ูุงู ุจุง ูุงู ูุดุชุฑ
    XLSX.writeFile(wb, `ุตูุฑุชุญุณุงุจ_${c}.xlsx`);
}
// --- ูพุงุงู ฺฉุฏูุง ุงฺฉุณู ---
async function setInitialCapital() { 
    if (currentUser.perms.admin) { 
        if (!db.avgRates) db.avgRates = {}; 
        db.currencies.forEach(c => {
            db.initialCapital[c] = parseFloat(document.getElementById(`initCap_${c}`).value) || 0;
            const rateInput = document.getElementById(`initRate_${c}`);
            if(rateInput) { db.avgRates[c] = parseFloat(rateInput.value) || 0; }
        });
        await saveDB(); 
        alert('ุณุฑูุงู ู ูุฑุฎ ุฎุฑุฏ ุฐุฎุฑู ุดุฏ.'); 
        renderDashboard(); 
    } 
}
async function changeMyPass() { const p = document.getElementById('myNewPass').value; if (p.length < 4) return; const u = db.users.find(x => x.u === currentUser.u); u.salt = generateSalt(); u.hash = hashPassword(p, u.salt); await saveDB(); alert('Password Changed.'); }
async function addUser() { const u = document.getElementById('newUName').value, p = document.getElementById('newUPass').value; if (u && p) { const s = generateSalt(); db.users.push({ u, salt: s, hash: hashPassword(p, s), perms: { hawala: document.getElementById('perm_hawala').checked, exchange: document.getElementById('perm_exchange').checked, accounts: document.getElementById('perm_accounts').checked, tt: document.getElementById('perm_tt').checked, admin: document.getElementById('perm_admin').checked } }); await saveDB(); renderUserManagement(); alert("User Added."); } }
function renderUserManagement() { document.getElementById('userListManage').innerHTML = db.users.map(u => `<div>${u.u} <button onclick="delUser('${u.u}')" class="btn btn-red" style="padding:2px 5px; font-size:10px">Delete</button></div>`).join(''); }
async function delUser(u) { if (u !== 'admin' && confirm('Delete?')) { db.users = db.users.filter(x => x.u !== u); await saveDB(); renderUserManagement(); alert("Deleted."); } }
async function addCity() { 
    const n = document.getElementById('newCityName').value.trim();
    const c = document.getElementById('newCityCode').value.trim().toUpperCase();
    const rep = document.getElementById('newCityRep').value.trim(); 
    const contact = document.getElementById('newCityContact').value.trim(); 

    if (n && c) { 
        db.cities.push({ name: n, code: c, rep: rep, contact: contact }); 
        db.cityHawalaCounters[c] = { Outgoing: 1001, Incoming: 1001 }; 
        await saveDB(); 
        updateUI(); 
        
        document.getElementById('newCityName').value = '';
        document.getElementById('newCityCode').value = '';
        document.getElementById('newCityRep').value = '';
        document.getElementById('newCityContact').value = '';

        alert("ุดูุฑ ู ูุดุฎุตุงุช ููุงูุฏู ุจุง ููููุช ุซุจุช ุดุฏ."); 
    } else {
        alert("ูุงู ุดูุฑ ู ฺฉุฏ ุดูุฑ ุงูุฒุงู ุงุณุช.");
    }
}
async function addCurrency() { const c = document.getElementById('newCurrCode').value.toUpperCase(); if (c && !db.currencies.includes(c)) { db.currencies.push(c); db.cashBox[c] = 0; db.initialCapital[c] = 0; await saveDB(); updateUI(); alert("Currency Added."); } }
async function deleteCurrency() { const c = document.getElementById('currToDelete').value; if(c && confirm('Delete?')) { db.currencies = db.currencies.filter(x=>x!==c); delete db.cashBox[c]; await saveDB(); updateUI(); renderDashboard(); alert("Deleted."); } }
function checkCityForDelete() { const c = document.getElementById('cityToDelete').value; document.getElementById('transferCitySection').style.display = db.hawalas.some(h=>h.cityBook===c) ? 'block' : 'none'; }
async function deleteCityProcess() { const c = document.getElementById('cityToDelete').value; if(!c) return; const hasH = db.hawalas.some(h=>h.cityBook===c); if(hasH) { const t=document.getElementById('cityTransferTarget').value; if(!t)return alert('Select Target'); db.hawalas.forEach(h=>{if(h.cityBook===c)h.cityBook=t}); } db.cities=db.cities.filter(x=>x.code!==c); await saveDB(); updateUI(); alert('City Deleted.'); }
async function resetData() { if (confirm('Warning: Full Reset?')) { db.hawalas = []; db.accounts = {}; db.journal = []; db.customers = []; db.cityHawalaCounters = {}; db.cities.forEach(c => db.cityHawalaCounters[c.code] = { Outgoing: 1001, Incoming: 1001 }); db.currencies.forEach(c => db.cashBox[c] = 0); fxProfit = {}; await saveDB(); location.reload(); } }
let allAccountsCache = []; 
function openAllAccountsModal() { allAccountsCache = db.customers.map(c => { const bal = {}; if(db.accounts[c.name]) { db.accounts[c.name].forEach(x => { bal[x.curr] = (bal[x.curr] || 0) + (x.credit - x.debit); }); } return { name: c.name, phone: c.phone, balances: bal }; }); renderAllAccountsList(allAccountsCache); document.getElementById('searchAllAcc').value = ''; openModal('modalAllAcc'); }
function filterAllAccounts() { const q = document.getElementById('searchAllAcc').value.toLowerCase().trim(); if (!q) { renderAllAccountsList(allAccountsCache); return; } const filtered = allAccountsCache.filter(x => { const n = x.name ? x.name.toLowerCase() : ""; const p = x.phone ? x.phone.toString() : ""; return n.includes(q) || p.includes(q); }); renderAllAccountsList(filtered); }
function renderAllAccountsList(list) {
    const container = document.getElementById('allAccountsList');
    if(list.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:gray">No Data</div>'; return; }
    container.innerHTML = list.map(item => {
        let balancesHtml = ''; let hasBalance = false;     
        for(let k in item.balances) { if(Math.abs(item.balances[k]) > 0.1) { hasBalance = true; const colorClass = item.balances[k] >= 0 ? 'text-green' : 'text-red'; const sign = item.balances[k] >= 0 ? '+' : ''; balancesHtml += `<span style="margin-left:8px; font-size:12px; background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:10px; border:1px solid rgba(212,175,5,0.2)">${k}: <span class="${colorClass}" dir="ltr" style="font-weight:900">${sign}${item.balances[k].toLocaleString()}</span></span>`; } }
        if(!hasBalance) { balancesHtml = '<span style="font-size:11px; opacity:0.6; color:var(--text-muted)">Settled</span>'; }
        return `<div class="account-list-item" onclick="selectAndOpenLedger('${item.name}')"><div style="display:flex; align-items:center; gap:10px;"><div style="background:var(--gold-faint); color:var(--gold-primary); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:1px solid var(--gold-border)">${item.name.charAt(0)}</div><div><div style="font-weight:bold; font-size:15px; color:var(--text-main)">${item.name}</div><div style="font-size:11px; opacity:0.7; color:var(--gold-primary)">${item.phone || ''}</div></div></div><div style="text-align:left; display:flex; flex-direction:column; align-items:flex-end; gap:5px; margin-top:5px;">${balancesHtml}</div></div>`;
    }).join('');
}
function selectAndOpenLedger(name) { closeModal('modalAllAcc'); go('accounts'); setTimeout(() => { const sel = document.getElementById('selCustomer'); const opt = Array.from(sel.options).find(o => o.value === name); if (!opt) { return setTimeout(() => selectAndOpenLedger(name), 150); } sel.value = name; loadCustomerLedger(); }, 200); }
function toggleAdminAccess(checkbox) { const isChecked = checkbox.checked; document.getElementById('perm_hawala').checked = isChecked; document.getElementById('perm_exchange').checked = isChecked; document.getElementById('perm_accounts').checked = isChecked; document.getElementById('perm_tt').checked = isChecked; }
// --- ุดุฑูุน ฺฉุฏูุง ุฌุฏุฏ ูพุฑููุงู ุดุฑฺฉุช ---
async function saveCompanyProfile() {
    if (!db.settings) db.settings = {};
    
    // ฺฏุฑูุชู ุงุทูุงุนุงุช ุงุฒ ฺฉุงุฏุฑูุง
    db.settings.companyName = document.getElementById('setCompName').value;
    db.settings.slogan = document.getElementById('setCompSlogan').value;
    db.settings.phone = document.getElementById('setCompPhone').value;
    db.settings.address = document.getElementById('setCompAddress').value;
    db.settings.footerMsg = document.getElementById('setCompFooter').value;
    
    await saveDB();
    applyCompanySettings();
    alert('ุชูุธูุงุช ุดุฑฺฉุช ุฐุฎุฑู ุดุฏ!');
}

function applyCompanySettings() {
    if (!db.settings) return;
    
    const name = db.settings.companyName || "ุตุฑุงู ูุฑุงุชโูุง";
    const slogan = db.settings.slogan || "ุฎุฏูุงุช ูพูู ู ุงุฑุฒ";
    
    // ุชุบุฑ ูุงู ุฏุฑ ุตูุญู ูุฑูุฏ
    const loginTitle = document.querySelector('.login-header-text');
    if(loginTitle) loginTitle.innerText = name;
    
    const loginSub = document.querySelector('.login-sub-text');
    if(loginSub) loginSub.innerText = slogan;
    
    // ุชุบุฑ ูุงู ุฏุฑ ููู ุณูุช ุฑุงุณุช
    const sidebarInfo = document.querySelector('.sidebar h2');
    if(sidebarInfo) sidebarInfo.innerText = name;
}
// --- ูพุงุงู ฺฉุฏูุง ุฌุฏุฏ ---
init();
document.addEventListener('DOMContentLoaded', () => { 
    const fxContainer = document.querySelector('.fx-container'); 
    if (fxContainer) { setFxDirection('Buy'); calcFx(); } 
    setCryptoCustType('external');
});
// --- ฺฉุฏูุง ูุฏุฑุช ฺฉุงุฑููุฏุงู ---

// 1. ุงุทููุงู ุงุฒ ูุฌูุฏ ุฏุชุงุจุณ ฺฉุงุฑููุฏุงู
if (!db.employees) { db.employees = []; }

// 2. ุชุงุจุน ููุงุด ูุณุช ฺฉุงุฑููุฏุงู
function renderEmployees() {
    const tbody = document.getElementById('employeeBody');
    if (!tbody) return;
    
    tbody.innerHTML = db.employees.map(emp => {
        const bal = emp.balance || 0;
        // ุงฺฏุฑ ุจุงูุงูุณ ูุซุจุช ุจุงุดุฏ ุนู ูุง ุจุฏูฺฉุงุฑู (ูุฑูุฒ)ุ ุงฺฏุฑ ููู ุง ุตูุฑ ุจุงุดุฏ ุณุจุฒ
        const color = bal > 0 ? 'var(--danger)' : 'var(--success)';
        
        return `
            <tr>
                <td style="font-weight:bold">${emp.name}</td>
                <td>${emp.job}</td>
                <td>${parseInt(emp.salary).toLocaleString()} ${emp.curr}</td>
                <td style="color:${color}; font-weight:900; direction:ltr">${bal.toLocaleString()} ${emp.curr}</td>
                <td>
                    <button class="btn btn-gold btn-sm" onclick="accrueSalary('${emp.id}')" title="ูุงู ุชูุงู ุดุฏุ ุญููู ุฑุง ุจู ุญุณุงุจุด ุจุฒู">๐ ุณุฑุฑุณุฏ ุญููู</button>
                    <button class="btn btn-blue btn-sm" onclick="paySalary('${emp.id}')" title="ูพุฑุฏุงุฎุช ูพูู ููุฏ ุงุฒ ุตูุฏูู">๐ฐ ูพุฑุฏุงุฎุช ููุฏ</button>
                    <button class="btn btn-red btn-sm" onclick="deleteEmployee('${emp.id}')">๐</button>
                </td>
            </tr>
        `;
    }).join('');
    
    // ูพุฑ ฺฉุฑุฏู ูุณุช ุงุฑุฒูุง ุฏุฑ ูุฑู ุฌุฏุฏ
    const currSelect = document.getElementById('empCurr');
    if(currSelect && currSelect.options.length === 0) {
        currSelect.innerHTML = db.currencies.map(c => `<option value="${c}">${c}</option>`).join('');
    }
}

// 3. ุฐุฎุฑู ฺฉุงุฑููุฏ ุฌุฏุฏ
async function saveNewEmployee() {
    const name = document.getElementById('empName').value;
    const job = document.getElementById('empJob').value;
    const salary = parseFloat(document.getElementById('empSalary').value);
    const curr = document.getElementById('empCurr').value;

    if(!name || !salary) { alert("ูุทูุงู ูุงู ู ุญููู ุฑุง ูุงุฑุฏ ฺฉูุฏ"); return; }

    const newEmp = {
        id: Date.now().toString(),
        name: name,
        job: job,
        salary: salary,
        curr: curr,
        balance: 0 // ุตูุฑ ุนู ุจโุญุณุงุจ
    };

    if(!db.employees) db.employees = [];
    db.employees.push(newEmp);
    await saveDB();
    closeModal('modalNewEmp');
    renderEmployees();
    alert("ฺฉุงุฑููุฏ ุฌุฏุฏ ุงุณุชุฎุฏุงู ุดุฏ.");
}

// 4. ุณุฑุฑุณุฏ ุญููู (ุงูุฒุงุด ุจุฏู ูุง ุจู ฺฉุงุฑููุฏ)
async function accrueSalary(id) {
    const emp = db.employees.find(e => e.id === id);
    if(!emp) return;

    if(confirm(`ุขุง ุญููู ูุงูุงูู ุจุฑุง ${emp.name} ุจู ูุจูุบ ${emp.salary} ${emp.curr} ูุญุงุณุจู ุดูุฏุ\n(ุงู ูุจูุบ ุจู ุทูุจ ฺฉุงุฑููุฏ ุงุถุงูู ูโุดูุฏ)`)) {
        emp.balance = (emp.balance || 0) + parseFloat(emp.salary);
        
        // ุซุจุช ุฏุฑ ฺฏุฒุงุฑุดุงุช
        logTx('ุญููู', `ุณุฑุฑุณุฏ ุญููู: ${emp.name}`, `Bedehi: ${emp.salary} ${emp.curr}`);
        
        await saveDB();
        renderEmployees();
    }
}

// 5. ูพุฑุฏุงุฎุช ุญููู (ฺฉุณุฑ ุงุฒ ุตูุฏูู + ฺฉุณุฑ ุงุฒ ุทูุจ ฺฉุงุฑููุฏ)
async function paySalary(id) {
    const emp = db.employees.find(e => e.id === id);
    if(!emp) return;
    
    // ูพุดููุงุฏ ูุจูุบ ูพุฑุฏุงุฎุช (ฺฉู ุจุฏู)
    const amountToPay = prompt(`ูุจูุบ ูพุฑุฏุงุฎุช ุจู ${emp.name} ุฑุง ูุงุฑุฏ ฺฉูุฏ:\n(ููุฌูุฏ ุทูุจ ุงุดุงู: ${emp.balance})`, emp.balance);
    
    if(amountToPay && parseFloat(amountToPay) > 0) {
        const amt = parseFloat(amountToPay);
        
        // ฺฺฉ ฺฉุฑุฏู ููุฌูุฏ ุตูุฏูู
        const currentCash = (db.cashBox[emp.curr] || 0) + (db.initialCapital[emp.curr] || 0);
        if(currentCash < amt) {
            alert(`ููุฌูุฏ ุตูุฏูู ${emp.curr} ฺฉุงู ูุณุช!`);
            return;
        }

        // ฺฉุณุฑ ุงุฒ ุตูุฏูู
        db.cashBox[emp.curr] -= amt;
        
        // ฺฉุณุฑ ุงุฒ ุทูุจ ฺฉุงุฑููุฏ
        emp.balance -= amt;

        // ุซุจุช ุฏุฑ ฺฏุฒุงุฑุดุงุช
        logTx('ุญููู', `ูพุฑุฏุงุฎุช ุญููู ุจู ${emp.name}`, `Cash Out: ${amt} ${emp.curr}`, 'SALARY_PAY', { empId: id, amt: amt, curr: emp.curr });

        await saveDB();
        renderEmployees();
        renderDashboard(); // ุจุฑุง ุขูพุฏุช ุดุฏู ููุฌูุฏ ุตูุฏูู ุฏุฑ ุตูุญู ุงุตู
        alert("ูพุฑุฏุงุฎุช ุงูุฌุงู ุดุฏ.");
    }
}

// 6. ุญุฐู ฺฉุงุฑููุฏ
async function deleteEmployee(id) {
    if(confirm("ุขุง ูุทูุฆู ูุณุชุฏุ ุงฺฏุฑ ฺฉุงุฑููุฏ ุญุฐู ุดูุฏ ุญุณุงุจ ู ฺฉุชุงุจ ุงู ูพุงฺฉ ูโุดูุฏ.")) {
        db.employees = db.employees.filter(e => e.id !== id);
        await saveDB();
        renderEmployees();
    }
}

// ุชุบุฑ ฺฉูฺฺฉ ุจุฑุง ุงูฺฉู ููุช ุฑู ุฏฺฉูู ููู ฺฉูฺฉ ูฺฉู ูุณุช ุจุงุฒุณุงุฒ ุดูุฏ
const originalGo = window.go;
window.go = function(pageId) {
    originalGo(pageId);
    if(pageId === 'employees') {
        renderEmployees();
    }
};

function switchSettingsTab(tabId, btn) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-menu-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}
function saveLogo() {
    const file = document.getElementById('logoUploader').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        if(!db.settings) db.settings = {};
        db.settings.logo = e.target.result;
        await saveDB();
        document.getElementById('logoPreview').src = db.settings.logo;
        document.getElementById('logoPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function clearLogo() {
    if(confirm('ุญุฐู ููฺฏูุ')) {
        if(db.settings) db.settings.logo = null;
        saveDB();
        document.getElementById('logoPreview').style.display = 'none';
        document.getElementById('logoUploader').value = '';
    }
}
// --- ุดุฑูุน ฺฉุฏูุง ุงุตูุงุญ ุณุฑูุงู ุงููู ---

// ฑ. ุชุงุจุน ุฌุฏุฏ ุจุฑุง ุณุงุฎุชู ฺฉุงุฏุฑูุง ูุฑูุฏ ุณุฑูุงู
function renderInitialCapitalInputs() {
    const container = document.getElementById('initialCapitalInputs');
    if (!container) return;

    let html = '';
    // ุจุฑุฑุณ ุงูฺฉู ูุณุช ุงุฑุฒูุง ููุฌูุฏ ุจุงุดุฏ
    if(!db.currencies) db.currencies = ['USD', 'AFN', 'EUR'];
    if(!db.initialCapital) db.initialCapital = {};
    if(!db.avgRates) db.avgRates = {};

    db.currencies.forEach(c => {
        const cap = db.initialCapital[c] || 0;
        const rate = db.avgRates[c] || 0;

        html += `
        <div style="background:rgba(0,0,0,0.1); padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--gold-border);">
            <div style="font-weight:bold; color:var(--gold-primary); margin-bottom:5px; border-bottom:1px solid var(--gold-border);">${c}</div>
            <div class="grid-2">
                <div>
                    <label class="label">ูุจูุบ ุณุฑูุงู ุงููู (ููุฌูุฏ ุดุฑูุน)</label>
                    <input type="number" id="initCap_${c}" class="input" value="${cap}" onfocus="this.select()">
                </div>
                <div>
                    <label class="label">ูุฑุฎ ูุงูฺฏู ุฎุฑุฏ (Cost Rate)</label>
                    <input type="number" id="initRate_${c}" class="input" value="${rate}" onfocus="this.select()" placeholder="ูุซูุงู: 1">
                </div>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

// ฒ. ุงุตูุงุญ ุชุงุจุน ุฌุงุจุฌุง ุชุจโูุง (ุชุง ููุช ุฑู ุฏฺฉูู ฺฉูฺฉ ฺฉุฑุฏุฏุ ฺฉุงุฏุฑูุง ุธุงูุฑ ุดููุฏ)
window.switchSettingsTab = function(tabId, btn) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-menu-btn').forEach(b => b.classList.remove('active'));
    
    const target = document.getElementById(tabId);
    if(target) target.classList.add('active');
    
    if(btn) btn.classList.add('active');

    // ุงฺฏุฑ ูุงุฑุฏ ุชุจ ุณุฑูุงู ุดุฏูุ ฺฉุงุฏุฑูุง ุฑุง ุจุณุงุฒ
    if (tabId === 'tab-capital') {
        renderInitialCapitalInputs();
    }
};

// ุชุงุจุน ููุงุด ู ูุญุงุณุจู ฺฉูุดูโูุง (ุงุตูุงุญ ุดุฏู: ุฏุณุชูโุจูุฏ ุดูุฑ + ุฏุฑุตุฏ ูุงุญุฏ)
function renderCommissionCalc() {
    // 1. ุฌูุนโุขูุฑ ุงุทูุงุนุงุช: ุดูุฑ -> ุงุฑุฒ -> ูุฌููุน ฺฉูุดู
    // ุณุงุฎุชุงุฑ ุฏุชุง: { "Kabul": { "USD": 100, "AFN": 5000 }, "Herat": { ... } }
    let cityData = {};
    
    db.hawalas.forEach(h => {
        if (h.comm && h.comm > 0) {
            const city = h.cityBook;
            // ุงุณุชูุงุฏู ุงุฒ ุงุฑุฒ ฺฉูุดู ุง ุงฺฏุฑ ูุจูุฏ ุงุฑุฒ ุฎูุฏ ุญูุงูู
            const curr = h.commCurr || h.curr;
            
            if (!cityData[city]) cityData[city] = {};
            if (!cityData[city][curr]) cityData[city][curr] = 0;
            
            cityData[city][curr] += h.comm;
        }
    });

    const container = document.getElementById('commCalcBody');
    // ฺูู ุทุฑุงุญ ุนูุถ ุดุฏุ ุจุงุฏ ุฌุฏูู ูุจู ุฑุง ูพุงฺฉ ฺฉูู ู ุฏุฒุงู ุฌุฏุฏ ุจุณุงุฒู
    // ุงูุง ฺูู ุฏุฑ HTML ุดูุง <table> ุซุงุจุช ุงุณุชุ ูุง ุจุงุฏ ฺฉู ูุญุชูุง ฺฉุงุฑุช ุฑุง ุนูุถ ฺฉูู ุง ุณุงุฎุชุงุฑ ุฌุฏูู ุฑุง ุชุบุฑ ุฏูู.
    // ุฑุงู ุจูุชุฑ: ุฌุฏูู HTML ุฑุง ูุงุฏุฏู ูโฺฏุฑู ู ุฏุงุฎู ฺฉุงูุชูุฑ ุงุตู ฺฉุงุฑุชุ ุจุงฺฉุณโูุง ุฌุฏุงฺฏุงูู ูโุณุงุฒู.
    
    const pageContainer = document.querySelector('#commissions .card');
    
    // ูุฏุฑ ฺฉุงุฑุช ุซุงุจุช ุจูุงูุฏุ ูุญุชูุง ุชุบุฑ ฺฉูุฏ
    let htmlContent = `
        <div class="card-header">
            <span>ูุญุงุณุจู ู ุชูุณู ุณูุฏ (ุจู ุชูฺฉฺฉ ุดูุฑ)</span>
            <button class="btn btn-gold" onclick="renderCommissionCalc()">๐ ูุญุงุณุจู ูุฌุฏุฏ</button>
        </div>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">
            * ุฏุฑุตุฏูุง ุฑุง ุจุฑุง ูุฑ ุดูุฑ ุชูุธู ฺฉูุฏ ุชุง ุฑู ุชูุงู ุงุฑุฒูุง ุขู ุดูุฑ ุงุนูุงู ุดูุฏ.
        </p>
    `;

    if (Object.keys(cityData).length === 0) {
        htmlContent += `<div style="text-align:center; padding:20px;">ูฺ ฺฉูุดู ุจุฑุง ูุญุงุณุจู ูุฌูุฏ ูุฏุงุฑุฏ.</div>`;
        pageContainer.innerHTML = htmlContent;
        return;
    }

    // ุญููู ุฑู ุดูุฑูุง
    for (let city in cityData) {
        // ุณุงุฎุช ุดูุงุณู ุงูู ุจุฑุง ุดูุฑ (ุญุฐู ูุงุตูู ู ...)
        const safeCityId = city.replace(/\s+/g, '_');
        
        htmlContent += `
        <div style="background:rgba(255,255,255,0.02); border:1px solid var(--gold-border); border-radius:12px; margin-bottom:25px; overflow:hidden;">
            
            <div style="background:rgba(212,175,55,0.1); padding:15px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; border-bottom:1px dashed var(--gold-border);">
                <div style="font-weight:900; font-size:18px; color:var(--gold-primary); margin-bottom:10px;">
                    ๐ ${city}
                </div>
                
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; color:var(--success)">ุณูู ูุง:</span>
                        <input type="number" class="input" style="width:60px; margin:0; text-align:center; height:35px; border-color:var(--success)" 
                               value="40" id="pc_share_${safeCityId}" oninput="updateCityCalc('${safeCityId}')"> %
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; color:var(--gold-primary)">ููุงูุฏู:</span>
                        <input type="number" class="input" style="width:60px; margin:0; text-align:center; height:35px; border-color:var(--gold-primary)" 
                               value="40" id="pc_ag_${safeCityId}" oninput="updateCityCalc('${safeCityId}')"> %
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; color:var(--danger)">ูุฒูู:</span>
                        <input type="number" class="input" style="width:60px; margin:0; text-align:center; height:35px; border-color:var(--danger)" 
                               value="20" id="pc_tax_${safeCityId}" oninput="updateCityCalc('${safeCityId}')"> %
                    </div>
                </div>
            </div>

            <div class="table-container" style="padding:0;">
                <table style="margin:0; border:none;">
                    <thead>
                        <tr>
                            <th style="background:transparent; border-bottom:1px solid #444;">ุงุฑุฒ</th>
                            <th style="background:transparent; border-bottom:1px solid #444;">ูุฌููุน ฺฉู ฺฉูุดู</th>
                            <th style="background:transparent; border-bottom:1px solid #444; color:var(--success)">โ ุณูู ูุง</th>
                            <th style="background:transparent; border-bottom:1px solid #444; color:var(--gold-primary)">๐ค ุณูู ููุงูุฏู</th>
                            <th style="background:transparent; border-bottom:1px solid #444; color:var(--danger)">๐ ูุฒูู/ูุงูุงุช</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        // ุญููู ุฑู ุงุฑุฒูุง ุขู ุดูุฑ
        for (let curr in cityData[city]) {
            const total = cityData[city][curr];
            const safeCurrId = curr.replace(/\s+/g, '_');
            // ุขุฏโูุง ููุญุตุฑ ุจู ูุฑุฏ ุจุฑุง ูุฑ ุณููู
            const rowId = `${safeCityId}_${safeCurrId}`;
            
            htmlContent += `
                        <tr>
                            <td style="font-weight:bold;">${curr}</td>
                            <td style="font-weight:900; font-size:16px;" dir="ltr" id="total_${rowId}" data-val="${total}">
                                ${total.toLocaleString()}
                            </td>
                            <td style="font-weight:bold; color:var(--success);" dir="ltr" id="res_share_${rowId}">0</td>
                            <td style="font-weight:bold; color:var(--gold-primary);" dir="ltr" id="res_ag_${rowId}">0</td>
                            <td style="font-weight:bold; color:var(--danger);" dir="ltr" id="res_tax_${rowId}">0</td>
                        </tr>
            `;
        }

        htmlContent += `
                    </tbody>
                </table>
            </div>
            <input type="hidden" id="currencies_${safeCityId}" value="${Object.keys(cityData[city]).join(',')}">
        </div>
        `;
    }

    pageContainer.innerHTML = htmlContent;

    // ุงุฌุฑุง ูุญุงุณุจู ุงููู ุจุฑุง ููู ุดูุฑูุง
    setTimeout(() => {
        for (let city in cityData) {
            updateCityCalc(city.replace(/\s+/g, '_'));
        }
    }, 100);
}

// ุชุงุจุน ูุญุงุณุจูโฺฏุฑ ุฌุฏุฏ (ฺฉ ุดูุฑ ุฑุง ูโฺฏุฑุฏ ู ุชูุงู ุงุฑุฒูุงุด ุฑุง ุขูพุฏุช ูโฺฉูุฏ)
function updateCityCalc(cityId) {
    // 1. ฺฏุฑูุชู ุฏุฑุตุฏูุง ุขู ุดูุฑ
    const pShare = parseFloat(document.getElementById(`pc_share_${cityId}`).value) || 0;
    const pAg = parseFloat(document.getElementById(`pc_ag_${cityId}`).value) || 0;
    const pTax = parseFloat(document.getElementById(`pc_tax_${cityId}`).value) || 0;

    // 2. ูพุฏุง ฺฉุฑุฏู ุงุฑุฒูุง ููุฌูุฏ ุฏุฑ ุขู ุดูุฑ
    const currString = document.getElementById(`currencies_${cityId}`).value;
    if (!currString) return;
    const currencies = currString.split(',');

    // 3. ูุญุงุณุจู ุจุฑุง ุชฺฉ ุชฺฉ ุงุฑุฒูุง
    currencies.forEach(curr => {
        const safeCurr = curr.replace(/\s+/g, '_'); // ุงฺฏุฑ ูุงุตูู ุฏุงุดุช
        const rowId = `${cityId}_${safeCurr}`;
        
        const totalEl = document.getElementById(`total_${rowId}`);
        const total = parseFloat(totalEl.getAttribute('data-val')) || 0;

        const valShare = (total * pShare) / 100;
        const valAg = (total * pAg) / 100;
        const valTax = (total * pTax) / 100;

        document.getElementById(`res_share_${rowId}`).innerText = valShare.toLocaleString(undefined, {maximumFractionDigits:1});
        document.getElementById(`res_ag_${rowId}`).innerText = valAg.toLocaleString(undefined, {maximumFractionDigits:1});
        document.getElementById(`res_tax_${rowId}`).innerText = valTax.toLocaleString(undefined, {maximumFractionDigits:1});
    });
}
function updateCommRow(key) {
    const row = document.getElementById(`row_${key}`);
    if(!row) return;
    
    // ฺฏุฑูุชู ูุจูุบ ฺฉู
    const totalCell = row.querySelector('[data-total]');
    const total = parseFloat(totalCell.getAttribute('data-total')) || 0;

    // ฺฏุฑูุชู ุฏุฑุตุฏูุง ุงุฒ ฺฉุงุฏุฑูุง ููุงู ุฑุฏู
    const pOff = parseFloat(document.getElementById(`p_off_${key}`).value) || 0;
    const pAg = parseFloat(document.getElementById(`p_ag_${key}`).value) || 0;
    const pTax = parseFloat(document.getElementById(`p_tax_${key}`).value) || 0;

    // ูุญุงุณุจู
    const vOff = (total * pOff) / 100;
    const vAg = (total * pAg) / 100;
    const vTax = (total * pTax) / 100;

    // ููุงุด ูุชุฌู
    document.getElementById(`res_off_${key}`).innerText = vOff.toLocaleString(undefined, {maximumFractionDigits:1});
    document.getElementById(`res_ag_${key}`).innerText = vAg.toLocaleString(undefined, {maximumFractionDigits:1});
    document.getElementById(`res_tax_${key}`).innerText = vTax.toLocaleString(undefined, {maximumFractionDigits:1});
}
function toggleMobileMenu() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('mobileOverlay');
    const btn = document.getElementById('mobileMenuBtn');
    if (sidebar.classList.contains('mobile-active')) {
        sidebar.classList.remove('mobile-active');
        overlay.style.display = 'none';
        btn.innerHTML = 'โฐ';
    } else {
        sidebar.classList.add('mobile-active');
        overlay.style.display = 'block';
        btn.innerHTML = 'โ';
    }
}
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (window.innerWidth <= 768) toggleMobileMenu();
    });
});
</script>
</body>
</html>
}